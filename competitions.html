<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المسابقات العائلية</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .timer { font-size: 12px; color: #ff3b30; font-weight: bold; background: #fff2f2; padding: 4px 10px; border-radius: 10px; }
        .option-btn { width: 100%; padding: 12px; margin-top: 8px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; text-align: right; }
        .option-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .selected-correct { background: #d4edda !important; border-color: #28a745; }
        .selected-wrong { background: #f8d7da !important; border-color: #dc3545; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="location.href='news.html'">➡️</button>
        <b>المسابقات النشطة</b>
    </div>

    <div id="compsFeed" style="padding: 15px;"></div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userData = {}; // نفترض جلب بيانات المستخدم هنا كما في الصفحات السابقة

    function startCountdown(endTime, elementId) {
        setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;
            if (distance < 0) {
                document.getElementById(elementId).innerHTML = "منتهية";
                return;
            }
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById(elementId).innerHTML = `⏳ متبقي: ${days}ي ${hours}س ${mins}د`;
        }, 1000);
    }

    onSnapshot(query(collection(db, "Competitions"), where("visible", "==", true)), snap => {
        const feed = document.getElementById('compsFeed');
        feed.innerHTML = "";
        snap.forEach(async d => {
            const c = d.data();
            const timerId = `timer-${d.id}`;
            const card = document.createElement('div');
            card.className = "comp-card";
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h3 style="margin:0;">${c.title}</h3>
                    <span id="${timerId}" class="timer">--</span>
                </div>
                <div id="questions-${d.id}" style="margin-top:15px;"></div>
            `;
            feed.appendChild(card);
            startCountdown(new Date(c.endDate).getTime(), timerId);
            loadUserQuestions(d.id, c.title);
        });
    });

    async function loadUserQuestions(compId, compTitle) {
        const qSnap = await getDocs(query(collection(db, `Competitions/${compId}/Questions`), where("active", "==", true)));
        const cont = document.getElementById(`questions-${compId}`);
        
        qSnap.forEach(async qDoc => {
            const q = qDoc.data();
            // فحص هل جاوب العضو مسبقاً
            const answeredSnap = await getDocs(query(collection(db, "Answers"), 
                where("userId", "==", auth.currentUser.uid), 
                where("questionId", "==", qDoc.id)));

            const isAnswered = !answeredSnap.empty;
            let optionsHtml = "";
            
            q.options.forEach(opt => {
                optionsHtml += `
                    <button class="option-btn" 
                        ${isAnswered ? 'disabled' : ''} 
                        onclick="submitAnswer('${compId}', '${compTitle}', '${qDoc.id}', '${q.text}', '${opt}', '${q.correctOption}', this)">
                        ${opt}
                    </button>`;
            });

            cont.innerHTML += `
                <div style="margin-bottom:20px; padding:10px; border-top:1px solid #eee;">
                    <p><b>السؤال:</b> ${q.text}</p>
                    ${optionsHtml}
                    ${isAnswered ? '<p style="font-size:10px; color:blue;">تم إرسال إجابتك لهذا السؤال</p>' : ''}
                </div>
            `;
        });
    }

    window.submitAnswer = async (compId, compTitle, qId, qText, selected, correct, btn) => {
        if(!confirm("هل أنت متأكد من هذه الإجابة؟ لا يمكن تغييرها لاحقاً.")) return;

        const isCorrect = (selected === correct);
        btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
        btn.classList.add(isCorrect ? 'selected-correct' : 'selected-wrong');

        await addDoc(collection(db, "Answers"), {
            userId: auth.currentUser.uid,
            userName: userData.fullName,
            userPhone: userData.phone,
            userEmail: userData.email,
            compId, compTitle,
            questionId: qId,
            questionText: qText,
            selectedOption: selected,
            isCorrect,
            timestamp: new Date()
        });
    };
</script>
</body>
</html>
