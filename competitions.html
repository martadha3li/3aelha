<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ù†Ù‚Ø§Ø·ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; }
        body { background: var(--bg); font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; padding-bottom: 50px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .user-stats { background: var(--primary); color: white; border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .comp-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .q-box { background: #f8f8fb; border-radius: 15px; padding: 15px; margin-bottom: 15px; }
        .option-btn { width: 100%; padding: 14px; margin-top: 8px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; text-align: right; }
        .correct { background: #34c759 !important; color: white; } .wrong { background: #ff3b30 !important; color: white; }
        .next-q-timer { background: #eef1ff; color: var(--primary); padding: 10px; border-radius: 10px; font-size: 13px; text-align: center; margin-top: 10px; border: 1px dashed var(--primary); }
    </style>
</head>
<body>

<div class="top-bar">
    <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
    <b>Ù…Ù†ØµØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</b>
    <div style="width:24px;"></div>
</div>

<div class="container">
    <div class="user-stats">
        <h2 id="totalPoints" style="margin:0;">0</h2>
        <p style="margin:0; opacity:0.8;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø© âœ¨</p>
    </div>

    <div id="compsFeed"></div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userData = null;

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.exists()) { 
                userData = snap.data(); 
                loadMyPoints(user.uid);
                loadComps(); 
            } else location.href = "profile.html";
        } else location.href = "login.html";
    });

    // Ø¬Ù„Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    function loadMyPoints(uid) {
        onSnapshot(query(collection(db, "Answers"), where("userId", "==", uid)), snap => {
            let total = 0;
            snap.forEach(d => { if(d.data().isCorrect) total += 10; });
            document.getElementById('totalPoints').innerText = total;
        });
    }

    function loadComps() {
        onSnapshot(query(collection(db, "Competitions"), where("visible", "==", true)), snap => {
            const feed = document.getElementById('compsFeed');
            feed.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const card = document.createElement('div');
                card.className = "comp-card";
                card.innerHTML = `<h3>${c.title}</h3><div id="qs-${d.id}"></div>`;
                feed.appendChild(card);
                loadQs(d.id, c.title);
            });
        });
    }

    async function loadQs(cid, ctitle) {
        const qSnap = await getDocs(query(collection(db, `Competitions/${cid}/Questions`), where("active", "==", true)));
        const cont = document.getElementById(`qs-${cid}`);
        const now = new Date();

        qSnap.forEach(async qDoc => {
            const q = qDoc.data();
            const showAt = new Date(q.showAt);

            if (showAt > now) {
                const timerDiv = document.createElement('div');
                timerDiv.className = "next-q-timer";
                cont.appendChild(timerDiv);
                const x = setInterval(() => {
                    const diff = new Date(q.showAt) - new Date();
                    if (diff <= 0) { clearInterval(x); location.reload(); }
                    const m = Math.floor((diff % 3600000) / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    timerDiv.innerHTML = `ğŸ”’ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯ Ø³ÙŠÙØªØ­ Ø¨Ø¹Ø¯: ${m}Ø¯ Ùˆ ${s}Ø«`;
                }, 1000);
                return;
            }

            const ansSnap = await getDocs(query(collection(db, "Answers"), where("userId", "==", auth.currentUser.uid), where("questionId", "==", qDoc.id)));
            const isAns = !ansSnap.empty;

            const qBox = document.createElement('div');
            qBox.className = "q-box";
            let optsHtml = "";
            q.options.forEach(opt => {
                let cls = "";
                if(isAns) {
                    const myA = ansSnap.docs[0].data().selectedOption;
                    if(opt === q.correctOption) cls = "correct";
                    else if(opt === myA) cls = "wrong";
                }
                optsHtml += `<button class="option-btn ${cls}" ${isAns?'disabled':''} onclick="sendAns('${cid}','${ctitle}','${qDoc.id}','${q.text}','${opt}','${q.correctOption}',this)">${opt}</button>`;
            });
            qBox.innerHTML = `<b>${q.text}</b>${optsHtml}`;
            cont.appendChild(qBox);
        });
    }

    window.sendAns = async (cid, ct, qid, qt, sel, corr, btn) => {
        if(!confirm("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŸ")) return;
        const isC = sel.trim() === corr.trim();
        await addDoc(collection(db, "Answers"), {
            userId: auth.currentUser.uid, userName: userData.fullName, userPhone: userData.phone,
            compId: cid, compTitle: ct, questionId: qid, questionText: qt,
            selectedOption: sel, isCorrect: isC, timestamp: serverTimestamp()
        });
        location.reload();
    };
</script>
</body>
</html>
