<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
Â  Â  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
Â  window.OneSignalDeferred = window.OneSignalDeferred || [];
Â  OneSignalDeferred.push(async function(OneSignal) {
Â  Â  await OneSignal.init({
Â  Â  Â  appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15",
Â  Â  });

Â  Â  // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
Â  Â  OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
Â  Â  Â  Â  const subscriptionId = event.current.id;
Â  Â  Â  Â  if (subscriptionId && auth.currentUser) {
Â  Â  Â  Â  Â  Â  const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
Â  Â  Â  Â  Â  Â  const { db } = await import("./config.js");
Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, "Users", auth.currentUser.uid), {
Â  Â  Â  Â  Â  Â  Â  Â  onesignalId: subscriptionId
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  });
Â  });
</script>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
Â  Â  <link rel="stylesheet" href="style.css">
Â  Â  <style>
Â  Â  Â  Â  :root { --primary: #5856d6; --bg: #f2f2f7; --accent: #ff9500; }
Â  Â  Â  Â  body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 50px; }
Â  Â  Â  Â  .container { padding: 15px; max-width: 600px; margin: auto; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
Â  Â  Â  Â  .comp-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--primary); }
Â  Â  Â  Â  .comp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ø¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
Â  Â  Â  Â  .comp-end-timer { font-size: 11px; background: #fff5e6; color: var(--accent); padding: 5px 10px; border-radius: 8px; font-weight: bold; border: 1px solid #ffe0b2; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… */
Â  Â  Â  Â  .next-q-timer { background: #eef1ff; color: var(--primary); padding: 15px; border-radius: 15px; text-align: center; border: 1px dashed var(--primary); margin: 15px 0; }
Â  Â  Â  Â  .timer-grid { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
Â  Â  Â  Â  .timer-unit { background: white; padding: 5px 8px; border-radius: 6px; min-width: 35px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
Â  Â  Â  Â  .timer-label { font-size: 9px; display: block; color: #8e8e93; }

Â  Â  Â  Â  .q-box { background: #f8f8fb; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
Â  Â  Â  Â  .option-btn { width: 100%; padding: 14px; margin-top: 8px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; text-align: right; font-size: 14px; transition: 0.2s; }
Â  Â  Â  Â  .correct { background: #34c759 !important; color: white; border-color: #34c759; }
Â  Â  Â  Â  .wrong { background: #ff3b30 !important; color: white; border-color: #ff3b30; }
Â  Â  </style>
</head>
<body>

<div class="top-bar">
Â  Â  <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
Â  Â  <b>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</b>
Â  Â  <div style="width:24px;"></div>
</div>

<div class="container" id="compsFeed">
Â  Â  <p style="text-align:center; color:gray; margin-top:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª...</p>
</div>

<script type="module">
Â  Â  import { auth, db } from './config.js';
Â  Â  import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
Â  Â  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

Â  Â  let userData = null;

Â  Â  onAuthStateChanged(auth, async user => {
Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  const snap = await getDoc(doc(db, "Users", user.uid));
Â  Â  Â  Â  Â  Â  userData = snap.data();
Â  Â  Â  Â  Â  Â  loadComps();
Â  Â  Â  Â  } else location.href = "login.html";
Â  Â  });

Â  Â  function loadComps() {
Â  Â  Â  Â  onSnapshot(query(collection(db, "Competitions"), where("visible", "==", true)), snap => {
Â  Â  Â  Â  Â  Â  const feed = document.getElementById('compsFeed');
Â  Â  Â  Â  Â  Â  feed.innerHTML = "";
Â  Â  Â  Â  Â  Â  snap.forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  const c = d.data();
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  card.className = "comp-card";
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="comp-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 style="margin:0;">${c.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="end-timer-${d.id}" class="comp-end-timer">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="qs-${d.id}"></div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  feed.appendChild(card);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // ØªØ´ØºÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
Â  Â  Â  Â  Â  Â  Â  Â  startCountdown(c.endDate, `end-timer-${d.id}`, "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
Â  Â  Â  Â  Â  Â  Â  Â  loadQuestions(d.id, c.title);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function loadQuestions(cid, ctitle) {
Â  Â  Â  Â  const qSnap = await getDocs(query(collection(db, `Competitions/${cid}/Questions`), where("active", "==", true)));
Â  Â  Â  Â  const cont = document.getElementById(`qs-${cid}`);
Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  let upcoming = [];

Â  Â  Â  Â  for (const qDoc of qSnap.docs) {
Â  Â  Â  Â  Â  Â  const q = qDoc.data();
Â  Â  Â  Â  Â  Â  const showAt = new Date(q.showAt);

Â  Â  Â  Â  Â  Â  if (showAt > now) {
Â  Â  Â  Â  Â  Â  Â  Â  upcoming.push({ time: showAt });
Â  Â  Â  Â  Â  Â  Â  Â  continue;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const ansSnap = await getDocs(query(collection(db, "Answers"), where("userId", "==", auth.currentUser.uid), where("questionId", "==", qDoc.id)));
Â  Â  Â  Â  Â  Â  const isAns = !ansSnap.empty;

Â  Â  Â  Â  Â  Â  const qBox = document.createElement('div');
Â  Â  Â  Â  Â  Â  qBox.className = "q-box";
Â  Â  Â  Â  Â  Â  let optsHtml = "";
Â  Â  Â  Â  Â  Â  q.options.forEach(opt => {
Â  Â  Â  Â  Â  Â  Â  Â  let cls = isAns ? (opt === q.correctOption ? "correct" : (opt === ansSnap.docs[0].data().selectedOption ? "wrong" : "")) : "";
Â  Â  Â  Â  Â  Â  Â  Â  optsHtml += `<button class="option-btn ${cls}" ${isAns?'disabled':''} onclick="sendAns('${cid}','${ctitle}','${qDoc.id}','${q.text}','${opt}','${q.correctOption}', ${q.points}, this)">${opt}</button>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  qBox.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>${q.text}</b> <span style="color:var(--primary); font-size:12px;">ğŸ’ ${q.points} Ù†</span></div>${optsHtml}`;
Â  Â  Â  Â  Â  Â  cont.appendChild(qBox);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø£ÙŠØ§Ù…ØŒ Ø³Ø§Ø¹Ø§ØªØŒ Ø¯Ù‚Ø§Ø¦Ù‚ØŒ Ø«ÙˆØ§Ù†ÙŠ)
Â  Â  Â  Â  if (upcoming.length > 0) {
Â  Â  Â  Â  Â  Â  upcoming.sort((a,b) => a.time - b.time);
Â  Â  Â  Â  Â  Â  const nextT = upcoming[0].time;
Â  Â  Â  Â  Â  Â  const timerDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  timerDiv.className = "next-q-timer";
Â  Â  Â  Â  Â  Â  cont.appendChild(timerDiv);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const diff = nextT - new Date();
Â  Â  Â  Â  Â  Â  Â  Â  if(diff <= 0) location.reload();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const d = Math.floor(diff / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  Â  Â  const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
Â  Â  Â  Â  Â  Â  Â  Â  const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
Â  Â  Â  Â  Â  Â  Â  Â  const s = Math.floor((diff % (1000 * 60)) / 1000);

Â  Â  Â  Â  Â  Â  Â  Â  timerDiv.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="font-size:13px;">ğŸ”’ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙŠÙØªØ­ Ø®Ù„Ø§Ù„:</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-grid">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-unit"><b>${d}</b><span class="timer-label">ÙŠÙˆÙ…</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-unit"><b>${h}</b><span class="timer-label">Ø³Ø§Ø¹Ø©</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-unit"><b>${m}</b><span class="timer-label">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timer-unit"><b>${s}</b><span class="timer-label">Ø«Ø§Ù†ÙŠØ©</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø©
Â  Â  function startCountdown(dateStr, elementId, finishMsg) {
Â  Â  Â  Â  const target = new Date(dateStr).getTime();
Â  Â  Â  Â  const el = document.getElementById(elementId);
Â  Â  Â  Â Â 
Â  Â  Â  Â  const timer = setInterval(() => {
Â  Â  Â  Â  Â  Â  const now = new Date().getTime();
Â  Â  Â  Â  Â  Â  const diff = target - now;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (diff < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(timer);
Â  Â  Â  Â  Â  Â  Â  Â  el.innerHTML = finishMsg;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const days = Math.floor(diff / (1000 * 60 * 60 * 24));
Â  Â  Â  Â  Â  Â  const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
Â  Â  Â  Â  Â  Â  const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  el.innerHTML = `â³ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${days}ÙŠ Ùˆ ${hours}Ø³ Ùˆ ${mins}Ø¯`;
Â  Â  Â  Â  }, 1000);
Â  Â  }

Â  Â  window.sendAns = async (cid, ct, qid, qt, sel, corr, pts, btn) => {
Â  Â  Â  Â  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;
Â  Â  Â  Â  const isC = sel.trim() === corr.trim();
Â  Â  Â  Â  await addDoc(collection(db, "Answers"), {
Â  Â  Â  Â  Â  Â  userId: auth.currentUser.uid,
Â  Â  Â  Â  Â  Â  userName: userData.fullName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
Â  Â  Â  Â  Â  Â  userPhone: userData.phone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
Â  Â  Â  Â  Â  Â  userEmail: auth.currentUser.email || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
Â  Â  Â  Â  Â  Â  compId: cid, compTitle: ct, questionId: qid, questionText: qt,
Â  Â  Â  Â  Â  Â  selectedOption: sel, isCorrect: isC, pointsAwarded: isC ? pts : 0,
Â  Â  Â  Â  Â  Â  timestamp: serverTimestamp()
Â  Â  Â  Â  });
Â  Â  Â  Â  location.reload();
Â  Â  };
</script>
</body>
</html>
