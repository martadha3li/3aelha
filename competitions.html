<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
:root{
 --blue:#007AFF;
 --green:#34C759;
 --red:#FF3B30;
 --bg:#F2F2F7;
}
body{margin:0;font-family:sans-serif;background:var(--bg);padding:70px 15px 100px;}
.comp-card{background:#fff;border-radius:20px;padding:20px;margin-bottom:25px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
.comp-card.ended{border:2px solid var(--red);background:#FFF5F5;}
.q-box{background:#f8f8fb;padding:15px;border-radius:15px;margin-bottom:15px;border:1px solid #eee;position:relative;}
.q-box.answered{opacity:.45;pointer-events:none;border:3px solid var(--green);background:#F0FFF4;}
.q-box.answered::after{
content:"ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹";
position:absolute;top:10px;left:10px;
background:var(--green);color:#fff;
padding:5px 10px;border-radius:20px;font-size:10px;
}
.option-btn{width:100%;padding:12px;margin-top:8px;border-radius:12px;border:1px solid #ddd;background:#fff;cursor:pointer;text-align:right;}
.option-btn.correct{background:var(--green)!important;color:#fff;border-color:var(--green);}
.option-btn.wrong{background:var(--red)!important;color:#fff;border-color:var(--red);}
</style>
</head>
<body>

<h2>ğŸ† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>
<div id="compsFeed">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

<script type="module">
import { auth, db } from './config.js';
import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

let userData=null;
let answeredQuestions={};

onAuthStateChanged(auth, async user=>{
 if(!user){location.href="login.html";return;}

 const snap=await getDoc(doc(db,"Users",user.uid));
 userData=snap.data();

 const ansQuery=query(collection(db,"Answers"),where("userId","==",user.uid));
 const ansSnap=await getDocs(ansQuery);
 ansSnap.forEach(d=>{
   answeredQuestions[d.data().questionId]=true;
 });

 loadCompetitions();
});

function loadCompetitions(){
 onSnapshot(collection(db,"Competitions"), snap=>{
   const feed=document.getElementById("compsFeed");
   feed.innerHTML="";

   snap.forEach(docSnap=>{
     const c=docSnap.data();
     const isEnded=c.endDate? new Date(c.endDate)<new Date():false;

     const card=document.createElement("div");
     card.className="comp-card"+(isEnded?" ended":"");

     card.innerHTML=`<h3>${c.title}</h3>`;
     const qsDiv=document.createElement("div");

     card.appendChild(qsDiv);
     feed.appendChild(card);

     if(!isEnded) loadQuestions(docSnap.id,c.title,qsDiv);
   });
 });
}

async function loadQuestions(cid,ctitle,container){
 const qSnap=await getDocs(collection(db,`Competitions/${cid}/Questions`));
 const now=new Date();

 qSnap.forEach(qDoc=>{
   const q=qDoc.data();
   if(new Date(q.showAt)>now) return;

   const isAnswered=answeredQuestions[qDoc.id];
   const box=document.createElement("div");
   box.className="q-box"+(isAnswered?" answered":"");

   box.innerHTML=`<b>${q.text}</b> <span style="color:blue">ğŸ’ ${q.points}</span>`;

   q.options.forEach(opt=>{
     const btn=document.createElement("button");
     btn.className="option-btn";
     btn.innerText=opt;

     if(!isAnswered){
       btn.onclick=()=>sendAnswer(cid,ctitle,qDoc.id,q.text,opt,q.correctOption,q.points,box);
     }

     box.appendChild(btn);
   });

   container.appendChild(box);
 });
}

async function sendAnswer(cid,ctitle,qid,qt,selected,correct,points,qBox){

 if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;

 const existing=query(collection(db,"Answers"),
  where("userId","==",auth.currentUser.uid),
  where("questionId","==",qid)
 );
 const check=await getDocs(existing);
 if(!check.empty){ alert("Ø£Ø¬Ø¨Øª Ø³Ø§Ø¨Ù‚Ø§Ù‹"); return;}

 const isCorrect=selected.trim()===correct.trim();
 const buttons=qBox.querySelectorAll("button");

 buttons.forEach(b=>{
   b.disabled=true;
   if(b.innerText.trim()===correct.trim()) b.classList.add("correct");
   if(!isCorrect && b.innerText.trim()===selected.trim()) b.classList.add("wrong");
 });

 qBox.classList.add("answered");

 await addDoc(collection(db,"Answers"),{
   userId:auth.currentUser.uid,
   userName:userData.fullName||"Ø¹Ø¶Ùˆ",
   userPhone:userData.phone||"",
   compId:cid,
   compTitle:ctitle,
   questionId:qid,
   questionText:qt,
   selectedOption:selected,
   isCorrect:isCorrect,
   pointsAwarded:isCorrect?points:0,
   timestamp:serverTimestamp()
 });
}
</script>
</body>
</html>
