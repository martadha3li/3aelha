<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .comp-wrapper { padding: 15px; padding-bottom: 100px; }
        .comp-card { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; border-right: 5px solid var(--primary); }
        .question-box { background: #f8f9fa; padding: 15px; border-radius: 15px; margin-top: 15px; }
        .opt-btn { width: 100%; margin-top: 8px; padding: 12px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; font-family: inherit; font-weight: bold; transition: 0.2s; }
        .opt-btn:hover { background: #eef6ff; border-color: var(--primary); }
        .opt-btn:disabled { opacity: 0.6; cursor: not-allowed; background: #eee; }
        .answered-tag { color: #34c759; font-size: 11px; font-weight: bold; margin-top: 10px; display: block; }
    </style>
</head>
<body style="background: #f4f7f6;">

    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
        <b>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¬ÙˆØ§Ø¦Ø² ğŸ†</b>
        <div style="width:20px;"></div>
    </div>

    <div class="comp-wrapper" id="compContainer">
        <p id="loadingMsg" style="text-align: center; color: gray; margin-top: 50px;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©...</p>
    </div>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></a>
        <a href="competitions.html" class="nav-item active"><span class="nav-icon">ğŸ†</span><span>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</span></a>
        <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDoc, getDocs, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUser = null;

    auth.onAuthStateChanged(async user => {
        if(user) {
            const s = await getDoc(doc(db, "Users", user.uid));
            currentUser = s.data();
            currentUser.uid = user.uid;
            loadCompetitions();
        } else { window.location.replace("login.html"); }
    });

    async function loadCompetitions() {
        const container = document.getElementById('compContainer');
        const now = new Date();

        onSnapshot(collection(db, "Competitions"), async (snap) => {
            if (snap.empty) {
                container.innerHTML = '<p style="text-align:center; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                return;
            }

            container.innerHTML = "";
            document.getElementById('loadingMsg')?.remove();

            for (const compDoc of snap.docs) {
                const comp = compDoc.data();
                const startDate = new Date(comp.start);
                const endDate = new Date(comp.end);

                // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹
                if (now >= startDate && now <= endDate) {
                    const compDiv = document.createElement('div');
                    compDiv.className = 'comp-card';
                    compDiv.innerHTML = `
                        <h3 style="margin:0; color:var(--primary);">ğŸ† ${comp.name}</h3>
                        <small style="color:gray;">ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ: ${endDate.toLocaleString('ar-EG')}</small>
                        <div id="questions-for-${compDoc.id}"></div>
                    `;
                    container.appendChild(compDiv);
                    
                    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
                    loadQuestions(compDoc.id, comp.name);
                }
            }
        });
    }

    async function loadQuestions(compId, compName) {
        const qContainer = document.getElementById(`questions-for-${compId}`);
        
        onSnapshot(collection(db, `Competitions/${compId}/Questions`), async (snap) => {
            qContainer.innerHTML = "";
            
            for (const qDoc of snap.docs) {
                const q = qDoc.data();
                
                // ÙØ­Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ø¶Ùˆ Ù‚Ø¯ Ø£Ø¬Ø§Ø¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„
                const answeredQuery = query(
                    collection(db, "CompResults"), 
                    where("userId", "==", currentUser.uid),
                    where("qId", "==", qDoc.id)
                );
                const answeredSnap = await getDocs(answeredQuery);
                const alreadyAnswered = !answeredSnap.empty;

                const qBox = document.createElement('div');
                qBox.className = 'question-box';
                qBox.innerHTML = `
                    <p style="margin-bottom:10px;"><b>â“ ${q.text}</b></p>
                    ${q.options.map((opt, i) => `
                        <button class="opt-btn" 
                            ${alreadyAnswered ? 'disabled' : ''} 
                            onclick="submitAnswer('${compId}', '${compName}', '${qDoc.id}', ${i+1}, ${q.correct})">
                            ${opt}
                        </button>
                    `).join('')}
                    ${alreadyAnswered ? '<span class="answered-tag">âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù…Ø³Ø¨Ù‚Ø§Ù‹</span>' : ''}
                `;
                qContainer.appendChild(qBox);
            }
        });
    }

    window.submitAnswer = async (compId, compName, qId, chosen, correct) => {
        try {
            await addDoc(collection(db, "CompResults"), {
                compId: compId,
                compName: compName,
                qId: qId,
                userId: currentUser.uid,
                userName: currentUser.fullName,
                isCorrect: (chosen == correct),
                timestamp: serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­! Ø­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚Ø±Ø¹Ø© ğŸ¥³");
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©");
        }
    };
</script>
</body>
</html>
