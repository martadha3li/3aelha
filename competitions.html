<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px}
.option{padding:8px;background:#eee;border-radius:10px;margin:5px 0;cursor:pointer}
.correct{background:#34C759;color:#fff}
.wrong{background:#FF3B30;color:#fff}
.answered{opacity:.5}
</style>
</head>
<body>

<h2>üèÅ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™</h2>
<div id="competitions"></div>

<script type="module">
import { db } from './config.js';
import {
collection,getDocs,onSnapshot,
addDoc,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const userName=localStorage.getItem("fullName");

onSnapshot(collection(db,"Competitions"),async snap=>{
 const container=document.getElementById("competitions");
 container.innerHTML="";

 for(const comp of snap.docs){
  const c=comp.data();
  if(c.visible===false) continue;

  const compId=comp.id;
  const qSnap=await getDocs(collection(db,`Competitions/${compId}/Questions`));
  let qHTML="";

  for(const q of qSnap.docs){
   const qData=q.data();

   qHTML+=`
   <div class="card">
    <b>${qData.text}</b>
    ${qData.options.map(opt=>
     `<div class="option" onclick="answer('${compId}','${qData.text}','${opt}','${qData.correctOption}',${qData.points||10},this)">
       ${opt}
      </div>`).join("")}
   </div>
   `;
  }

  container.innerHTML+=`
  <div class="card">
    <h3>${c.title}</h3>
    ${qHTML}
  </div>
  `;
 }
});

window.answer=async(compId,question,selected,correct,points,el)=>{
 const isCorrect=selected===correct;

 el.classList.add(isCorrect?'correct':'wrong');
 el.parentElement.classList.add("answered");

 await addDoc(collection(db,"Answers"),{
  userName,
  compId,
  questionText:question,
  selectedOption:selected,
  correctOption:correct,
  isCorrect,
  pointsAwarded:isCorrect?points:0,
  timestamp:serverTimestamp()
 });
};
</script>
</body>
</html>
