<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15",
    });

    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
        const subscriptionId = event.current.id;
        if (subscriptionId && auth.currentUser) {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const { db } = await import("./config.js");
            await updateDoc(doc(db, "Users", auth.currentUser.uid), {
                onesignalId: subscriptionId
            });
        }
    });
  });
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; --accent: #ff9500; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 50px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
        .comp-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 5px solid var(--primary); }
        .comp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        
        /* Ø¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
        .comp-end-timer { font-size: 11px; background: #fff5e6; color: var(--accent); padding: 5px 10px; border-radius: 8px; font-weight: bold; border: 1px solid #ffe0b2; }
        
        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… */
        .next-q-timer { background: #eef1ff; color: var(--primary); padding: 15px; border-radius: 15px; text-align: center; border: 1px dashed var(--primary); margin: 15px 0; }
        .timer-grid { display: flex; justify-content: center; gap: 10px; margin-top: 5px; }
        .timer-unit { background: white; padding: 5px 8px; border-radius: 6px; min-width: 35px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .timer-label { font-size: 9px; display: block; color: #8e8e93; }

        .q-box { background: #f8f8fb; border-radius: 15px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        .option-btn { width: 100%; padding: 14px; margin-top: 8px; border-radius: 12px; border: 1px solid #ddd; background: white; cursor: pointer; text-align: right; font-size: 14px; transition: 0.2s; }
        .correct { background: #34c759 !important; color: white; border-color: #34c759; }
        .wrong { background: #ff3b30 !important; color: white; border-color: #ff3b30; }

/* ØªØµÙ…ÙŠÙ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© */
#drawOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    z-index: 10000; display: none; flex-direction: column;
    align-items: center; justify-content: center; color: white;
}
.slot-machine {
    font-size: 30px; font-weight: bold; color: var(--ios-gold);
    height: 100px; overflow: hidden; text-align: center;
    border: 2px solid var(--ios-gold); padding: 20px;
    border-radius: 15px; width: 80%; margin: 20px 0;
}
.winner-item {
    background: var(--ios-green); color: white;
    padding: 10px 20px; border-radius: 10px; margin: 5px;
    animation: pop 0.5s ease-out;
}
@keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        
    </style>
</head>
    <div id="adminDrawTool" style="display:none; padding:15px; background:white; margin:15px; border-radius:15px; border:1px solid #ddd;">
    <h4 style="margin:0 0 10px 0;">ğŸ° Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h4>
    <select id="drawCompSelect" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;"></select>
    <input type="number" id="winnerCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†" value="1" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ccc;">
    <button onclick="prepareDraw()" style="width:100%; background:var(--ios-gold); color:black; border:none; padding:12px; border-radius:10px; font-weight:bold;">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
</div>

<div id="drawOverlay">
    <h2 id="drawStatus">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©...</h2>
    <div id="slotBox" class="slot-machine">---</div>
    <div id="winnersList" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
    <button id="closeDrawBtn" onclick="document.getElementById('drawOverlay').style.display='none'" style="display:none; margin-top:20px; padding:10px 30px; border-radius:10px; border:none; background:white; color:black;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>
<body>

<div class="top-bar">
    <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
    <b>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</b>
    <div style="width:24px;"></div>
</div>

<div class="container" id="compsFeed">
    <p style="text-align:center; color:gray; margin-top:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª...</p>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userData = null;

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            userData = snap.data();
            loadComps();
        } else location.href = "login.html";
    });

    function loadComps() {
        onSnapshot(query(collection(db, "Competitions"), where("visible", "==", true)), snap => {
            const feed = document.getElementById('compsFeed');
            feed.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const card = document.createElement('div');
                card.className = "comp-card";
                card.innerHTML = `
                    <div class="comp-header">
                        <h3 style="margin:0;">${c.title}</h3>
                        <div id="end-timer-${d.id}" class="comp-end-timer">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
                    </div>
                    <div id="qs-${d.id}"></div>
                `;
                feed.appendChild(card);
                
                // ØªØ´ØºÙŠÙ„ Ø¹Ø¯Ø§Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
                startCountdown(c.endDate, `end-timer-${d.id}`, "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
                loadQuestions(d.id, c.title);
            });
        });
    }

    async function loadQuestions(cid, ctitle) {
        const qSnap = await getDocs(query(collection(db, `Competitions/${cid}/Questions`), where("active", "==", true)));
        const cont = document.getElementById(`qs-${cid}`);
        const now = new Date();
        let upcoming = [];

        for (const qDoc of qSnap.docs) {
            const q = qDoc.data();
            const showAt = new Date(q.showAt);

            if (showAt > now) {
                upcoming.push({ time: showAt });
                continue;
            }

            const ansSnap = await getDocs(query(collection(db, "Answers"), where("userId", "==", auth.currentUser.uid), where("questionId", "==", qDoc.id)));
            const isAns = !ansSnap.empty;

            const qBox = document.createElement('div');
            qBox.className = "q-box";
            let optsHtml = "";
            q.options.forEach(opt => {
                let cls = isAns ? (opt === q.correctOption ? "correct" : (opt === ansSnap.docs[0].data().selectedOption ? "wrong" : "")) : "";
                optsHtml += `<button class="option-btn ${cls}" ${isAns?'disabled':''} onclick="sendAns('${cid}','${ctitle}','${qDoc.id}','${q.text}','${opt}','${q.correctOption}', ${q.points}, this)">${opt}</button>`;
            });
            qBox.innerHTML = `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><b>${q.text}</b> <span style="color:var(--primary); font-size:12px;">ğŸ’ ${q.points} Ù†</span></div>${optsHtml}`;
            cont.appendChild(qBox);
        }

        // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… (Ø£ÙŠØ§Ù…ØŒ Ø³Ø§Ø¹Ø§ØªØŒ Ø¯Ù‚Ø§Ø¦Ù‚ØŒ Ø«ÙˆØ§Ù†ÙŠ)
        if (upcoming.length > 0) {
            upcoming.sort((a,b) => a.time - b.time);
            const nextT = upcoming[0].time;
            const timerDiv = document.createElement('div');
            timerDiv.className = "next-q-timer";
            cont.appendChild(timerDiv);
            
            setInterval(() => {
                const diff = nextT - new Date();
                if(diff <= 0) location.reload();
                
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);

                timerDiv.innerHTML = `
                    <span style="font-size:13px;">ğŸ”’ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙŠÙØªØ­ Ø®Ù„Ø§Ù„:</span>
                    <div class="timer-grid">
                        <div class="timer-unit"><b>${d}</b><span class="timer-label">ÙŠÙˆÙ…</span></div>
                        <div class="timer-unit"><b>${h}</b><span class="timer-label">Ø³Ø§Ø¹Ø©</span></div>
                        <div class="timer-unit"><b>${m}</b><span class="timer-label">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
                        <div class="timer-unit"><b>${s}</b><span class="timer-label">Ø«Ø§Ù†ÙŠØ©</span></div>
                    </div>
                `;
            }, 1000);
        }
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¹Ø§Ù…Ø©
    function startCountdown(dateStr, elementId, finishMsg) {
        const target = new Date(dateStr).getTime();
        const el = document.getElementById(elementId);
        
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const diff = target - now;
            
            if (diff < 0) {
                clearInterval(timer);
                el.innerHTML = finishMsg;
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            
            el.innerHTML = `â³ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${days}ÙŠ Ùˆ ${hours}Ø³ Ùˆ ${mins}Ø¯`;
        }, 1000);
    }

    window.sendAns = async (cid, ct, qid, qt, sel, corr, pts, btn) => {
        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;
        const isC = sel.trim() === corr.trim();
        await addDoc(collection(db, "Answers"), {
            userId: auth.currentUser.uid,
            userName: userData.fullName || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
            userPhone: userData.phone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
            userEmail: auth.currentUser.email || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
            compId: cid, compTitle: ct, questionId: qid, questionText: qt,
            selectedOption: sel, isCorrect: isC, pointsAwarded: isC ? pts : 0,
            timestamp: serverTimestamp()
        });
        location.reload();
    };

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù„Ø§Ø²Ù…Ø©
import { getDocs, query, collection, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
async function populateCompList() {
    const q = query(collection(db, "Competitions"));
    const snap = await getDocs(q);
    const select = document.getElementById('drawCompSelect');
    select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</option>';
    snap.forEach(doc => {
        select.innerHTML += `<option value="${doc.id}">${doc.data().title}</option>`;
    });
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¬Ø²Ø¡ Ø§Ù„Ù€ Auth Ù„ÙŠØ´Ù…Ù„ ØªØ´ØºÙŠÙ„ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¨Ø¦Ø©
// (Ø£Ø¶Ù Ù‡Ø°Ø§ Ø¯Ø§Ø®Ù„ auth.onAuthStateChanged)
if (userData.role === 'admin' || userData.role === 'Ù…Ø¯ÙŠØ±') {
    document.getElementById('adminDrawTool').style.display = 'block';
    populateCompList();
}

window.prepareDraw = async () => {
    const compId = document.getElementById('drawCompSelect').value;
    const count = parseInt(document.getElementById('winnerCount').value);
    if (!compId) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø¨Ù‚Ø©");

    document.getElementById('drawOverlay').style.display = 'flex';
    document.getElementById('winnersList').innerHTML = "";
    document.getElementById('drawStatus').innerText = "Ø¬Ø§Ø±ÙŠ ØªØµÙÙŠØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©...";
    
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø· Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
    const q = query(collection(db, "Answers"), 
                where("compId", "==", compId), 
                where("isCorrect", "==", true));
    
    const snap = await getDocs(q);
    let candidates = [];
    snap.forEach(doc => {
        const data = doc.data();
        // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø´Ø®Øµ Ø¥Ø°Ø§ Ø£Ø¬Ø§Ø¨ Ø¹Ù„Ù‰ Ø¹Ø¯Ø© Ø£Ø³Ø¦Ù„Ø© ØµØ­ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
        if (!candidates.find(c => c.userId === data.userId)) {
            candidates.push({ name: data.userName, userId: data.userId });
        }
    });

    if (candidates.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ³Ø§Ø¨Ù‚ÙŠÙ† Ø¨Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©!");
        document.getElementById('drawOverlay').style.display = 'none';
        return;
    }

    startAnimation(candidates, count);
};

function startAnimation(list, winnerCount) {
    const slotBox = document.getElementById('slotBox');
    let winners = [];
    let tempCandidates = [...list];

    // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    for (let i = 0; i < winnerCount; i++) {
        if (tempCandidates.length === 0) break;
        const randomIndex = Math.floor(Math.random() * tempCandidates.length);
        winners.push(tempCandidates.splice(randomIndex, 1)[0]);
    }

    // ØªØ£Ø«ÙŠØ± Ø­Ø±ÙƒØ© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ (Ù„Ø¥Ø¶ÙØ§Ø¡ Ø§Ù„Ù…ØµØ¯Ø§Ù‚ÙŠØ©)
    let counter = 0;
    const interval = setInterval(() => {
        slotBox.innerText = list[Math.floor(Math.random() * list.length)].name;
        counter++;
        if (counter > 30) { // Ø¨Ø¹Ø¯ 30 Ù„ÙØ© ØªÙˆÙ‚Ù ÙˆØ§Ø¸Ù‡Ø± Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†
            clearInterval(interval);
            showWinners(winners);
        }
    }, 100);
}

function showWinners(winners) {
    document.getElementById('drawStatus').innerText = "ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²ÙŠÙ†!";
    const slotBox = document.getElementById('slotBox');
    slotBox.innerText = "Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø³Ø­Ø¨";
    
    const listDiv = document.getElementById('winnersList');
    winners.forEach((w, index) => {
        setTimeout(() => {
            const div = document.createElement('div');
            div.className = 'winner-item';
            div.innerHTML = `ğŸ† Ø§Ù„ÙØ§Ø¦Ø² ${index + 1}: ${w.name}`;
            listDiv.appendChild(div);
        }, index * 800); // Ø¸Ù‡ÙˆØ± ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„ÙØ§Ø¦Ø²ÙŠÙ†
    });

    document.getElementById('closeDrawBtn').style.display = 'block';
}
    
</script>
</body>
</html>
