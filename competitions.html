<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15" });
      });
    </script>

    <style>
        :root { 
            --ios-blue: #007AFF; --ios-bg: #F2F2F7; --ios-orange: #FF9500; 
            --ios-green: #34C759; --ios-red: #FF3B30; --card-bg: #FFFFFF;
        }

        body { 
            background: var(--ios-bg); font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; padding-top: 75px; padding-bottom: 90px; direction: rtl;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø§Ù„Ù…Ø·ÙˆØ± */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; border-bottom: .5px solid #C6C6C8; z-index: 5000;
        }
        .nav-btn-top { text-decoration: none; font-size: 20px; padding: 5px 10px; }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        .comp-card, .history-card { 
            background: var(--card-bg); border-radius: 22px; padding: 20px; 
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 0.5px solid #E5E5EA;
        }

        .section-title { font-size: 18px; font-weight: 800; margin: 10px 5px 15px; color: #1c1c1e; display: flex; align-items: center; gap: 8px; }
        
        /* Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª */
        .history-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 0; border-bottom: 0.5px solid #F2F2F7; 
        }
        .history-item:last-child { border-bottom: none; }
        .history-info b { display: block; font-size: 14px; }
        .history-info span { font-size: 11px; color: #8e8e93; }
        .status-badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: bold; color: white; }

        .q-box { background: #F8F8FB; border-radius: 18px; padding: 18px; margin-bottom: 15px; border: 0.5px solid #EEE; }
        .q-box.answered { opacity: 0.7; pointer-events: none; }

        .option-btn { 
            width: 100%; padding: 15px; margin-top: 10px; border-radius: 14px; 
            border: 1px solid #E5E5EA; background: white; cursor: pointer; 
            text-align: right; font-size: 15px; font-weight: 500;
        }
        
        .option-btn.correct { background: var(--ios-green) !important; color: white; border-color: var(--ios-green); }
        .option-btn.wrong { background: var(--ios-red) !important; color: white; border-color: var(--ios-red); }

        .draw-nav-btn {
            background: linear-gradient(135deg, var(--ios-orange), #FFCC00);
            color: white; text-decoration: none; display: flex; align-items: center;
            justify-content: center; padding: 15px; border-radius: 18px;
            font-weight: bold; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(255,149,0,0.3);
        }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center; border-top: 0.5px solid #C6C6C8; z-index: 5000;
        }
        .nav-item { font-size: 26px; color: #8E8E93; text-decoration: none; }
        .nav-item.active { color: var(--ios-blue); }
    </style>
</head>
<body>

<div class="top-bar">
    <a href="index.html" class="nav-btn-top">ğŸ </a>
    <b>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</b>
    <div style="display: flex; gap: 10px;">
        <div id="adminTools" style="display:none; cursor:pointer; font-size:22px;" onclick="location.href='add_competition.html'">âŠ•</div>
        <div onclick="history.back()" style="cursor:pointer; font-size:20px;">ğŸ”™</div>
    </div>
</div>

<div class="container">
    <a href="draw.html" class="draw-nav-btn">
        ğŸ° Ø¯Ø®ÙˆÙ„ Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ù…ØªØ·ÙˆØ±
    </a>

    <div class="section-title">ğŸ† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</div>
    <div id="compsFeed">
        <p style="text-align:center; color:gray;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª...</p>
    </div>

    <div class="section-title">ğŸ•’ Ø³Ø¬Ù„ Ù…Ø´Ø§Ø±ÙƒØ§ØªÙŠ Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
    <div class="history-card" id="userHistory">
        <p style="text-align:center; color:gray; font-size:13px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„ Ù…Ø´Ø§Ø±ÙƒØ§ØªÙƒ...</p>
    </div>
</div>

<nav class="bottom-bar">
    <a href="news.html" class="nav-item">ğŸ </a>
    <a href="chat.html" class="nav-item">ğŸ’¬</a>
    <a href="competitions.html" class="nav-item active">ğŸ†</a>
    <a href="profile.html" class="nav-item">ğŸ‘¤</a>
</nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userData = null;
    let myAnswersIds = [];

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            userData = snap.data();
            if (userData?.role === 'admin' || userData?.role === 'Ù…Ø¯ÙŠØ±') {
                document.getElementById('adminTools').style.display = 'block';
            }
            
            loadUserHistory(user.uid);
            loadComps();
        } else location.href = "login.html";
    });

    // Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª
    async function loadUserHistory(uid) {
        const hQuery = query(
            collection(db, "Answers"), 
            where("userId", "==", uid),
            orderBy("timestamp", "desc"),
            limit(5)
        );
        
        onSnapshot(hQuery, snap => {
            const hDiv = document.getElementById('userHistory');
            hDiv.innerHTML = "";
            myAnswersIds = [];

            if(snap.empty) {
                hDiv.innerHTML = '<p style="text-align:center; color:gray; font-size:12px;">Ù„Ù… ØªØ´Ø§Ø±Ùƒ ÙÙŠ Ø£ÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø¨Ø¹Ø¯</p>';
                return;
            }

            snap.forEach(d => {
                const data = d.data();
                myAnswersIds.push(data.questionId);
                const statusColor = data.isCorrect ? 'var(--ios-green)' : 'var(--ios-red)';
                const statusText = data.isCorrect ? 'Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©';

                hDiv.innerHTML += `
                    <div class="history-item">
                        <div class="history-info">
                            <b>${data.questionText || 'Ø³Ø¤Ø§Ù„ Ù…Ø³Ø§Ø¨Ù‚Ø©'}</b>
                            <span>${data.compTitle || ''}</span>
                        </div>
                        <div class="status-badge" style="background:${statusColor}">${statusText}</div>
                    </div>
                `;
            });
        });
    }

    function loadComps() {
        onSnapshot(collection(db, "Competitions"), snap => {
            const feed = document.getElementById('compsFeed');
            feed.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                const card = document.createElement('div');
                card.className = "comp-card";
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; font-size:17px;">${c.title}</h3>
                        <span id="timer-${d.id}" style="font-size:11px; color:var(--ios-orange); font-weight:bold;">...</span>
                    </div>
                    <div id="qs-${d.id}"></div>
                `;
                feed.appendChild(card);
                loadQuestions(d.id, c.title);
            });
        });
    }

    async function loadQuestions(cid, ctitle) {
        const qSnap = await getDocs(collection(db, `Competitions/${cid}/Questions`));
        const cont = document.getElementById(`qs-${cid}`);
        const now = new Date();

        qSnap.forEach(qDoc => {
            const q = qDoc.data();
            if (new Date(q.showAt) > now) return; 

            const isAns = myAnswersIds.includes(qDoc.id);
            const qBox = document.createElement('div');
            qBox.className = `q-box ${isAns ? 'answered' : ''}`;
            
            let optsHtml = "";
            q.options.forEach(opt => {
                let cls = (isAns && opt === q.correctOption) ? "correct" : "";
                optsHtml += `<button class="option-btn ${cls}" ${isAns?'disabled':''} onclick="sendAns('${cid}','${ctitle}','${qDoc.id}','${q.text}','${opt}','${q.correctOption}', ${q.points}, this)">${opt}</button>`;
            });

            qBox.innerHTML = `<b>${q.text}</b> ${optsHtml} ${isAns ? '<div style="color:var(--ios-green); font-size:11px; margin-top:10px; text-align:center;">âœ“ ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</div>' : ''}`;
            cont.appendChild(qBox);
        });
    }

    window.sendAns = async (cid, ct, qid, qt, sel, corr, pts, btn) => {
        if(!confirm("Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;
        const isC = sel.trim() === corr.trim();
        await addDoc(collection(db, "Answers"), {
            userId: auth.currentUser.uid,
            userName: userData.fullName || "Ø¹Ø¶Ùˆ",
            compId: cid, compTitle: ct, questionId: qid, questionText: qt,
            selectedOption: sel, isCorrect: isC, pointsAwarded: isC ? pts : 0,
            timestamp: serverTimestamp()
        });
        alert(isC ? "Ø£Ø­Ø³Ù†Øª! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©" : "Ù„Ù„Ø£Ø³ÙØŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©");
    };
</script>
</body>
</html>
