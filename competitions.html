<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15",
        });
      });
    </script>

    <style>
        :root { 
            --ios-blue: #007AFF; 
            --ios-bg: #F2F2F7; 
            --ios-orange: #FF9500; 
            --ios-green: #34C759;
            --ios-red: #FF3B30;
            --card-bg: #FFFFFF;
        }

        body { 
            background: var(--ios-bg); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; padding-top: 70px; padding-bottom: 90px;
        }

        .top-bar {
            position: fixed; top: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box;
            border-bottom: .5px solid #C6C6C8; z-index: 5000;
        }
        .top-bar b { font-size: 20px; font-weight: 800; }

        .container { padding: 15px; max-width: 600px; margin: auto; }

        .comp-card { 
            background: var(--card-bg); border-radius: 22px; 
            padding: 20px; margin-bottom: 25px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            border: 0.5px solid #E5E5EA;
        }
        
        .comp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .comp-header h3 { margin: 0; font-size: 19px; color: #1c1c1e; }
        
        .comp-end-timer { 
            font-size: 11px; background: #FFF9F2; color: var(--ios-orange); 
            padding: 6px 12px; border-radius: 10px; font-weight: bold; 
            border: 0.5px solid #FFE0B2; 
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø¬Ø§Ø¨ Ø¹Ù„ÙŠÙ‡ */
        .q-box.answered { opacity: 0.6; filter: grayscale(0.3); }
        .answered-label { 
            font-size: 11px; color: var(--ios-green); font-weight: bold; 
            display: block; margin-top: 10px; text-align: center;
        }

        .q-box { background: #F8F8FB; border-radius: 18px; padding: 18px; margin-bottom: 15px; border: 0.5px solid #EEE; position: relative; }
        
        .option-btn { 
            width: 100%; padding: 15px; margin-top: 10px; 
            border-radius: 14px; border: 1px solid #E5E5EA; 
            background: white; cursor: pointer; text-align: right; 
            font-size: 15px; font-weight: 500; transition: 0.3s; 
        }
        
        .option-btn.correct { background: var(--ios-green) !important; color: white; border-color: var(--ios-green); }
        .option-btn.wrong { background: var(--ios-red) !important; color: white; border-color: var(--ios-red); }

        .next-q-timer { 
            background: #F0F4FF; color: var(--ios-blue); 
            padding: 20px; border-radius: 18px; text-align: center; 
            border: 1px dashed var(--ios-blue); margin: 20px 0; 
        }
        .timer-grid { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .timer-unit { background: white; padding: 8px; border-radius: 10px; min-width: 45px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .timer-unit b { font-size: 16px; display: block; }
        .timer-label { font-size: 9px; color: #8e8e93; font-weight: bold; }

        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 0.5px solid #C6C6C8; z-index: 5000;
        }
        .nav-item { font-size: 26px; color: #8E8E93; text-decoration: none; }
        .nav-item.active { color: var(--ios-blue); }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="width:24px;" onclick="history.back()">ğŸ”™</div>
    <b>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</b>
    <div id="adminTools" style="display:none;" onclick="location.href='add_competition.html'">âŠ•</div>
</div>

<div class="container" id="compsFeed">
    <p style="text-align:center; color:gray; margin-top:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª...</p>
</div>

<nav class="bottom-bar">
    <a href="news.html" class="nav-item">ğŸ </a>
    <a href="chat.html" class="nav-item">ğŸ’¬</a>
    <a href="competitions.html" class="nav-item active">ğŸ†</a>
    <a href="profile.html" class="nav-item">ğŸ‘¤</a>
</nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userData = null;

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            userData = snap.data();
            
            if (userData.role === 'admin' || userData.role === 'Ù…Ø¯ÙŠØ±') {
                document.getElementById('adminTools').style.display = 'block';
            }
            loadComps();
        } else location.href = "login.html";
    });

    function loadComps() {
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙ‚Ø·
        onSnapshot(collection(db, "Competitions"), snap => {
            const feed = document.getElementById('compsFeed');
            feed.innerHTML = "";
            snap.forEach(d => {
                const c = d.data();
                // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· visible Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
                const card = document.createElement('div');
                card.className = "comp-card";
                card.innerHTML = `
                    <div class="comp-header">
                        <h3>${c.title}</h3>
                        <div id="end-timer-${d.id}" class="comp-end-timer">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
                    </div>
                    <div id="qs-${d.id}"></div>
                `;
                feed.appendChild(card);
                startCountdown(c.endDate, `end-timer-${d.id}`, "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
                loadQuestions(d.id, c.title);
            });
        });
    }

    async function loadQuestions(cid, ctitle) {
        const qSnap = await getDocs(collection(db, `Competitions/${cid}/Questions`));
        const cont = document.getElementById(`qs-${cid}`);
        const now = new Date();
        let upcoming = [];

        for (const qDoc of qSnap.docs) {
            const q = qDoc.data();
            const showAt = new Date(q.showAt);

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠØ­Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„
            if (showAt > now) {
                upcoming.push({ time: showAt });
                continue;
            }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹
            const ansSnap = await getDocs(query(collection(db, "Answers"), 
                where("userId", "==", auth.currentUser.uid), 
                where("questionId", "==", qDoc.id)));
            
            const isAns = !ansSnap.empty;

            const qBox = document.createElement('div');
            qBox.className = `q-box ${isAns ? 'answered' : ''}`;
            
            let optsHtml = "";
            q.options.forEach(opt => {
                let cls = "";
                if (isAns) {
                    const userAns = ansSnap.docs[0].data().selectedOption;
                    if (opt === q.correctOption) cls = "correct"; // Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø®Ø¶Ø±Ø§Ø¡ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù„
                    else if (opt === userAns) cls = "wrong"; // Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø®Ø·Ø£ ØªØ¸Ù‡Ø± Ø­Ù…Ø±Ø§Ø¡
                }
                optsHtml += `
                    <button class="option-btn ${cls}" ${isAns ? 'disabled' : ''} 
                        onclick="sendAns('${cid}','${ctitle}','${qDoc.id}','${q.text}','${opt}','${q.correctOption}', ${q.points}, this)">
                        ${opt}
                    </button>`;
            });

            qBox.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <b>${q.text}</b> 
                    <span style="color:var(--ios-blue); font-size:12px; font-weight:bold;">ğŸ’ ${q.points} Ù†</span>
                </div>
                ${optsHtml}
                ${isAns ? '<span class="answered-label">âœ“ ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¨Ù†Ø¬Ø§Ø­</span>' : ''}
            `;
            cont.appendChild(qBox);
        }

        // Ø¹Ø±Ø¶ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if (upcoming.length > 0) {
            upcoming.sort((a,b) => a.time - b.time);
            const nextT = upcoming[0].time;
            const timerDiv = document.createElement('div');
            timerDiv.className = "next-q-timer";
            cont.appendChild(timerDiv);
            
            const timerInt = setInterval(() => {
                const diff = nextT - new Date();
                if(diff <= 0) { clearInterval(timerInt); location.reload(); }
                const d = Math.floor(diff / (86400000));
                const h = Math.floor((diff % 86400000) / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);

                timerDiv.innerHTML = `
                    <span style="font-size:13px; font-weight:600;">ğŸ”’ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¯Ù… ÙŠÙØªØ­ Ø®Ù„Ø§Ù„:</span>
                    <div class="timer-grid">
                        <div class="timer-unit"><b>${d}</b><span class="timer-label">ÙŠÙˆÙ…</span></div>
                        <div class="timer-unit"><b>${h}</b><span class="timer-label">Ø³Ø§Ø¹Ø©</span></div>
                        <div class="timer-unit"><b>${m}</b><span class="timer-label">Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
                        <div class="timer-unit"><b>${s}</b><span class="timer-label">Ø«Ø§Ù†ÙŠØ©</span></div>
                    </div>
                `;
            }, 1000);
        }
    }

    function startCountdown(dateStr, elementId, finishMsg) {
        const target = new Date(dateStr).getTime();
        const el = document.getElementById(elementId);
        const timer = setInterval(() => {
            const now = new Date().getTime();
            const diff = target - now;
            if (diff < 0) { clearInterval(timer); el.innerHTML = finishMsg; return; }
            const days = Math.floor(diff / 86400000);
            const hours = Math.floor((diff % 86400000) / 3600000);
            const mins = Math.floor((diff % 3600000) / 60000);
            el.innerHTML = `â³ ÙŠÙ†ØªÙ‡ÙŠ Ø®Ù„Ø§Ù„: ${days}ÙŠ Ùˆ ${hours}Ø³ Ùˆ ${mins}Ø¯`;
        }, 1000);
    }

    window.sendAns = async (cid, ct, qid, qt, sel, corr, pts, btn) => {
        if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©ØŸ")) return;
        
        // Ù…Ù†Ø¹ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø±
        btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
        
        const isC = sel.trim() === corr.trim();
        try {
            await addDoc(collection(db, "Answers"), {
                userId: auth.currentUser.uid,
                userName: userData.fullName || userData.name || "Ø¹Ø¶Ùˆ",
                userPhone: userData.phone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„",
                compId: cid, 
                compTitle: ct, 
                questionId: qid, 
                questionText: qt,
                selectedOption: sel, 
                isCorrect: isC, 
                pointsAwarded: isC ? pts : 0,
                timestamp: serverTimestamp()
            });
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ù‡ØªØ©
            location.reload();
        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹.");
            btn.parentElement.querySelectorAll('button').forEach(b => b.disabled = false);
        }
    };
</script>
</body>
</html>
