<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™ ŸÑŸÑÿπÿßÿ¶ŸÑÿ©</title>
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; --accent: #ff9500; --ios-green: #34c759; --ios-red: #ff3b30; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding-top: 65px; }
        .top-bar { position: fixed; top: 0; width: 100%; height: 60px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); display: flex; align-items: center; padding: 0 15px; border-bottom: 0.5px solid #C6C6C8; z-index: 1000; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .comp-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .q-box { background: #f8f8fb; border-radius: 18px; padding: 18px; margin-bottom: 15px; border: 1px solid #eee; }
        .option-btn { width: 100%; padding: 14px; margin-top: 10px; border-radius: 12px; border: 1px solid #ddd; background: white; text-align: right; cursor: pointer; }
        .correct { background: var(--ios-green) !important; color: white; border-color: var(--ios-green); }
        .wrong { background: var(--ios-red) !important; color: white; border-color: var(--ios-red); }
    </style>
</head>
<body>

<div class="top-bar">
    <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">‚û°Ô∏è</button>
    <b style="margin-right:10px;">ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™ ÿßŸÑŸÜÿ¥ÿ∑ÿ©</b>
</div>

<div class="container" id="compsFeed">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿßÿ™...</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, where, addDoc, getDocs, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let uData = null;

    onAuthStateChanged(auth, async user => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            uData = snap.data();
            loadComps();
        } else location.href = "login.html";
    });

    function loadComps() {
        onSnapshot(query(collection(db, "Competitions"), where("visible", "==", true)), snap => {
            const feed = document.getElementById('compsFeed');
            feed.innerHTML = "";
            snap.forEach(async d => {
                const c = d.data();
                const card = document.createElement('div');
                card.className = "comp-card";
                card.innerHTML = `<h3>${c.title}</h3><div id="qs-${d.id}">ÿ¨ÿßÿ±Ÿä ÿ¨ŸÑÿ® ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ©...</div>`;
                feed.appendChild(card);
                loadQuestions(d.id, c.title);
            });
        });
    }

    async function loadQuestions(cid, ct) {
        const qSnap = await getDocs(query(collection(db, "Questions"), where("compId", "==", cid)));
        const cont = document.getElementById(`qs-${cid}`);
        cont.innerHTML = "";

        for (const qDoc of qSnap.docs) {
            const q = qDoc.data();
            const ansSnap = await getDocs(query(collection(db, "Answers"), where("userId", "==", auth.currentUser.uid), where("questionId", "==", qDoc.id)));
            const isAns = !ansSnap.empty;

            const qBox = document.createElement('div');
            qBox.className = "q-box";
            let optsHtml = "";
            
            q.options.forEach((opt, idx) => {
                let cls = "";
                if(isAns) {
                    const mySel = ansSnap.docs[0].data().selectedOption;
                    const correctText = q.options[q.correctAnswer];
                    if(opt === correctText) cls = "correct";
                    else if(opt === mySel) cls = "wrong";
                }
                optsHtml += `<button class="option-btn ${cls}" ${isAns?'disabled':''} onclick="submitAns('${cid}','${ct}','${qDoc.id}','${q.text}','${opt}',${q.correctAnswer},${q.points})">${opt}</button>`;
            });

            qBox.innerHTML = `<b>${q.text}</b> <span style="color:var(--primary); float:left;">üíé ${q.points}ŸÜ</span>${optsHtml}`;
            cont.appendChild(qBox);
        }
    }

    window.submitAns = async (cid, ct, qid, qt, sel, corrIdx, pts) => {
        if(!confirm("ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©ÿü")) return;
        const qDoc = await getDoc(doc(db, "Questions", qid));
        const isC = sel === qDoc.data().options[corrIdx];
        await addDoc(collection(db, "Answers"), {
            userId: auth.currentUser.uid, userName: uData.fullName || "ÿπÿ∂Ÿà",
            compId: cid, compTitle: ct, questionId: qid, questionText: qt,
            selectedOption: sel, isCorrect: isC, pointsAwarded: isC ? pts : 0,
            timestamp: serverTimestamp()
        });
        location.reload();
    };
</script>
</body>
</html>
