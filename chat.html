<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿ™ŸÑÿ∫ÿ±ÿßŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ©</title>
    <style>
        :root { --tg-blue: #2481cc; --tg-bg: #f4f4f4; --tg-card: #ffffff; }
        body { background: var(--tg-bg); font-family: -apple-system, system-ui, sans-serif; margin: 0; padding: 20px 10px; }
        .container { max-width: 600px; margin: 0 auto; }
        
        .search-container { position: sticky; top: 0; z-index: 100; margin-bottom: 20px; }
        .search-bar { width: 100%; padding: 12px 20px; border-radius: 25px; border: none; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); outline: none; box-sizing: border-box; }

        .chat-list { display: flex; flex-direction: column; gap: 10px; }
        .chat-item { 
            background: var(--tg-card); 
            padding: 15px; 
            border-radius: 18px; 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            cursor: pointer;
            transition: 0.2s;
            margin: 0 5px; /* ÿßÿ®ÿπÿßÿØ ÿπŸÜ ÿßŸÑÿ≠ŸàÿßŸÅ */
        }
        .chat-item:active { transform: scale(0.97); background: #f0f0f0; }
        
        .avatar { width: 55px; height: 55px; border-radius: 50%; background: var(--tg-blue); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; flex-shrink: 0; }
        .info { flex: 1; overflow: hidden; }
        .name { font-weight: bold; color: #222; margin-bottom: 4px; display: block; }
        .preview { font-size: 13px; color: #777; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #results { position: absolute; width: 100%; background: white; border-radius: 15px; margin-top: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: none; z-index: 101; }
    </style>
</head>
<body>
    <div class="container">
        <div class="search-container">
            <input type="text" id="search" class="search-bar" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ£ŸÅÿ±ÿßÿØ ÿßŸÑÿπÿßÿ¶ŸÑÿ©...">
            <div id="results"></div>
        </div>

        <div class="chat-list" id="mainList">
            <div class="chat-item" id="publicBtn" style="border: 1px solid #e0eaf3;">
                <div class="avatar" style="background: linear-gradient(135deg, #64b5f6, #2196f3);">üè†</div>
                <div class="info">
                    <span class="name">ÿßŸÑŸÖÿ¨ŸÑÿ≥ ÿßŸÑÿπÿßŸÖ</span>
                    <span class="preview" id="pubStatus">ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿ≤ÿßŸÖŸÜÿ©...</span>
                </div>
            </div>
            
            <div id="privateChats"></div>
        </div>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, query, where, onSnapshot, getDoc, doc, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let me = null;
    let config = {};

    auth.onAuthStateChanged(async (user) => {
        if (!user) location.href = 'login.html';
        const snap = await getDoc(doc(db, "Users", user.uid));
        me = snap.data();
        listenConfig();
        loadRecent();
    });

    function listenConfig() {
        onSnapshot(doc(db, "Settings", "AppConfig"), (snap) => {
            config = snap.data() || { publicChatEnabled: true };
            const status = document.getElementById('pubStatus');
            const isAdmin = me.role === 'admin';
            
            if (!config.publicChatEnabled && !isAdmin) {
                status.innerText = "üîí ŸÖÿ∫ŸÑŸÇ ŸÖÿ§ŸÇÿ™ÿßŸã";
                document.getElementById('publicBtn').onclick = () => alert("ÿßŸÑŸÖÿ¨ŸÑÿ≥ ŸÖÿ∫ŸÑŸÇ");
            } else {
                status.innerText = "ÿ¥ÿßÿ±ŸÉ ŸÅŸä ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿßÿ¶ŸÑÿ©";
                document.getElementById('publicBtn').onclick = () => location.href = 'public_chat.html';
            }
        });
    }

    function loadRecent() {
        const q = query(collection(db, "PrivateMessages"), orderBy("timestamp", "desc"), limit(50));
        onSnapshot(q, async (snap) => {
            const list = document.getElementById('privateChats');
            list.innerHTML = "";
            const seen = new Set();
            
            for (const d of snap.docs) {
                const m = d.data();
                const other = m.senderId === auth.currentUser.uid ? m.receiverId : (m.receiverId === auth.currentUser.uid ? m.senderId : null);
                if (other && !seen.has(other)) {
                    seen.add(other);
                    const uSnap = await getDoc(doc(db, "Users", other));
                    const u = uSnap.data();
                    list.innerHTML += `
                        <div class="chat-item" onclick="location.href='private_chat.html?id=${other}'">
                            <div class="avatar">${u.fullName[0]}</div>
                            <div class="info">
                                <span class="name">${u.fullName}</span>
                                <span class="preview">${m.text}</span>
                            </div>
                        </div>`;
                }
            }
        });
    }

    // ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿ≥ÿ±Ÿäÿπ
    document.getElementById('search').oninput = async (e) => {
        const val = e.target.value.trim();
        const res = document.getElementById('results');
        if (val.length < 2) { res.style.display = 'none'; return; }
        
        const snap = await getDocs(collection(db, "Users"));
        res.innerHTML = "";
        res.style.display = 'block';
        snap.forEach(d => {
            const u = d.data();
            if (u.fullName.includes(val) && d.id !== auth.currentUser.uid) {
                const item = document.createElement('div');
                item.className = "chat-item";
                item.innerHTML = `<span class="name">${u.fullName}</span>`;
                item.onclick = () => location.href = `private_chat.html?id=${d.id}`;
                res.appendChild(item);
            }
        });
    };
</script>
</body>
</html>
