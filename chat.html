<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { background: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding-top: 80px; padding-bottom: 100px; }
        .section-title { font-size: 13px; color: #8E8E93; margin: 20px 15px 10px; font-weight: 600; text-transform: uppercase; }
        .chat-card { background: white; border-radius: 15px; padding: 12px 15px; display: flex; align-items: center; gap: 12px; margin: 0 15px 8px; cursor: pointer; border: 0.5px solid #E5E5EA; position: relative; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; position: relative; flex-shrink: 0; }
        .online-dot { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #34C759; border: 2px solid white; border-radius: 50%; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; }
        .chat-name { font-weight: bold; font-size: 16px; color: #1c1c1e; }
        .chat-time { font-size: 11px; color: #8E8E93; }
        .chat-sub { display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .chat-last-msg { font-size: 13px; color: #8E8E93; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .unread-badge { background: #FF3B30; color: white; font-size: 10px; padding: 2px 7px; border-radius: 10px; font-weight: bold; }
        .search-box { margin: 0 15px 15px; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 10px; border: none; background: #E5E5EA; outline: none; box-sizing: border-box; }
    </style>
</head>
<body>
    <script type="module" src="header.js"></script>
    <script type="module" src="navbar.js"></script>

    <div class="search-box">
        <input type="text" id="userSearch" class="search-input" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ Ù„Ù…Ø±Ø§Ø³Ù„ØªÙ‡...">
        <div id="searchResults"></div>
    </div>

    <div class="section-title">Ø§Ù„ØºØ±Ù ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
    <div class="chat-card" onclick="location.href='public_chat.html'">
        <div class="avatar" style="background: linear-gradient(45deg, #007AFF, #5856D6);">ğŸ </div>
        <div class="chat-info"><span class="chat-name">Ø§Ù„Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¹Ø§Ø¦Ù„Ø©</span><br><small>Ø¯Ø±Ø¯Ø´Ø© Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹</small></div>
    </div>
    <div id="tempGroupsList"></div>

    <div class="section-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</div>
    <div id="recentPrivateList"></div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, query, where, getDocs, doc, onSnapshot, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(user => { if(user) { loadData(user.uid); } else location.href='login.html'; });

    function loadData(uid) {
        // 1. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        onSnapshot(query(collection(db, "TemporaryGroups"), where("members", "array-contains", uid)), snap => {
            const list = document.getElementById('tempGroupsList'); list.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                list.innerHTML += `<div class="chat-card" onclick="location.href='group_chat.html?id=${d.id}'">
                    <div class="avatar" style="background: #FF9500;">â³</div>
                    <div class="chat-info"><span class="chat-name">${g.groupName}</span><br><small>Ù…Ø¬Ù…ÙˆØ¹Ø© Ø®Ø§ØµØ© Ù…Ø¤Ù‚ØªØ©</small></div>
                </div>`;
            });
        });

        // 2. Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© + Ø§Ù„Ø¹Ø¯Ø§Ø¯ + Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
        onSnapshot(query(collection(db, "PrivateMessages")), async snap => {
            const lastMsgs = new Map(); const unread = new Map();
            snap.forEach(d => {
                const m = d.data(); const otherId = m.senderId === uid ? m.receiverId : m.receiverId === uid ? m.senderId : null;
                if(otherId) {
                    const existing = lastMsgs.get(otherId);
                    if(!existing || (m.timestamp?.toMillis() || 0) > (existing.timestamp?.toMillis() || 0)) lastMsgs.set(otherId, m);
                    if(m.receiverId === uid && !m.isRead) unread.set(otherId, (unread.get(otherId) || 0) + 1);
                }
            });

            const sorted = Array.from(lastMsgs.entries()).sort((a,b) => (b[1].timestamp?.toMillis() || 0) - (a[1].timestamp?.toMillis() || 0));
            const recentDiv = document.getElementById('recentPrivateList'); recentDiv.innerHTML = "";
            
            for(let [otherId, m] of sorted) {
                const uDoc = await getDoc(doc(db, "Users", otherId));
                if(uDoc.exists()) {
                    const u = uDoc.data(); const count = unread.get(otherId) || 0;
                    const isOnline = u.lastSeen && (new Date().getTime() - u.lastSeen.toMillis()) < 300000;
                    recentDiv.innerHTML += `
                    <div class="chat-card" onclick="location.href='private_chat.html?id=${otherId}'">
                        <div class="avatar" style="background:#007AFF">${u.fullName.charAt(0)} ${isOnline ? '<div class="online-dot"></div>' : ''}</div>
                        <div class="chat-info">
                            <div class="chat-header"><span class="chat-name">${u.fullName}</span><span class="chat-time">${m.timestamp?.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) || ''}</span></div>
                            <div class="chat-sub">
                                <span class="chat-last-msg" style="${count > 0 ? 'color:#000; font-weight:bold;' : ''}">${m.image ? 'ğŸ“· ØµÙˆØ±Ø©' : m.text}</span>
                                ${count > 0 ? `<span class="unread-badge">${count}</span>` : ''}
                            </div>
                        </div>
                    </div>`;
                }
            }
        });
    }
</script>
</body>
</html>
