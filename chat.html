<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --bg: #e5ddd5; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .chat-header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; }
        .back-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; position: relative; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .my-msg { align-self: flex-end; background: #dcf8c6; border-bottom-left-radius: 2px; }
        .other-msg { align-self: flex-start; background: var(--white); border-bottom-right-radius: 2px; }
        .msg-info { font-size: 10px; color: #888; display: block; margin-bottom: 4px; }
        .msg-time { font-size: 9px; color: #999; text-align: left; display: block; margin-top: 4px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø®Ø§Øµ ÙÙ‚Ø·) */
        .auto-delete-info { background: #fff3cd; color: #856404; font-size: 11px; text-align: center; padding: 5px; border-bottom: 1px solid #ffeeba; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-area { background: #f0f0f0; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .chat-input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 14px; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø§ØµØ© */
        .system-msg { align-self: center; background: rgba(0,0,0,0.05); color: #666; font-size: 11px; padding: 4px 12px; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="chat-header">
        <button class="back-btn" onclick="location.href='news.html'">â¡ï¸</button>
        <div style="text-align: center; flex: 1;">
            <b id="chatTitle">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</b>
            <div id="onlineStatus" style="font-size: 10px; opacity: 0.8;">Ù…ØªØµÙ„</div>
        </div>
        <div id="chatIcon" style="font-size: 20px;">ğŸŒ</div>
    </div>

    <div id="autoDeleteBar" class="auto-delete-info" style="display: none;">
        ğŸ§¹ ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®ØµÙˆØµÙŠØ©.
    </div>

    <div id="chatMessages"></div>

    <div class="input-area">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." onkeypress="handleKeyPress(event)">
        <button class="send-btn" onclick="sendMessage()">â¤</button>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, doc, getDoc, getDocs, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData, currentChatPath, chatType, chatId;

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø· (URL Parameters)
    const params = new URLSearchParams(window.location.search);
    const pathParam = params.get('path'); // Ù…Ø«Ø§Ù„: Messages Ø£Ùˆ PrivateChats/ID/messages
    const titleParam = params.get('title');
    const typeParam = params.get('type'); // public, private, group
    chatId = params.get('cid');

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            
            if (userData.status !== 'active' && userData.role !== 'admin') {
                alert("Ø­Ø³Ø§Ø¨Ùƒ ØºÙŠØ± Ù…ÙØ¹Ù„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.");
                window.location.href = "news.html";
                return;
            }

            setupChat();
        } else {
            window.location.href = "index.html";
        }
    });

    function setupChat() {
        currentChatPath = pathParam || "Messages";
        document.getElementById('chatTitle').innerText = titleParam || "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©";
        
        if (typeParam === 'private') {
            document.getElementById('autoDeleteBar').style.display = 'block';
            document.getElementById('chatIcon').innerText = "ğŸ‘¤";
            checkAutoDeleteSettings();
        } else if (typeParam === 'group') {
            document.getElementById('chatIcon').innerText = "ğŸ‘¥";
        }

        loadMessages();
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
    function loadMessages() {
        const q = query(collection(db, currentChatPath), orderBy("time", "asc"));
        onSnapshot(q, (snap) => {
            const box = document.getElementById('chatMessages');
            box.innerHTML = "";
            snap.forEach((d) => {
                const m = d.data();
                const isMe = m.uid === userUID;
                const time = m.time ? new Date(m.time.toDate()).toLocaleTimeString('ar-SA', {hour: '2-digit', minute:'2-digit'}) : '';
                
                box.innerHTML += `
                    <div class="msg ${isMe ? 'my-msg' : 'other-msg'}">
                        ${!isMe ? `<b class="msg-info">${m.sender}</b>` : ''}
                        ${m.text}
                        <span class="msg-time">${time}</span>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    window.sendMessage = async () => {
        const inp = document.getElementById('chatInput');
        const text = inp.value.trim();
        if (!text) return;

        await addDoc(collection(db, currentChatPath), {
            text: text,
            sender: userData.fullName,
            uid: userUID,
            time: serverTimestamp()
        });

        inp.value = "";
    };

    window.handleKeyPress = (e) => {
        if (e.key === 'Enter') sendMessage();
    };

    // Ù…ÙŠØ²Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„)
    async function checkAutoDeleteSettings() {
        if (!chatId) return;
        const cSnap = await getDoc(doc(db, "PrivateChats", chatId));
        if (cSnap.exists()) {
            const hours = cSnap.data().autoDeleteHours || 0;
            if (hours > 0) {
                const expiryTime = Date.now() - (hours * 60 * 60 * 1000);
                const q = query(collection(db, currentChatPath), where("time", "<", new Date(expiryTime)));
                const oldMsgs = await getDocs(q);
                oldMsgs.forEach(m => deleteDoc(m.ref));
            }
        }
    }
</script>
</body>
</html>
