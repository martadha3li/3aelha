<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; gap: 15px; sticky: top; z-index: 1000; }
        .back-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chatSelector { flex: 1; overflow-y: auto; padding: 15px; }
        .section-title { font-size: 14px; color: #7f8c8d; margin: 20px 0 10px 5px; font-weight: bold; }
        .chat-item { background: white; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .chat-icon { width: 45px; height: 45px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        /* Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø±Ù‚Ù… */
        .search-box { display: flex; gap: 8px; margin-bottom: 15px; }
        .search-box input { flex: 1; padding: 12px; border-radius: 12px; border: 1px solid #ddd; outline: none; }
        .search-box button { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 12px; cursor: pointer; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù†Ø´Ø·Ø© */
        #activeChat { display: none; flex: 1; flex-direction: column; background: #e5ddd5; }
        #messagesBox { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; font-size: 14px; }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        .other-msg { align-self: flex-start; background: white; }

        .input-area { background: #f0f0f0; padding: 10px; display: flex; gap: 8px; }
        .input-area input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #ddd; }
        .send-btn { background: var(--primary); color: white; border: none; width: 45px; height: 45px; border-radius: 50%; }
    </style>
</head>
<body>

    <div class="header">
        <button class="back-btn" id="headerBackBtn" onclick="location.href='news.html'">â¡ï¸</button>
        <b id="headerTitle">Ù…Ø±ÙƒØ² Ø§Ù„Ø¯Ø±Ø¯Ø´Ø§Øª</b>
    </div>

    <div id="chatSelector">
        <div class="chat-item" onclick="startChat('Messages', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©', 'public')">
            <div class="chat-icon">ğŸŒ</div>
            <div><b>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b><br><small>Ù…ØªØ§Ø­Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</small></div>
        </div>

        <div class="section-title">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ ğŸ‘¥</div>
        <div id="tempGroupsList"></div>

        <div class="section-title">Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ (Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©) ğŸ‘¤</div>
        <div class="search-box">
            <input type="number" id="phoneSearchInp" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„...">
            <button onclick="searchByPhone()">Ø¨Ø­Ø«</button>
        </div>

        <div class="section-title">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
        <div id="prevPrivateList"></div>
    </div>

    <div id="activeChat">
        <div id="messagesBox"></div>
        <div class="input-area">
            <input type="text" id="msgInp" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
            <button class="send-btn" onclick="sendMsg()">â¤</button>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, doc, getDoc, getDocs, where, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData, currentPath, unsub;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            if(userData.status !== 'active' && userData.role !== 'admin') {
                alert("Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„."); window.location.href="news.html";
                return;
            }
            loadGroups();
            loadPrevPrivate();
        } else { window.location.href = "index.html"; }
    });

    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Ù…Ø®ØµØµØ© Ø£Ùˆ Ù„Ù„Ø¬Ù…ÙŠØ¹)
    function loadGroups() {
        onSnapshot(collection(db, "TempGroups"), (snap) => {
            const list = document.getElementById('tempGroupsList');
            list.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                const isAllowed = g.targetType === 'all' || (g.allowedUsers && g.allowedUsers.includes(userUID));
                if(g.expiry > Date.now() && isAllowed) {
                    list.innerHTML += `
                        <div class="chat-item" onclick="startChat('TempGroups/${d.id}/messages', '${g.name}', 'group')">
                            <div class="chat-icon" style="background:#e8f5e9;">ğŸ‘¥</div>
                            <div><b>${g.name}</b><br><small>ØªÙ†ØªÙ‡ÙŠ ${new Date(g.expiry).toLocaleTimeString('ar-SA')}</small></div>
                        </div>`;
                }
            });
        });
    }

    // 2. Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¨Ø¯Ø¡ Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµØ©
    window.searchByPhone = async () => {
        const phone = document.getElementById('phoneSearchInp').value;
        if(!phone) return;
        const q = query(collection(db, "Users"), where("phone", "==", phone), limit(1));
        const snap = await getDocs(q);
        if(snap.empty) { alert("Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„!"); return; }
        
        const otherUser = snap.docs[0].data();
        const otherUID = snap.docs[0].id;
        const cid = [userUID, otherUID].sort().join("_");
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ ÙÙŠ PrivateChats Ù„ÙƒÙŠ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        await setDoc(doc(db, "PrivateChats", cid), { active: true }, { merge: true });
        startChat(`PrivateChats/${cid}/messages`, otherUser.fullName, 'private');
    };

    // 3. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    function loadPrevPrivate() {
        onSnapshot(collection(db, "PrivateChats"), (snap) => {
            const list = document.getElementById('prevPrivateList');
            list.innerHTML = "";
            snap.forEach(async d => {
                if(d.id.includes(userUID)) {
                    const otherUID = d.id.replace(userUID, "").replace("_", "");
                    const uDoc = await getDoc(doc(db, "Users", otherUID));
                    if(uDoc.exists()) {
                        list.innerHTML += `
                            <div class="chat-item" onclick="startChat('PrivateChats/${d.id}/messages', '${uDoc.data().fullName}', 'private')">
                                <div class="chat-icon" style="background:#e3f2fd;">ğŸ‘¤</div>
                                <div><b>${uDoc.data().fullName}</b></div>
                            </div>`;
                    }
                }
            });
        });
    }

    // 4. Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø©
    window.startChat = (path, title, type) => {
        currentPath = path;
        document.getElementById('chatSelector').style.display = 'none';
        document.getElementById('activeChat').style.display = 'flex';
        document.getElementById('headerTitle').innerText = title;
        document.getElementById('headerBackBtn').onclick = () => location.reload(); // Ù„Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…Ø±ÙƒØ²

        if(unsub) unsub();
        const q = query(collection(db, path), orderBy("time", "asc"));
        unsub = onSnapshot(q, (snap) => {
            const box = document.getElementById('messagesBox');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                box.innerHTML += `<div class="msg ${m.uid===userUID?'my-msg':'other-msg'}"><b>${m.sender}:</b><br>${m.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.sendMsg = async () => {
        const inp = document.getElementById('msgInp');
        if(!inp.value.trim()) return;
        await addDoc(collection(db, currentPath), {
            text: inp.value,
            sender: userData.fullName,
            uid: userUID,
            time: serverTimestamp()
        });
        inp.value = "";
    };
</script>
</body>
</html>
