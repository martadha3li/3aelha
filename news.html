<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>

<style>
:root {
    --ios-blue:#007AFF;
    --ios-red:#FF3B30;
    --ios-bg:#F2F2F7;
    --card-bg:#FFFFFF;
    --text-main:#1c1c1e;
    --text-sec:#8E8E93;
}

body{
    background-color:var(--ios-bg);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
    margin:0;
    padding-top:70px;
    padding-bottom:90px;
}

.header{
    position:fixed;top:0;width:100%;height:65px;
    background:rgba(255,255,255,0.85);
    backdrop-filter:blur(20px);
    display:flex;justify-content:space-between;align-items:center;
    padding:0 20px;
    border-bottom:.5px solid #C6C6C8;
    z-index:5000;
}

.header h1{font-size:22px;font-weight:800;margin:0;}
.header-btns{display:flex;gap:18px;align-items:center;}

#adminTools{display:none;align-items:center;gap:18px;}
.icon-btn{font-size:26px;cursor:pointer;color:var(--ios-blue);}
.logout-btn{color:var(--ios-red);font-size:24px;cursor:pointer;}

.post-card{
    background:var(--card-bg);
    margin:15px;
    border-radius:18px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);
    overflow:hidden;
    position:relative;
    border:.5px solid #E5E5EA;
}

.post-card.disabled{opacity:.55;filter:grayscale(.8);}
.post-header{padding:12px 15px;display:flex;justify-content:space-between;align-items:center;}

.author-info{display:flex;align-items:center;gap:12px;}
.avatar{
    width:38px;height:38px;background:#E5E5EA;border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    font-weight:bold;color:var(--ios-blue);
}

.post-image{width:100%;max-height:350px;object-fit:cover;}

.post-content{padding:15px;}
.post-content h2{margin:0 0 6px 0;font-size:19px;font-weight:700;}
.post-content p{margin:0;font-size:15px;color:#3a3a3c;display:none;margin-top:10px;}

.post-actions{
    display:flex;justify-content:space-around;
    padding:12px 0;border-top:.5px solid #E5E5EA;
    background:#FAFAFA;
}

.action-item{display:flex;align-items:center;gap:6px;color:var(--text-sec);font-size:14px;cursor:pointer;}
.action-item.active{color:var(--ios-red);}

.dropdown{
    position:absolute;left:15px;top:50px;
    background:#fff;border-radius:14px;
    box-shadow:0 8px 25px rgba(0,0,0,.15);
    display:none;flex-direction:column;z-index:1000;
    min-width:160px;
}
.dropdown button{
    padding:14px;border:none;background:none;text-align:right;cursor:pointer;
}
.dropdown button:last-child{color:var(--ios-red);}
</style>
</head>

<body>

<header class="header">
<h1>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
<div class="header-btns">
<div id="adminTools">
<div class="icon-btn" onclick="location.href='add_news.html'">âŠ•</div>
<div class="icon-btn" onclick="location.href='admin.html'">âš™ï¸</div>
</div>
<div class="logout-btn" onclick="handleLogout()">ğŸšª</div>
</div>
</header>

<div id="newsFeed"></div>

<nav class="bottom-bar">
<a href="news.html" class="nav-item active">ğŸ </a>
<a href="chat.html" class="nav-item">ğŸ’¬</a>
<a href="competitions.html" class="nav-item">ğŸ†</a>
<a href="profile.html" class="nav-item">ğŸ‘¤</a>
</nav>

<script type="module">

import { auth, db } from './config.js';
import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let userUID, userData;

function enableAdminUI(){
    document.getElementById('adminTools').style.display='flex';
}

auth.onAuthStateChanged(async(user)=>{
if(user){
userUID=user.uid;

const userSnap=await getDoc(doc(db,"Users",userUID));
if(userSnap.exists()){
userData=userSnap.data();

const role=(userData.role||userData.Role||userData.userRole||'')
.toString().toLowerCase().trim();

if(
role.includes('admin')||
role.includes('editor')||
role.includes('Ù…Ø¯ÙŠØ±')||
role.includes('Ù…Ø­Ø±Ø±')
){
enableAdminUI();
}
}

loadPosts();
}else{
window.location.href="login.html";
}
});

function loadPosts(){
const feed=document.getElementById('newsFeed');

onSnapshot(collection(db,"News"),(snap)=>{
feed.innerHTML="";
let posts=[];
snap.forEach(d=>posts.push({id:d.id,...d.data()}));

posts.sort((a,b)=>(b.publishDate||0)-(a.publishDate||0));

posts.forEach(post=>{

const hasLiked=post.likedBy?.includes(userUID);

const card=document.createElement('div');
card.className='post-card';

card.innerHTML=`

<div class="post-header">
<div class="author-info">
<div class="avatar">${post.authorName?.charAt(0)||'U'}</div>
<div>
<b>${post.authorName||'Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'}</b>
<span>${post.publishDate?new Date(post.publishDate).toLocaleDateString('ar-EG'):''}</span>
</div>
</div>
</div>

<img class="post-image" src="${post.img||'https://via.placeholder.com/500x300'}">

<div class="post-content" onclick="toggleText('${post.id}')">
<h2>${post.title}</h2>
<p id="text-${post.id}">${post.body||post.content||''}</p>
</div>

<div class="post-actions">
<div class="action-item ${hasLiked?'active':''}" onclick="doLike('${post.id}',${hasLiked})">
${hasLiked?'â¤ï¸':'ğŸ¤'} <span>${post.likedBy?.length||0}</span>
</div>

<div class="action-item" onclick="toggleComments('${post.id}')">
ğŸ’¬ <span>${post.comments?.length||0}</span>
</div>

<div class="action-item">
ğŸ‘ï¸ <span>${post.viewedBy?.length||0}</span>
</div>
</div>

<div id="comments-${post.id}" style="display:none;padding:10px;border-top:1px solid #eee;">
<div id="commentsList-${post.id}" style="margin-bottom:8px;"></div>
<input type="text" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..."
style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;"
onkeydown="if(event.key==='Enter'){addComment('${post.id}',this.value);this.value='';}">
</div>

`;

feed.appendChild(card);
});
});
}

window.toggleText=(id)=>{
const p=document.getElementById(`text-${id}`);
p.style.display=p.style.display==='block'?'none':'block';
};

window.toggleComments=async(id)=>{
const box=document.getElementById(`comments-${id}`);
const isOpen=box.style.display==='block';
box.style.display=isOpen?'none':'block';
if(!isOpen) loadComments(id);
};

window.loadComments=async(id)=>{
const list=document.getElementById(`commentsList-${id}`);
list.innerHTML="";

const snap=await getDoc(doc(db,"News",id));
const data=snap.data();
const comments=data.comments||[];

comments.forEach(c=>{
const div=document.createElement("div");
div.style="font-size:13px;margin-bottom:5px;background:#f2f2f7;padding:6px;border-radius:8px;";
div.innerHTML=`<b>${c.name}:</b> ${c.text}`;
list.appendChild(div);
});
};

window.addComment=async(id,text)=>{
if(!text.trim())return;

await updateDoc(doc(db,"News",id),{
comments:arrayUnion({
name:userData?.name||"Ø¹Ø¶Ùˆ",
text:text,
date:Date.now()
})
});

loadComments(id);
};

window.doLike=async(id,liked)=>{
await updateDoc(doc(db,"News",id),{
likedBy:liked?arrayRemove(userUID):arrayUnion(userUID)
});
};

window.handleLogout=()=>{
if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ"))
auth.signOut().then(()=>location.reload());
};

</script>

</body>
</html>
