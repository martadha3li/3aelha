<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¬Ù…Ø§Ù„ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© */
        body { background-color: #f0f2f5; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠ */
        .top-bar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            padding: 10px 20px;
        }

        /* ÙƒØ±Øª Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
        .news-card {
            background: #ffffff;
            margin: 15px auto;
            max-width: 500px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04);
            border: none;
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .news-img-main {
            width: 100%;
            height: auto;
            max-height: 350px;
            object-fit: cover;
            border-bottom: 1px solid #f0f0f0;
        }

        /* Ø±Ø£Ø³ Ø§Ù„Ù…Ù†Ø´ÙˆØ± */
        .author-section {
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .author-img-ring {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(45deg, #007aff, #34c759);
        }
        .author-img-ring img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid white;
        }

        /* Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª (Ø¥Ù†Ø³ØªØºØ±Ø§Ù… Ø³ØªØ§ÙŠÙ„) */
        .interaction-bar {
            padding: 12px 18px;
            display: flex;
            gap: 20px;
            font-size: 22px;
        }
        .heart-icon { transition: 0.2s; cursor: pointer; }
        .heart-icon:active { transform: scale(1.4); }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Øµ */
        .content-section { padding: 0 18px 15px 18px; }
        .post-title { font-size: 16px; font-weight: 800; color: #1c1c1e; margin-bottom: 6px; }
        .post-text { font-size: 14px; color: #3a3a3c; line-height: 1.6; }

        /* Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .status-badge {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 10px;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù…Ø­Ø±Ø± */
        .editor-dashboard {
            background: #f8f9fa;
            padding: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            border-top: 1px solid #eee;
        }
        .mini-btn {
            background: white;
            border: 1px solid #ddd;
            padding: 6px 15px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comments-section {
            background: #fafafa;
            border-top: 1px solid #f0f0f0;
            padding: 15px;
            display: none;
        }
        .comment-bubble {
            background: white;
            padding: 8px 12px;
            border-radius: 15px;
            margin-bottom: 8px;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙÙ„ÙŠØ© Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .bottom-nav {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            bottom: 20px;
            width: 90%;
            left: 5%;
            border-radius: 30px;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" style="height:38px; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
            <b style="color:var(--primary); font-size:18px; letter-spacing: -0.5px;">Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</b>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="adminBtn" style="display:none; cursor:pointer; font-size:22px;" onclick="location.href='admin.html'">âš™ï¸</span>
            <span id="logoutBtn" style="cursor:pointer; font-size:22px;" onclick="handleLogout()">ğŸšª</span>
        </div>
    </div>

    <div id="newsFeed" style="padding-top: 10px;">
        <p style="text-align:center; margin-top:100px; color:#8e8e93; font-weight:500;">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ØµØµ ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø±...</p>
    </div>

    <button id="addNewsBtn" class="floating-btn" onclick="location.href='add_news.html'" style="display:none; bottom: 100px; left: 30px; transform: scale(1.1);">+</button>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item active"><span class="nav-icon">ğŸ </span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span></a>
        <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userUID, userData;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            if (userData.role === 'admin' || userData.role === 'editor') {
                document.getElementById('addNewsBtn').style.display = 'block';
                if(userData.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
            }
            loadFeed();
        } else { window.location.replace("index.html"); }
    });

    function loadFeed() {
        const now = Date.now();
        onSnapshot(query(collection(db, "News"), orderBy("publishDate", "desc")), (snap) => {
            const feed = document.getElementById('newsFeed');
            feed.innerHTML = "";
            
            snap.forEach((d) => {
                const n = d.data();
                const isAuth = (userUID === n.authorId) || (userData.role === 'admin' || userData.role === 'editor');
                const isScheduled = n.publishDate > now;
                const isStopped = n.isStopped === true;

                if ((isScheduled || isStopped) && !isAuth) return;

                const hasLiked = n.likedBy?.includes(userUID);
                const card = document.createElement('div');
                card.className = 'news-card';
                
                card.innerHTML = `
                    <div class="author-section">
                        <div class="author-img-ring">
                            <img src="${n.authorImg || 'https://via.placeholder.com/45'}">
                        </div>
                        <div>
                            <div style="font-weight:700; font-size:14px; color:#1c1c1e;">${n.authorName}</div>
                            <div style="font-size:11px; color:#8e8e93;">${new Date(n.publishDate).toLocaleDateString('ar-EG')}</div>
                        </div>
                    </div>

                    <div class="content-section">
                        ${isScheduled ? '<span class="status-badge" style="background:#f39c12;">â³ Ù…Ù†Ø´ÙˆØ± Ù…Ø¬Ø¯ÙˆÙ„</span>' : ''}
                        ${isStopped ? '<span class="status-badge" style="background:#ff3b30;">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø­Ø±Ø±ÙŠÙ†</span>' : ''}
                        <div class="post-title">${n.title}</div>
                    </div>

                    ${n.img ? `<img src="${n.img}" class="news-img-main">` : ''}

                    <div class="interaction-bar">
                        <span class="heart-icon" onclick="toggleLike('${d.id}', ${hasLiked})">${hasLiked ? 'â¤ï¸' : 'ğŸ¤'}</span>
                        <span style="cursor:pointer;" onclick="toggleComments('${d.id}')">ğŸ’¬</span>
                    </div>

                    <div class="content-section">
                        <div style="font-weight:700; font-size:13px; margin-bottom:5px;">${n.likedBy?.length || 0} Ø¥Ø¹Ø¬Ø§Ø¨</div>
                        <div class="post-text">${n.body}</div>
                    </div>

                    <div id="tray-${d.id}" class="comments-section">
                        <div id="list-${d.id}"></div>
                        <div style="display:flex; gap:8px; margin-top:12px;">
                            <input type="text" id="inp-${d.id}" placeholder="Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚..." style="flex:1; border:1px solid #eee; padding:8px 12px; border-radius:20px; font-size:13px; outline:none;" onkeypress="handleCommKey(event, '${d.id}')">
                            <button onclick="addComment('${d.id}')" style="background:var(--primary); color:white; border:none; padding:0 15px; border-radius:20px; font-weight:600; font-size:12px;">Ù†Ø´Ø±</button>
                        </div>
                    </div>

                    ${isAuth ? `
                        <div class="editor-dashboard">
                            <button class="mini-btn" onclick="location.href='add_news.html?edit=${d.id}'">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="mini-btn" style="color:#ff3b30" onclick="deletePost('${d.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    ` : ''}
                `;
                feed.appendChild(card);
                updateCommentCount(d.id);
            });
        });
    }

    // (Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© - Like, Comment, Logout - ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª)
    window.toggleLike = async (id, hasLiked) => {
        await updateDoc(doc(db, "News", id), { likedBy: hasLiked ? arrayRemove(userUID) : arrayUnion(userUID) });
    };

    window.toggleComments = (id) => {
        const tray = document.getElementById(`tray-${id}`);
        tray.style.display = (tray.style.display === 'block') ? 'none' : 'block';
        if (tray.style.display === 'block') loadComments(id);
    };

    window.loadComments = (id) => {
        const list = document.getElementById(`list-${id}`);
        onSnapshot(query(collection(db, `News/${id}/Comments`), orderBy("timestamp", "asc")), (snap) => {
            list.innerHTML = "";
            snap.forEach(c => {
                const data = c.data();
                list.innerHTML += `<div class="comment-bubble"><b>${data.userName}</b> ${data.text}</div>`;
            });
        });
    };

    window.addComment = async (id) => {
        const inp = document.getElementById(`inp-${id}`);
        if (!inp.value.trim()) return;
        await addDoc(collection(db, `News/${id}/Comments`), {
            text: inp.value, userName: userData.fullName, timestamp: serverTimestamp()
        });
        inp.value = "";
    };

    window.handleCommKey = (e, id) => { if (e.key === 'Enter') window.addComment(id); };
    window.deletePost = async (id) => { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) await deleteDoc(doc(db, "News", id)); };
    window.handleLogout = async () => { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) { await signOut(auth); window.location.replace("index.html"); } };
    function updateCommentCount(id) {} // Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ
</script>
</body>
</html>
