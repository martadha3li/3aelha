<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #28a745; --temp: #6f42c1; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; background: #f0f2f5; height: 100vh; }
        .layout { display: flex; flex: 1; overflow: hidden; }
        
        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        nav { width: 220px; background: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .nav-section { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .item-link { padding: 10px; cursor: pointer; border-radius: 5px; font-size: 14px; transition: 0.2s; }
        .item-link:hover { background: rgba(255,255,255,0.1); }
        .active-group { background: var(--temp) !important; font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        main { flex: 1; padding: 20px; overflow-y: auto; }
        #chatWrapper { width: 350px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; background: white; max-width: 80%; font-size: 13px; }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        
        #chatInputArea { padding: 10px; border-top: 1px solid #ddd; display: flex; }
        #chatInput { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 8px 12px; }
    </style>
</head>
<body>

    <div class="layout">
        <nav>
            <div class="nav-section">
                <h3>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                <div class="item-link" onclick="window.switchChat('public', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')">ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            </div>

            <div class="nav-section">
                <h3 style="color: #a29bfe;">Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø¤Ù‚ØªØ© ğŸ•’</h3>
                <div id="tempGroupsList"></div>
            </div>

            <div class="nav-section">
                <h3>Ø®Ø§Øµ ğŸ‘¤</h3>
                <div id="privateUsers"></div>
            </div>

            <div style="margin-top: auto;">
                <a href="profile.html" style="color: #ffc107; text-decoration: none;">ğŸ‘¤ Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</a>
            </div>
        </nav>

        <main>
            <h2 id="pageTitle">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
            <div id="newsList"></div>
        </main>

        <div id="chatWrapper">
            <div id="chatHeader" style="background:#333; color:white; padding:15px; text-align:center;">
                <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
            </div>
            <div id="chatMessages"></div>
            <div id="chatInputArea">
                <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
                <button id="sendBtn" style="border:none; background:none; cursor:pointer; font-size:20px;">â¤</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentChatPath = "Messages";
        let unsubscribe = null;

        // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù†Ø´Ø·Ø©
        onSnapshot(collection(db, "TempGroups"), (snap) => {
            const list = document.getElementById('tempGroupsList');
            list.innerHTML = "";
            const now = new Date().getTime();
            snap.forEach(d => {
                const group = d.data();
                if (group.expiry > now) {
                    const div = document.createElement('div');
                    div.className = 'item-link';
                    div.innerText = "# " + group.name;
                    div.onclick = () => window.switchChat(`TempGroups/${d.id}/messages`, group.name);
                    list.appendChild(div);
                }
            });
        });

        // 2. ØªØ¨Ø¯ÙŠÙ„ ØºØ±Ù Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        window.switchChat = (path, title) => {
            currentChatPath = path;
            document.getElementById('chatTitle').innerText = title;
            loadMessages();
        };

        function loadMessages() {
            if (unsubscribe) unsubscribe();
            const q = query(collection(db, currentChatPath), orderBy("time", "asc"));
            unsubscribe = onSnapshot(q, (snap) => {
                const box = document.getElementById('chatMessages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    box.innerHTML += `<div class="msg ${isMe ? 'my-msg' : ''}"><b>${m.sender}:</b> ${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendBtn').onclick = async () => {
            const txt = document.getElementById('chatInput').value;
            if (!txt.trim()) return;
            const u = await getDoc(doc(db, "Users", auth.currentUser.uid));
            await addDoc(collection(db, currentChatPath), {
                text: txt,
                sender: u.data().fullName,
                uid: auth.currentUser.uid,
                time: serverTimestamp()
            });
            document.getElementById('chatInput').value = "";
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        auth.onAuthStateChanged(user => { if(user) loadMessages(); });
    </script>
</body>
</html>
