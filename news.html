<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #28a745; --unread: #2ecc71; --read: #bdc3c7; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f4f7f6; overflow-x: hidden; }
        
        /* ØªØµÙ…ÙŠÙ… Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ (Ù…Ø«Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª) */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; font-size: 12px; flex: 1; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
        main { padding: 20px 20px 80px 20px; }
        .news-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 4px solid var(--primary); }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (ØªÙ… Ø¥ØµÙ„Ø§Ø­Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª Ù„Ù„Ù…Ø®ÙˆÙ„ÙŠÙ†) */
        #adminLink { display: none; background: #e74c3c; color: white; padding: 10px; border-radius: 50%; width: 40px; height: 40px; text-align: center; line-height: 40px; position: fixed; top: 20px; left: 20px; z-index: 2000; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .chat-popup { display: none; position: fixed; bottom: 70px; left: 10px; right: 10px; top: 20px; background: white; z-index: 2001; border-radius: 15px 15px 0 0; flex-direction: column; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .chat-header { background: var(--primary); color: white; padding: 15px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
        .user-list-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; margin-left: 10px; }
        .dot-unread { background: var(--unread); box-shadow: 0 0 5px var(--unread); }
        .dot-none { background: var(--read); }

        /* ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¯ÙŠØ± */
        .desktop-view { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 300px 1fr 350px; }
    </style>
</head>
<body id="appBody">

    <a href="admin.html" id="adminLink">âš™ï¸</a>

    <div id="notificationBar" style="display:none; padding:10px; text-align:center; color:white;"></div>

    <main id="mainContent">
        <h2 id="viewTitle">Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        <div id="newsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        
        <div id="usersView" style="display:none;">
            <h3>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</h3>
            <div id="onlineUsers"></div>
        </div>
    </main>

    <div id="chatPopup" class="chat-popup">
        <div class="chat-header">
            <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:20px;">âœ•</button>
        </div>
        <div id="chatMessages"></div>
        <div style="padding:10px; display:flex; border-top:1px solid #ddd;">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
            <button id="sendBtn" style="background:none; border:none; color:var(--primary); font-size:24px;">â¤</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showSection('news')"><i>ğŸ“°</i>Ø£Ø®Ø¨Ø§Ø±</div>
        <div class="nav-item" onclick="showSection('chats')"><i>ğŸ’¬</i>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div class="nav-item" id="tempGroupsIcon" onclick="showSection('groups')"><i>ğŸ‘¥</i>Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</div>
        <div class="nav-item" onclick="location.href='profile.html'"><i>ğŸ‘¤</i>Ù…Ù„ÙÙŠ</div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentChatPath = "Messages";
        let currentUserData = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "Users", user.uid));
                currentUserData = snap.data();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ±Ø§Ù‹ Ø£Ùˆ Ù…Ø´Ø±ÙØ§Ù‹
                if (currentUserData.role === 'admin' || currentUserData.canPost) {
                    document.getElementById('adminLink').style.display = 'block';
                    // ØªØ·Ø¨ÙŠÙ‚ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø®ØªØ§Ø± Ù„Ù„Ù…Ø¯ÙŠØ±
                    if (currentUserData.viewType === 'desktop') {
                        document.getElementById('appBody').classList.add('desktop-view');
                    }
                }
                loadNews();
                loadOnlineUsers();
            } else { window.location.href = "index.html"; }
        });

        // ØªÙ†Ù‚Ù„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Mobile Style)
        window.showSection = (section) => {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('newsList').style.display = 'none';
            document.getElementById('usersView').style.display = 'none';
            
            if(section === 'news') {
                document.getElementById('newsList').style.display = 'block';
                document.getElementById('viewTitle').innerText = "Ø§Ù„Ø£Ø®Ø¨Ø§Ø±";
            } else if (section === 'chats') {
                document.getElementById('usersView').style.display = 'block';
                document.getElementById('viewTitle').innerText = "Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ©";
                openChat('public', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©');
            }
        };

        // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        window.openChat = (path, title) => {
            currentChatPath = path === 'public' ? "Messages" : "PrivateChats/" + path + "/messages";
            document.getElementById('chatTitle').innerText = title;
            document.getElementById('chatPopup').style.display = 'flex';
            loadMessages(currentChatPath);
        };

        window.closeChat = () => {
            document.getElementById('chatPopup').style.display = 'none';
        };

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ù…ÙŠØ²Ø© (Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©/Ù‚Ø¯ÙŠÙ…Ø©)
        function loadOnlineUsers() {
            onSnapshot(collection(db, "Users"), (snap) => {
                const list = document.getElementById('onlineUsers');
                list.innerHTML = "";
                snap.forEach(async (uDoc) => {
                    if (uDoc.id !== auth.currentUser.uid) {
                        const chatId = [auth.currentUser.uid, uDoc.id].sort().join("_");
                        // ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ø¦Ù„ ØºÙŠØ± Ù…Ù‚Ø±ÙˆØ¡Ø© (ØªØ¨Ø³ÙŠØ·: Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø­Ù„Ù‚Ø© ÙÙŠ Firestore Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©)
                        const q = query(collection(db, `PrivateChats/${chatId}/messages`), where("uid", "!=", auth.currentUser.uid), where("read", "==", false));
                        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ù…Ø­Ø§Ø¯Ø«Ø© Ø³Ø§Ø¨Ù‚Ø© Ø£Ùˆ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©
                        list.innerHTML += `
                            <div class="user-list-item" onclick="openChat('${chatId}', '${uDoc.data().fullName}')">
                                <div class="status-dot dot-none" id="dot-${chatId}"></div>
                                <span>${uDoc.data().fullName}</span>
                            </div>`;
                    }
                });
            });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        document.getElementById('sendBtn').onclick = async () => {
            const text = document.getElementById('chatInput').value;
            if (!text.trim()) return;
            await addDoc(collection(db, currentChatPath), {
                text,
                uid: auth.currentUser.uid,
                sender: currentUserData.fullName,
                time: serverTimestamp(),
                read: false
            });
            document.getElementById('chatInput').value = "";
        };

        function loadMessages(path) {
            const q = query(collection(db, path), orderBy("time", "asc"));
            onSnapshot(q, (snap) => {
                const box = document.getElementById('chatMessages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    box.innerHTML += `<div style="display:flex; flex-direction:column; align-items:${isMe?'flex-start':'flex-end'}">
                        <div class="msg" style="background:${isMe?'#dcf8c6':'white'}; padding:8px; border-radius:10px; margin:5px;">${m.text}</div>
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    list.innerHTML += `<div class="news-card"><h4>${d.data().title}</h4><p>${d.data().body}</p></div>`;
                });
            });
        }
    </script>
</body>
</html>
