<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --twitter-blue: #1DA1F2; --gold: #ffc107; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ */
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .user-perms { font-size: 11px; background: #e8f4fd; color: var(--twitter-blue); padding: 4px 10px; border-radius: 15px; font-weight: bold; }
        .logout-btn { background: none; border: none; font-size: 20px; cursor: pointer; color: var(--danger); }

        /* Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© (Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©) */
        .star-broadcast { color: var(--gold); font-size: 24px; cursor: pointer; animation: pulse 1.5s infinite; display: none; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } 100% { opacity: 1; transform: scale(1); } }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
        .search-container { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; box-sizing: border-box; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
        .admin-nav { display: none; background: #fff; padding: 10px; border-bottom: 1px solid #eee; justify-content: space-around; }
        .admin-btn { border: none; background: #eee; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--primary); }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; display: flex; }
        .news-img-thumb { width: 110px; height: 110px; object-fit: cover; }
        .news-brief { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .news-brief h3 { margin: 0; font-size: 15px; }
        .news-meta-mini { font-size: 11px; color: #888; display: flex; gap: 10px; margin-top: 5px; }

        /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-height: 92vh; border-radius: 25px 25px 0 0; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .reaction-bar { display: flex; align-items: center; gap: 20px; padding: 15px 0; border-top: 1px solid #eee; margin-top: 15px; }
        .bird-btn { background: none; border: none; cursor: pointer; font-size: 24px; color: #ccc; }
        .bird-btn.active { color: var(--twitter-blue); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; font-size: 11px; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; display: none; }
    </style>
</head>
<body>

    <div class="top-bar">
        <button class="logout-btn" id="logoutBtn">ğŸšª</button>
        <div id="broadcastStar" class="star-broadcast" onclick="showBroadcastMsg()">â­</div>
        <div id="permsBadge" class="user-perms" style="display:none;"></div>
        <span style="font-weight:bold; color:var(--primary);">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <div class="search-container">
        <input type="text" id="newsSearchInp" class="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±..." oninput="window.filterNews()">
    </div>

    <div id="adminNav" class="admin-nav">
        <button id="manageAppBtn" class="admin-btn" onclick="location.href='admin.html'" style="display:none">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        <button id="manageNewsBtn" class="admin-btn" onclick="window.openNewsEditor()" style="display:none">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</button>
    </div>

    <main id="newsList">
        <h2 style="padding: 15px 15px 0 15px;" id="newsTitleHeader">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        <div id="newsContainer"></div>
    </main>

    <div id="newsEditor" class="modal" style="display:none; align-items: center;">
        <div class="modal-content" style="height: 100%; border-radius: 0; padding: 20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
                <button onclick="window.closeNewsEditor()" style="font-size:24px; border:none; background:none;">âœ•</button>
            </div>
            <input type="file" id="newsImgInp" accept="image/*">
            <input type="text" id="newsTitleInp" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
            <textarea id="newsBodyInp" rows="8" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
            <button class="admin-btn" style="background:var(--accent); color:white; width:100%; padding:15px; font-size:16px;" id="saveNewsBtn">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

    <div id="fullNewsModal" class="modal">
        <div class="modal-content">
            <img id="fnImg" style="width:100%; max-height:250px; object-fit:cover;">
            <div style="padding:20px;">
                <h2 id="fnTitle"></h2>
                <p id="fnBody" style="line-height:1.7; white-space:pre-wrap;"></p>
                <div class="reaction-bar">
                    <button id="birdLikeBtn" class="bird-btn">ğŸ•Šï¸ <span id="fnLikeCount" style="font-size:14px;">0</span></button>
                    <button id="waShareBtn" style="background:#25D366; color:white; border:none; padding:8px 20px; border-radius:25px; font-weight:bold;">ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
                </div>
                <button onclick="closeFullNews()" style="width:100%; margin-top:20px; padding:15px; border:none; background:#eee; border-radius:10px; font-weight:bold;">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø®Ø¨Ø§Ø±</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="location.reload()" style="color:var(--primary); font-weight:bold;">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div onclick="window.toggleChat()" style="cursor:pointer;">ğŸ’¬<br>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© <span id="chatBadge" class="badge">0</span></div>
        <div onclick="location.href='profile.html'" style="cursor:pointer;">ğŸ‘¤<br>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, updateDoc, setDoc, serverTimestamp, increment, arrayUnion, arrayRemove, where, collectionGroup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let userUID = null;
        let userData = null;
        let newsImgBase = "";
        let allNews = [];
        let activeBroadcastMsg = "";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                displayUserUI();
                loadNews();
                checkBroadcast();
                trackUnread();
            } else { window.location.href = "index.html"; }
        });

        function displayUserUI() {
            const badge = document.getElementById('permsBadge');
            let p = [];
            if(userData.role === 'admin') p.push("Ù…Ø¯ÙŠØ±");
            if(userData.canAdd) p.push("Ø¥Ø¶Ø§ÙØ©");
            if(userData.canEdit) p.push("ØªØ¹Ø¯ÙŠÙ„");
            
            if(p.length > 0) {
                badge.innerText = p.join(" | ");
                badge.style.display = 'block';
                document.getElementById('adminNav').style.display = 'flex';
                if(userData.role === 'admin') document.getElementById('manageAppBtn').style.display = 'block';
                if(userData.canAdd || userData.role === 'admin') document.getElementById('manageNewsBtn').style.display = 'block';
            }
        }

        // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
        function checkBroadcast() {
            onSnapshot(doc(db, "Settings", "broadcast"), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.expiry > Date.now()) {
                        activeBroadcastMsg = data.message;
                        document.getElementById('broadcastStar').style.display = 'block';
                    } else { document.getElementById('broadcastStar').style.display = 'none'; }
                }
            });
        }
        window.showBroadcastMsg = () => { if(activeBroadcastMsg) alert("ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©:\n\n" + activeBroadcastMsg); };

        // Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
        window.filterNews = () => {
            const term = document.getElementById('newsSearchInp').value.toLowerCase();
            const filtered = allNews.filter(n => n.title.toLowerCase().includes(term) || n.body.toLowerCase().includes(term));
            renderNews(filtered);
        };

        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                allNews = [];
                snap.forEach(d => allNews.push({ id: d.id, ...d.data() }));
                renderNews(allNews);
            });
        }

        function renderNews(arr) {
            const container = document.getElementById('newsContainer');
            container.innerHTML = "";
            arr.forEach(n => {
                const card = document.createElement('div');
                card.className = 'news-card';
                card.onclick = () => openFullNews(n.id);
                card.innerHTML = `
                    <img src="${n.img || 'https://via.placeholder.com/110'}" class="news-img-thumb">
                    <div class="news-brief">
                        <h3>${n.title}</h3>
                        <div class="news-meta-mini">
                            <span>ğŸ•Šï¸ ${n.likes || 0}</span>
                            <span>ğŸ“… ${n.date?.toDate().toLocaleDateString('ar-SA')}</span>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        window.openNewsEditor = () => document.getElementById('newsEditor').style.display = 'flex';
        window.closeNewsEditor = () => document.getElementById('newsEditor').style.display = 'none';
        window.closeFullNews = () => document.getElementById('fullNewsModal').style.display = 'none';

        document.getElementById('newsImgInp').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => newsImgBase = reader.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('saveNewsBtn').onclick = async () => {
            const t = document.getElementById('newsTitleInp').value;
            const b = document.getElementById('newsBodyInp').value;
            if(!t || !b) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            await addDoc(collection(db, "News"), { title: t, body: b, img: newsImgBase, likes: 0, likedBy: [], date: serverTimestamp() });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±"); window.closeNewsEditor();
        };

        window.openFullNews = async (id) => {
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            document.getElementById('fnImg').src = n.img || '';
            document.getElementById('fnTitle').innerText = n.title;
            document.getElementById('fnBody').innerText = n.body;
            document.getElementById('fnLikeCount').innerText = n.likes || 0;
            document.getElementById('fullNewsModal').style.display = 'flex';
        };

        document.getElementById('logoutBtn').onclick = () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) signOut(auth); };

        function trackUnread() {
            const q = query(collectionGroup(db, 'messages'), where('uid', '!=', userUID), where('read', '==', false));
            onSnapshot(q, (snap) => {
                let count = 0;
                snap.forEach(d => { if (d.ref.path.includes(userUID)) count++; });
                const badge = document.getElementById('chatBadge');
                badge.innerText = count; badge.style.display = count > 0 ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
