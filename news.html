<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; --danger: #ff3b30; --success: #34c759; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding-bottom: 70px; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø£Ø®Ø¨Ø§Ø± */
        .news-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); overflow: hidden; }
        .news-img { width: 100%; height: 220px; border-radius: 15px; object-fit: cover; margin-bottom: 12px; display: block; background: #eee; }
        .news-title { font-size: 18px; font-weight: bold; margin-bottom: 8px; color: #1c1c1e; }
        .news-desc { font-size: 14px; color: #444; line-height: 1.6; }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø­Ø±Ø± */
        .admin-tools { display: none; gap: 8px; margin-top: 15px; padding-top: 10px; border-top: 1px solid #f0f0f0; flex-wrap: wrap; }
        .admin-btn { border: none; padding: 8px 12px; border-radius: 10px; font-size: 11px; cursor: pointer; font-weight: bold; flex: 1; min-width: 80px; }
        .btn-edit { background: #eef1ff; color: var(--primary); }
        .btn-delete { background: #fff1f0; color: var(--danger); }
        .btn-toggle { background: #f0fff4; color: var(--success); }
        
        .news-hidden { opacity: 0.6; border: 1px dashed var(--danger); }
        
        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        @keyframes slideDown { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div class="top-bar">
    <button onclick="location.href='profile.html'" style="border:none; background:none; font-size:22px;">ğŸ‘¤</button>
    <b>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</b>
    <div id="adminTag" style="display:none; background:gold; padding:2px 8px; border-radius:8px; font-size:10px; font-weight:bold;">Ù…Ø­Ø±Ø±</div>
</div>

<div class="container" id="newsFeed">
    <p style="text-align:center; color:gray; margin-top:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</p>
</div>

<div class="bottom-nav">
    <button onclick="location.href='news.html'" class="active">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    <button onclick="location.href='competitions.html'">ğŸ†<br>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</button>
    <button onclick="location.href='profile.html'">ğŸ‘¤<br>Ù…Ù„ÙÙŠ</button>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let isAdmin = false;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, user => {
        if (user) {
            // ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù„Ø¥ÙŠÙ…ÙŠÙ„Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ Ù„ØªØ¸Ù‡Ø± Ù„Ùƒ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ±
            if (user.email === "admin@family.com") { 
                isAdmin = true;
                document.getElementById('adminTag').style.display = 'block';
            }
            loadNews();
            watchNotifications();
        } else {
            location.href = "login.html";
        }
    });

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±
    function loadNews() {
        const q = query(collection(db, "News"), orderBy("createdAt", "desc"));
        onSnapshot(q, snap => {
            const feed = document.getElementById('newsFeed');
            if (snap.empty) {
                feed.innerHTML = "<p style='text-align:center; padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
                return;
            }
            feed.innerHTML = "";
            snap.forEach(d => {
                const n = d.data();
                if (!n.visible && !isAdmin) return;

                const card = document.createElement('div');
                card.className = `news-card ${!n.visible ? 'news-hidden' : ''}`;
                card.innerHTML = `
                    ${n.image ? `<img src="${n.image}" class="news-img">` : ''}
                    <div class="news-title">${n.title} ${!n.visible ? ' (Ù…Ø®ÙÙŠ)' : ''}</div>
                    <div class="news-desc">${n.content}</div>
                    <div class="admin-tools" style="display: ${isAdmin ? 'flex' : 'none'}">
                        <button class="admin-btn btn-edit" onclick="window.editNews('${d.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                        <button class="admin-btn btn-toggle" onclick="window.toggleVis('${d.id}', ${n.visible})">
                            ${n.visible ? 'ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡' : 'ğŸ‘ï¸ Ø¥Ø¸Ù‡Ø§Ø±'}
                        </button>
                        <button class="admin-btn btn-delete" onclick="window.delNews('${d.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    // 3. Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¥ØªØ§Ø­ØªÙ‡Ø§ Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
    window.delNews = async (id) => {
        if (confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø¨Ø±ØŸ")) await deleteDoc(doc(db, "News", id));
    };

    window.toggleVis = async (id, curr) => {
        await updateDoc(doc(db, "News", id), { visible: !curr });
    };

    window.editNews = (id) => {
        location.href = `add_news.html?edit=${id}`;
    };

    // 4. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ÙÙˆØ±ÙŠØ© Ø§Ù„Ù…ØµÙ„Ø­
    function watchNotifications() {
        const qNotify = query(collection(db, "Notifications"), orderBy("createdAt", "desc"), limit(1));
        let isFirst = true;

        onSnapshot(qNotify, snap => {
            if (isFirst) { isFirst = false; return; }
            snap.docChanges().forEach(change => {
                if (change.type === "added") {
                    const data = change.doc.data();
                    showPopup(data.title, data.message);
                }
            });
        });
    }

    function showPopup(title, msg) {
        const p = document.createElement('div');
        p.style = `position:fixed; top:10px; left:10px; right:10px; background:var(--primary); color:white; padding:15px; border-radius:15px; z-index:10000; animation:slideDown 0.5s ease; box-shadow:0 5px 15px rgba(0,0,0,0.3);`;
        p.innerHTML = `<b>ğŸ”” ${title}</b><p style="margin:5px 0 0; font-size:12px;">${msg}</p>`;
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 5000);
    }

</script>
</body>
</html>
