<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --twitter-blue: #1DA1F2; --gold: #ffc107; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; overflow-x: hidden; }

        /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ */
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .star-broadcast { color: var(--gold); font-size: 24px; cursor: pointer; animation: pulse 1.5s infinite; display: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ (Popup) Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© */
        .pop-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; padding: 20px; }
        .pop-card { width: 90%; max-width: 380px; padding: 25px; border-radius: 20px; text-align: center; }
        .pop-white { background: white; color: #333; }
        .pop-red { background: var(--danger); color: white; }
        .pop-green { background: var(--accent); color: white; }

        /* Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± */
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; display: flex; }
        .news-img-thumb { width: 110px; height: 110px; object-fit: cover; }
        .news-brief { padding: 10px; flex: 1; }
        .news-meta { font-size: 11px; color: #888; margin-top: 5px; display: flex; gap: 10px; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) */
        .news-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 8000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 25px 25px 0 0; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .full-img-small { width: 100%; max-height: 200px; object-fit: contain; border-radius: 15px; background: #f0f0f0; margin-bottom: 15px; }
        
        /* Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± */
        .overlay-full { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; }
        .chat-selector-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        
        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */
        .active-chat-window { display: none; position: fixed; inset: 0; background: #e5ddd5; z-index: 5000; flex-direction: column; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; font-size: 14px; }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        .other-msg { align-self: flex-start; background: white; }
        .auto-delete-bar { background: #fff3cd; padding: 8px 15px; font-size: 11px; display: flex; justify-content: space-between; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .restricted { display: none !important; }
    </style>
</head>
<body>

    <div id="loginPopupOverlay" class="pop-overlay">
        <div id="loginPopupCard" class="pop-card">
            <h3 id="popTitle">ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <p id="popMsg"></p>
            <button onclick="window.closePopup()" style="margin-top:15px; padding:10px 25px; border-radius:25px; border:none; cursor:pointer; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="top-bar">
        <button onclick="window.handleLogout()" style="background:none; border:none; font-size:22px;">ğŸšª</button>
        <div id="broadcastStar" class="star-broadcast" onclick="window.showBC()">â­</div>
        <div id="adminTools" style="display:none;">
            <button onclick="location.href='admin.html'" style="background:none; border:none; font-size:20px;">âš™ï¸</button>
        </div>
        <span id="userStatus" style="font-size:11px; font-weight:bold; color:orange;"></span>
        <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <main id="newsContainer"></main>

    <div id="newsModal" class="news-modal">
        <div class="modal-content">
            <button onclick="window.closeNewsModal()" style="float:left; border:none; background:none; font-size:24px;">âœ•</button>
            <img id="mImg" class="full-img-small">
            <h2 id="mTitle" style="margin:0; font-size:18px;"></h2>
            <p id="mBody" style="line-height:1.6; color:#34495e; font-size:14px; white-space:pre-wrap;"></p>
            
            <div id="newsActions" class="modal-actions" style="display:flex; gap:20px; border-top:1px solid #eee; padding:10px 0;">
                <button id="likeBtn" style="border:none; background:none; font-size:20px;">ğŸ•Šï¸ <span id="mLikeCount">0</span></button>
                <button id="waBtn" style="background:#25D366; color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:bold;">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>

            <div id="commentsArea">
                <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ğŸ’¬</h4>
                <div id="mCommentsList" style="max-height:150px; overflow-y:auto; font-size:13px; border-bottom:1px solid #eee; margin-bottom:10px;"></div>
                <div id="commentInputArea" style="display:flex; gap:5px;">
                    <input type="text" id="cInput" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px;">
                    <button id="sendComment" style="border:none; background:var(--primary); color:white; border-radius:10px; padding:0 15px;">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>
        </div>
    </div>

    <div id="chatCenterOverlay" class="overlay-full">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
            <button onclick="window.toggleChatCenter()" style="color:white; background:none; border:none; font-size:24px;">âœ•</button>
        </div>
        <div style="padding:10px; overflow-y:auto; flex:1; background:#f0f2f5;">
            <div class="chat-selector-item" onclick="window.openChat('Messages', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')"><span>ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span></div>
            <h4 style="margin:15px 10px 5px;">Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙƒ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h4>
            <div id="tempGroupsList"></div>
            <h4 style="margin:15px 10px 5px;">Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</h4>
            <div style="display:flex; padding:5px 10px;">
                <input type="number" id="searchPhone" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¬Ø¯ÙŠØ¯Ø©..." style="flex:1; padding:10px; border:1px solid #ddd; border-radius:10px;">
                <button onclick="window.searchByPhone()" style="background:var(--primary); color:white; border:none; padding:10px; border-radius:10px; margin-right:5px;">Ø¨Ø­Ø«</button>
            </div>
            <div id="previousChatsList"></div>
        </div>
    </div>

    <div id="activeChatWindow" class="active-chat-window">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span id="activeChatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <button onclick="window.closeActiveChat()" style="color:white; background:none; border:none; font-size:24px;">âœ•</button>
        </div>
        <div id="autoDeleteBar" class="auto-delete-bar" style="display:none;">
            <span>ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:</span>
            <select id="autoDeleteSelect" onchange="window.updateAutoDelete()">
                <option value="0">Ø¥ÙŠÙ‚Ø§Ù</option>
                <option value="1">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
                <option value="24">Ø¨Ø¹Ø¯ ÙŠÙˆÙ…</option>
            </select>
        </div>
        <div id="chatMessages"></div>
        <div style="padding:10px; background:white; display:flex;">
            <input type="text" id="chatInput" style="flex:1; padding:12px; border-radius:20px; border:1px solid #ddd;" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
            <button id="sendChatBtn" style="background:none; border:none; color:var(--primary); font-size:24px; margin-right:10px;">â¤</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="location.reload()">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div id="chatIcon" onclick="window.toggleChatCenter()">ğŸ’¬<br>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div onclick="location.href='profile.html'">ğŸ‘¤<br>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, where, getDocs, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let userUID, userData, userAge, unsubMsgs, currentChatID, currentChatPath;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                userAge = new Date().getFullYear() - new Date(userData.dob).getFullYear();
                
                // Ù‚ÙŠÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø·Ù„
                if(userData.status !== 'active') {
                    document.getElementById('userStatus').innerText = "(Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„)";
                    document.getElementById('chatIcon').classList.add('restricted');
                }
                if(userData.role === 'admin') document.getElementById('adminTools').style.display = 'block';

                loadNews();
                loadTempGroups();
                loadPreviousChats();
                checkPopup();
                checkStarBC();
            } else { window.location.href = "index.html"; }
        });

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ø¹ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.onclick = () => window.openNewsModal(d.id);
                    
                    onSnapshot(collection(db, `News/${d.id}/Comments`), (cSnap) => {
                        card.innerHTML = `
                            <img src="${n.img}" class="news-img">
                            <div class="news-info">
                                <h3 style="margin:0; font-size:15px;">${n.title}</h3>
                                <div class="news-meta">
                                    <span>ğŸ•Šï¸ ${n.likes || 0}</span>
                                    <span>ğŸ’¬ ${cSnap.size}</span>
                                    <span>ğŸ“… ${n.date?.toDate().toLocaleDateString('ar-SA')}</span>
                                </div>
                            </div>`;
                    });
                    container.appendChild(card);
                });
            });
        }

        // 2. ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø± ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        window.openNewsModal = async (id) => {
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            document.getElementById('mImg').src = n.img;
            document.getElementById('mTitle').innerText = n.title;
            document.getElementById('mBody').innerText = n.body;
            document.getElementById('mLikeCount').innerText = n.likes || 0;
            
            if(userData.status !== 'active') {
                document.getElementById('newsActions').classList.add('restricted');
                document.getElementById('commentInputArea').classList.add('restricted');
            }

            document.getElementById('waBtn').onclick = () => {
                const text = `*${n.title}*\n${n.body.substring(0,100)}...\n\nØªØ§Ø¨Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚!`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            };

            document.getElementById('newsModal').style.display = 'flex';
            loadComments(id);
            document.getElementById('sendComment').onclick = () => postComment(id);
        };

        async function postComment(newsId) {
            const inp = document.getElementById('cInput');
            if(!inp.value.trim()) return;
            await addDoc(collection(db, `News/${newsId}/Comments`), {
                text: inp.value, sender: userData.fullName, uid: userUID, time: serverTimestamp()
            });
            inp.value = "";
        }

        function loadComments(id) {
            onSnapshot(query(collection(db, `News/${id}/Comments`), orderBy("time", "asc")), (snap) => {
                const list = document.getElementById('mCommentsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;"><b>${d.data().sender}:</b> ${d.data().text}</div>`;
                });
            });
        }

        // 3. Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø®ØµÙˆØµÙŠØ©
        window.toggleChatCenter = () => {
            const el = document.getElementById('chatCenterOverlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.searchByPhone = async () => {
            const phone = document.getElementById('searchPhone').value;
            const q = query(collection(db, "Users"), where("phone", "==", phone), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) {
                const u = snap.docs[0];
                const cid = [userUID, u.id].sort().join("_");
                window.openChat(`PrivateChats/${cid}/messages`, u.data().fullName, cid);
            } else { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…"); }
        };

        window.openChat = async (path, title, cid = null) => {
            currentChatPath = path; currentChatID = cid;
            document.getElementById('activeChatTitle').innerText = title;
            document.getElementById('activeChatWindow').style.display = 'flex';
            document.getElementById('autoDeleteBar').style.display = cid ? 'flex' : 'none';
            
            if(cid) {
                const cSnap = await getDoc(doc(db, "PrivateChats", cid));
                document.getElementById('autoDeleteSelect').value = cSnap.exists() ? (cSnap.data().autoDeleteHours || 0) : 0;
            }

            if(unsubMsgs) unsubMsgs();
            unsubMsgs = onSnapshot(query(collection(db, path), orderBy("time", "asc")), (snap) => {
                const box = document.getElementById('chatMessages'); box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    box.innerHTML += `<div class="msg ${m.uid === userUID ? 'my-msg' : 'other-msg'}"><b>${m.sender}:</b><br>${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        };

        document.getElementById('sendChatBtn').onclick = async () => {
            const txt = document.getElementById('chatInput').value; if(!txt.trim()) return;
            if(currentChatID) await setDoc(doc(db, "PrivateChats", currentChatID), { active: true }, { merge: true });
            await addDoc(collection(db, currentChatPath), { text: txt, sender: userData.fullName, uid: userUID, time: serverTimestamp() });
            document.getElementById('chatInput').value = "";
        };

        // 4. Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
        window.updateAutoDelete = async () => {
            const hours = document.getElementById('autoDeleteSelect').value;
            await setDoc(doc(db, "PrivateChats", currentChatID), { autoDeleteHours: parseInt(hours) }, { merge: true });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
        };

        function loadTempGroups() {
            onSnapshot(collection(db, "TempGroups"), (snap) => {
                const list = document.getElementById('tempGroupsList'); list.innerHTML = "";
                snap.forEach(d => {
                    const g = d.data();
                    const isAllowed = g.targetType === 'all' || (g.allowedUsers && g.allowedUsers.includes(userUID));
                    if(g.expiry > Date.now() && !g.disabled && isAllowed) {
                        list.innerHTML += `<div class="chat-selector-item" onclick="window.openChat('TempGroups/${d.id}/messages', '${g.name}')">ğŸ‘¥ ${g.name}</div>`;
                    }
                });
            });
        }

        function loadPreviousChats() {
            onSnapshot(collection(db, "PrivateChats"), (snap) => {
                const list = document.getElementById('previousChatsList'); list.innerHTML = "";
                snap.forEach(async d => {
                    if(d.id.includes(userUID)) {
                        const otherUID = d.id.replace(userUID, "").replace("_", "");
                        const u = (await getDoc(doc(db, "Users", otherUID))).data();
                        if(u) list.innerHTML += `<div class="chat-selector-item" onclick="window.openChat('PrivateChats/${d.id}/messages', '${u.fullName}', '${d.id}')">ğŸ‘¤ ${u.fullName}</div>`;
                    }
                });
            });
        }

        // 5. Ø§Ù„Ù†Ø¬Ù…Ø© ÙˆØ§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
        function checkPopup() {
            onSnapshot(doc(db, "Settings", "loginPopup"), (s) => {
                if(s.exists()){
                    const d = s.data();
                    if(d.expiry > Date.now() && localStorage.getItem('last_pop_id') !== d.id){
                        document.getElementById('popMsg').innerText = d.message;
                        document.getElementById('loginPopupCard').className = `pop-card pop-${d.type}`;
                        document.getElementById('loginPopupOverlay').style.display = 'flex';
                        localStorage.setItem('last_pop_id', d.id);
                        if(d.duration > 0) setTimeout(() => window.closePopup(), d.duration * 1000);
                    }
                }
            });
        }

        function checkStarBC() {
            onSnapshot(doc(db, "Settings", "broadcast"), (s) => {
                if(s.exists()){
                    const d = s.data();
                    const match = (d.targetGender === 'all' || d.targetGender === userData.gender) && (userAge >= d.minAge && userAge <= d.maxAge) && (d.expiry > Date.now());
                    document.getElementById('broadcastStar').style.display = match ? 'block' : 'none';
                    window.activeBCMsg = d.message;
                }
            });
        }

        window.showBC = () => alert("ğŸ“¢ " + window.activeBCMsg);
        window.closePopup = () => document.getElementById('loginPopupOverlay').style.display = 'none';
        window.closeNewsModal = () => document.getElementById('newsModal').style.display = 'none';
        window.handleLogout = () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut(); };

    </script>
</body>
</html>
