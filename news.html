<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#007AFF">

    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15" });
      });
    </script>

    <style>
        :root { 
            --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF;
            --ios-gray: #8E8E93; --ios-green: #34C759;
        }

        body { 
            background: var(--ios-bg); font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; padding-top: 85px; padding-bottom: 90px; direction: rtl;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar {
            position: fixed; top: 0; width: 100%; height: 75px;
            background: rgba(255,255,255,0.85); backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; box-sizing: border-box; border-bottom: .5px solid #C6C6C8; z-index: 5000;
        }

        .header-center { text-align: center; flex-grow: 1; }
        .header-center h1 { font-size: 18px; margin: 0; font-weight: 800; }
        .full-date { font-size: 10px; color: var(--ios-gray); margin-top: 3px; font-weight: 500; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .install-btn {
            display: none; background: var(--ios-blue); color: white; border: none;
            padding: 6px 12px; border-radius: 12px; font-size: 11px; font-weight: bold; cursor: pointer;
        }
        .admin-add-btn { font-size: 24px; color: var(--ios-blue); text-decoration: none; display: none; }

        .container { padding: 10px 15px; max-width: 600px; margin: auto; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± */
        .news-card { 
            background: var(--card-bg); border-radius: 20px; overflow: hidden;
            margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 0.5px solid #E5E5EA;
        }
        .news-img { width: 100%; height: 220px; object-fit: cover; background: #eee; }
        .news-content { padding: 15px; }
        .news-tag { color: var(--ios-blue); font-size: 11px; font-weight: 700; margin-bottom: 6px; display: block; }
        .news-title { font-size: 19px; font-weight: 800; color: #1c1c1e; margin: 0 0 8px 0; }
        .news-desc { font-size: 14.5px; color: #3a3a3c; line-height: 1.5; margin-bottom: 15px; }
        
        .news-footer { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-top: 12px; border-top: 0.5px solid #F2F2F7;
        }
        .stats-group { display: flex; gap: 12px; color: var(--ios-gray); font-size: 12px; align-items: center; }
        .like-btn { border: none; background: #F2F2F7; padding: 6px 12px; border-radius: 15px; font-size: 13px; cursor: pointer; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ */
        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center; border-top: 0.5px solid #C6C6C8; z-index: 5000;
        }
        .nav-item { font-size: 24px; color: #8E8E93; text-decoration: none; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: var(--ios-blue); }
        .nav-label { font-size: 10px; margin-top: 4px; }
    </style>
</head>
<body>

<div class="top-bar">
    <button id="btnInstall" class="install-btn">ØªØ«Ø¨ÙŠØª ğŸ“²</button>
    <div class="header-center">
        <h1>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h1>
        <div id="currentDate" class="full-date"></div>
    </div>
    <a id="adminLink" href="add_news.html" class="admin-add-btn">âŠ•</a>
</div>

<div class="container" id="newsFeed">
    <p style="text-align:center; color:gray; margin-top:50px;">Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</p>
</div>

<nav class="bottom-bar">
    <a href="news.html" class="nav-item active">ğŸ <span class="nav-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
    <a href="chat.html" class="nav-item">ğŸ’¬<span class="nav-label">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></a>
    <a href="competitions.html" class="nav-item">ğŸ†<span class="nav-label">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</span></a>
    <a href="profile.html" class="nav-item">ğŸ‘¤<span class="nav-label">Ø­Ø³Ø§Ø¨ÙŠ</span></a>
</nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, query, orderBy, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const newsFeed = document.getElementById('newsFeed');
    const adminLink = document.getElementById('adminLink');

    // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù‡Ø¬Ø±ÙŠØŒ Ù…ÙŠÙ„Ø§Ø¯ÙŠØŒ Ø§Ø³Ù… Ø§Ù„ÙŠÙˆÙ…)
    function showFullDate() {
        const now = new Date();
        const day = now.toLocaleDateString('ar-SA', { weekday: 'long' });
        const hijri = now.toLocaleDateString('ar-SA-u-ca-islamic-uma', { day: 'numeric', month: 'long', year: 'numeric' });
        const greg = now.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        document.getElementById('currentDate').innerText = `${day} | ${hijri} Ù‡Ù€ | ${greg} Ù…`;
    }

    // 2. Ø¥Ø¯Ø§Ø±Ø© ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (PWA)
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('btnInstall').style.display = 'block';
    });

    document.getElementById('btnInstall').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            deferredPrompt = null;
            document.getElementById('btnInstall').style.display = 'none';
        }
    });

    // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            showFullDate();
            const userDoc = await getDoc(doc(db, "Users", user.uid));
            if (userDoc.data()?.role === 'admin' || userDoc.data()?.role === 'Ù…Ø¯ÙŠØ±') {
                adminLink.style.display = 'block';
            }
            loadNews();
        } else {
            location.href = "login.html";
        }
    });

    // 4. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
    function loadNews() {
        const q = query(collection(db, "News"), orderBy("timestamp", "desc"));
        
        onSnapshot(q, (snapshot) => {
            newsFeed.innerHTML = "";
            snapshot.forEach((docSnap) => {
                const news = docSnap.data();
                const newsId = docSnap.id;

                // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¸Ù‡ÙˆØ±
                updateDoc(doc(db, "News", newsId), {
                    views: increment(1)
                });

                const timeStr = news.timestamp ? news.timestamp.toDate().toLocaleString('ar-EG', {hour:'2-digit', minute:'2-digit'}) : '';
                
                const card = document.createElement('div');
                card.className = 'news-card';
                card.innerHTML = `
                    ${news.imageUrl ? `<img src="${news.imageUrl}" class="news-img" loading="lazy">` : ''}
                    <div class="news-content">
                        <span class="news-tag">${news.category || 'Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'}</span>
                        <h2 class="news-title">${news.title}</h2>
                        <p class="news-desc">${news.content}</p>
                        <div class="news-footer">
                            <div class="stats-group">
                                <span>ğŸ•’ ${timeStr}</span>
                                <span>ğŸ‘ï¸ ${news.views || 0}</span>
                            </div>
                            <button class="like-btn" onclick="window.handleLike('${newsId}')">â¤ï¸ ${news.likes || 0}</button>
                        </div>
                    </div>
                `;
                newsFeed.appendChild(card);
            });
        });
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
    window.handleLike = async (id) => {
        await updateDoc(doc(db, "News", id), { likes: increment(1) });
    };
</script>

</body>
</html>
