<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 70px; }
        
        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ - ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªÙ…ÙˆØ¶Ø¹ */
        .pop-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; 
        }
        .pop-card { width: 85%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .pop-white { background: white; color: #333; }
        .pop-red { background: var(--danger); color: white; }
        .pop-green { background: var(--accent); color: white; }
        
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .star-bc { color: #ffc107; font-size: 24px; cursor: pointer; display: none; }
        
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .news-img { width: 100px; height: 100px; object-fit: cover; }
        .news-info { padding: 10px; flex: 1; }
    </style>
</head>
<body>

    <div id="loginPopupOverlay" class="pop-overlay">
        <div id="loginPopupCard" class="pop-card">
            <h3 id="popTitle">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡</h3>
            <p id="popMsg"></p>
            <button onclick="closePopup()" style="margin-top:20px; padding:10px 25px; border-radius:25px; border:none; cursor:pointer; font-weight:bold;">Ø­Ø³Ù†Ø§Ù‹ØŒ Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="mainPageContent">
        <div class="top-bar">
            <button id="logoutBtn" style="background:none; border:none; font-size:22px;">ğŸšª</button>
            <div id="broadcastStar" class="star-bc" onclick="showBC()">â­</div>
            <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </div>

        <div id="newsContainer">
            </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { doc, getDoc, onSnapshot, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let userUID, userData, userAge;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                userAge = new Date().getFullYear() - new Date(userData.dob).getFullYear();
                
                loadNews();
                checkPopupOnce(); // ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
                checkStarBC();    // ÙØ­Øµ Ø§Ù„Ù†Ø¬Ù…Ø©
            } else {
                window.location.href = "index.html";
            }
        });

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ±Ù‡Ø§
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    container.innerHTML += `
                        <div class="news-card">
                            <img src="${n.img || 'https://via.placeholder.com/100'}" class="news-img">
                            <div class="news-info">
                                <h3 style="margin:0; font-size:16px;">${n.title}</h3>
                                <p style="font-size:12px; color:#666;">${n.body.substring(0,50)}...</p>
                            </div>
                        </div>`;
                });
            });
        }

        // 2. ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
        function checkPopupOnce() {
            onSnapshot(doc(db, "Settings", "loginPopup"), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    const lastSeenID = localStorage.getItem('last_popup_id');
                    
                    // Ø§Ù„Ø´Ø±ÙˆØ·: Ø§Ù„ÙˆÙ‚Øª Ù„Ù… ÙŠÙ†ØªÙ‡Ù + Ø§Ù„Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù… ÙŠØ±Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„
                    if(data.expiry > Date.now() && data.id !== lastSeenID) {
                        showPopup(data);
                    }
                }
            });
        }

        function showPopup(data) {
            const overlay = document.getElementById('loginPopupOverlay');
            const card = document.getElementById('loginPopupCard');
            document.getElementById('popMsg').innerText = data.message;
            card.className = `pop-card pop-${data.type}`;
            overlay.style.display = 'flex';
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±Ù ÙÙˆØ±Ø§Ù‹ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            localStorage.setItem('last_popup_id', data.id);

            if(data.duration > 0) {
                setTimeout(() => { closePopup(); }, data.duration * 1000);
            }
        }

        window.closePopup = () => {
            document.getElementById('loginPopupOverlay').style.display = 'none';
        };

        // 3. ÙØ­Øµ Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
        function checkStarBC() {
            onSnapshot(doc(db, "Settings", "broadcast"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    const match = (d.targetGender === 'all' || d.targetGender === userData.gender) && 
                                  (userAge >= d.minAge && userAge <= d.maxAge) && (d.expiry > Date.now());
                    document.getElementById('broadcastStar').style.display = match ? 'block' : 'none';
                    window.bcMessage = d.message;
                }
            });
        }
        window.showBC = () => alert("ğŸ“¢ " + window.bcMessage);

        document.getElementById('logoutBtn').onclick = () => signOut(auth);
    </script>
</body>
</html>
