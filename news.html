<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1c1c1e;
            --text-sec: #8E8E93;
        }

        body {
            background-color: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding-top: 70px;
            padding-bottom: 90px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ Ø¨Ù†Ù…Ø· Ø²Ø¬Ø§Ø¬ÙŠ */
        .header {
            position: fixed; top: 0; width: 100%; height: 65px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box;
            border-bottom: 0.5px solid #C6C6C8; z-index: 5000;
        }

        .header h1 { font-size: 22px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        .header-btns { display: flex; gap: 18px; align-items: center; }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù…Ø®ÙÙŠØ© Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ */
        #adminTools { display: none; align-items: center; gap: 18px; }
        .icon-btn { font-size: 26px; cursor: pointer; color: var(--ios-blue); display: flex; align-items: center; }
        .logout-btn { color: var(--ios-red); font-size: 24px; cursor: pointer; }

        /* ÙƒØ±Øª Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
        .post-card {
            background: var(--card-bg);
            margin: 15px; border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden; position: relative;
            border: 0.5px solid #E5E5EA;
        }

        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø¹Ø·Ù„ */
        .post-card.disabled { opacity: 0.55; filter: grayscale(0.8); }
        .post-card.disabled::after { 
            content: "Ù…Ø®ÙÙŠ Ø¹Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡"; position: absolute; top: 10px; right: 10px; 
            background: rgba(255,59,48,0.9); color: white; padding: 4px 10px; 
            border-radius: 8px; font-size: 10px; font-weight: bold;
        }

        .post-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .author-info { display: flex; align-items: center; gap: 12px; }
        .author-info .avatar { width: 38px; height: 38px; background: #E5E5EA; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: var(--ios-blue); }
        .author-info b { font-size: 15px; display: block; }
        .author-info span { font-size: 11px; color: var(--text-sec); }

        .post-image { width: 100%; height: auto; max-height: 350px; object-fit: cover; display: block; }

        .post-content { padding: 15px; }
        .post-content h2 { margin: 0 0 6px 0; font-size: 19px; font-weight: 700; line-height: 1.3; }
        .post-content p { margin: 0; font-size: 15px; color: #3a3a3c; line-height: 1.5; display: none; margin-top: 10px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .post-actions {
            display: flex; justify-content: space-around;
            padding: 12px 0; border-top: 0.5px solid #E5E5EA;
            background: #FAFAFA;
        }
        .action-item {
            display: flex; align-items: center; gap: 6px;
            color: var(--text-sec); font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .action-item.active { color: var(--ios-red); }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .edit-dots { font-size: 24px; color: var(--text-sec); cursor: pointer; padding: 0 5px; }
        .dropdown {
            position: absolute; left: 15px; top: 50px;
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px);
            border-radius: 14px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: none; flex-direction: column; z-index: 1000;
            border: 0.5px solid #ddd; min-width: 160px; overflow: hidden;
        }
        .dropdown button {
            padding: 14px; border: none; background: none;
            text-align: right; font-size: 14px; font-weight: 500;
            border-bottom: 0.5px solid #eee; cursor: pointer; width: 100%;
        }
        .dropdown button:last-child { border-bottom: none; color: var(--ios-red); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª */
        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 75px;
            background: rgba(255,255,255,0.92); backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 0.5px solid #C6C6C8; z-index: 5000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { font-size: 26px; color: #8E8E93; text-decoration: none; transition: 0.2s; }
        .nav-item.active { color: var(--ios-blue); }

    </style>
</head>
<body>

    <header class="header">
        <h1>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        <div class="header-btns">
            <div id="adminTools">
                <div class="icon-btn" onclick="location.href='add_news.html'" title="Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±">âŠ•</div>
                <div class="icon-btn" onclick="location.href='admin.html'" title="Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…">âš™ï¸</div>
            </div>
            <div class="logout-btn" onclick="handleLogout()">ğŸšª</div>
        </div>
    </header>

    <div id="newsFeed"></div>

    <nav class="bottom-bar">
        <a href="news.html" class="nav-item active">ğŸ </a>
        <a href="chat.html" class="nav-item">ğŸ’¬</a>
        <a href="competitions.html" class="nav-item">ğŸ†</a>
        <a href="profile.html" class="nav-item">ğŸ‘¤</a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData;

    // Ø¯Ø§Ù„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø¯ÙŠØ± (Force Show)
    function enableAdminUI() {
        const tools = document.getElementById('adminTools');
        if (tools) {
            tools.style.display = 'flex';
            console.log("Admin UI Enabled âœ…");
        }
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            try {
                const userSnap = await getDoc(doc(db, "Users", userUID));
                if (userSnap.exists()) {
                    userData = userSnap.data();
                    const role = String(userData.role || '').toLowerCase().trim();
                    
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØªØ¨Ø© (ØªØ£ÙƒØ¯ Ø£Ù† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø­Ù‚Ù„ Ø§Ø³Ù…Ù‡ role)
                    if (role === 'admin' || role === 'editor' || role === 'Ù…Ø¯ÙŠØ±' || role === 'Ù…Ø­Ø±Ø±') {
                        enableAdminUI();
                    }
                }
            } catch (e) { console.error("Error fetching role:", e); }
            loadPosts();
        } else { window.location.href = "login.html"; }
    });

    function loadPosts() {
        const feed = document.getElementById('newsFeed');
        onSnapshot(collection(db, "News"), (snap) => {
            feed.innerHTML = "";
            let posts = [];
            snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
            posts.sort((a,b) => (b.publishDate || 0) - (a.publishDate || 0));

            posts.forEach(post => {
                const role = (userData?.role || '').toLowerCase();
                const isManager = (role === 'admin' || role === 'editor' || role === 'Ù…Ø¯ÙŠØ±' || userUID === post.authorId);
                
                if (!post.visible && !isManager) return;

                const hasLiked = post.likedBy?.includes(userUID);
                const card = document.createElement('div');
                card.className = `post-card ${!post.visible ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div class="post-header">
                        <div class="author-info">
                            <div class="avatar">${post.authorName?.charAt(0) || 'U'}</div>
                            <div>
                                <b>${post.authorName || 'Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'}</b>
                                <span>${post.publishDate ? new Date(post.publishDate).toLocaleDateString('ar-EG') : ''}</span>
                            </div>
                        </div>
                        ${isManager ? `<div class="edit-dots" onclick="event.stopPropagation(); toggleMenu('${post.id}')">â‹®</div>` : ''}
                        <div id="menu-${post.id}" class="dropdown">
                            <button onclick="doAction('${post.id}', 'toggleVis', ${post.visible})">${post.visible ? 'ğŸ”’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø¨Ø±' : 'ğŸ”“ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±'}</button>
                            <button onclick="location.href='add_news.html?edit=${post.id}'">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button onclick="doAction('${post.id}', 'delete')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±</button>
                        </div>
                    </div>

                    <img class="post-image" src="${post.img || 'https://via.placeholder.com/500x300'}" onerror="this.src='https://via.placeholder.com/500x300'" onclick="zoomImg(this.src)">

                    <div class="post-content" onclick="toggleText('${post.id}')">
                        <h2>${post.title}</h2>
                        <p id="text-${post.id}">${post.body || post.content || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©.'}</p>
                    </div>

                    <div class="post-actions">
                        <div class="action-item ${hasLiked ? 'active' : ''}" onclick="doLike('${post.id}', ${hasLiked})">
                            ${hasLiked ? 'â¤ï¸' : 'ğŸ¤'} <span>${post.likedBy?.length || 0}</span>
                        </div>
                        <div class="action-item" onclick="toggleText('${post.id}')">
                            ğŸ’¬ <span>ØªØ¹Ù„ÙŠÙ‚</span>
                        </div>
                        <div class="action-item">
                            ğŸ‘ï¸ <span>${post.viewedBy?.length || 0}</span>
                        </div>
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
    window.toggleText = (id) => {
        const p = document.getElementById(`text-${id}`);
        const isOpening = p.style.display !== 'block';
        p.style.display = isOpening ? 'block' : 'none';
        if (isOpening) updateDoc(doc(db, "News", id), { viewedBy: arrayUnion(userUID) });
    };

    window.toggleMenu = (id) => {
        const m = document.getElementById(`menu-${id}`);
        const isOpen = m.style.display === 'flex';
        document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
        m.style.display = isOpen ? 'none' : 'flex';
        
        if (!isOpen) {
            setTimeout(() => {
                window.onclick = () => { m.style.display = 'none'; window.onclick = null; };
            }, 100);
        }
    };

    window.doLike = async (id, liked) => {
        await updateDoc(doc(db, "News", id), { likedBy: liked ? arrayRemove(userUID) : arrayUnion(userUID) });
    };

    window.doAction = async (id, type, current) => {
        if (type === 'delete' && confirm('Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŒ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) await deleteDoc(doc(db, "News", id));
        if (type === 'toggleVis') await updateDoc(doc(db, "News", id), { visible: !current });
    };

    window.handleLogout = () => { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(()=>location.reload()); };

    window.zoomImg = (src) => {
        const v = document.createElement('div');
        v.style = "position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:10px;";
        v.innerHTML = `<img src="${src}" style="max-width:100%; max-height:80%; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.5);">`;
        v.onclick = () => v.remove();
        document.body.appendChild(v);
    };

</script>
</body>
</html>
