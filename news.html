<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #28a745; --unread: #e74c3c; --green: #2ecc71; --whatsapp: #25D366; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: #f4f7f6; padding-bottom: 70px; }
        
        #adminLink { display: none; background: #e74c3c; color: white; padding: 10px; border-radius: 50%; width: 40px; height: 40px; text-align: center; line-height: 40px; position: fixed; top: 20px; left: 20px; z-index: 2000; text-decoration: none; font-size: 20px; }
        #notificationBar { display: none; padding: 12px; text-align: center; font-weight: bold; color: white; position: sticky; top: 0; z-index: 1500; }
        
        .news-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 5px solid var(--primary); }
        .news-actions { display: flex; gap: 15px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .action-btn { background: none; border: none; cursor: pointer; font-size: 14px; display: flex; align-items: center; gap: 5px; color: #666; }
        .action-btn.liked { color: #e74c3c; }
        .share-wa { color: var(--whatsapp) !important; font-weight: bold; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; font-size: 12px; flex: 1; position: relative; }
        .badge { position: absolute; top: -5px; right: 25%; background: var(--unread); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; display: none; border: 2px solid white; }

        .chat-popup { display: none; position: fixed; inset: 0; background: white; z-index: 2001; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; }
    </style>
</head>
<body id="appBody">

    <a href="admin.html" id="adminLink">âš™ï¸</a>
    <div id="notificationBar"></div>

    <main>
        <section id="newsSection" class="active-section">
            <h2>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
            <div id="newsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </section>

        <section id="chatsSection" style="display:none;">
            <h2>Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h2>
            <div id="onlineUsers"></div>
        </section>
    </main>

    <div id="chatPopup" class="chat-popup">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span id="chatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
        </div>
        <div id="chatMessages"></div>
        <div style="padding:10px; display:flex; border-top:1px solid #ddd;">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
            <button id="sendBtn" style="background:none; border:none; font-size:24px;">â¤</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchSection('news')"><i>ğŸ“°</i><span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span></div>
        <div class="nav-item" onclick="switchSection('chats')">
            <i>ğŸ’¬</i><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <span id="totalUnreadBadge" class="badge">0</span>
        </div>
        <div class="nav-item" onclick="location.href='profile.html'"><i>ğŸ‘¤</i><span>Ù…Ù„ÙÙŠ</span></div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp, updateDoc, increment, arrayUnion, arrayRemove, collectionGroup, where, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let settings = { likesEnabled: true, shareEnabled: true };

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const sSnap = await getDoc(doc(db, "Settings", "global"));
                if(sSnap.exists()) settings = sSnap.data();

                const uSnap = await getDoc(doc(db, "Users", user.uid));
                if (uSnap.data().role === 'admin') document.getElementById('adminLink').style.display = 'block';
                
                loadNews();
                trackUnread();
            } else { window.location.href = "index.html"; }
        });

        // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ ÙˆØ§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
        window.toggleLike = async (newsId, isLiked) => {
            const ref = doc(db, "News", newsId);
            if (isLiked) {
                await updateDoc(ref, { likes: increment(-1), likedBy: arrayRemove(auth.currentUser.uid) });
            } else {
                await updateDoc(ref, { likes: increment(1), likedBy: arrayUnion(auth.currentUser.uid) });
            }
        };

        window.shareNews = (title, body) => {
            const text = `*${title}*\n${body}\n\n_ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ù…Ù† ØªØ·Ø¨ÙŠÙ‚Ù†Ø§_`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank');
        };

        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    const isLiked = n.likedBy?.includes(auth.currentUser.uid);
                    list.innerHTML += `
                        <div class="news-card">
                            <h4>${n.title}</h4>
                            <p>${n.body}</p>
                            <div class="news-actions">
                                ${settings.likesEnabled ? `
                                    <button class="action-btn ${isLiked?'liked':''}" onclick="toggleLike('${d.id}', ${isLiked})">
                                        â¤ï¸ ${n.likes || 0}
                                    </button>` : ''}
                                ${settings.shareEnabled ? `
                                    <button class="action-btn share-wa" onclick="shareNews('${n.title}', '${n.body}')">
                                        ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨
                                    </button>` : ''}
                            </div>
                        </div>`;
                });
            });
        }

        // [Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ÙˆØ§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ØªØ¸Ù„ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©...]
        window.switchSection = (id) => {
            document.getElementById('newsSection').style.display = id === 'news' ? 'block' : 'none';
            document.getElementById('chatsSection').style.display = id === 'chats' ? 'block' : 'none';
        };

        function trackUnread() {
            const q = query(collectionGroup(db, 'messages'), where('uid', '!=', auth.currentUser.uid), where('read', '==', false));
            onSnapshot(q, (snap) => {
                let count = 0;
                snap.forEach(d => { if (d.ref.path.includes(auth.currentUser.uid)) count++; });
                document.getElementById('totalUnreadBadge').innerText = count;
                document.getElementById('totalUnreadBadge').style.display = count > 0 ? 'block' : 'none';
            });
        }
    </script>
</body>
</html>
