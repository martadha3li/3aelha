<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <style>
        :root {
            --primary: #007AFF;
            --bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1C1C1E;
            --text-sub: #8E8E93;
            --shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding-bottom: 120px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ø§Ø¦Ù… */
            direction: rtl;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .header {
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-actions { display: flex; gap: 12px; }
        .action-icon { 
            font-size: 18px; 
            background: #F2F2F7; 
            width: 40px; 
            height: 40px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 12px; 
            cursor: pointer;
            text-decoration: none;
            color: #1c1c1e;
        }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± */
        .news-container { padding: 15px; }
        
        .news-card {
            background: var(--card-bg);
            border-radius: 20px;
            display: flex;
            padding: 12px;
            gap: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: 0.2s;
            border: 0.5px solid #eee;
        }

        .news-card:active { transform: scale(0.98); }

        .news-img {
            width: 100px;
            height: 100px;
            border-radius: 16px;
            object-fit: cover;
            background: #eee;
        }

        .news-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .news-title {
            font-size: 15.5px;
            font-weight: 800;
            margin: 0;
            line-height: 1.4;
            color: var(--text-main);
        }

        .news-stats { display: flex; gap: 8px; font-size: 11px; color: var(--text-sub); margin-top: 10px; }
        .stat { background: #F2F2F7; padding: 4px 8px; border-radius: 8px; font-weight: 600; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù… (Ø§Ù„Ù…Ù†ÙØµÙ„ ÙˆØ§Ù„Ù…Ù†Ø­Ù†ÙŠ) */
        .bottom-nav-wrapper {
            position: fixed;
            bottom: 25px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            z-index: 3000;
        }

        .bottom-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            align-items: center;
            width: 100%;
            max-width: 500px;
            height: 68px;
            border-radius: 24px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.18);
            border: 1px solid rgba(255,255,255,0.4);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #8E8E93;
            flex: 1;
            transition: 0.2s;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 22px; }
        .nav-label { font-size: 9px; font-weight: bold; margin-top: 3px; }

        .hidden { display: none !important; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø®Ø¨Ø± */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            z-index: 4000;
            align-items: flex-end;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            width: 100%;
            max-width: 500px;
            border-radius: 32px 32px 0 0;
            padding: 25px;
            max-height: 85vh;
            overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    </style>
</head>
<body>

    <header class="header">
        <div class="header-actions">
            <a href="add_news.html" class="action-icon">â•</a>
            <a href="admin.html" class="action-icon">âš™ï¸</a>
        </div>
        <img src="logo.png" style="height: 35px;" onerror="this.style.display='none'">
        <div class="header-actions">
            <div class="action-icon" onclick="handleLogout()">ğŸšª</div>
        </div>
    </header>

    <main class="news-container" id="newsFeed">
        <div style="text-align:center; padding:50px; color:#999;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©...</div>
    </main>

    <div class="bottom-nav-wrapper">
        <nav class="bottom-nav">
            <a href="news.html" class="nav-item active">
                <span class="nav-icon">ğŸ </span><span class="nav-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>
            
            <a href="duas.html" id="nav-duas" class="nav-item">
                <span class="nav-icon">ğŸ“–</span><span class="nav-label">Ø§Ù„Ø£Ø¯Ø¹ÙŠØ©</span>
            </a>

            <a href="chat.html" id="nav-chat" class="nav-item">
                <span class="nav-icon">ğŸ’¬</span><span class="nav-label">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            </a>

            <a href="prayer_times.html" id="nav-prayer" class="nav-item">
                <span class="nav-icon">ğŸ•Œ</span><span class="nav-label">Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</span>
            </a>

            <a href="profile.html" class="nav-item">
                <span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Ø­Ø³Ø§Ø¨ÙŠ</span>
            </a>
        </nav>
    </div>

    <div id="postModal" class="modal" onclick="if(event.target==this)this.style.display='none'">
        <div class="modal-content" id="postModalContent"></div>
    </div>

    <script type="module">
        import { db, auth } from './config.js';
        import { collection, onSnapshot, doc, updateDoc, increment, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const feed = document.getElementById('newsFeed');

        // 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø±ÙˆØ¬
        window.handleLogout = () => {
            if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) {
                auth.signOut().then(() => location.href = 'index.html');
            }
        };

        // 2. Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¸Ù‡ÙˆØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
        onSnapshot(doc(db, "Settings", "AppConfig"), (snap) => {
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('nav-chat')?.classList.toggle('hidden', data.showChat === false);
                document.getElementById('nav-duas')?.classList.toggle('hidden', data.showDuas === false);
                document.getElementById('nav-prayer')?.classList.toggle('hidden', data.showPrayer === false);
            }
        });

        // 3. Ø¥ØµÙ„Ø§Ø­ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± (Ø§Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„)
        const fetchNews = () => {
            // Ù†Ø³ØªØ®Ø¯Ù… onSnapshot Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­ÙŠØ©ØŒ Ù„ÙƒÙ†Ù†Ø§ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙƒØ§Ù…Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø£Ø®Ø·Ø§Ø¡ Index
            onSnapshot(collection(db, "Posts"), (snap) => {
                feed.innerHTML = "";
                
                if (snap.empty) {
                    feed.innerHTML = `
                        <div style="text-align:center; padding:50px;">
                            <p style="color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø¨Ø§Ø± Ù…Ù†Ø´ÙˆØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Posts</p>
                        </div>`;
                    return;
                }

                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Firebase Index)
                let allPosts = [];
                snap.forEach(doc => {
                    allPosts.push({ id: doc.id, ...doc.data() });
                });

                // ØªØ±ØªÙŠØ¨ ÙŠØ¯ÙˆÙŠ: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ timestamp Ø£Ùˆ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…ØªØ§Ø­)
                allPosts.sort((a, b) => {
                    const timeA = a.timestamp?.seconds || a.date || 0;
                    const timeB = b.timestamp?.seconds || b.date || 0;
                    return timeB - timeA;
                });

                allPosts.forEach((d) => {
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.onclick = () => openPost(d.id, d);
                    
                    card.innerHTML = `
                        <img src="${d.imageUrl || 'https://via.placeholder.com/100'}" class="news-img">
                        <div class="news-info">
                            <h2 class="news-title">${d.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h2>
                            <div class="news-stats">
                                <span class="stat">â¤ï¸ ${d.likes || 0}</span>
                                <span class="stat">ğŸ’¬ ${d.commentsCount || 0}</span>
                                <span class="stat">ğŸ‘ï¸ ${d.views || 0}</span>
                            </div>
                        </div>
                    `;
                    feed.appendChild(card);
                });
            }, (err) => {
                console.error("Firestore Error:", err);
                feed.innerHTML = `<p style="color:red; text-align:center; padding:20px;">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ${err.message}</p>`;
            });
        };

        // 4. ÙØªØ­ Ø§Ù„Ø®Ø¨Ø± ÙˆØ²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
        window.openPost = (id, d) => {
            updateDoc(doc(db, "Posts", id), { views: increment(1) }).catch(e => console.log("Views update failed"));
            
            const modal = document.getElementById('postModal');
            document.getElementById('postModalContent').innerHTML = `
                <img src="${d.imageUrl}" style="width:100%; border-radius:20px; margin-bottom:15px; max-height:280px; object-fit:cover;">
                <h2 style="margin:0 0 10px 0; font-size:20px;">${d.title}</h2>
                <p style="line-height:1.7; color:#333; font-size:15px; white-space:pre-wrap;">${d.content}</p>
                
                <div style="margin-top:25px; padding-top:15px; border-top:1px solid #eee;">
                    <button onclick="location.href='comments.html?id=${id}'" 
                            style="width:100%; padding:16px; background:var(--primary); color:white; border:none; border-radius:18px; font-weight:bold; font-size:15px; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px;">
                        <span>Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span> ğŸ’¬
                    </button>
                </div>
            `;
            modal.style.display = 'flex';
        };

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ù„Ø¨
        fetchNews();

    </script>
</body>
</html>
