<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --gold: #ffc107; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .news-card { background: white; margin: 12px; border-radius: 15px; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .news-img { width: 100px; height: 100px; object-fit: cover; }
        .overlay-full { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .chat-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="top-bar">
        <button onclick="signOutNow()" style="background:none; border:none; font-size:22px;">ğŸšª</button>
        <div id="starBC" style="color:var(--gold); font-size:24px; display:none; cursor:pointer;" onclick="alert(bcMsg)">â­</div>
        <span id="userPerms" style="font-size:12px; font-weight:bold; color:var(--primary);"></span>
        <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <div id="newsContainer"></div>

    <div id="chatOverlay" class="overlay-full">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
            <button onclick="toggleChat(false)" style="color:white; background:none; border:none; font-size:24px;">âœ•</button>
        </div>
        <div style="padding:10px; flex:1; overflow-y:auto;">
            <div class="chat-item" onclick="openChat('Messages', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')">ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <h4 style="margin:10px;">Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙƒ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</h4>
            <div id="tempGroupsArea"></div>
            <h4 style="margin:10px;">Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</h4>
            <input type="number" id="pSearch" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <button onclick="searchPrivate()" style="width:100%; margin-top:5px; padding:10px; background:var(--primary); color:white; border:none; border-radius:10px;">Ø¨Ø­Ø« ÙˆØ¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø©</button>
            <div id="prevChats"></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="location.reload()">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div onclick="toggleChat(true)">ğŸ’¬<br>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div onclick="location.href='profile.html'">ğŸ‘¤<br>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let userUID, userData, bcMsg;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                if(userData.role === 'admin') document.getElementById('userPerms').innerText = "Ø§Ù„Ù…Ø¯ÙŠØ±";
                loadNews();
                loadGroups();
                checkStar();
            } else { window.location.href = "index.html"; }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© ÙÙ‚Ø·
        function loadGroups() {
            onSnapshot(collection(db, "TempGroups"), (snap) => {
                const area = document.getElementById('tempGroupsArea');
                area.innerHTML = "";
                snap.forEach(d => {
                    const g = d.data();
                    const isAllowed = g.targetType === 'all' || (g.allowedUsers && g.allowedUsers.includes(userUID));
                    if(g.expiry > Date.now() && !g.disabled && isAllowed) {
                        area.innerHTML += `<div class="chat-item" onclick="openChat('TempGroups/${d.id}/messages', '${g.name}')">ğŸ‘¥ ${g.name}</div>`;
                    }
                });
            });
        }

        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    container.innerHTML += `
                        <div class="news-card">
                            <img src="${n.img || 'https://via.placeholder.com/100'}" class="news-img">
                            <div style="padding:10px;">
                                <h3 style="margin:0; font-size:15px;">${n.title}</h3>
                                <div style="font-size:11px; color:#888;">ğŸ•Šï¸ ${n.likes} | ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
                            </div>
                        </div>`;
                });
            });
        }

        window.toggleChat = (show) => document.getElementById('chatOverlay').style.display = show ? 'flex' : 'none';
        window.signOutNow = () => auth.signOut();
        // (Ø¨Ù‚ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© ØªØªØ¨Ø¹ Ù†ÙØ³ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
    </script>
</body>
</html>
