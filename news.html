<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --twitter-blue: #1DA1F2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .star-bc { color: #ffc107; font-size: 24px; cursor: pointer; display: none; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
        .pop-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .pop-card { width: 85%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; }
        .pop-white { background: white; } .pop-red { background: var(--danger); color: white; } .pop-green { background: var(--accent); color: white; }

        /* Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ± */
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; display: flex; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .news-img { width: 100px; height: 100px; object-fit: cover; }
        .news-info { padding: 10px; flex: 1; }
        .news-meta { font-size: 11px; color: #888; margin-top: 5px; display: flex; gap: 10px; align-items: center; }

        /* Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± */
        #newsEditor { display: none; position: fixed; inset: 0; background: white; z-index: 9000; flex-direction: column; padding: 20px; overflow-y: auto; }
        input, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
    </style>
</head>
<body>

    <div id="loginPopupOverlay" class="pop-overlay">
        <div id="loginPopupCard" class="pop-card">
            <p id="popMsg"></p>
            <button onclick="window.closePopup()" style="margin-top:15px; padding:10px 20px; border-radius:20px; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="newsEditor">
        <h2>Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
        <input type="file" id="newsImgInp" accept="image/*">
        <input type="text" id="newsTitleInp" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
        <textarea id="newsBodyInp" rows="6" placeholder="Ù†Øµ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
        <button class="btn" style="background:var(--accent); color:white; width:100%; padding:15px;" id="saveNewsBtn">Ø¨Ø« Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¢Ù†</button>
        <button onclick="window.closeNewsEditor()" style="width:100%; margin-top:10px; border:none; background:none; color:red;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div class="top-bar">
        <button id="logoutBtn" style="background:none; border:none; font-size:20px;">ğŸšª</button>
        <div id="broadcastStar" class="star-bc" onclick="window.showBC()">â­</div>
        <div id="adminTools" style="display:none;">
            <button onclick="window.openNewsEditor()" style="background:var(--primary); color:white; border:none; padding:5px 10px; border-radius:15px; font-size:11px;">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</button>
        </div>
        <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <div id="newsContainer"></div>

    <nav class="bottom-nav">
        <div onclick="location.reload()">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div onclick="window.toggleChat()">ğŸ’¬<br>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div onclick="location.href='profile.html'">ğŸ‘¤<br>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let userUID, userData, newsImgBase64 = "";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                if(userData.role === 'admin' || userData.canAdd) document.getElementById('adminTools').style.display = 'block';
                loadNews();
                checkPopup();
                checkStar();
            } else { window.location.href = "index.html"; }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const container = document.getElementById('newsContainer');
                container.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.innerHTML = `
                        <img src="${n.img || 'https://via.placeholder.com/100'}" class="news-img">
                        <div class="news-info">
                            <h3 style="margin:0; font-size:15px;">${n.title}</h3>
                            <div class="news-meta">
                                <span>ğŸ•Šï¸ ${n.likes || 0}</span>
                                <span>ğŸ’¬ <span id="commCount-${d.id}">0</span></span>
                                <span>ğŸ“… ${n.date?.toDate().toLocaleDateString('ar-SA')}</span>
                            </div>
                        </div>`;
                    container.appendChild(card);
                    // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                    onSnapshot(collection(db, `News/${d.id}/Comments`), (s) => {
                        document.getElementById(`commCount-${d.id}`).innerText = s.size;
                    });
                });
            });
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø®Ø¨Ø±
        window.openNewsEditor = () => document.getElementById('newsEditor').style.display = 'flex';
        window.closeNewsEditor = () => document.getElementById('newsEditor').style.display = 'none';

        document.getElementById('newsImgInp').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => newsImgBase64 = reader.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('saveNewsBtn').onclick = async () => {
            const t = document.getElementById('newsTitleInp').value;
            const b = document.getElementById('newsBodyInp').value;
            if(!t || !b) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            await addDoc(collection(db, "News"), {
                title: t, body: b, img: newsImgBase64,
                likes: 0, likedBy: [], date: serverTimestamp()
            });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
            location.reload();
        };

        // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ (Ù„Ù„Ù…Ø±Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©)
        function checkPopup() {
            onSnapshot(doc(db, "Settings", "loginPopup"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    if(d.expiry > Date.now() && localStorage.getItem('last_pop_id') !== d.id) {
                        document.getElementById('popMsg').innerText = d.message;
                        document.getElementById('loginPopupCard').className = `pop-card pop-${d.type}`;
                        document.getElementById('loginPopupOverlay').style.display = 'flex';
                        localStorage.setItem('last_pop_id', d.id);
                    }
                }
            });
        }
        window.closePopup = () => document.getElementById('loginPopupOverlay').style.display = 'none';

        function checkStar() {
            onSnapshot(doc(db, "Settings", "broadcast"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    const match = (d.targetGender === 'all' || d.targetGender === userData.gender) && (d.expiry > Date.now());
                    document.getElementById('broadcastStar').style.display = match ? 'block' : 'none';
                    window.bcMsg = d.message;
                }
            });
        }
        window.showBC = () => alert("ğŸ“¢ " + window.bcMsg);
        document.getElementById('logoutBtn').onclick = () => signOut(auth);
    </script>
</body>
</html>
