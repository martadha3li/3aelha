<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --twitter-blue: #1DA1F2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .admin-nav { display: none; background: white; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; justify-content: space-around; }
        .admin-btn { border: none; background: #eee; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; display: flex; }
        .news-img-thumb { width: 110px; height: 110px; object-fit: cover; }
        .news-brief { padding: 10px; flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .news-brief h3 { margin: 0; font-size: 15px; color: var(--primary); }
        .news-meta-mini { font-size: 11px; color: #888; display: flex; gap: 10px; margin-top: 5px; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-height: 92vh; border-radius: 25px 25px 0 0; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .full-img { width: 100%; max-height: 250px; object-fit: cover; }
        .content-area { padding: 20px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„ (Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·ÙŠØ±) */
        .reaction-bar { display: flex; align-items: center; gap: 20px; padding: 15px 0; border-top: 1px solid #eee; margin-top: 15px; }
        .bird-btn { background: none; border: none; cursor: pointer; font-size: 24px; color: #ccc; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .bird-btn.active { color: var(--twitter-blue); }
        .share-wa-btn { background: #25D366; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; font-weight: bold; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        
        /* Ù…Ø­Ø±Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± */
        #newsEditor { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; padding: 20px; overflow-y: auto; }
    </style>
</head>
<body>

    <div id="adminNav" class="admin-nav">
        <button id="manageAppBtn" class="admin-btn" onclick="location.href='admin.html'" style="display:none">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button>
        <button id="manageNewsBtn" class="admin-btn" onclick="openNewsEditor()" style="display:none">â• Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    </div>

    <main id="newsList">
        <h2 style="padding: 15px 15px 0 15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        </main>

    <div id="newsEditor">
        <h2>Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
        <input type="file" id="newsImgInput" accept="image/*">
        <input type="text" id="newsTitleInp" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
        <textarea id="newsBodyInp" rows="6" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
        <button class="admin-btn" style="background:var(--accent); color:white; width:100%; padding:15px; margin-top:10px;" id="saveNewsBtn">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±</button>
        <button class="admin-btn" style="background:var(--danger); color:white; width:100%; margin-top:10px;" onclick="closeNewsEditor()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="fullNewsModal" class="modal">
        <div class="modal-content">
            <img id="fnImg" class="full-img">
            <div class="content-area">
                <h2 id="fnTitle" style="margin:0;"></h2>
                <small id="fnDate" style="color:#888;"></small>
                <p id="fnBody" style="line-height:1.7; white-space:pre-wrap; color:#333; margin-top:15px;"></p>
                
                <div class="reaction-bar">
                    <button id="birdLikeBtn" class="bird-btn">ğŸ•Šï¸ <span id="fnLikeCount" style="font-size:14px; color:#555;">0</span></button>
                    <button id="waShareBtn" class="share-wa-btn">ğŸŸ¢ Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨</button>
                </div>

                <div id="commentsWrapper">
                    <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
                    <div id="commentsList"></div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <input type="text" id="commInp" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹..." style="flex:1; padding:10px; border-radius:20px; border:1px solid #ddd;">
                        <button id="sendCommBtn" style="border:none; background:none; font-size:22px; cursor:pointer;">â¤</button>
                    </div>
                </div>
                <button onclick="closeFullNews()" style="width:100%; margin-top:20px; padding:10px; border:none; background:#eee; border-radius:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="location.reload()" style="color:var(--primary); font-weight:bold; cursor:pointer;">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div onclick="window.toggleChat()" style="cursor:pointer;">ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div onclick="location.href='profile.html'" style="cursor:pointer;">ğŸ‘¤ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let userUID = null;
        let userData = null;
        let newsPhotoBase64 = "";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                checkPermissions();
                loadNews();
            } else { window.location.href = "index.html"; }
        });

        // ÙØ­Øµ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª
        function checkPermissions() {
            const adminNav = document.getElementById('adminNav');
            const manageApp = document.getElementById('manageAppBtn');
            const manageNews = document.getElementById('manageNewsBtn');

            if (userData.role === 'admin') {
                adminNav.style.display = 'flex';
                manageApp.style.display = 'block';
                manageNews.style.display = 'block';
            } else if (userData.canAdd || userData.canEdit || userData.canDelete) {
                adminNav.style.display = 'flex';
                manageNews.style.display = 'block';
            }
        }

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© Ù…Ø¹ Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = `<h2 style="padding:15px 15px 0 15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>`;
                snap.forEach(async (d) => {
                    const n = d.data();
                    // Ø¬Ù„Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (ÙØ±Ø¹ÙŠ)
                    const commSnap = await getDoc(doc(db, "News", d.id)); // ØªØ¨Ø³ÙŠØ· Ù„Ù„Ø¹Ø¯Ø§Ø¯
                    
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.onclick = () => openFullNews(d.id);
                    card.innerHTML = `
                        <img src="${n.img || 'https://via.placeholder.com/110'}" class="news-img-thumb">
                        <div class="news-brief">
                            <h3>${n.title}</h3>
                            <div class="news-meta-mini">
                                <span>ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ø§Øª: <span id="commCount-${d.id}">0</span></span>
                                <span>ğŸ•Šï¸ Ø¥Ø¹Ø¬Ø§Ø¨: ${n.likes || 0}</span>
                                <span>ğŸ“… ${n.date?.toDate().toLocaleDateString('ar-SA')}</span>
                            </div>
                        </div>`;
                    list.appendChild(card);
                    countComments(d.id);
                });
            });
        }

        function countComments(id) {
            onSnapshot(collection(db, `News/${id}/Comments`), (s) => {
                const el = document.getElementById(`commCount-${id}`);
                if(el) el.innerText = s.size;
            });
        }

        // ÙØªØ­ Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
        window.openFullNews = async (id) => {
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            const isLiked = n.likedBy?.includes(userUID);

            document.getElementById('fnImg').src = n.img || '';
            document.getElementById('fnTitle').innerText = n.title;
            document.getElementById('fnBody').innerText = n.body;
            document.getElementById('fnDate').innerText = n.date?.toDate().toLocaleString('ar-SA');
            document.getElementById('fnLikeCount').innerText = n.likes || 0;
            
            const bird = document.getElementById('birdLikeBtn');
            bird.className = isLiked ? 'bird-btn active' : 'bird-btn';
            bird.onclick = () => handleLike(id, isLiked);

            document.getElementById('waShareBtn').onclick = () => {
                const shareText = `*${n.title}*\n${n.body.substring(0,100)}...\n\nØ±Ø§Ø¨Ø· Ø§Ù„Ø®Ø¨Ø± Ø¹Ù„Ù‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:\n${window.location.origin}/news.html?id=${id}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(shareText)}`, '_blank');
            };

            document.getElementById('fullNewsModal').style.display = 'flex';
            loadFullComments(id);
            document.getElementById('sendCommBtn').onclick = () => postComment(id);
        };

        async function handleLike(id, liked) {
            const ref = doc(db, "News", id);
            await updateDoc(ref, {
                likes: increment(liked ? -1 : 1),
                likedBy: liked ? arrayRemove(userUID) : arrayUnion(userUID)
            });
            openFullNews(id); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        }

        window.closeFullNews = () => document.getElementById('fullNewsModal').style.display = 'none';
        window.openNewsEditor = () => document.getElementById('newsEditor').style.display = 'flex';
        window.closeNewsEditor = () => document.getElementById('newsEditor').style.display = 'none';

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØ±
        document.getElementById('newsImgInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => newsPhotoBase64 = reader.result;
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('saveNewsBtn').onclick = async () => {
            const t = document.getElementById('newsTitleInp').value;
            const b = document.getElementById('newsBodyInp').value;
            if(!t || !b) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            await addDoc(collection(db, "News"), {
                title: t, body: b, img: newsPhotoBase64,
                likes: 0, likedBy: [], date: serverTimestamp()
            });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
            location.reload();
        };

        function loadFullComments(id) {
            onSnapshot(query(collection(db, `News/${id}/Comments`), orderBy("time", "asc")), (snap) => {
                const l = document.getElementById('commentsList');
                l.innerHTML = "";
                snap.forEach(d => {
                    l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; font-size:13px;"><b>${d.data().userName}:</b> ${d.data().text}</div>`;
                });
            });
        }

        async function postComment(id) {
            const inp = document.getElementById('commInp');
            if(!inp.value) return;
            await addDoc(collection(db, `News/${id}/Comments`), {
                text: inp.value, userName: userData.fullName, uid: userUID, time: serverTimestamp()
            });
            inp.value = "";
        }
    </script>
</body>
</html>
