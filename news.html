<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --unread: #e74c3c; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; overflow-x: hidden; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯ÙŠØ± */
        #adminLink { display: none; background: var(--unread); color: white; padding: 10px; border-radius: 50%; width: 45px; height: 45px; text-align: center; line-height: 45px; position: fixed; top: 15px; left: 15px; z-index: 2000; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
        .news-item { background: white; margin: 12px; padding: 15px; border-radius: 12px; shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-right: 5px solid var(--primary); }
        .news-item h3 { margin: 0 0 8px 0; font-size: 18px; color: var(--primary); }
        .news-item p { margin: 0; color: #666; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø®Ø¨Ø± Ø§Ù„ÙƒØ§Ù…Ù„ */
        .full-news-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: flex-end; }
        .full-news-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .news-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .news-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„ */
        .interaction-bar { display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .act-btn { background: none; border: none; font-size: 14px; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comments-area { padding: 15px; background: #f9f9f9; }
        .comm-card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; position: relative; }
        .comm-user { font-weight: bold; color: var(--primary); margin-bottom: 3px; }
        .comment-input-wrap { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; }
        .comment-input-wrap input { flex: 1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 20px; outline: none; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ - 3 Ø®ÙŠØ§Ø±Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; flex: 1; position: relative; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; font-style: normal; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .badge { position: absolute; top: -5px; right: 20%; background: var(--unread); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }

        /* Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-overlay { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; }
    </style>
</head>
<body>

    <a href="admin.html" id="adminLink">âš™ï¸</a>

    <main>
        <div id="newsSection">
            <h2 style="padding: 15px 15px 0 15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
            <div id="newsList"></div>
        </div>
    </main>

    <div id="fullNewsOverlay" class="full-news-overlay">
        <div class="full-news-content">
            <div class="news-header">
                <h2 id="fnTitle" style="margin:0; font-size:18px;"></h2>
                <button onclick="closeFullNews()" style="background:none; border:none; font-size:24px;">âœ•</button>
            </div>
            <div class="news-scroll">
                <p id="fnBody" style="line-height:1.6; color:#333; white-space: pre-wrap;"></p>
                <div class="interaction-bar">
                    <button class="act-btn" id="likeBtn">â¤ï¸ <span id="likeCount">0</span></button>
                    <button class="act-btn" id="shareBtn">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨</button>
                </div>
                <div class="comments-area">
                    <h4 style="margin-top:0;">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
                    <div id="commentsList"></div>
                </div>
            </div>
            <div class="comment-input-wrap">
                <input type="text" id="newCommentInput" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹...">
                <button id="sendCommentBtn" style="background:none; border:none; color:var(--primary); font-size:22px; margin-right:10px;">â¤</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()">
            <i>ğŸ“°</i><span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
        </div>

        <div class="nav-item" onclick="toggleChatList()">
            <i>ğŸ’¬</i><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <span id="unreadCount" class="badge" style="display:none;">0</span>
        </div>

        <div class="nav-item" onclick="location.href='profile.html'">
            <i>ğŸ‘¤</i><span>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span>
        </div>
    </nav>

    <div id="chatListOverlay" class="chat-overlay" style="background:#f4f7f6;">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
            <button onclick="toggleChatList()" style="color:white; background:none; border:none; font-size:20px;">âœ•</button>
        </div>
        <div style="padding:15px;">
            <div class="news-item" onclick="openChat('public', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')">ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <div class="news-item" onclick="showGroups()">ğŸ‘¥ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ù‚Ø§Ø´</div>
            <div class="news-item" onclick="showPrivateUsers()">ğŸ“© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø§ØµØ©</div>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp, updateDoc, increment, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUserId = null;
        let activeNewsId = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                if (snap.data().role === 'admin') document.getElementById('adminLink').style.display = 'block';
                loadNews();
            } else { window.location.href = "index.html"; }
        });

        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ø®ØªØµØ±Ø©
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    list.innerHTML += `
                        <div class="news-item" onclick="openFullNews('${d.id}')">
                            <h3>${n.title}</h3>
                            <p>${n.body}</p>
                        </div>`;
                });
            });
        }

        // ÙØªØ­ Ø§Ù„Ø®Ø¨Ø± ÙƒØ§Ù…Ù„Ø§Ù‹
        window.openFullNews = async (id) => {
            activeNewsId = id;
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            
            document.getElementById('fnTitle').innerText = n.title;
            document.getElementById('fnBody').innerText = n.body;
            document.getElementById('likeCount').innerText = n.likes || 0;
            document.getElementById('fullNewsOverlay').style.display = 'flex';
            
            loadComments(id);
            
            // Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
            document.getElementById('likeBtn').onclick = () => toggleLike(id, n.likedBy?.includes(currentUserId));
            // Ø²Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
            document.getElementById('shareBtn').onclick = () => shareOnWhatsApp(n.title, n.body);
            // Ø²Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
            document.getElementById('sendCommentBtn').onclick = () => postComment(id);
        };

        window.closeFullNews = () => {
            document.getElementById('fullNewsOverlay').style.display = 'none';
        };

        async function toggleLike(id, isLiked) {
            const ref = doc(db, "News", id);
            await updateDoc(ref, {
                likes: increment(isLiked ? -1 : 1),
                likedBy: isLiked ? arrayRemove(currentUserId) : arrayUnion(currentUserId)
            });
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            const snap = await getDoc(ref);
            document.getElementById('likeCount').innerText = snap.data().likes;
        }

        function shareOnWhatsApp(title, body) {
            const text = `*${title}*\n${body}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        async function postComment(newsId) {
            const input = document.getElementById('newCommentInput');
            if (!input.value.trim()) return;
            const uSnap = await getDoc(doc(db, "Users", currentUserId));
            await addDoc(collection(db, `News/${newsId}/Comments`), {
                text: input.value,
                userName: uSnap.data().fullName,
                uid: currentUserId,
                time: serverTimestamp()
            });
            input.value = "";
        }

        function loadComments(newsId) {
            onSnapshot(query(collection(db, `News/${newsId}/Comments`), orderBy("time", "asc")), (snap) => {
                const list = document.getElementById('commentsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `
                        <div class="comm-card">
                            <div class="comm-user">${c.userName}</div>
                            <div>${c.text}</div>
                        </div>`;
                });
            });
        }

        window.toggleChatList = () => {
            const el = document.getElementById('chatListOverlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        // Ù…Ù„Ø§Ø­Ø¸Ø©: ÙˆØ¸Ø§Ø¦Ù openChat Ùˆ showGroups ÙŠØªÙ… Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªÙŠ Ø¨Ø±Ù…Ø¬Ù†Ø§Ù‡Ø§ Ø³Ø§Ø¨Ù‚Ø§Ù‹
    </script>
</body>
</html>
