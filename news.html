<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <img src="logo.png" style="height: 35px; border-radius: 8px;">
            <span style="font-weight:bold; color:var(--primary);">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span>
        </div>
        <div>
            <button id="adminLink" style="display:none; border:none; background:none; font-size:22px;" onclick="location.href='admin.html'">âš™ï¸</button>
            <button onclick="handleLogout()" style="border:none; background:none; font-size:22px;">ğŸšª</button>
        </div>
    </div>

    <div id="newsFeed"></div>

    <button id="addNewsBtn" class="floating-btn" onclick="location.href='add_news.html'" style="display:none;">+</button>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item active"><span class="nav-icon">ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a>
        <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userUID, userData;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            if (userData.role === 'admin' || userData.role === 'editor') {
                document.getElementById('addNewsBtn').style.display = 'block';
                if(userData.role === 'admin') document.getElementById('adminLink').style.display = 'block';
            }
            loadFeed();
        } else { window.location.href = "index.html"; }
    });

    function loadFeed() {
        onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
            const feed = document.getElementById('newsFeed');
            feed.innerHTML = "";
            snap.forEach((d) => {
                const n = d.data();
                const canControl = (userUID === n.authorId) || (userData.role === 'admin');
                feed.innerHTML += `
                    <div class="news-card">
                        <div class="news-body-content">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                                <img src="${n.authorImg || 'https://via.placeholder.com/40'}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                                <div><b>${n.authorName}</b><br><small style="color:var(--text-muted)">${n.category || 'Ø¹Ø§Ù…'}</small></div>
                            </div>
                            <h3 style="margin:0 0 10px 0;">${n.title}</h3>
                        </div>
                        <img src="${n.img}" class="news-img-main">
                        <div class="news-body-content">
                            <p>${n.body}</p>
                            <div style="display:flex; justify-content:space-between; margin-top:15px;">
                                <span style="color:var(--primary); font-weight:bold;">â¤ï¸ ${n.likes || 0}</span>
                                ${canControl ? `<button onclick="deleteNews('${d.id}')" style="color:var(--danger); border:none; background:none; font-weight:bold; cursor:pointer;">ğŸ—‘ï¸ Ø­Ø°Ù</button>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        });
    }

    window.deleteNews = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ")) await deleteDoc(doc(db, "News", id)); };
    window.handleLogout = async () => { if(confirm("ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ØŸ")) { await signOut(auth); window.location.href="index.html"; } };
</script>
</body>
</html>
