<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --unread: #e74c3c; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; overflow-x: hidden; }

        /* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù…Ø¯ÙŠØ± */
        #adminLink { display: none; background: var(--unread); color: white; padding: 10px; border-radius: 50%; width: 45px; height: 45px; text-align: center; line-height: 45px; position: fixed; top: 15px; left: 15px; z-index: 2000; text-decoration: none; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
        .news-item { background: white; margin: 12px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border-right: 5px solid var(--primary); }
        .news-item h3 { margin: 0 0 8px 0; font-size: 18px; color: var(--primary); }
        .news-item p { margin: 0; color: #666; font-size: 14px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø®Ø¨Ø± Ø§Ù„ÙƒØ§Ù…Ù„ */
        .full-news-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: flex-end; }
        .full-news-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .news-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .news-scroll { flex: 1; overflow-y: auto; padding: 20px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„ */
        .interaction-bar { display: flex; justify-content: space-around; padding: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }
        .act-btn { background: none; border: none; font-size: 14px; color: #555; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        /* Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comments-area { padding: 15px; background: #f9f9f9; }
        .comm-card { background: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
        .comm-user { font-weight: bold; color: var(--primary); margin-bottom: 3px; }
        .comment-input-wrap { display: flex; padding: 10px; background: white; border-top: 1px solid #eee; }
        .comment-input-wrap input { flex: 1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 20px; outline: none; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 8px 0; box-shadow: 0 -2px 15px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; flex: 1; position: relative; }
        .nav-item i { display: block; font-size: 20px; margin-bottom: 2px; font-style: normal; }
        .nav-item span { font-size: 11px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .badge { position: absolute; top: -5px; right: 20%; background: var(--unread); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; display: none; }

        /* Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-overlay { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; font-size: 14px; }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        .other-msg { align-self: flex-start; background: white; }
    </style>
</head>
<body>

    <a href="admin.html" id="adminLink">âš™ï¸</a>

    <main id="newsSection">
        <h2 style="padding: 15px 15px 0 15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        <div id="newsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </main>

    <div id="fullNewsOverlay" class="full-news-overlay">
        <div class="full-news-content">
            <div class="news-header">
                <h2 id="fnTitle"></h2>
                <button onclick="closeFullNews()" style="background:none; border:none; font-size:24px;">âœ•</button>
            </div>
            <div class="news-scroll">
                <p id="fnBody" style="white-space: pre-wrap;"></p>
                <div class="interaction-bar">
                    <button class="act-btn" id="likeBtn">â¤ï¸ <span id="likeCount">0</span></button>
                    <button class="act-btn" id="shareBtn">ğŸŸ¢ ÙˆØ§ØªØ³Ø§Ø¨</button>
                </div>
                <div class="comments-area">
                    <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
                    <div id="commentsList"></div>
                </div>
            </div>
            <div class="comment-input-wrap">
                <input type="text" id="newCommentInput" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ø§Ù‹...">
                <button id="sendCommentBtn" style="background:none; border:none; color:var(--primary); font-size:22px;">â¤</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()"><i>ğŸ“°</i><span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span></div>
        <div class="nav-item" onclick="toggleChatList()">
            <i>ğŸ’¬</i><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <span id="unreadBadge" class="badge">0</span>
        </div>
        <div class="nav-item" onclick="location.href='profile.html'"><i>ğŸ‘¤</i><span>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span></div>
    </nav>

    <div id="chatListOverlay" class="chat-overlay" style="background:#f4f7f6;">
        <div style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
            <button onclick="toggleChatList()" style="color:white; background:none; border:none; font-size:20px;">âœ•</button>
        </div>
        <div id="chatOptions" style="padding:15px; overflow-y:auto;">
            <div class="news-item" onclick="openChat('Messages', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')">ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</div>
            <div id="groupsArea">
                <h4 style="margin:10px;">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</h4>
                <div id="tempGroupsList"></div>
            </div>
            <div id="usersArea">
                <h4 style="margin:10px;">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø®Ø§ØµØ©</h4>
                <div id="privateUsersList"></div>
            </div>
        </div>
    </div>

    <div id="activeChatWindow" class="chat-overlay">
        <div id="activeChatHeader" style="background:var(--primary); color:white; padding:15px; display:flex; justify-content:space-between;">
            <span id="activeChatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <button onclick="closeActiveChat()" style="color:white; background:none; border:none; font-size:20px;">âœ•</button>
        </div>
        <div id="chatMessages"></div>
        <div style="padding:10px; display:flex; border-top:1px solid #ddd; background:white;">
            <input type="text" id="chatInput" style="flex:1; border:1px solid #ccc; padding:10px; border-radius:20px;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button id="sendChatMsg" style="background:none; border:none; color:var(--primary); font-size:24px;">â¤</button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp, updateDoc, increment, arrayUnion, arrayRemove, where, collectionGroup } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUserId = null;
        let currentChatPath = "";
        let chatUnsubscribe = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                if (snap.data()?.role === 'admin') document.getElementById('adminLink').style.display = 'block';
                loadNews();
                loadTempGroups();
                loadPrivateUsers();
                trackUnread();
            } else { window.location.href = "index.html"; }
        });

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ---
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const n = d.data();
                    const item = document.createElement('div');
                    item.className = 'news-item';
                    item.onclick = () => window.openFullNews(d.id);
                    item.innerHTML = `<h3>${n.title}</h3><p>${n.body}</p>`;
                    list.appendChild(item);
                });
            });
        }

        window.openFullNews = async (id) => {
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            document.getElementById('fnTitle').innerText = n.title;
            document.getElementById('fnBody').innerText = n.body;
            document.getElementById('likeCount').innerText = n.likes || 0;
            document.getElementById('fullNewsOverlay').style.display = 'flex';
            loadComments(id);

            document.getElementById('likeBtn').onclick = () => toggleLike(id, n.likedBy?.includes(currentUserId));
            document.getElementById('shareBtn').onclick = () => shareOnWA(n.title, n.body);
            document.getElementById('sendCommentBtn').onclick = () => postComment(id);
        };

        window.closeFullNews = () => document.getElementById('fullNewsOverlay').style.display = 'none';

        // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø£Ø²Ø±Ø§Ø±) ---
        window.toggleChatList = () => {
            const el = document.getElementById('chatListOverlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.openChat = (path, title) => {
            currentChatPath = path;
            document.getElementById('activeChatTitle').innerText = title;
            document.getElementById('activeChatWindow').style.display = 'flex';
            loadChatMessages(path);
        };

        window.closeActiveChat = () => {
            document.getElementById('activeChatWindow').style.display = 'none';
            if (chatUnsubscribe) chatUnsubscribe();
        };

        function loadTempGroups() {
            onSnapshot(collection(db, "TempGroups"), (snap) => {
                const list = document.getElementById('tempGroupsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const g = d.data();
                    if (g.expiry > Date.now()) {
                        const div = document.createElement('div');
                        div.className = 'news-item';
                        div.innerText = "# " + g.name;
                        div.onclick = () => window.openChat(`TempGroups/${d.id}/messages`, g.name);
                        list.appendChild(div);
                    }
                });
            });
        }

        function loadPrivateUsers() {
            onSnapshot(collection(db, "Users"), (snap) => {
                const list = document.getElementById('privateUsersList');
                list.innerHTML = "";
                snap.forEach(uDoc => {
                    if (uDoc.id !== currentUserId) {
                        const u = uDoc.data();
                        const chatId = [currentUserId, uDoc.id].sort().join("_");
                        const div = document.createElement('div');
                        div.className = 'news-item';
                        div.innerText = u.fullName;
                        div.onclick = () => window.openChat(`PrivateChats/${chatId}/messages`, u.fullName);
                        list.appendChild(div);
                    }
                });
            });
        }

        function loadChatMessages(path) {
            if (chatUnsubscribe) chatUnsubscribe();
            const q = query(collection(db, path), orderBy("time", "asc"));
            chatUnsubscribe = onSnapshot(q, (snap) => {
                const box = document.getElementById('chatMessages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === currentUserId;
                    box.innerHTML += `<div class="msg ${isMe ? 'my-msg' : 'other-msg'}"><b>${m.sender}:</b><br>${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendChatMsg').onclick = async () => {
            const inp = document.getElementById('chatInput');
            if (!inp.value.trim()) return;
            const u = await getDoc(doc(db, "Users", currentUserId));
            await addDoc(collection(db, currentChatPath), {
                text: inp.value,
                sender: u.data().fullName,
                uid: currentUserId,
                time: serverTimestamp(),
                read: false
            });
            inp.value = "";
        };

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---
        function trackUnread() {
            const q = query(collectionGroup(db, 'messages'), where('uid', '!=', currentUserId), where('read', '==', false));
            onSnapshot(q, (snap) => {
                let count = 0;
                snap.forEach(d => { if (d.ref.path.includes(currentUserId)) count++; });
                const b = document.getElementById('unreadBadge');
                b.innerText = count;
                b.style.display = count > 0 ? 'block' : 'none';
            });
        }

        async function toggleLike(id, liked) {
            await updateDoc(doc(db, "News", id), {
                likes: increment(liked ? -1 : 1),
                likedBy: liked ? arrayRemove(currentUserId) : arrayUnion(currentUserId)
            });
        }

        function shareOnWA(t, b) { window.open(`https://wa.me/?text=${encodeURIComponent(t + '\n' + b)}`); }

        async function postComment(id) {
            const i = document.getElementById('newCommentInput');
            if(!i.value.trim()) return;
            const u = await getDoc(doc(db, "Users", currentUserId));
            await addDoc(collection(db, `News/${id}/Comments`), {
                text: i.value, userName: u.data().fullName, time: serverTimestamp()
            });
            i.value = "";
        }

        function loadComments(id) {
            onSnapshot(query(collection(db, `News/${id}/Comments`), orderBy("time", "asc")), (snap) => {
                const l = document.getElementById('commentsList');
                l.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    l.innerHTML += `<div class="comm-card"><b>${c.userName}</b><br>${c.text}</div>`;
                });
            });
        }

    </script>
</body>
</html>
