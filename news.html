<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± */
        .editor-tools { display: flex; gap: 10px; padding: 10px 15px; background: #f8f9fa; border-top: 1px solid #eee; justify-content: flex-end; }
        .btn-tool { font-size: 11px; padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; cursor: pointer; background: white; transition: 0.2s; }
        .btn-tool:hover { background: #eee; }
        .stopped-news { opacity: 0.7; filter: grayscale(0.5); border: 2px dashed var(--danger); }
        .stop-tag { background: var(--danger); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; margin-bottom: 5px; display: inline-block; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 25px; box-shadow: var(--shadow); position: relative; }
        .close-modal { position: absolute; top: 15px; left: 15px; font-size: 20px; cursor: pointer; color: var(--text-muted); }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; outline: none; font-family: inherit; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:8px;">
            <img src="logo.png" style="height:35px; border-radius:8px;">
            <b style="color:var(--primary);">Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</b>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <span id="adminBtn" style="display:none; cursor:pointer; font-size:20px;" onclick="location.href='admin.html'">âš™ï¸</span>
            <span style="cursor:pointer; font-size:20px;" onclick="handleLogout()">ğŸšª</span>
        </div>
    </div>

    <div id="newsFeed"></div>

    <button id="addNewsBtn" class="floating-btn" onclick="openAddModal()" style="display:none;">+</button>

    <div id="newsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">âœ•</span>
            <h2 id="modalTitle" style="margin-top:0; font-size:18px;">Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
            
            <input type="text" id="postTitle" class="modal-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
            
            <label style="font-size:12px; color:gray;">ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±:</label>
            <input type="file" id="postImgFile" accept="image/*" class="modal-input" onchange="processModalImage()">
            <input type="hidden" id="postImgBase64">

            <textarea id="postBody" class="modal-input" rows="4" placeholder="Ù…Ø§Ø°Ø§ ÙŠØ¯ÙˆØ± ÙÙŠ Ø°Ù‡Ù†ÙƒØŸ"></textarea>
            
            <button class="btn-main" id="submitPostBtn" style="width:100%; margin-top:10px;">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item active"><span class="nav-icon">ğŸ </span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span></a>
        <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, doc, getDoc, updateDoc, deleteDoc, addDoc, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let userUID, userData, editingId = null;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            if (userData.role === 'admin' || userData.role === 'editor') {
                document.getElementById('addNewsBtn').style.display = 'block';
                if(userData.role === 'admin') document.getElementById('adminBtn').style.display = 'block';
            }
            loadFeed();
        } else { window.location.replace("index.html"); }
    });

    function loadFeed() {
        onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
            const feed = document.getElementById('newsFeed');
            feed.innerHTML = "";
            snap.forEach((d) => {
                const n = d.data();
                const isAuthorized = (userUID === n.authorId) || (userData.role === 'admin');
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø®Ø¨Ø± Ù…ÙˆÙ‚ÙˆÙØ§Ù‹ ÙˆÙ„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©ØŒ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ù„Ùƒ
                if (n.isStopped && !isAuthorized) return;

                const card = document.createElement('div');
                card.className = `news-card ${n.isStopped ? 'stopped-news' : ''}`;
                card.innerHTML = `
                    <div class="news-body-content">
                        ${n.isStopped ? '<span class="stop-tag">ğŸš« Ù…ÙˆÙ‚ÙˆÙ Ø¹Ù† Ø§Ù„Ø¹Ø±Ø¶</span>' : ''}
                        <div class="author-info">
                            <img src="${n.authorImg || 'https://via.placeholder.com/35'}" class="author-img">
                            <div>
                                <b>${n.authorName}</b>
                                <div style="font-size:10px; color:gray;">${n.date ? new Date(n.date.toDate()).toLocaleString('ar-EG') : ''}</div>
                            </div>
                        </div>
                    </div>
                    <img src="${n.img}" class="news-img-main" style="cursor:pointer">
                    <div class="news-body-content">
                        <h3 style="margin:0 0 5px 0; font-size:15px;">${n.title}</h3>
                        <p style="font-size:13px; color:#444;">${n.body}</p>
                    </div>

                    <div class="post-actions">
                        <span>â¤ï¸ ${n.likedBy?.length || 0}</span>
                        <span style="cursor:pointer" onclick="toggleComments('${d.id}')">ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚Ø§Øª</span>
                    </div>

                    ${isAuthorized ? `
                        <div class="editor-tools">
                            <button class="btn-tool" onclick="prepareEdit('${d.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button class="btn-tool" onclick="toggleStop('${d.id}', ${n.isStopped})">${n.isStopped ? 'âœ… Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø´Ø±' : 'ğŸš« Ø¥ÙŠÙ‚Ø§Ù'}</button>
                            <button class="btn-tool" style="color:red" onclick="deletePost('${d.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    ` : ''}

                    <div id="tray-${d.id}" class="comments-tray">
                        <div id="list-${d.id}"></div>
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„) ---
    window.openAddModal = () => {
        editingId = null;
        document.getElementById('modalTitle').innerText = "Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯";
        document.getElementById('submitPostBtn').innerText = "Ù†Ø´Ø± Ø§Ù„Ø¢Ù†";
        document.getElementById('postTitle').value = "";
        document.getElementById('postBody').value = "";
        document.getElementById('postImgBase64').value = "";
        document.getElementById('newsModal').style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('newsModal').style.display = 'none';

    window.processModalImage = () => {
        const file = document.getElementById('postImgFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => document.getElementById('postImgBase64').value = reader.result;
        if (file) reader.readAsDataURL(file);
    };

    document.getElementById('submitPostBtn').onclick = async () => {
        const title = document.getElementById('postTitle').value;
        const body = document.getElementById('postBody').value;
        const img = document.getElementById('postImgBase64').value;

        if (!title || !body) return alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰");

        if (editingId) {
            // ØªØ­Ø¯ÙŠØ« Ø®Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯
            const updateData = { title, body };
            if (img) updateData.img = img;
            await updateDoc(doc(db, "News", editingId), updateData);
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¨Ø±");
        } else {
            // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯
            await addDoc(collection(db, "News"), {
                title, body, img: img || "",
                authorId: userUID, authorName: userData.fullName,
                authorImg: userData.profileImg || "",
                date: serverTimestamp(), likedBy: [], isStopped: false
            });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
        }
        closeModal();
    };

    // --- ÙˆØ¸Ø§Ø¦Ù Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± ---
    window.prepareEdit = async (id) => {
        const s = await getDoc(doc(db, "News", id));
        const n = s.data();
        editingId = id;
        document.getElementById('modalTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±";
        document.getElementById('submitPostBtn').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª";
        document.getElementById('postTitle').value = n.title;
        document.getElementById('postBody').value = n.body;
        document.getElementById('postImgBase64').value = n.img;
        document.getElementById('newsModal').style.display = 'flex';
    };

    window.toggleStop = async (id, currentStatus) => {
        await updateDoc(doc(db, "News", id), { isStopped: !currentStatus });
    };

    window.deletePost = async (id) => {
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø®Ø¨Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await deleteDoc(doc(db, "News", id));
        }
    };

    window.handleLogout = async () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) { await signOut(auth); location.replace("index.html"); } };
</script>
</body>
</html>
