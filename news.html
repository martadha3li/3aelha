<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --twitter-blue: #1da1f2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; padding-bottom: 70px; }
        
        /* Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
        .pop-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; padding: 20px; }
        .pop-card { width: 100%; max-width: 350px; padding: 25px; border-radius: 20px; text-align: center; position: relative; animation: popUp 0.3s ease-out; }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pop-white { background: white; color: #333; }
        .pop-red { background: var(--danger); color: white; }
        .pop-green { background: var(--accent); color: white; }
        
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); sticky: top; z-index: 1000; }
        .star-bc { color: #ffc107; font-size: 24px; cursor: pointer; display: none; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    </style>
</head>
<body>

    <div id="loginPopupOverlay" class="pop-overlay">
        <div id="loginPopupCard" class="pop-card">
            <h3 id="popTitle">ğŸ”” ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <p id="popMsg"></p>
            <button onclick="closePopup()" style="margin-top:15px; padding:8px 20px; border-radius:20px; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="top-bar">
        <button onclick="signOutUser()" style="background:none; border:none; font-size:20px;">ğŸšª</button>
        <div id="broadcastStar" class="star-bc" onclick="showBC()">â­</div>
        <span id="pageTitle" style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <main id="newsContainer"></main>

    <script type="module">
        import { auth, db } from './config.js';
        import { doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let userUID, userData, userAge;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                userAge = new Date().getFullYear() - new Date(userData.dob).getFullYear();
                
                checkPopup();
                checkStarBC();
            }
        });

        // ÙØ­Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
        function checkPopup() {
            onSnapshot(doc(db, "Settings", "loginPopup"), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    const lastSeenID = localStorage.getItem('last_popup_id');
                    
                    // ÙŠØ¸Ù‡Ø± Ø¥Ø°Ø§ ÙƒØ§Ù†: 1. Ù„Ù… ÙŠÙ†ØªÙ‡Ù ÙˆÙ‚ØªÙ‡ 2. Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡ ÙŠØ®ØªÙ„Ù Ø¹Ù† Ø¢Ø®Ø± Ø¥Ø´Ø¹Ø§Ø± Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    if(data.expiry > Date.now() && data.id !== lastSeenID) {
                        showPopup(data);
                    }
                }
            });
        }

        function showPopup(data) {
            const overlay = document.getElementById('loginPopupOverlay');
            const card = document.getElementById('loginPopupCard');
            document.getElementById('popMsg').innerText = data.message;
            card.className = `pop-card pop-${data.type}`;
            overlay.style.display = 'flex';
            
            // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¸Ù‡ÙˆØ± Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
            localStorage.setItem('last_popup_id', data.id);
            
            if(data.duration > 0) {
                setTimeout(() => { closePopup(); }, data.duration * 1000);
            }
        }

        window.closePopup = () => document.getElementById('loginPopupOverlay').style.display = 'none';

        function checkStarBC() {
            onSnapshot(doc(db, "Settings", "broadcast"), (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    const match = (d.targetGender === 'all' || d.targetGender === userData.gender) && 
                                  (userAge >= d.minAge && userAge <= d.maxAge) && (d.expiry > Date.now());
                    document.getElementById('broadcastStar').style.display = match ? 'block' : 'none';
                    window.bcMessage = d.message;
                }
            });
        }
        window.showBC = () => alert("ğŸ“¢ " + window.bcMessage);
    </script>
</body>
</html>
