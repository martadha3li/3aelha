<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ† | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <style>
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #000000;
            --text-sec: #8E8E93;
        }

        body {
            background-color: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding-top: 70px; /* Ù„ØªØ±Ùƒ Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± */
            padding-bottom: 80px;
            -webkit-tap-highlight-color: transparent;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .header {
            position: fixed; top: 0; width: 100%; height: 60px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box;
            border-bottom: 0.5px solid #D1D1D6; z-index: 1000;
        }

        .header h1 { font-size: 20px; font-weight: 800; margin: 0; }
        .header-btns { display: flex; gap: 15px; align-items: center; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø®ÙÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ± */
        #adminTools { display: none; align-items: center; gap: 15px; }
        .icon-btn { font-size: 22px; cursor: pointer; color: var(--ios-blue); transition: 0.2s; }
        .logout-btn { color: var(--ios-red); font-size: 22px; }

        /* ÙƒØ±Øª Ø§Ù„Ø®Ø¨Ø± */
        .post-card {
            background: var(--card-bg);
            margin: 15px; border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden; position: relative;
            transition: transform 0.2s;
        }

        .post-card.disabled { opacity: 0.6; grayscale: 1; border: 1px dashed red; }

        .post-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .author-info { display: flex; align-items: center; gap: 10px; }
        .author-info b { font-size: 14px; }
        .author-info span { font-size: 11px; color: var(--text-sec); }

        .post-image { width: 100%; height: 250px; object-fit: cover; background: #eee; }

        .post-content { padding: 15px; }
        .post-content h2 { margin: 0 0 8px 0; font-size: 18px; line-height: 1.4; }
        .post-content p { margin: 0; font-size: 14px; color: #333; line-height: 1.5; display: none; } /* ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± */

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .post-actions {
            display: flex; justify-content: space-around;
            padding: 12px 5px; border-top: 0.5px solid #F2F2F7;
        }
        .action-item {
            display: flex; align-items: center; gap: 6px;
            color: var(--text-sec); font-size: 14px; font-weight: 500;
            cursor: pointer;
        }
        .action-item.active { color: var(--ios-red); }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ØªØ­Ø±ÙŠØ± */
        .edit-dots { font-size: 20px; color: var(--text-sec); padding: 5px; }
        .dropdown {
            position: absolute; left: 15px; top: 45px;
            background: white; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none; flex-direction: column; z-index: 100;
            border: 0.5px solid #ddd; min-width: 140px;
        }
        .dropdown button {
            padding: 12px; border: none; background: none;
            text-align: right; font-size: 14px; border-bottom: 0.5px solid #eee;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-bar {
            position: fixed; bottom: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 0.5px solid #D1D1D6; z-index: 1000;
        }
        .nav-item { font-size: 24px; color: var(--text-sec); text-decoration: none; }
        .nav-item.active { color: var(--ios-blue); }

    </style>
</head>
<body>

    <header class="header">
        <h1>Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        <div class="header-btns">
            <div id="adminTools">
                <div class="icon-btn" onclick="location.href='add_news.html'">âŠ•</div>
                <div class="icon-btn" onclick="location.href='admin.html'">âš™ï¸</div>
            </div>
            <div class="logout-btn" onclick="handleLogout()">ğŸšª</div>
        </div>
    </header>

    <div id="newsFeed"></div>

    <nav class="bottom-bar">
        <a href="news.html" class="nav-item active">ğŸ </a>
        <a href="chat.html" class="nav-item">ğŸ’¬</a>
        <a href="competitions.html" class="nav-item">ğŸ†</a>
        <a href="profile.html" class="nav-item">ğŸ‘¤</a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const userSnap = await getDoc(doc(db, "Users", userUID));
            if (userSnap.exists()) {
                userData = userSnap.data();
                const role = (userData.role || 'user').toLowerCase();
                if (role === 'admin' || role === 'editor' || role === 'Ù…Ø¯ÙŠØ±') {
                    document.getElementById('adminTools').style.display = 'flex';
                }
            }
            loadPosts();
        } else { window.location.href = "login.html"; }
    });

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø¨ØªØµÙ…ÙŠÙ… Ø¥Ù†Ø³ØªØ¬Ø±Ø§Ù…/ÙÙŠØ³Ø¨ÙˆÙƒ
    function loadPosts() {
        const feed = document.getElementById('newsFeed');
        onSnapshot(collection(db, "News"), (snap) => {
            feed.innerHTML = "";
            let posts = [];
            snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
            posts.sort((a,b) => (b.publishDate || 0) - (a.publishDate || 0));

            posts.forEach(post => {
                const isManager = userData?.role === 'admin' || userData?.role === 'Ù…Ø¯ÙŠØ±' || userUID === post.authorId;
                if (!post.visible && !isManager) return;

                const hasLiked = post.likedBy?.includes(userUID);
                const card = document.createElement('div');
                card.className = `post-card ${!post.visible ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div class="post-header">
                        <div class="author-info">
                            <div style="width:35px; height:35px; background:var(--ios-blue); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">${post.authorName?.charAt(0) || 'U'}</div>
                            <div>
                                <b>${post.authorName || 'Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'}</b><br>
                                <span>${post.publishDate ? new Date(post.publishDate).toLocaleDateString('ar-EG') : ''}</span>
                            </div>
                        </div>
                        ${isManager ? `<div class="edit-dots" onclick="toggleMenu('${post.id}')">â‹®</div>` : ''}
                        <div id="menu-${post.id}" class="dropdown">
                            <button onclick="doAction('${post.id}', 'toggleVis', ${post.visible})">${post.visible ? 'ğŸ”’ Ø¥Ø®ÙØ§Ø¡' : 'ğŸ”“ ØªÙØ¹ÙŠÙ„'}</button>
                            <button onclick="location.href='add_news.html?edit=${post.id}'">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="doAction('${post.id}', 'delete')" style="color:var(--ios-red)">ğŸ—‘ï¸ Ø­Ø°Ù</button>
                        </div>
                    </div>

                    <img class="post-image" src="${post.img || 'https://via.placeholder.com/400x250'}" onclick="zoomImg(this.src)">

                    <div class="post-content" onclick="toggleText('${post.id}')">
                        <h2>${post.title}</h2>
                        <p id="text-${post.id}">${post.body || post.content || ''}</p>
                    </div>

                    <div class="post-actions">
                        <div class="action-item ${hasLiked ? 'active' : ''}" onclick="doLike('${post.id}', ${hasLiked})">
                            ${hasLiked ? 'â¤ï¸' : 'ğŸ¤'} ${post.likedBy?.length || 0}
                        </div>
                        <div class="action-item" onclick="showComments('${post.id}')">
                            ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚
                        </div>
                        <div class="action-item">
                            ğŸ‘ï¸ ${post.viewedBy?.length || 0}
                        </div>
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© ---
    window.toggleText = (id) => {
        const p = document.getElementById(`text-${id}`);
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
        updateDoc(doc(db, "News", id), { viewedBy: arrayUnion(userUID) });
    };

    window.toggleMenu = (id) => {
        const m = document.getElementById(`menu-${id}`);
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    };

    window.doLike = async (id, liked) => {
        const ref = doc(db, "News", id);
        await updateDoc(ref, { likedBy: liked ? arrayRemove(userUID) : arrayUnion(userUID) });
    };

    window.doAction = async (id, type, current) => {
        if (type === 'delete' && confirm('Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) await deleteDoc(doc(db, "News", id));
        if (type === 'toggleVis') await updateDoc(doc(db, "News", id), { visible: !current });
    };

    window.handleLogout = () => { if(confirm("Ù‡Ù„ ØªÙˆØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(()=>location.reload()); };

    window.zoomImg = (src) => {
        const v = document.createElement('div');
        v.style = "position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:2000;display:flex;align-items:center;justify-content:center;padding:20px;";
        v.innerHTML = `<img src="${src}" style="max-width:100%; border-radius:10px;">`;
        v.onclick = () => v.remove();
        document.body.appendChild(v);
    };

</script>
</body>
</html>
