<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© | Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
<div class="top-bar">
       <h1>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h1>
    <a id="adminLink" href="add_news.html" class="admin-add-btn">âŠ•</a>
</div>
     <div style="display: flex; align-items: center;">
        <button id="installApp" class="install-btn">ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ğŸ“²</button>
    </div>
    <style>
        /* Ø²Ø± ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
.install-btn {
    display: none; /* ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ«Ø¨ÙŠØª */
    background: var(--ios-blue);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 10px;
}
        :root {
            --ios-blue: #007AFF;
            --ios-red: #FF3B30;
            --ios-bg: #F2F2F7;
            --card-bg: #FFFFFF;
            --text-main: #1c1c1e;
            --text-sec: #8E8E93;
        }

        body {
            background-color: var(--ios-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding-top: 70px;
            padding-bottom: 90px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .header {
            position: fixed; top: 0; width: 100%; height: 65px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px);
            display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; box-sizing: border-box;
            border-bottom: .5px solid #C6C6C8;
            z-index: 5000;
        }

        .header h1 { font-size: 20px; font-weight: 800; margin: 0; }
        .header-btns { display: flex; gap: 18px; align-items: center; }

        #adminTools { display: none; align-items: center; gap: 18px; }
        .icon-btn { font-size: 26px; cursor: pointer; color: var(--ios-blue); }
        .logout-btn { color: var(--ios-red); font-size: 24px; cursor: pointer; }

        /* ÙƒØ±Øª Ø§Ù„Ø®Ø¨Ø± */
        .post-card {
            background: var(--card-bg);
            margin: 15px; border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0,0,0,.05);
            overflow: hidden; position: relative;
            border: .5px solid #E5E5EA;
        }

        .post-card.disabled { opacity: .55; filter: grayscale(.8); border: 1px dashed red; }
        .post-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }

        .author-info { display: flex; align-items: center; gap: 12px; }
        .avatar {
            width: 38px; height: 38px; background: #E5E5EA; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: var(--ios-blue);
        }

        .post-image { width: 100%; max-height: 350px; object-fit: cover; background: #f0f0f0; }

        .post-content { padding: 15px; }
        .post-content h2 { margin: 0 0 6px 0; font-size: 18px; font-weight: 700; }
        .post-content p { margin: 0; font-size: 14px; color: #3a3a3c; display: none; margin-top: 10px; line-height: 1.5; }

        .post-actions {
            display: flex; justify-content: space-around;
            padding: 12px 0; border-top: .5px solid #E5E5EA;
            background: #FAFAFA;
        }

        .action-item { display: flex; align-items: center; gap: 6px; color: var(--text-sec); font-size: 13px; cursor: pointer; font-weight: 500; }
        .action-item.active { color: var(--ios-red); }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
        .edit-dots { font-size: 22px; color: var(--text-sec); cursor: pointer; padding: 5px; }
        .dropdown {
            position: absolute; left: 15px; top: 45px;
            background: #fff; border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,.15);
            display: none; flex-direction: column; z-index: 1000;
            min-width: 150px; border: 1px solid #eee; overflow: hidden;
        }
        .dropdown button {
            padding: 12px 15px; border: none; background: none; text-align: right; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f9f9f9;
        }
        .dropdown button:last-child { color: var(--ios-red); border-bottom: none; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ (Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø¸Ù‡ÙˆØ±) */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0; height: 70px;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(15px);
            display: flex; justify-content: space-around; align-items: center;
            border-top: .5px solid #C6C6C8; z-index: 5000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { font-size: 24px; text-decoration: none; color: #8E8E93; transition: 0.2s; }
        .nav-item.active { color: var(--ios-blue); transform: scale(1.1); }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª */
        .comment-box { display:none; padding:15px; background:#f9f9f9; border-top:1px solid #eee; }
        .comment-input { display: flex; gap: 8px; margin-top: 10px; }
        .comment-input input { flex: 1; padding: 8px 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }
    </style>
</head>

<body>

    <header class="header">
        <h1>Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</h1>
        <div class="header-btns">
            <div id="adminTools">
                <div class="icon-btn" onclick="location.href='add_news.html'">âŠ•</div>
                <div class="icon-btn" onclick="location.href='admin.html'">âš™ï¸</div>
            </div>
            <div class="logout-btn" onclick="handleLogout()">ğŸšª</div>
        </div>
    </header>

    <div id="newsFeed"></div>

    <nav class="bottom-bar">
        <a href="news.html" class="nav-item active">ğŸ </a>
        <a href="chat.html" class="nav-item">ğŸ’¬</a>
        <a href="competitions.html" class="nav-item">ğŸ†</a>
        <a href="profile.html" class="nav-item">ğŸ‘¤</a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData;

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù„Ù„Ù…Ø¯ÙŠØ±
    function enableAdminUI() {
        const tools = document.getElementById('adminTools');
        if(tools) tools.style.display = 'flex';
    }

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const userSnap = await getDoc(doc(db, "Users", userUID));
            if (userSnap.exists()) {
                userData = userSnap.data();
                const role = (userData.role || userData.Role || 'user').toString().toLowerCase();
                if (role.includes('admin') || role.includes('Ù…Ø¯ÙŠØ±') || role.includes('editor')) {
                    enableAdminUI();
                }
            }
            loadPosts();
        } else {
            window.location.href = "login.html";
        }
    });

    function loadPosts() {
        const feed = document.getElementById('newsFeed');
        onSnapshot(collection(db, "News"), (snap) => {
            feed.innerHTML = "";
            let posts = [];
            snap.forEach(d => posts.push({ id: d.id, ...d.data() }));
            posts.sort((a, b) => (b.publishDate || 0) - (a.publishDate || 0));

            posts.forEach(post => {
                const hasLiked = post.likedBy?.includes(userUID);
                const role = (userData?.role || '').toLowerCase();
                const isManager = (role.includes('admin') || role.includes('Ù…Ø¯ÙŠØ±') || userUID === post.authorId);
                
                if (!post.visible && !isManager) return;

                const card = document.createElement('div');
                card.className = `post-card ${!post.visible ? 'disabled' : ''}`;
                card.innerHTML = `
                    <div class="post-header">
                        <div class="author-info">
                            <div class="avatar">${post.authorName?.charAt(0) || 'U'}</div>
                            <div>
                                <b>${post.authorName || 'Ø¹Ø¶Ùˆ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©'}</b><br>
                                <small style="color:gray; font-size:10px;">${post.publishDate ? new Date(post.publishDate).toLocaleDateString('ar-EG') : ''}</small>
                            </div>
                        </div>
                        ${isManager ? `<div class="edit-dots" onclick="event.stopPropagation(); window.toggleDropdown('${post.id}')">â‹®</div>` : ''}
                        <div id="dropdown-${post.id}" class="dropdown">
                            <button onclick="window.changeVisibility('${post.id}', ${post.visible})">${post.visible ? 'ğŸ”’ ØªØ¹Ø·ÙŠÙ„' : 'ğŸ”“ ØªÙØ¹ÙŠÙ„'}</button>
                            <button onclick="location.href='add_news.html?edit=${post.id}'">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
                            <button onclick="window.deleteNews('${post.id}')">ğŸ—‘ï¸ Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                        </div>
                    </div>

                    <img class="post-image" src="${post.img || 'https://via.placeholder.com/500x300'}" onclick="window.zoomImg(this.src)">

                    <div class="post-content" onclick="toggleText('${post.id}')">
                        <h2>${post.title}</h2>
                        <p id="text-${post.id}">${post.body || post.content || ''}</p>
                    </div>

                    <div class="post-actions">
                        <div class="action-item ${hasLiked ? 'active' : ''}" onclick="doLike('${post.id}', ${hasLiked})">
                            ${hasLiked ? 'â¤ï¸' : 'ğŸ¤'} <span>${post.likedBy?.length || 0}</span>
                        </div>
                        <div class="action-item" onclick="toggleComments('${post.id}')">
                            ğŸ’¬ <span>${post.comments?.length || 0}</span>
                        </div>
                        <div class="action-item">
                            ğŸ‘ï¸ <span>${post.viewedBy?.length || 0}</span>
                        </div>
                    </div>

                    <div id="comments-${post.id}" class="comment-box">
                        <div id="commentsList-${post.id}"></div>
                        <div class="comment-input">
                            <input type="text" id="input-${post.id}" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." 
                                   onkeydown="if(event.key==='Enter') addComment('${post.id}', this.value)">
                            <button onclick="addComment('${post.id}', document.getElementById('input-${post.id}').value)" 
                                    style="border:none; background:var(--ios-blue); color:white; border-radius:15px; padding:5px 12px;">Ù†Ø´Ø±</button>
                        </div>
                    </div>
                `;
                feed.appendChild(card);
            });
        });
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ…
    window.toggleText = (id) => {
        const p = document.getElementById(`text-${id}`);
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    };

    window.toggleDropdown = (id) => {
        const d = document.getElementById(`dropdown-${id}`);
        const isOpen = d.style.display === 'flex';
        document.querySelectorAll('.dropdown').forEach(el => el.style.display = 'none');
        d.style.display = isOpen ? 'none' : 'flex';
    };

    window.toggleComments = (id) => {
        const box = document.getElementById(`comments-${id}`);
        const isOpen = box.style.display === 'block';
        box.style.display = isOpen ? 'none' : 'block';
        if (!isOpen) loadComments(id);
    };

    window.loadComments = async (id) => {
        const list = document.getElementById(`commentsList-${id}`);
        const snap = await getDoc(doc(db, "News", id));
        const comments = snap.data().comments || [];
        list.innerHTML = comments.map(c => `
            <div style="font-size:13px; margin-bottom:8px; background:#eee; padding:8px; border-radius:10px;">
                <b>${c.name}:</b> ${c.text}
            </div>
        `).join('');
    };

    window.addComment = async (id, text) => {
        if (!text.trim()) return;
        const input = document.getElementById(`input-${id}`);
        await updateDoc(doc(db, "News", id), {
            comments: arrayUnion({
                name: userData?.fullName || userData?.name || "Ø¹Ø¶Ùˆ",
                text: text,
                date: Date.now()
            })
        });
        input.value = "";
        loadComments(id);
    };

    window.doLike = async (id, liked) => {
        await updateDoc(doc(db, "News", id), {
            likedBy: liked ? arrayRemove(userUID) : arrayUnion(userUID)
        });
    };

    window.changeVisibility = async (id, current) => {
        await updateDoc(doc(db, "News", id), { visible: !current });
    };

    window.deleteNews = async (id) => {
        if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await deleteDoc(doc(db, "News", id));
        }
    };

    window.handleLogout = () => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ")) auth.signOut().then(() => location.reload());
    };

    window.zoomImg = (src) => {
        const v = document.createElement('div');
        v.style = "position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;";
        v.innerHTML = `<img src="${src}" style="max-width:100%; border-radius:10px;">`;
        v.onclick = () => v.remove();
        document.body.appendChild(v);
    };

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± ÙÙŠ Ø§Ù„Ø®Ø§Ø±Ø¬
    window.onclick = () => document.querySelectorAll('.dropdown').forEach(d => d.style.display = 'none');
</script>
<script src="onesignal-handler.js"></script>
    <script>
    let deferredPrompt;
    const installBtn = document.getElementById('installApp');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Ù…Ù†Ø¹ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù† Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
        e.preventDefault();
        // Ø­ÙØ¸ Ø§Ù„Ø­Ø¯Ø« Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
        deferredPrompt = e;
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        installBtn.style.display = 'block';
    });

    installBtn.addEventListener('click', async () => {
        if (deferredPrompt) {
            // Ø¥Ø¸Ù‡Ø§Ø± Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ«Ø¨ÙŠØª
            deferredPrompt.prompt();
            // Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                console.log('User accepted the install prompt');
            }
            deferredPrompt = null;
            installBtn.style.display = 'none';
        }
    });

    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­
    window.addEventListener('appinstalled', () => {
        installBtn.style.display = 'none';
        alert('ØªÙ… ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!');
    });
</script>
</body>
</html>





