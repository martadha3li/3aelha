<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; --twitter-blue: #1DA1F2; --gold: #ffc107; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .star-broadcast { color: var(--gold); font-size: 24px; cursor: pointer; animation: pulse 1.5s infinite; display: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø± */
        .search-container { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .search-input { width: 100%; padding: 10px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; box-sizing: border-box; }
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.08); cursor: pointer; display: flex; }
        .news-img-thumb { width: 110px; height: 110px; object-fit: cover; }
        .news-brief { padding: 10px; flex: 1; }

        /* Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ */
        .overlay-full { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; }
        .overlay-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .chat-selector-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: white; margin: 5px 10px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        /* Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ */
        .new-chat-search { padding: 15px; background: #fff; border-bottom: 1px solid #eee; }
        .new-chat-search input { width: 70%; padding: 10px; border-radius: 20px 0 0 20px; border: 1px solid #ddd; outline: none; }
        .new-chat-search button { width: 28%; padding: 10px; border-radius: 0 20px 20px 0; border: none; background: var(--primary); color: white; cursor: pointer; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ */
        .active-chat-window { display: none; position: fixed; inset: 0; background: #e5ddd5; z-index: 5000; flex-direction: column; }
        .auto-delete-bar { background: #fff3cd; padding: 8px 15px; font-size: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ffeeba; }
        #chatMessages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 10px; max-width: 80%; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .my-msg { align-self: flex-end; background: #dcf8c6; }
        .other-msg { align-self: flex-start; background: white; }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .nav-item { text-align: center; color: #7f8c8d; cursor: pointer; font-size: 11px; position: relative; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--danger); color: white; border-radius: 50%; padding: 2px 6px; font-size: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <button id="logoutBtn" style="background:none; border:none; font-size:20px; color:var(--danger); cursor:pointer;">ğŸšª</button>
        <div id="broadcastStar" class="star-broadcast" onclick="showBroadcastMsg()">â­</div>
        <div id="permsBadge" style="font-size:11px; color:var(--twitter-blue); font-weight:bold;"></div>
        <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <div class="search-container">
        <input type="text" id="newsSearchInp" class="search-input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±..." oninput="window.filterNews()">
    </div>

    <main id="newsList">
        <div id="newsContainer"></div>
    </main>

    <div id="chatCenterOverlay" class="overlay-full">
        <div class="overlay-header">
            <span>Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</span>
            <button onclick="window.toggleChatCenter()" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
        </div>
        <div style="padding: 0; background: #f0f2f5; flex: 1; overflow-y: auto;">
            <div class="chat-selector-item" style="margin-top:15px;" onclick="window.openChat('Messages', 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©')">
                <span>ğŸŒ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</span>
            </div>

            <div class="new-chat-search">
                <h4 style="margin:0 0 10px 0; font-size:14px;">Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„)</h4>
                <div style="display:flex;">
                    <input type="number" id="searchUserPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„...">
                    <button onclick="window.searchByPhone()">Ø¨Ø­Ø«</button>
                </div>
            </div>
            
            <h4 style="margin: 15px 15px 5px;">Ù…Ø­Ø§Ø¯Ø«Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
            <div id="previousChatsList"></div>
        </div>
    </div>

    <div id="activeChatWindow" class="active-chat-window">
        <div class="overlay-header">
            <span id="activeChatTitle">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
            <button onclick="window.closeActiveChat()" style="background:none; border:none; color:white; font-size:24px;">âœ•</button>
        </div>
        <div id="autoDeleteBar" class="auto-delete-bar" style="display:none;">
            <span>ğŸ§¹ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</span>
            <select id="autoDeleteSelect" onchange="window.updateAutoDeleteSettings()">
                <option value="0">Ø¥ÙŠÙ‚Ø§Ù</option>
                <option value="1">Ø¨Ø¹Ø¯ Ø³Ø§Ø¹Ø©</option>
                <option value="24">Ø¨Ø¹Ø¯ ÙŠÙˆÙ…</option>
                <option value="168">Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹</option>
            </select>
        </div>
        <div id="chatMessages"></div>
        <div style="padding:10px; background:white; display:flex;">
            <input type="text" id="chatInput" style="flex:1; padding:12px; border-radius:20px; border:1px solid #ddd;" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
            <button id="sendMsgBtn" style="background:none; border:none; color:var(--primary); font-size:24px; margin-right:10px;">â¤</button>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item" onclick="location.reload()">ğŸ“°<br>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div class="nav-item" onclick="window.toggleChatCenter()">
            ğŸ’¬<br>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© <span id="chatBadge" class="badge" style="display:none;">0</span>
        </div>
        <div class="nav-item" onclick="location.href='profile.html'">ğŸ‘¤<br>Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, where, collectionGroup, getDocs, limit, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let userUID = null;
        let userData = null;
        let currentChatPath = "";
        let currentChatID = null;
        let unsubMessages = null;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                loadNews();
                loadPreviousChats();
                trackUnread();
                checkBroadcast();
            } else { window.location.href = "index.html"; }
        });

        // 1. Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¨Ø¯Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©
        window.searchByPhone = async () => {
            const phone = document.getElementById('searchUserPhone').value;
            if(!phone) return;
            const q = query(collection(db, "Users"), where("phone", "==", phone), limit(1));
            const snap = await getDocs(q);
            if(snap.empty) {
                alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…");
            } else {
                const otherUser = snap.docs[0].data();
                const otherUID = snap.docs[0].id;
                const chatId = [userUID, otherUID].sort().join("_");
                window.openChat(`PrivateChats/${chatId}/messages`, otherUser.fullName, chatId);
            }
        };

        // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙÙ‚Ø·
        function loadPreviousChats() {
            onSnapshot(collection(db, "PrivateChats"), (snap) => {
                const list = document.getElementById('previousChatsList');
                list.innerHTML = "";
                snap.forEach(async (d) => {
                    if(d.id.includes(userUID)) {
                        const otherUID = d.id.replace(userUID, "").replace("_", "");
                        const uSnap = await getDoc(doc(db, "Users", otherUID));
                        if(uSnap.exists()) {
                            const u = uSnap.data();
                            const item = document.createElement('div');
                            item.className = 'chat-selector-item';
                            item.innerHTML = `<span>ğŸ‘¤ ${u.fullName}</span>`;
                            item.onclick = () => window.openChat(`PrivateChats/${d.id}/messages`, u.fullName, d.id);
                            list.appendChild(item);
                        }
                    }
                });
            });
        }

        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        window.updateAutoDeleteSettings = async () => {
            if(!currentChatID) return;
            const hours = document.getElementById('autoDeleteSelect').value;
            await setDoc(doc(db, "PrivateChats", currentChatID), {
                autoDeleteHours: parseInt(hours),
                lastUpdatedBy: userUID
            }, { merge: true });
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ");
        };

        async function cleanOldMessages(path, chatId) {
            const snap = await getDoc(doc(db, "PrivateChats", chatId));
            if(!snap.exists() || !snap.data().autoDeleteHours) return;
            const hours = snap.data().autoDeleteHours;
            if(hours === 0) return;

            const expiryTime = Date.now() - (hours * 60 * 60 * 1000);
            const q = query(collection(db, path), where("time", "<", new Date(expiryTime)));
            const oldMsgs = await getDocs(q);
            oldMsgs.forEach(m => deleteDoc(m.ref));
        }

        // 4. ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        window.toggleChatCenter = () => {
            const el = document.getElementById('chatCenterOverlay');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        };

        window.openChat = async (path, title, chatId = null) => {
            currentChatPath = path;
            currentChatID = chatId;
            document.getElementById('activeChatTitle').innerText = title;
            document.getElementById('activeChatWindow').style.display = 'flex';
            
            const deleteBar = document.getElementById('autoDeleteBar');
            if(chatId) {
                deleteBar.style.display = 'flex';
                const cSnap = await getDoc(doc(db, "PrivateChats", chatId));
                document.getElementById('autoDeleteSelect').value = cSnap.exists() ? (cSnap.data().autoDeleteHours || 0) : 0;
                cleanOldMessages(path, chatId); // ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
            } else {
                deleteBar.style.display = 'none';
            }
            startMessageListener(path);
        };

        window.closeActiveChat = () => {
            document.getElementById('activeChatWindow').style.display = 'none';
            if(unsubMessages) unsubMessages();
        };

        // --- (Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ‚Ø±Ø©) ---
        function startMessageListener(path) {
            if(unsubMessages) unsubMessages();
            const q = query(collection(db, path), orderBy("time", "asc"));
            unsubMessages = onSnapshot(q, (snap) => {
                const box = document.getElementById('chatMessages');
                box.innerHTML = "";
                snap.forEach(d => {
                    const m = d.data();
                    const isMe = m.uid === userUID;
                    box.innerHTML += `<div class="msg ${isMe ? 'my-msg' : 'other-msg'}">
                        <small style="display:block; font-size:10px; color:#888;">${m.sender}</small>
                        ${m.text}
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        document.getElementById('sendMsgBtn').onclick = async () => {
            const inp = document.getElementById('chatInput');
            if(!inp.value.trim()) return;
            // Ø¥Ù†Ø´Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
            if(currentChatID) await setDoc(doc(db, "PrivateChats", currentChatID), { active: true }, { merge: true });
            
            await addDoc(collection(db, currentChatPath), {
                text: inp.value, sender: userData.fullName, uid: userUID, time: serverTimestamp(), read: false
            });
            inp.value = "";
        };

        function loadNews() { /* ... Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© ... */ }
        function trackUnread() { /* ... Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ... */ }
        function checkBroadcast() { /* ... Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© ... */ }
        document.getElementById('logoutBtn').onclick = () => { if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) signOut(auth); };

    </script>
</body>
</html>
