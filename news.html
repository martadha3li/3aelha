<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠ (ÙŠØ¸Ù‡Ø± Ù„Ù„Ù…Ø®ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·) */
        #adminTools { display: none; background: var(--primary); color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 1000; }
        
        /* ØªØµÙ…ÙŠÙ… Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØµØ±Ø© */
        .news-card { background: white; margin: 12px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: pointer; display: flex; align-items: center; }
        .news-img-thumb { width: 100px; height: 100px; object-fit: cover; }
        .news-brief { padding: 10px; flex: 1; }
        .news-brief h3 { margin: 0; font-size: 16px; color: var(--primary); }
        .news-brief small { color: #888; font-size: 10px; }
        
        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„Ù„Ø®Ø¨Ø± Ø§Ù„ÙƒØ§Ù…Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: flex-end; }
        .modal-content { background: white; width: 100%; max-height: 90vh; border-radius: 20px 20px 0 0; overflow-y: auto; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .full-img { width: 100%; max-height: 250px; object-fit: cover; }
        .content-body { padding: 20px; }
        .actions-bar { display: flex; gap: 20px; padding: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; }

        /* Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø± */
        #newsEditorModal { display: none; position: fixed; inset: 0; background: white; z-index: 3000; flex-direction: column; padding: 20px; overflow-y: auto; }
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; }
        .btn { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-post { background: var(--accent); color: white; width: 100%; }
        .btn-close { background: var(--danger); color: white; }
    </style>
</head>
<body>

    <div id="adminTools">
        <span>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø®Ø¨Ø§Ø±: </span>
        <button class="btn" style="background:#fff; color:var(--primary); font-size:12px;" onclick="openNewsEditor()">â• Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</button>
    </div>

    <main id="newsList">
        <h2 style="padding: 15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        </main>

    <div id="newsEditorModal">
        <h2 id="editorTitle">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
        <input type="file" id="newsImgInput" accept="image/*">
        <img id="newsImgPreview" style="width:100%; height:150px; object-fit:cover; display:none; border-radius:10px;">
        <input type="text" id="newsTitleInput" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
        <textarea id="newsBodyInput" rows="5" placeholder="ÙˆØµÙ Ø§Ù„Ø®Ø¨Ø± Ø¨Ø§Ù„ØªÙØµÙŠÙ„"></textarea>
        
        <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
            <label><input type="checkbox" id="allowComments" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</label><br>
            <label><input type="checkbox" id="allowLikes" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨</label><br>
            <label><input type="checkbox" id="allowShare" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</label>
        </div>
        
        <button class="btn btn-post" id="saveNewsBtn">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¢Ù†</button>
        <button class="btn btn-close" style="margin-top:10px;" onclick="closeNewsEditor()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>

    <div id="fullNewsModal" class="modal">
        <div class="modal-content">
            <button onclick="closeFullNews()" style="float:left; margin:15px; background:none; border:none; font-size:24px;">âœ•</button>
            <img id="fnImg" class="full-img">
            <div class="content-body">
                <h2 id="fnTitle"></h2>
                <small id="fnDate" style="color:#888;"></small>
                <p id="fnBody" style="line-height:1.6; white-space:pre-wrap;"></p>
                
                <div class="actions-bar" id="fnActions">
                    </div>

                <div id="commentsSection">
                    <h4>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</h4>
                    <div id="commentsList"></div>
                    <div id="commentInputArea" style="display:flex; gap:5px; margin-top:15px;">
                        <input type="text" id="newComment" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="margin:0;">
                        <button id="sendCommentBtn" class="btn btn-primary" style="background:var(--primary); color:white;">â¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div onclick="location.reload()" style="color:var(--primary); font-weight:bold;">ğŸ“° Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</div>
        <div onclick="window.toggleChatCenter()">ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
        <div onclick="location.href='profile.html'">ğŸ‘¤ Ø¨Ø±ÙˆÙØ§ÙŠÙ„</div>
    </nav>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, query, orderBy, onSnapshot, doc, getDoc, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUserId = null;
        let currentUserData = null;
        let selectedNewsImg = "";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUserId = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                currentUserData = snap.data();
                
                // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…Ù† Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ©
                if (currentUserData.role === 'admin' || currentUserData.canAdd) {
                    document.getElementById('adminTools').style.display = 'block';
                }
                loadNews();
            } else { window.location.href = "index.html"; }
        });

        // --- Ù†Ø¸Ø§Ù… Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ---
        document.getElementById('newsImgInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = () => {
                selectedNewsImg = reader.result;
                document.getElementById('newsImgPreview').src = selectedNewsImg;
                document.getElementById('newsImgPreview').style.display = 'block';
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        window.openNewsEditor = () => document.getElementById('newsEditorModal').style.display = 'flex';
        window.closeNewsEditor = () => document.getElementById('newsEditorModal').style.display = 'none';

        // --- Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± ---
        document.getElementById('saveNewsBtn').onclick = async () => {
            const title = document.getElementById('newsTitleInput').value;
            const body = document.getElementById('newsBodyInput').value;
            if(!title || !body) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ÙˆØµÙ");

            await addDoc(collection(db, "News"), {
                title, body, 
                img: selectedNewsImg,
                commentsEnabled: document.getElementById('allowComments').checked,
                likesEnabled: document.getElementById('allowLikes').checked,
                shareEnabled: document.getElementById('allowShare').checked,
                likes: 0, likedBy: [],
                date: serverTimestamp()
            });
            alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­");
            location.reload();
        };

        // --- Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ---
        function loadNews() {
            onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
                const list = document.getElementById('newsList');
                list.innerHTML = `<h2 style="padding:15px;">Ø¢Ø®Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>`;
                snap.forEach(d => {
                    const n = d.data();
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.onclick = () => openFullNews(d.id);
                    card.innerHTML = `
                        <img src="${n.img || 'https://via.placeholder.com/100'}" class="news-img-thumb">
                        <div class="news-brief">
                            <h3>${n.title} <small>${n.date?.toDate().toLocaleDateString('ar-SA')}</small></h3>
                            <p style="font-size:12px; color:#666; margin:5px 0;">${n.body.substring(0,60)}...</p>
                        </div>
                    `;
                    list.appendChild(card);
                });
            });
        }

        // --- ÙØªØ­ Ø§Ù„Ø®Ø¨Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ ---
        window.openFullNews = async (id) => {
            const snap = await getDoc(doc(db, "News", id));
            const n = snap.data();
            
            document.getElementById('fnImg').src = n.img || '';
            document.getElementById('fnTitle').innerText = n.title;
            document.getElementById('fnDate').innerText = n.date?.toDate().toLocaleString('ar-SA');
            document.getElementById('fnBody').innerText = n.body;
            
            // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­Ø³Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¨Ø±
            document.getElementById('commentsSection').style.display = n.commentsEnabled ? 'block' : 'none';
            
            // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ù…Ø¯ÙŠØ± (Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±)
            const actions = document.getElementById('fnActions');
            actions.innerHTML = "";
            if(currentUserData.role === 'admin' || currentUserData.canDelete) {
                const delBtn = document.createElement('button');
                delBtn.innerText = "ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø®Ø¨Ø±";
                delBtn.className = "btn btn-close";
                delBtn.onclick = async () => { if(confirm("Ø­Ø°ÙØŸ")) { await deleteDoc(doc(db, "News", id)); closeFullNews(); } };
                actions.appendChild(delBtn);
            }

            document.getElementById('fullNewsModal').style.display = 'flex';
            loadComments(id);
            
            document.getElementById('sendCommentBtn').onclick = () => postComment(id);
        };

        window.closeFullNews = () => document.getElementById('fullNewsModal').style.display = 'none';

        // --- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ---
        async function postComment(newsId) {
            const txt = document.getElementById('newComment').value;
            if(!txt) return;
            await addDoc(collection(db, `News/${newsId}/Comments`), {
                text: txt, userName: currentUserData.fullName, uid: currentUserId, time: serverTimestamp()
            });
            document.getElementById('newComment').value = "";
        }

        function loadComments(newsId) {
            onSnapshot(query(collection(db, `News/${newsId}/Comments`), orderBy("time", "asc")), (snap) => {
                const list = document.getElementById('commentsList');
                list.innerHTML = "";
                snap.forEach(d => {
                    const c = d.data();
                    list.innerHTML += `
                        <div style="border-bottom:1px solid #eee; padding:10px; position:relative;">
                            <b>${c.userName}</b>: ${c.text}
                            ${(currentUserData.role === 'admin' || c.uid === currentUserId) ? `<button onclick="deleteComment('${newsId}','${d.id}')" style="float:left; color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button>` : ''}
                        </div>`;
                });
            });
        }

        window.deleteComment = async (nId, cId) => { await deleteDoc(doc(db, `News/${nId}/Comments`, cId)); };

    </script>
</body>
</html>
