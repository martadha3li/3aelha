<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø°ÙƒÙŠ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #2ecc71; --danger: #e74c3c; --twitter-blue: #1DA1F2; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f4f7f6; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚ ÙˆØ³Ø· Ø§Ù„Ø´Ø§Ø´Ø© */
        .login-popup-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; padding: 20px; }
        .login-popup-content { width: 100%; max-width: 400px; padding: 25px; border-radius: 15px; text-align: center; position: relative; animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ */
        .popup-white { background: white; color: #333; }
        .popup-red { background: var(--danger); color: white; }
        .popup-green { background: var(--accent); color: white; }
        
        .popup-close-btn { margin-top: 15px; padding: 8px 20px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; background: rgba(0,0,0,0.1); }

        .top-bar { background: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .star-broadcast { color: #ffc107; font-size: 24px; cursor: pointer; animation: pulse 1.5s infinite; display: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="loginPopupOverlay" class="login-popup-overlay">
        <div id="loginPopupContent" class="login-popup-content">
            <h3 id="popTitle">ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
            <p id="popMessage"></p>
            <button class="popup-close-btn" onclick="closeLoginPopup()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="top-bar">
        <button onclick="location.href='index.html'" style="background:none; border:none; font-size:20px;">ğŸšª</button>
        <div id="broadcastStar" class="star-broadcast" onclick="showBroadcast()">â­</div>
        <span style="font-weight:bold;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>

    <script type="module">
        import { auth, db } from './config.js';
        import { doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let userUID = null;
        let userData = null;
        let currentAge = 0;

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                userUID = user.uid;
                const snap = await getDoc(doc(db, "Users", user.uid));
                userData = snap.data();
                currentAge = new Date().getFullYear() - new Date(userData.dob).getFullYear();
                
                checkBroadcastTargeting();
                checkLoginPopup();
            }
        });

        // 1. ÙØ­Øµ Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©
        function checkBroadcastTargeting() {
            onSnapshot(doc(db, "Settings", "broadcast"), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    const now = Date.now();
                    
                    // Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªÙ‡Ø¯Ø§Ù
                    const genderMatch = (data.targetGender === 'all' || data.targetGender === userData.gender);
                    const ageMatch = (currentAge >= data.minAge && currentAge <= data.maxAge);
                    const timeMatch = (data.expiry > now);

                    if(genderMatch && ageMatch && timeMatch) {
                        document.getElementById('broadcastStar').style.display = 'block';
                        window.activeMsg = data.message;
                    } else {
                        document.getElementById('broadcastStar').style.display = 'none';
                    }
                }
            });
        }
        window.showBroadcast = () => alert("ğŸ“¢ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ©:\n\n" + window.activeMsg);

        // 2. ÙØ­Øµ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚
        function checkLoginPopup() {
            onSnapshot(doc(db, "Settings", "loginPopup"), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.expiry > Date.now()) {
                        const overlay = document.getElementById('loginPopupOverlay');
                        const content = document.getElementById('loginPopupContent');
                        
                        document.getElementById('popMessage').innerText = data.message;
                        content.className = `login-popup-content popup-${data.type}`;
                        overlay.style.display = 'flex';

                        // Ø¥ØºÙ„Ø§Ù‚ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
                        setTimeout(() => { closeLoginPopup(); }, data.duration * 1000);
                    }
                }
            });
        }

        window.closeLoginPopup = () => {
            document.getElementById('loginPopupOverlay').style.display = 'none';
        };
    </script>
</body>
</html>
