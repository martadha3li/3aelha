<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مواقيت الصلاة</title>
    <script src="https://cdn.jsdelivr.net/npm/praytimes@2.3.1/prayTimes.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #0f2027, #2c5364); color:white; padding:1.5rem; font-family:system-ui; min-height:100vh; }
        .card { background:rgba(255,255,255,0.12); backdrop-filter:blur(12px); border:none; border-radius:1.2rem; box-shadow:0 8px 24px rgba(0,0,0,0.5); }
        .countdown { color:#ffdd57; font-weight:bold; font-size:1.4rem; }
        table { font-size:1rem; }
        th { background:rgba(255,255,255,0.2) !important; }
        .active { background:rgba(255,221,87,0.25) !important; }
        #monthTable { display:none; }
        .status { color:#ffdd57; }
    </style>
</head>
<body>

<div class="container">
    <div class="text-center mb-4">
        <h3>مواقيت الصلاة</h3>
        <div id="cityName" class="status">جارٍ التحميل...</div>
        <div id="countdown" class="countdown"></div>
    </div>

    <div class="card p-4 mb-4">
        <div class="mb-3">
            <label class="form-label">اختر المدينة</label>
            <select id="citySelect" class="form-select" onchange="loadAndRender()">
                <option value="gps">موقعي الحالي</option>
                <option value="ahsa">الأحساء</option>
                <option value="dammam">الدمام</option>
                <option value="riyadh">الرياض</option>
                <option value="jeddah">جدة</option>
                <option value="mecca">مكة</option>
            </select>
        </div>

        <div id="todayTable"></div>

        <button class="btn btn-primary w-100 mt-3" onclick="toggleMonthTable()">عرض/إخفاء جدول الشهر</button>
        <div id="monthTable" class="mt-4"></div>
    </div>
</div>

<script type="module">
    import { db } from './config.js';  // ← تأكد من وجود الملف
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const prayTimes = new PrayTimes('Jafari');
    prayTimes.adjust({ fajr: 18.5, maghrib: 4, isha: 14.5 });

    const cities = {
        ahsa:   {name:"الأحساء",   lat:25.383,   lng:49.586},
        dammam: {name:"الدمام",    lat:26.4207,  lng:50.0888},
        riyadh: {name:"الرياض",    lat:24.7136,  lng:46.6753},
        jeddah: {name:"جدة",       lat:21.4858,  lng:39.1925},
        mecca:  {name:"مكة",       lat:21.3891,  lng:39.8579}
    };

    let adjustments = {global:{}, daily:{}};
    let selectedCity = "gps";
    let userCoords = null;

    async function loadAdjustments() {
        try {
            const snap = await getDoc(doc(db, "Settings", "Adjustments"));
            if (snap.exists()) adjustments = snap.data() || {global:{}, daily:{}};
        } catch(e) { console.warn("لا يمكن تحميل التعديلات", e); }
    }

    function addMinutes(time, min) {
        let [h,m] = time.split(":").map(Number);
        let d = new Date(2000,0,1,h,m+min);
        return d.toTimeString().slice(0,5);
    }

    function applyAdj(times, date) {
        const day = date.getDate()+"";
        const g = adjustments.global;
        const d = adjustments.daily[day] || {};
        return {
            fajr: addMinutes(times.fajr,    (g.fajr||0) + (d.fajr||0)),
            dhuhr:addMinutes(times.dhuhr,   g.dhuhr||0),
            asr:  addMinutes(times.asr,     g.asr||0),
            maghrib:addMinutes(times.maghrib,(g.maghrib||0)+(d.maghrib||0)),
            isha: addMinutes(times.isha,    g.isha||0)
        };
    }

    function getTimesFor(lat, lng, date = new Date()) {
        return applyAdj(prayTimes.getTimes(date, [lat, lng], 3), date);
    }

    async function loadAndRender() {
        selectedCity = document.getElementById("citySelect").value;
        document.getElementById("cityName").textContent = "جارٍ التحميل...";

        if (selectedCity === "gps") {
            if (!userCoords) {
                try {
                    const pos = await new Promise((res, rej) => 
                        navigator.geolocation.getCurrentPosition(res, rej, {timeout:8000, maximumAge:30000})
                    );
                    userCoords = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                } catch (e) {
                    console.warn("فشل تحديد الموقع", e);
                    document.getElementById("cityName").textContent = "تعذر تحديد الموقع ← اختر مدينة يدوياً";
                    selectedCity = "riyadh"; // fallback
                }
            }
        }

        const coords = selectedCity === "gps" ? userCoords : cities[selectedCity];
        if (!coords) {
            document.getElementById("cityName").textContent = "يرجى اختيار مدينة";
            return;
        }

        document.getElementById("cityName").textContent = 
            selectedCity === "gps" ? "موقعك الحالي" : cities[selectedCity].name;

        await loadAdjustments();
        renderToday(coords);
    }

    function renderToday(coords) {
        const today = new Date();
        const a = getTimesFor(cities.ahsa.lat, cities.ahsa.lng, today);
        const d = getTimesFor(cities.dammam.lat, cities.dammam.lng, today);
        const r = getTimesFor(cities.riyadh.lat, cities.riyadh.lng, today);
        const c = getTimesFor(coords.lat, coords.lng, today);

        let html = `
        <table class="table table-dark table-striped text-center">
            <thead><tr><th>الصلاة</th><th>الأحساء</th><th>الدمام</th><th>الرياض</th><th>الحالي</th></tr></thead>
            <tbody>
                <tr><td>الفجر</td><td>${a.fajr}</td><td>${d.fajr}</td><td>${r.fajr}</td><td>${c.fajr}</td></tr>
                <tr><td>الظهر</td><td>${a.dhuhr}</td><td>${d.dhuhr}</td><td>${r.dhuhr}</td><td>${c.dhuhr}</td></tr>
                <tr><td>العصر</td><td>${a.asr}</td><td>${d.asr}</td><td>${r.asr}</td><td>${c.asr}</td></tr>
                <tr><td>المغرب</td><td>${a.maghrib}</td><td>${d.maghrib}</td><td>${r.maghrib}</td><td>${c.maghrib}</td></tr>
                <tr><td>العشاء</td><td>${a.isha}</td><td>${d.isha}</td><td>${r.isha}</td><td>${c.isha}</td></tr>
            </tbody>
        </table>`;

        document.getElementById("todayTable").innerHTML = html;
        startCountdown(c);
    }

    function startCountdown(times) {
        const prayers = [
            {name:"الفجر", time:times.fajr},
            {name:"الظهر", time:times.dhuhr},
            {name:"العصر", time:times.asr},
            {name:"المغرب",time:times.maghrib},
            {name:"العشاء",time:times.isha}
        ];

        setInterval(() => {
            const now = new Date();
            for (let p of prayers) {
                let [h,m] = p.time.split(":").map(Number);
                let pt = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                if (pt > now) {
                    const diff = pt - now;
                    const hLeft = Math.floor(diff / 3600000);
                    const mLeft = Math.floor((diff % 3600000) / 60000);
                    const sLeft = Math.floor((diff % 60000) / 1000);
                    document.getElementById("countdown").textContent = 
                        `الصلاة القادمة: ${p.name} بعد ${hLeft.toString().padStart(2,"0")}:${mLeft.toString().padStart(2,"0")}:${sLeft.toString().padStart(2,"0")}`;
                    break;
                }
            }
        }, 980);
    }

    window.toggleMonthTable = async function() {
        const el = document.getElementById("monthTable");
        if (el.style.display !== "block") {
            el.style.display = "block";
            await renderMonthTable();
        } else {
            el.style.display = "none";
        }
    };

    async function renderMonthTable() {
        await loadAdjustments();
        const now = new Date();
        let html = '<table class="table table-dark table-sm text-center"><thead><tr><th>اليوم</th><th>فجر</th><th>مغرب</th></tr></thead><tbody>';

        for (let i = 1; i <= 31; i++) {
            let d = new Date(now.getFullYear(), now.getMonth(), i);
            if (d.getMonth() !== now.getMonth()) break;
            let t = getTimesFor(cities.riyadh.lat, cities.riyadh.lng, d); // أو أي مدينة مرجعية
            html += `<tr><td>${i}</td><td>${t.fajr}</td><td>${t.maghrib}</td></tr>`;
        }
        html += '</tbody></table>';
        document.getElementById("monthTable").innerHTML = html;
    }

    // التحميل الأولي
    loadAndRender().catch(console.error);
</script>
</body>
</html>
