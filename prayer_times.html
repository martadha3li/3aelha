<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; text-align: center; }
        
        /* ÙƒØ±Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© */
        .info-card { background: #1c1c1e; color: #fff; padding: 20px; border-radius: 25px; margin-bottom: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .timer-value { font-size: 28px; font-weight: 900; color: #34C759; margin: 5px 0; }
        .upcoming-event { border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; font-size: 13px; color: #FFCC00; }

        .date-card { background: linear-gradient(135deg, #007AFF, #0055AA); color: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; }
        .today-event-box { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px; font-size: 14px; margin-top: 10px; font-weight: bold; }

        .times-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .times-table th { color: var(--ios-blue); font-size: 11px; padding: 5px; }
        .time-row-card { background: var(--card-bg); border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .time-row-card td { padding: 12px 2px; border-bottom: 0.5px solid #f2f2f7; font-size: 13px; }
        
        .prayer-name { font-weight: bold; color: #444; text-align: right; padding-right: 15px !important; }
        .ahsa-time { color: var(--ios-blue); font-weight: 800; background: #E5F1FF; }
        .user-loc-time { color: #5856D6; font-weight: 800; background: #F5F5FF; border: 1px solid #5856D6; border-radius: 10px; }
    </style>
</head>
<body>

    <div class="info-card">
        <div id="nextPrayerLabel" style="font-size: 12px; opacity: 0.8;">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</div>
        <div class="timer-value" id="timer">00:00:00</div>
        <div id="upcomingEventBox" class="upcoming-event">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©...</div>
    </div>

    <div class="date-card">
        <div id="hijriDate" style="font-size: 19px; font-weight: bold;">-- --- ----</div>
        <div id="todayEvent" class="today-event-box">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…</div>
    </div>

    <table class="times-table">
        <thead>
            <tr>
                <th style="text-align: right; padding-right: 15px;">Ø§Ù„ÙØ±ÙŠØ¶Ø©</th>
                <th>Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</th>
                <th id="userCityHeader" style="display:none; color:#5856D6;">Ù…ÙˆÙ‚Ø¹Ùƒ</th>
                <th>Ø§Ù„Ø¯Ù…Ø§Ù…</th>
                <th>Ø§Ù„Ø±ÙŠØ§Ø¶</th>
            </tr>
        </thead>
        <tbody id="prayerTableBody"></tbody>
    </table>

    <button onclick="location.href='news.html'" style="margin-top:25px; border:none; background:none; color:var(--ios-blue); font-weight:bold; cursor:pointer;">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script type="module">
    import { db } from './config.js';
    import { doc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const AHSA_LONG = 49.598; 
    let userOffset = 0;
    let prayerTimesArr = [];

    const prayers = [
        { id: 'Imsak', name: 'Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ', base: '04:35', key: 'offsetImsak' },
        { id: 'Fajr', name: 'Ø§Ù„ÙØ¬Ø±', base: '04:45', key: 'offsetFajr' },
        { id: 'Shuruq', name: 'Ø§Ù„Ø´Ø±ÙˆÙ‚', base: '06:05', key: 'offsetShuruq' },
        { id: 'Dhuhr', name: 'Ø§Ù„Ø¸Ù‡Ø±', base: '12:05', key: 'offsetDhuhr' },
        { id: 'Maghrib', name: 'Ø§Ù„Ù…ØºØ±Ø¨', base: '18:15', key: 'offsetMaghrib' }
    ];

    // Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ
    const today = new Date();
    const hOptions = { day:'numeric', month:'long', year:'numeric', calendar:'islamic-uma' };
    const hNumOptions = { day:'numeric', month:'numeric', calendar:'islamic-uma' };
    document.getElementById('hijriDate').innerText = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-uma', hOptions).format(today);
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù€ "ÙŠÙˆÙ…-Ø´Ù‡Ø±"
    const hParts = new Intl.DateTimeFormat('en-u-ca-islamic-uma', {day:'numeric', month:'numeric'}).format(today).split('/');
    const currentDayMonth = `${hParts[0]}-${hParts[1]}`;

    // 1. Ø·Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userOffset = (AHSA_LONG - pos.coords.longitude) * 4;
            document.getElementById('userCityHeader').style.display = 'table-cell';
            loadApp();
        }, () => loadApp());
    } else { loadApp(); }

    function loadApp() {
        onSnapshot(doc(db, "Settings", "PrayerConfig"), (snap) => {
            const config = snap.exists() ? snap.data() : {};
            renderTimes(config);
            findEvents(config.event);
        });
    }

    function renderTimes(config) {
        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        prayerTimesArr = [];

        prayers.forEach(p => {
            const off = config[p.key] || 0;
            const ahsaDate = calculateDate(p.base, off);
            prayerTimesArr.push({ name: p.name, date: ahsaDate });

            const row = document.createElement('tr');
            row.className = 'time-row-card';
            
            let userCell = userOffset !== 0 ? `<td class="user-loc-time">${formatT(calculateDate(p.base, off + userOffset))}</td>` : "";

            row.innerHTML = `
                <td class="prayer-name">${p.name}</td>
                <td class="ahsa-time">${formatT(ahsaDate)}</td>
                ${userCell}
                <td class="other-time">${formatT(calculateDate(p.base, off - 3))}</td>
                <td class="other-time">${formatT(calculateDate(p.base, off + 12))}</td>
            `;
            tbody.appendChild(row);
        });
        startCountdown();
    }

    async function findEvents(manualEvent) {
        // ÙØ­Øµ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…
        const allEventsSnap = await getDocs(collection(db, "HijriEvents"));
        let todayMsg = manualEvent || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…";
        let upcoming = null;
        let minDiff = 400;

        allEventsSnap.forEach(doc => {
            const ev = doc.data();
            const evKey = `${ev.day}-${ev.month}`;
            
            if(evKey === currentDayMonth) {
                todayMsg = `ğŸŒŸ ${ev.title}`;
            }

            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© (ØªÙ‚Ø±ÙŠØ¨ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ù‡ Ø­Ø³Ø¨Ø© Ù…Ø¨Ø³Ø·Ø© Ù„ÙØ±Ù‚ Ø§Ù„Ø´Ù‡ÙˆØ± ÙˆØ§Ù„Ø£ÙŠØ§Ù…
            let diff = (ev.month * 30 + ev.day) - (parseInt(hParts[1]) * 30 + parseInt(hParts[0]));
            if (diff > 0 && diff < minDiff) {
                minDiff = diff;
                upcoming = { title: ev.title, days: diff };
            }
        });

        document.getElementById('todayEvent').innerText = todayMsg;
        if(upcoming) {
            document.getElementById('upcomingEventBox').innerText = `Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ${upcoming.title} (Ø¨Ø¹Ø¯ ${upcoming.days} ÙŠÙˆÙ…)`;
        } else {
            document.getElementById('upcomingEventBox').style.display = 'none';
        }
    }

    function calculateDate(base, offset) {
        let [h, m] = base.split(':').map(Number);
        let d = new Date(); d.setHours(h, m + Math.round(offset), 0, 0); return d;
    }

    function formatT(d) {
        return d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }).replace("Øµ", "Ø£").replace("Ù…", "Ù…");
    }

    function startCountdown() {
        if(window.timer) clearInterval(window.timer);
        window.timer = setInterval(() => {
            const now = new Date();
            let next = prayerTimesArr.find(p => p.date > now);
            if(!next) {
                let tom = new Date(prayerTimesArr[0].date); tom.setDate(tom.getDate()+1);
                next = { name: prayerTimesArr[0].name, date: tom };
            }
            const diff = next.date - now;
            const hh = Math.floor(diff/3600000), mm = Math.floor((diff%3600000)/60000), ss = Math.floor((diff%60000)/1000);
            document.getElementById('timer').innerText = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
            document.getElementById('nextPrayerLabel').innerText = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù€ ${next.name}:`;
        }, 1000);
    }
</script>
</body>
</html>
