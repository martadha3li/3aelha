<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© - Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { 
            background: linear-gradient(180deg, #1a2a6c, #b21f1f, #fdbb2d); 
            background-attachment: fixed; font-family: -apple-system, sans-serif;
            margin: 0; color: white; padding-top: 80px; text-align: center;
        }
        .location-badge {
            background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px);
            padding: 8px 20px; border-radius: 20px; display: inline-flex;
            align-items: center; gap: 8px; font-size: 14px; margin-bottom: 10px;
        }
        .hijri-date { font-size: 18px; opacity: 0.9; margin-bottom: 25px; }
        .prayer-list {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(15px);
            border-radius: 25px; width: 90%; max-width: 400px; margin: 0 auto;
        }
        .prayer-row {
            display: flex; justify-content: space-between; padding: 20px 25px;
            border-bottom: 0.5px solid rgba(255,255,255,0.1);
        }
        .prayer-row:last-child { border-bottom: none; }
        .time-val { font-variant-numeric: tabular-nums; font-weight: bold; }
    </style>
</head>
<body>

    <script type="module" src="header.js"></script>
    <script type="module" src="navbar.js"></script>

    <div class="location-badge">ğŸ“ <span id="cityName">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span></div>
    <div class="hijri-date" id="hijriDisplay">-- --- ----</div>

    <div class="prayer-list">
        <div class="prayer-row"><span>Ø§Ù„ÙØ¬Ø±</span><span class="time-val" id="fajr">--:--</span></div>
        <div class="prayer-row"><span>Ø§Ù„Ø¸Ù‡Ø±</span><span class="time-val" id="dhuhr">--:--</span></div>
        <div class="prayer-row"><span>Ø§Ù„Ø¹ØµØ±</span><span class="time-val" id="asr">--:--</span></div>
        <div class="prayer-row"><span>Ø§Ù„Ù…ØºØ±Ø¨</span><span class="time-val" id="maghrib">--:--</span></div>
        <div class="prayer-row"><span>Ø§Ù„Ø¹Ø´Ø§Ø¡</span><span class="time-val" id="isha">--:--</span></div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-uma-nu-latn', {
        day: 'numeric', month: 'long', year: 'numeric'
    }).format(new Date());
    document.getElementById('hijriDisplay').innerText = hijri;

    // 2. Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª
    function adjustTime(timeStr, offset) {
        if (!timeStr) return "--:--";
        let [hrs, mins] = timeStr.split(':').map(Number);
        let d = new Date();
        d.setHours(hrs);
        d.setMinutes(mins + (offset || 0));
        return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
    }

    // 3. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    navigator.geolocation.getCurrentPosition(async (pos) => {
        const { latitude: lat, longitude: lon } = pos.coords;

        // Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=ar`);
        const geoData = await geo.json();
        document.getElementById('cityName').innerText = geoData.address.city || geoData.address.town || "Ø§Ù„Ø£Ø­Ø³Ø§Ø¡";

        // Ø¬Ù„Ø¨ Ø£ÙˆÙ‚Ø§Øª Ø§Ù„ØµÙ„Ø§Ø© (Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´ÙŠØ¹Ø© Ù„Ù„Ø£Ø­Ø³Ø§Ø¡)
        const api = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=99&methodSettings[fajr]=18.5&methodSettings[maghrib]=4.0&methodSettings[isha]=14.5`);
        const data = await api.json();
        const apiTimes = data.data.timings;

        // Ø¬Ù„Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        const adminSnap = await getDoc(doc(db, "Settings", "PrayerOffsets"));
        const off = adminSnap.exists() ? adminSnap.data() : {};

        // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        document.getElementById('fajr').innerText = adjustTime(apiTimes.Fajr, off.fajr);
        document.getElementById('dhuhr').innerText = adjustTime(apiTimes.Dhuhr, off.dhuhr);
        document.getElementById('asr').innerText = adjustTime(apiTimes.Asr, off.asr);
        document.getElementById('maghrib').innerText = adjustTime(apiTimes.Maghrib, off.maghrib);
        document.getElementById('isha').innerText = adjustTime(apiTimes.Isha, off.isha);
    });
</script>
</body>
</html>
