<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© | Ø§Ù„Ø£Ø­Ø³Ø§Ø¡ ÙˆØ§Ù„Ù…Ù†Ø§Ø·Ù‚</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; text-align: center; }
        
        /* ÙƒØ±Øª Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ */
        .countdown-card { background: #1c1c1e; color: #fff; padding: 20px; border-radius: 25px; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .next-label { font-size: 14px; opacity: 0.8; margin-bottom: 5px; }
        .timer-value { font-size: 32px; font-weight: 900; font-variant-numeric: tabular-nums; color: #34C759; }

        /* ÙƒØ±Øª Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© */
        .date-card { background: linear-gradient(135deg, #007AFF, #0055AA); color: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,122,255,0.3); }
        .hijri-date { font-size: 20px; font-weight: bold; margin-bottom: 5px; }
        .event-text { background: rgba(255,255,255,0.15); padding: 10px; border-radius: 12px; font-size: 14px; margin-top: 10px; border: 1px dashed rgba(255,255,255,0.3); }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø·ÙˆØ± */
        .times-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; margin-top: 10px; }
        .times-table th { color: var(--ios-blue); font-size: 13px; padding: 10px; }
        .time-row-card { background: var(--card-bg); border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); transition: 0.3s; }
        .time-row-card td { padding: 15px 5px; border-bottom: 0.5px solid #f2f2f7; }
        
        .prayer-name { font-weight: bold; color: #444; text-align: right; padding-right: 15px !important; border-radius: 15px 0 0 15px; }
        .ahsa-time { color: var(--ios-blue); font-weight: 800; font-size: 17px; background: #E5F1FF; }
        .other-time { color: #666; font-size: 14px; font-weight: 600; }
        
        .active-prayer { border: 2px solid #34C759 !important; transform: scale(1.02); }
    </style>
</head>
<body>

    <div class="countdown-card" id="countdownBox" style="display: none;">
        <div class="next-label" id="nextPrayerLabel">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©...</div>
        <div class="timer-value" id="timer">00:00:00</div>
    </div>

    <div class="date-card">
        <div id="hijriDate" class="hijri-date">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®...</div>
        <div id="gregorianDate" style="opacity: 0.9; font-size: 13px;"></div>
        <div id="todayEvent" class="event-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</div>
    </div>

    <table class="times-table">
        <thead>
            <tr>
                <th style="text-align: right; padding-right: 15px;">Ø§Ù„ÙØ±ÙŠØ¶Ø©</th>
                <th>Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</th>
                <th>Ø§Ù„Ø¯Ù…Ø§Ù…</th>
                <th>Ø§Ù„Ø±ÙŠØ§Ø¶</th>
            </tr>
        </thead>
        <tbody id="prayerTableBody"></tbody>
    </table>

    <button onclick="location.href='news.html'" style="margin-top:30px; border:none; background:none; color:var(--ios-blue); font-weight:bold; cursor:pointer; font-size: 16px;">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script type="module">
    import { db } from './config.js';
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const prayers = [
        { id: 'Imsak', name: 'Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ', base: '04:35', key: 'offsetImsak' },
        { id: 'Fajr', name: 'Ø§Ù„ÙØ¬Ø±', base: '04:45', key: 'offsetFajr' },
        { id: 'Shuruq', name: 'Ø§Ù„Ø´Ø±ÙˆÙ‚', base: '06:05', key: 'offsetShuruq' },
        { id: 'Dhuhr', name: 'Ø§Ù„Ø¸Ù‡Ø±', base: '12:05', key: 'offsetDhuhr' },
        { id: 'Maghrib', name: 'Ø§Ù„Ù…ØºØ±Ø¨', base: '18:15', key: 'offsetMaghrib' }
    ];

    let prayerTimesObjects = [];

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const today = new Date();
    const hijriOptions = { day: 'numeric', month: 'long', year: 'numeric', calendar: 'islamic-uma' };
    document.getElementById('hijriDate').innerText = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-uma', hijriOptions).format(today);
    document.getElementById('gregorianDate').innerText = today.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'long' });

    onSnapshot(doc(db, "Settings", "PrayerConfig"), (docSnap) => {
        const config = docSnap.exists() ? docSnap.data() : {};
        if(config.event) document.getElementById('todayEvent').innerText = config.event;

        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        prayerTimesObjects = [];

        prayers.forEach(p => {
            const offset = config[p.key] || 0;
            const ahsaDate = getPrayerDate(p.base, offset);
            
            prayerTimesObjects.push({ name: p.name, date: ahsaDate });

            const row = document.createElement('tr');
            row.className = 'time-row-card';
            row.id = `row-${p.id}`;
            row.innerHTML = `
                <td class="prayer-name">${p.name}</td>
                <td class="ahsa-time">${formatTime(ahsaDate)}</td>
                <td class="other-time">${formatTime(getPrayerDate(p.base, offset - 3))}</td>
                <td class="other-time">${formatTime(getPrayerDate(p.base, offset + 12))}</td>
            `;
            tbody.appendChild(row);
        });
        updateCountdown();
    });

    function getPrayerDate(base, offset) {
        let [hrs, mins] = base.split(':').map(Number);
        let d = new Date();
        d.setHours(hrs, mins + offset, 0, 0);
        return d;
    }

    function formatTime(date) {
        return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }).replace("Øµ", "Ø£").replace("Ù…", "Ù…");
    }

    function updateCountdown() {
        setInterval(() => {
            const now = new Date();
            let next = prayerTimesObjects.find(p => p.date > now);
            
            // Ø¥Ø°Ø§ Ø§Ù†ØªÙ‡Øª ØµÙ„ÙˆØ§Øª Ø§Ù„ÙŠÙˆÙ…ØŒ Ø§Ø¨Ø­Ø« Ø¹Ù† Ø£ÙˆÙ„ ØµÙ„Ø§Ø© ØºØ¯Ø§Ù‹ (Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ)
            if (!next) {
                const tomorrowImsak = new Date(prayerTimesObjects[0].date);
                tomorrowImsak.setDate(tomorrowImsak.getDate() + 1);
                next = { name: prayerTimesObjects[0].name, date: tomorrowImsak };
            }

            document.getElementById('countdownBox').style.display = 'block';
            document.getElementById('nextPrayerLabel').innerText = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù€ ${next.name} (Ø§Ù„Ø£Ø­Ø³Ø§Ø¡):`;
            
            const diff = next.date - now;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);

            document.getElementById('timer').innerText = 
                `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            
            // ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ø£Ø­Ù…Ø± Ø¥Ø°Ø§ Ø¨Ù‚ÙŠ Ø£Ù‚Ù„ Ù…Ù† 15 Ø¯Ù‚ÙŠÙ‚Ø©
            document.getElementById('timer').style.color = (diff < 900000) ? "#FF3B30" : "#34C759";
        }, 1000);
    }
</script>
</body>
</html>
