<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© | Ø¹Ø§Ø¦Ù„Ø© Ù…Ø±ØªØ¶Ù‰</title>
    <style>
        :root { --islamic-green: #006644; --gold: #D4AF37; --soft-bg: #F8F9F5; --white: #FFFFFF; }
        body { background-color: var(--soft-bg); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; text-align: center; direction: rtl; }
        
        .date-display { font-size: 15px; font-weight: bold; color: var(--islamic-green); margin: 15px 0; line-height: 1.6; }
        .date-separator { color: var(--gold); margin: 0 5px; }

        .main-header-card { 
            background: linear-gradient(145deg, var(--islamic-green), #004422); 
            color: white; padding: 25px 20px; border-radius: 30px; margin-bottom: 20px; 
            box-shadow: 0 10px 25px rgba(0,70,40,0.2); border: 2px solid var(--gold);
        }

        .timer-val { font-size: 36px; font-weight: 800; color: var(--gold); margin: 10px 0; font-family: sans-serif; }

        .event-box {
            background: rgba(255, 255, 255, 0.1); border: 1px dashed var(--gold);
            border-radius: 15px; padding: 12px; margin-top: 15px; font-size: 14px; min-height: 45px;
        }

        .prayer-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .prayer-table th { color: var(--islamic-green); font-size: 11px; padding-bottom: 5px; }
        
        .prayer-row { background: var(--white); border-radius: 18px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .prayer-row td { padding: 16px 8px; font-size: 15px; font-weight: bold; }
        .prayer-row td:first-child { border-radius: 0 18px 18px 0; text-align: right; padding-right: 20px; }
        .prayer-row td:last-child { border-radius: 18px 0 0 18px; }

        .time-cell { font-family: sans-serif; font-weight: 700; color: #444; }
        .primary-time { color: var(--islamic-green); font-size: 17px; background: #f0f7f3; }
        .user-time { color: #5856D6; border: 1.5px solid #5856D6; border-radius: 10px; }
        
        .back-btn { background: var(--islamic-green); color: white; border: none; padding: 12px 30px; border-radius: 20px; font-weight: bold; margin-top: 25px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="date-display" id="fullDateDisplay">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®...</div>

    <div class="main-header-card">
        <div id="nextPrayerLabel" style="font-size: 13px; opacity: 0.9;">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø¨Ø¹Ø¯:</div>
        <div class="timer-val" id="timer">00:00:00</div>
        <div id="eventContainer" class="event-box">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª...</div>
    </div>

    <table class="prayer-table">
        <thead>
            <tr>
                <th>Ø§Ù„ÙØ±ÙŠØ¶Ø©</th>
                <th>Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</th>
                <th id="userCityHeader" style="display:none;">Ù…ÙˆÙ‚Ø¹Ùƒ</th>
                <th>Ø§Ù„Ø¯Ù…Ø§Ù…</th>
                <th>Ø§Ù„Ø±ÙŠØ§Ø¶</th>
            </tr>
        </thead>
        <tbody id="prayerTableBody"></tbody>
    </table>

    <button class="back-btn" onclick="location.href='news.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script type="module">
    import { db } from './config.js';
    import { doc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const AHSA_LONG = 49.598; 
    let userOffset = 0;
    let prayerTimesArr = [];
    let currentConfig = {};

    // --- 1. ØªØµØ­ÙŠØ­ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‡Ø¬Ø±ÙŠ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„ÙŠÙˆÙ… (7 Ø±Ù…Ø¶Ø§Ù† 1447) ---
    const now = new Date();
    const arabicMonths = ["Ù…Ø­Ø±Ù…", "ØµÙØ±", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„", "Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰", "Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©", "Ø±Ø¬Ø¨", "Ø´Ø¹Ø¨Ø§Ù†", "Ø±Ù…Ø¶Ø§Ù†", "Ø´ÙˆØ§Ù„", "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©", "Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©"];
    const weekDays = ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³", "Ø§Ù„Ø¬Ù…Ø¹Ø©", "Ø§Ù„Ø³Ø¨Øª"];

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù‡Ø¬Ø±ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø¯Ø®Ù„Ø§ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø§Ù„ÙŠÙˆÙ… 24 ÙØ¨Ø±Ø§ÙŠØ± = 7 Ø±Ù…Ø¶Ø§Ù†)
    const hDay = 7; 
    const hMonth = 9; // Ø±Ù…Ø¶Ø§Ù†
    const hYear = 1447;

    const mDate = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()}`;
    const dName = weekDays[now.getDay()];

    document.getElementById('fullDateDisplay').innerHTML = `
        ${hDay} ${arabicMonths[hMonth-1]} ${hYear} Ù‡Ù€ 
        <span class="date-separator">|</span> 
        ${mDate} Ù…
        <span class="date-separator">-</span>
        ${dName}
    `;

    // --- 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
            userOffset = (AHSA_LONG - pos.coords.longitude) * 4;
            document.getElementById('userCityHeader').style.display = 'table-cell';
            startListening();
        }, () => startListening());
    } else { startListening(); }

    function startListening() {
        onSnapshot(doc(db, "Settings", "PrayerConfig"), (snap) => {
            if (snap.exists()) {
                currentConfig = snap.data();
                renderUI();
            }
        });
    }

    async function renderUI() {
        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        prayerTimesArr = [];

        const prayers = [
            { id: 'Imsak', name: 'Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ', base: '04:35', key: 'offsetImsak' },
            { id: 'Fajr', name: 'Ø§Ù„ÙØ¬Ø±', base: '04:45', key: 'offsetFajr' },
            { id: 'Shuruq', name: 'Ø§Ù„Ø´Ø±ÙˆÙ‚', base: '06:05', key: 'offsetShuruq' },
            { id: 'Dhuhr', name: 'Ø§Ù„Ø¸Ù‡Ø±', base: '12:05', key: 'offsetDhuhr' },
            { id: 'Maghrib', name: 'Ø§Ù„Ù…ØºØ±Ø¨', base: '18:15', key: 'offsetMaghrib' }
        ];

        prayers.forEach(p => {
            const off = currentConfig[p.key] || 0;
            const ahsaDate = calc(p.base, off);
            prayerTimesArr.push({ name: p.name, date: ahsaDate });

            const row = document.createElement('tr');
            row.className = 'prayer-row';
            let uCell = userOffset !== 0 ? `<td class="time-cell user-time">${fmt(calc(p.base, off + userOffset))}</td>` : "";

            row.innerHTML = `
                <td>${p.name}</td>
                <td class="time-cell primary-time">${fmt(ahsaDate)}</td>
                ${uCell}
                <td class="time-cell">${fmt(calc(p.base, off - 3))}</td>
                <td class="time-cell">${fmt(calc(p.base, off + 12))}</td>
            `;
            tbody.appendChild(row);
        });

        // --- 3. ØªØµØ­ÙŠØ­ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø«Ø§Ø¨Øª ---
        const evSnap = await getDocs(collection(db, "HijriEvents"));
        let todayMsg = null;
        let upcoming = null;
        let minDiff = 400;

        evSnap.forEach(dDoc => {
            const ev = dDoc.data();
            const evDay = parseInt(ev.day);
            const evMonth = parseInt(ev.month);

            if(evDay === hDay && evMonth === hMonth) {
                todayMsg = ev.title;
            }

            // Ø­Ø³Ø¨Ø© Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø±Ù…Ø¶Ø§Ù† (9) ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            let diff = 0;
            if (evMonth === hMonth) {
                diff = evDay - hDay;
            } else if (evMonth > hMonth) {
                diff = (evMonth - hMonth) * 30 + (evDay - hDay);
            } else {
                diff = (12 - hMonth + evMonth) * 30 + (evDay - hDay);
            }

            if (diff > 0 && diff < minDiff) {
                minDiff = diff;
                upcoming = { title: ev.title, days: diff };
            }
        });

        const box = document.getElementById('eventContainer');
        if (todayMsg) {
            box.innerHTML = `<span style="color:var(--gold); font-weight:bold;">âœ¨ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…:</span><br>${todayMsg}`;
        } else if (upcoming) {
            let dayText = upcoming.days === 1 ? "ØºØ¯Ø§Ù‹" : `Ø¨Ø¹Ø¯ ${upcoming.days} ÙŠÙˆÙ…`;
            box.innerHTML = `<span style="opacity:0.8; font-size:12px;">Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© (${dayText}):</span><br><b>${upcoming.title}</b>`;
        } else {
            box.innerText = currentConfig.event || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù‚Ø±ÙŠØ¨Ø©";
        }
        
        startTimer();
    }

    function calc(base, off) {
        let [h, m] = base.split(':').map(Number);
        let d = new Date(); d.setHours(h, m + Math.round(off), 0, 0); return d;
    }

    function fmt(d) {
        let h = d.getHours(), m = d.getMinutes();
        let amp = h >= 12 ? ' PM' : ' AM';
        h = h % 12 || 12;
        return `${h}:${m < 10 ? '0'+m : m}${amp}`;
    }

    function startTimer() {
        if(window.timerLoop) clearInterval(window.timerLoop);
        window.timerLoop = setInterval(() => {
            const now = new Date();
            let next = prayerTimesArr.find(p => p.date > now);
            if(!next && prayerTimesArr.length > 0) {
                let tom = new Date(prayerTimesArr[0].date); tom.setDate(tom.getDate()+1);
                next = { name: prayerTimesArr[0].name, date: tom };
            }
            if(next) {
                const diff = next.date - now;
                const hh = Math.floor(diff/3600000), mm = Math.floor((diff%3600000)/60000), ss = Math.floor((diff%60000)/1000);
                document.getElementById('timer').innerText = `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
                document.getElementById('nextPrayerLabel').innerText = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„Ù€ ${next.name}:`;
            }
        }, 1000);
    }
</script>
    <script type="module" src="navbar.js"></script>
</body>
</html>
