<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مواقيت الصلاة</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0A84FF">

<script src="https://cdn.jsdelivr.net/npm/praytimes@2.3.1/prayTimes.min.js"></script>

<style>
body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont;
background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
color:white;
padding:20px;
}

.header{
text-align:center;
margin-bottom:20px;
}

.city{
font-size:14px;
opacity:.9;
}

.countdown{
margin-top:8px;
font-size:16px;
color:#FFD700;
}

.card{
background:rgba(255,255,255,0.1);
backdrop-filter:blur(20px);
border-radius:20px;
padding:15px;
margin-bottom:20px;
box-shadow:0 8px 20px rgba(0,0,0,0.3);
}

table{
width:100%;
border-collapse:collapse;
font-size:14px;
}

th,td{
padding:10px;
text-align:center;
}

th{
background:rgba(255,255,255,0.15);
border-radius:10px;
}

.prayer-row.active{
background:rgba(255,215,0,0.2);
border-radius:10px;
}

.month-btn{
background:#0A84FF;
border:none;
padding:10px;
border-radius:10px;
color:white;
width:100%;
margin-top:10px;
}

#monthTable{
display:none;
margin-top:15px;
}
</style>
</head>

<body>

<div class="header">
<h2>مواقيت الصلاة</h2>
<div class="city" id="cityName">جارٍ تحديد الموقع...</div>
<div class="countdown" id="countdown"></div>
</div>

<div class="card">
<div id="todayTable"></div>
<button class="month-btn" onclick="toggleMonth()">عرض الشهر الهجري كامل</button>
<div id="monthTable"></div>
</div>

<script>
if ('serviceWorker' in navigator) {
navigator.serviceWorker.register('service-worker.js');
}

const prayTimes = new PrayTimes('Jafari');
prayTimes.adjust({fajr:18.5, maghrib:4, isha:14.5});

const cities={
ahsa:{name:"الأحساء",lat:25.383,lng:49.586},
dammam:{name:"الدمام",lat:26.4207,lng:50.0888},
riyadh:{name:"الرياض",lat:24.7136,lng:46.6753}
};

function calculate(lat,lng,date){
return prayTimes.getTimes(date,[lat,lng],3);
}

function calculateMidnight(maghrib,fajr){
let [mh,mm]=maghrib.split(':').map(Number);
let [fh,fm]=fajr.split(':').map(Number);
let m=new Date(); m.setHours(mh,mm);
let f=new Date(); f.setDate(f.getDate()+1); f.setHours(fh,fm);
let mid=new Date(m.getTime()+((f-m)/2));
return mid.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
}

function renderToday(gps){

let today=new Date();

let a=calculate(cities.ahsa.lat,cities.ahsa.lng,today);
let d=calculate(cities.dammam.lat,cities.dammam.lng,today);
let r=calculate(cities.riyadh.lat,cities.riyadh.lng,today);
let g=calculate(gps.lat,gps.lng,today);

let midnight=calculateMidnight(a.maghrib,a.fajr);

document.getElementById("todayTable").innerHTML=`
<table>
<tr>
<th>الصلاة</th>
<th>الأحساء</th>
<th>الدمام</th>
<th>الرياض</th>
<th>موقعك</th>
</tr>
<tr><td>الفجر</td><td>${a.fajr}</td><td>${d.fajr}</td><td>${r.fajr}</td><td>${g.fajr}</td></tr>
<tr><td>الظهر</td><td>${a.dhuhr}</td><td>${d.dhuhr}</td><td>${r.dhuhr}</td><td>${g.dhuhr}</td></tr>
<tr><td>العصر</td><td>${a.asr}</td><td>${d.asr}</td><td>${r.asr}</td><td>${g.asr}</td></tr>
<tr><td>المغرب</td><td>${a.maghrib}</td><td>${d.maghrib}</td><td>${r.maghrib}</td><td>${g.maghrib}</td></tr>
<tr><td>العشاء</td><td>${a.isha}</td><td>${d.isha}</td><td>${r.isha}</td><td>${g.isha}</td></tr>
<tr><td>منتصف الليل</td><td>${midnight}</td><td>-</td><td>-</td><td>-</td></tr>
</table>
`;

startCountdown(a);
}

function startCountdown(times){
let prayers=[
{n:"الفجر",t:times.fajr},
{n:"الظهر",t:times.dhuhr},
{n:"العصر",t:times.asr},
{n:"المغرب",t:times.maghrib},
{n:"العشاء",t:times.isha}
];

function update(){
let now=new Date();
for(let p of prayers){
let [h,m]=p.t.split(':').map(Number);
let pt=new Date(); pt.setHours(h,m,0);
if(pt>now){
let diff=Math.floor((pt-now)/1000);
let hrs=Math.floor(diff/3600);
let mins=Math.floor((diff%3600)/60);
let secs=diff%60;
document.getElementById("countdown").innerText=
"الصلاة القادمة: "+p.n+" بعد "+hrs+":"+mins+":"+secs;
break;
}
}
}
setInterval(update,1000);
}

function toggleMonth(){
let box=document.getElementById("monthTable");
if(box.style.display==="none"){
renderMonth();
box.style.display="block";
}else{
box.style.display="none";
}
}

function renderMonth(){
let today=new Date();
let html="<table><tr><th>اليوم</th><th>فجر</th><th>مغرب</th></tr>";
for(let i=1;i<=30;i++){
let date=new Date(today.getFullYear(),today.getMonth(),i);
let t=calculate(cities.ahsa.lat,cities.ahsa.lng,date);
html+=`<tr><td>${i}</td><td>${t.fajr}</td><td>${t.maghrib}</td></tr>`;
}
html+="</table>";
document.getElementById("monthTable").innerHTML=html;
}

navigator.geolocation.getCurrentPosition(pos=>{
document.getElementById("cityName").innerText="موقعك الجغرافي";
renderToday({lat:pos.coords.latitude,lng:pos.coords.longitude});
});
</script>

</body>
</html>
