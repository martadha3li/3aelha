<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø© | Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <script src="https://cdn.jsdelivr.net/npm/adhan@4.4.5/dist/Adhan.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; padding: 15px; text-align: center; line-height: 1.6; }
        
        .countdown-card { background: #1c1c1e; color: #fff; padding: 20px; border-radius: 25px; margin-bottom: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
        .timer-value { font-size: 32px; font-weight: 900; color: #34C759; font-variant-numeric: tabular-nums; }

        .date-card { background: linear-gradient(135deg, #007AFF, #0055AA); color: white; padding: 20px; border-radius: 25px; margin-bottom: 20px; }
        .event-text { background: rgba(255,255,255,0.15); padding: 12px; border-radius: 12px; font-size: 14px; margin-top: 10px; border: 1px dashed rgba(255,255,255,0.3); }

        .times-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .times-table th { color: var(--ios-blue); font-size: 11px; padding: 5px; }
        .time-row-card { background: var(--card-bg); border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .time-row-card td { padding: 12px 2px; border-bottom: 0.5px solid #f2f2f7; font-size: 13px; }
        
        .prayer-name { font-weight: bold; color: #444; text-align: right; padding-right: 12px !important; }
        .ahsa-time { color: var(--ios-blue); font-weight: 800; background: #E5F1FF; }
        .user-loc-time { color: #5856D6; font-weight: 800; background: #F5F5FF; border: 1px solid #5856D6; border-radius: 10px; }
        .other-time { color: #666; font-size: 12px; }
        
        #loadingOverlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loadingOverlay">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª...</div>

    <div class="countdown-card" id="countdownBox" style="display: none;">
        <div id="nextPrayerLabel" style="font-size: 13px; opacity: 0.8;">Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©:</div>
        <div class="timer-value" id="timer">00:00:00</div>
    </div>

    <div class="date-card">
        <div id="hijriDate" style="font-size: 19px; font-weight: bold;"></div>
        <div id="todayEvent" class="event-text">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…</div>
    </div>

    <table class="times-table">
        <thead>
            <tr>
                <th style="text-align: right; padding-right: 12px;">Ø§Ù„ÙØ±ÙŠØ¶Ø©</th>
                <th>Ø§Ù„Ø£Ø­Ø³Ø§Ø¡</th>
                <th id="userCityHeader" style="display:none; color:#5856D6;">Ù…ÙˆÙ‚Ø¹Ùƒ</th>
                <th>Ø§Ù„Ø¯Ù…Ø§Ù…</th>
                <th>Ø§Ù„Ø±ÙŠØ§Ø¶</th>
            </tr>
        </thead>
        <tbody id="prayerTableBody"></tbody>
    </table>

    <button onclick="location.href='news.html'" style="margin-top:25px; border:none; background:none; color:var(--ios-blue); font-weight:bold; cursor:pointer;">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>

<script type="module">
    import { db } from './config.js';
    import { doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentConfig = {};
    let userPrayerTimes = null;
    let prayerTimesObjects = [];

    const prayerList = [
        { id: 'fajr', name: 'Ø§Ù„ÙØ¬Ø±', key: 'offsetFajr', base: '04:45' },
        { id: 'sunrise', name: 'Ø§Ù„Ø´Ø±ÙˆÙ‚', key: 'offsetShuruq', base: '06:05' },
        { id: 'dhuhr', name: 'Ø§Ù„Ø¸Ù‡Ø±', key: 'offsetDhuhr', base: '12:05' },
        { id: 'maghrib', name: 'Ø§Ù„Ù…ØºØ±Ø¨', key: 'offsetMaghrib', base: '18:15' }
    ];

    // 1. Ø­Ø³Ø§Ø¨ Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ„ÙƒÙŠØ§Ù‹ (GPS)
    function initGPS() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition((pos) => {
                const coords = new adhan.Coordinates(pos.coords.latitude, pos.coords.longitude);
                const params = adhan.CalculationMethod.MoonsightingCommittee();
                params.fajrAngle = 18.0;
                params.maghribAngle = 4.0;
                
                userPrayerTimes = new adhan.PrayerTimes(coords, new Date(), params);
                document.getElementById('userCityHeader').style.display = 'table-cell';
                renderTable();
            }, (err) => {
                console.log("GPS Error:", err);
                renderTable(); // Ø±Ù†Ø¯Ø±Ø© Ø­ØªÙ‰ Ø¨Ø¯ÙˆÙ† GPS
            });
        } else { renderTable(); }
    }

    // 2. Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª
    const today = new Date();
    const hijriFull = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-uma', {day:'numeric', month:'long', year:'numeric'});
    const hijriNum = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-uma', {day:'numeric', month:'numeric'});
    document.getElementById('hijriDate').innerText = hijriFull.format(today);

    const hDateStr = hijriNum.format(today).replace(/[Ù -Ù©]/g, d => "Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©".indexOf(d)).replace("/", "-");

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    onSnapshot(doc(db, "Settings", "PrayerConfig"), (docSnap) => {
        currentConfig = docSnap.exists() ? docSnap.data() : {};
        
        // Ø¬Ù„Ø¨ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ… (Ù‡Ø¬Ø±ÙŠØ© Ø£Ùˆ ÙŠØ¯ÙˆÙŠØ©)
        onSnapshot(doc(db, "HijriEvents", hDateStr), (evSnap) => {
            const display = document.getElementById('todayEvent');
            if (evSnap.exists()) {
                display.innerHTML = `ğŸŒŸ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…: <b>${evSnap.data().title}</b>`;
            } else {
                display.innerText = currentConfig.event || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…";
            }
            document.getElementById('loadingOverlay').style.display = 'none';
            initGPS(); // Ø¨Ø¯Ø¡ Ø§Ù„Ù€ GPS Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        });
    });

    function renderTable() {
        const tbody = document.getElementById('prayerTableBody');
        tbody.innerHTML = "";
        prayerTimesObjects = [];

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø± Ø¨Ù€ 10 Ø¯Ù‚Ø§Ø¦Ù‚)
        const fajrOffset = currentConfig.offsetFajr || 0;
        const imsakAhsa = getAhsaDate('04:45', fajrOffset - 10);
        
        appendRow(tbody, 'Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ', imsakAhsa, (userPrayerTimes ? new Date(userPrayerTimes.fajr.getTime() - 10*60000) : null), fajrOffset - 10);

        prayerList.forEach(p => {
            const offset = currentConfig[p.key] || 0;
            const ahsaDate = getAhsaDate(p.base, offset);
            prayerTimesObjects.push({ name: p.name, date: ahsaDate });
            appendRow(tbody, p.name, ahsaDate, (userPrayerTimes ? userPrayerTimes[p.id] : null), offset);
        });
        updateCountdown();
    }

    function appendRow(tbody, name, ahsaDate, userDate, offset) {
        const row = document.createElement('tr');
        row.className = 'time-row-card';
        let userCell = userPrayerTimes ? `<td class="user-loc-time">${formatTime(userDate)}</td>` : "";
        
        row.innerHTML = `
            <td class="prayer-name">${name}</td>
            <td class="ahsa-time">${formatTime(ahsaDate)}</td>
            ${userCell}
            <td class="other-time">${formatTime(getAhsaDate(ahsaDate, -3, true))}</td>
            <td class="other-time">${formatTime(getAhsaDate(ahsaDate, 12, true))}</td>
        `;
        tbody.appendChild(row);
    }

    function getAhsaDate(base, offset, isDateObj = false) {
        let d = isDateObj ? new Date(base.getTime()) : null;
        if (!isDateObj) {
            let [hrs, mins] = base.split(':').map(Number);
            d = new Date(); d.setHours(hrs, mins + offset, 0, 0);
        } else {
            d.setMinutes(d.getMinutes() + offset);
        }
        return d;
    }

    function formatTime(date) {
        if(!date) return "--:--";
        return date.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', hour12: true }).replace("Øµ", "Ø£").replace("Ù…", "Ù…");
    }

    function updateCountdown() {
        if(window.tInt) clearInterval(window.tInt);
        window.tInt = setInterval(() => {
            const now = new Date();
            let next = prayerTimesObjects.find(p => p.date > now);
            if (!next && prayerTimesObjects.length > 0) {
                let tom = new Date(prayerTimesObjects[0].date); tom.setDate(tom.getDate()+1);
                next = { name: prayerTimesObjects[0].name, date: tom };
            }
            if(next) {
                document.getElementById('countdownBox').style.display = 'block';
                const diff = next.date - now;
                const h = Math.floor(diff/3600000), m = Math.floor((diff%3600000)/60000), s = Math.floor((diff%60000)/1000);
                document.getElementById('timer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            }
        }, 1000);
    }
</script>
</body>
</html>
