<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</title>

<style>
:root{
    --primary:#0A84FF;
    --glass:rgba(255,255,255,0.15);
}
body{
    margin:0;
    font-family:-apple-system;
    background:linear-gradient(160deg,#0f2027,#203a43,#2c5364);
    color:white;
    text-align:center;
    padding-top:90px;
}
.card{
    width:92%;
    max-width:420px;
    margin:15px auto;
    background:var(--glass);
    backdrop-filter:blur(20px);
    border-radius:25px;
    padding:15px;
}
.prayer-row{
    display:flex;
    justify-content:space-between;
    padding:14px;
    border-bottom:1px solid rgba(255,255,255,0.1);
}
.prayer-row.active{
    background:rgba(10,132,255,0.3);
    border-radius:15px;
}
.badge{
    display:inline-block;
    padding:6px 15px;
    border-radius:20px;
    background:rgba(255,255,255,0.2);
    font-size:13px;
}
.countdown{
    font-size:14px;
    opacity:.9;
    margin-top:5px;
}
</style>
</head>
<body>

<div class="badge">ğŸ“ <span id="cityName">Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹...</span></div>
<div id="hijriDate" style="margin-top:10px"></div>

<div class="card">
<div id="prayerContainer"></div>
<div class="countdown" id="nextPrayerBox"></div>
</div>

<div class="card">
<h4>ğŸ“¿ Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…</h4>
<div id="todayEvent">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø©</div>
</div>

<div class="card">
<h4>ğŸ—“ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©</h4>
<div id="nextEvent">--</div>
</div>

<script type="module">
import { db } from './config.js';
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const hijri = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {
day:'numeric',month:'long',year:'numeric'
}).format(new Date());
document.getElementById('hijriDate').innerText = hijri;

function adjustTime(timeStr, offset){
if(!timeStr) return "--:--";
let [h,m] = timeStr.split(':').map(Number);
let d = new Date();
d.setHours(h);
d.setMinutes(m + (offset||0));
return d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
}

function getNextPrayer(times){
let now=new Date();
for(let p of times){
let t=new Date();
let [h,m]=p.time.split(':');
t.setHours(h,m);
if(t>now) return {name:p.name,time:p.time};
}
return null;
}

async function loadPrayerTimes(lat,lon){

let geo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=ar`);
let geoData = await geo.json();
document.getElementById('cityName').innerText =
geoData.address.city || geoData.address.town || geoData.address.village || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";

let api = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=99&methodSettings[fajr]=18.5&methodSettings[maghrib]=4&methodSettings[isha]=14.5`);
let data = await api.json();
let apiTimes = data.data.timings;

const adminSnap = await getDoc(doc(db,"Settings","PrayerOffsets"));
const off = adminSnap.exists()? adminSnap.data():{};

let prayers = [
{name:"Ø§Ù„ÙØ¬Ø±",time:adjustTime(apiTimes.Fajr,off.fajr)},
{name:"Ø§Ù„Ø¸Ù‡Ø±",time:adjustTime(apiTimes.Dhuhr,off.dhuhr)},
{name:"Ø§Ù„Ø¹ØµØ±",time:adjustTime(apiTimes.Asr,off.asr)},
{name:"Ø§Ù„Ù…ØºØ±Ø¨",time:adjustTime(apiTimes.Maghrib,off.maghrib)},
{name:"Ø§Ù„Ø¹Ø´Ø§Ø¡",time:adjustTime(apiTimes.Isha,off.isha)}
];

let container=document.getElementById("prayerContainer");
container.innerHTML="";
prayers.forEach(p=>{
let row=document.createElement("div");
row.className="prayer-row";
row.innerHTML=`<span>${p.name}</span><span>${p.time}</span>`;
container.appendChild(row);
});

let next=getNextPrayer(prayers);
if(next){
document.getElementById("nextPrayerBox").innerText=
"Ø§Ù„ØµÙ„Ø§Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: "+next.name+" Ø¹Ù†Ø¯ "+next.time;
}
}

navigator.geolocation.getCurrentPosition(
pos=>loadPrayerTimes(pos.coords.latitude,pos.coords.longitude),
()=>loadPrayerTimes(25.383,49.586) // fallback Ø§Ù„Ø£Ø­Ø³Ø§Ø¡
);

// ===== Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª =====
const eventsSnap = await getDoc(doc(db,"Settings","HijriEvents"));
if(eventsSnap.exists()){
let events = eventsSnap.data().events || [];
let today = hijri;
let todayEvent = events.find(e=>e.date===today);
if(todayEvent) document.getElementById("todayEvent").innerText=todayEvent.title;

let upcoming = events.find(e=>new Date(e.gregorian)>new Date());
if(upcoming) document.getElementById("nextEvent").innerText=upcoming.title;
}

</script>
</body>
</html>
