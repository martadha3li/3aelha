<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .reg-container { padding: 30px 20px; max-width: 450px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #444; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-family: inherit; outline: none; }
        .form-input:focus { border-color: var(--primary); }
        .location-note { font-size: 11px; color: #8e8e93; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="history.back()" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</b>
        <div style="width:20px;"></div>
    </div>

    <div class="reg-container">
        <div class="category-card" style="background:white; padding:25px; border-radius:25px; box-shadow: var(--shadow);">
            
            <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="regName" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            </div>

            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input type="tel" id="regPhone" class="form-input" placeholder="05xxxxxxxx">
            </div>

            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label>Ø§Ù„Ø¹Ù…Ø±</label>
                    <input type="number" id="regAge" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: 25">
                </div>
                <div>
                    <label>Ø§Ù„Ø¬Ù†Ø³</label>
                    <select id="regGender" class="form-input">
                        <option value="male">Ø°ÙƒØ±</option>
                        <option value="female">Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³ÙƒÙ† Ø§Ù„Ø¯Ø§Ø¦Ù…</label>
                <input type="text" id="regCity" class="form-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ø±ÙŠØ§Ø¶ØŒ Ø§Ù„Ø¯Ù…Ø§Ù…...">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input type="email" id="regEmail" class="form-input" placeholder="email@example.com">
            </div>

            <div class="form-group">
                <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="regPass" class="form-input" placeholder="********">
            </div>

            <p class="location-note">
                ğŸ“ Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªÙˆØ«ÙŠÙ‚ Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨.
            </p>

            <button id="btnRegister" class="btn-main" style="width:100%; margin-top:15px; padding:15px;" onclick="handleRegister()">
                Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            </button>
            
            <p style="text-align:center; font-size:13px; margin-top:15px;">
                Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ <a href="index.html" style="color:var(--primary); text-decoration:none; font-weight:bold;">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ</a>
            </p>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù€ GPS
    async function getGPSLocation() {
        return new Promise((resolve) => {
            if (!navigator.geolocation) {
                console.warn("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹");
                resolve(null);
            }
            navigator.geolocation.getCurrentPosition(
                (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
                (err) => {
                    console.error("Ø±ÙØ¶ Ø§Ù„Ø¹Ø¶Ùˆ Ø¥Ø°Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹", err);
                    resolve(null);
                },
                { timeout: 10000 }
            );
        });
    }

    window.handleRegister = async () => {
        const name = document.getElementById('regName').value.trim();
        const phone = document.getElementById('regPhone').value.trim();
        const age = document.getElementById('regAge').value.trim();
        const gender = document.getElementById('regGender').value;
        const city = document.getElementById('regCity').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const pass = document.getElementById('regPass').value.trim();
        const btn = document.getElementById('btnRegister');

        if(!name || !phone || !email || !pass) return alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (GPS)
        const coords = await getGPSLocation();

        try {
            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙÙŠ Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
            const user = userCredential.user;

            // 3. ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firestore Ù…Ø¹ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (regLoc)
            await setDoc(doc(db, "Users", user.uid), {
                fullName: name,
                phone: phone,
                age: parseInt(age),
                gender: gender,
                city: city,
                role: "user",
                status: "pending",
                regLoc: coords, // ØªØ®Ø²ÙŠÙ† Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ ÙˆØ§Ù„Ø¹Ø±Ø¶
                createdAt: serverTimestamp()
            });

            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ.");
            window.location.href = "index.html";

        } catch (error) {
            alert("ÙØ´Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message);
            btn.disabled = false;
            btn.innerText = "Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
        }
    };
</script>
</body>
</html>
