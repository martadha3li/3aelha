<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .users-wrapper { padding: 15px; overflow-x: auto; }
        .search-box { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; font-family: inherit; }
        
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 15px; overflow: hidden; font-size: 13px; box-shadow: var(--shadow); }
        th { background: var(--primary); color: white; padding: 12px; text-align: center; }
        td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; white-space: nowrap; }
        tr:last-child td { border: none; }

        .btn-action { padding: 5px 8px; border: none; border-radius: 6px; cursor: pointer; margin: 2px; font-size: 12px; color: white; }
        .btn-edit { background: #34c759; }
        .btn-ban { background: #ff3b30; }
        .btn-delete { background: #1c1c1e; }
        
        .role-badge { padding: 2px 6px; border-radius: 5px; font-size: 10px; font-weight: bold; }
        .admin-role { background: #ffcc00; color: #000; }
        .user-role { background: #eef6ff; color: var(--primary); }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="location.href='admin_requests.html'" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
        <b>Ø¬Ø¯ÙˆÙ„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</b>
        <div style="width:20px;"></div>
    </div>

    <div class="users-wrapper">
        <input type="text" id="userSearch" class="search-box" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." oninput="searchTable()">
        
        <table id="usersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø¬Ù†Ø³</th>
                    <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                    <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="usersBody">
                </tbody>
        </table>
    </div>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const usersBody = document.getElementById('usersBody');

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø´ÙƒÙ„ Ø­ÙŠ
    onSnapshot(collection(db, "Users"), (snap) => {
        usersBody.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            const id = d.id;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-weight:bold;">${u.fullName}</td>
                <td>${u.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</td>
                <td>${u.phone || '--'}</td>
                <td><span class="role-badge ${u.role === 'admin' ? 'admin-role' : 'user-role'}">${u.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                <td>
                    <button class="btn-action btn-edit" onclick="editUser('${id}', '${u.fullName}')">âœï¸</button>
                    <button class="btn-action btn-ban" onclick="toggleBan('${id}', ${u.isBanned})">${u.isBanned ? 'âœ… ÙÙƒ' : 'ğŸš« Ù…Ù†Ø¹'}</button>
                    <button class="btn-action btn-delete" onclick="deleteUser('${id}')">ğŸ—‘ï¸</button>
                </td>
            `;
            usersBody.appendChild(tr);
        });
    });

    // 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø¨Ø­Ø«
    window.searchTable = () => {
        const input = document.getElementById('userSearch').value.toLowerCase();
        const rows = usersBody.getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(input) ? '' : 'none';
        }
    };

    // 2. ÙˆØ¸ÙŠÙØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø£Ùˆ Ø§Ù„Ø§Ø³Ù… (Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø·)
    window.editUser = async (id, oldName) => {
        const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ:", oldName);
        const newRole = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (admin / editor / member):");
        if (newName || newRole) {
            await updateDoc(doc(db, "Users", id), { 
                fullName: newName || oldName,
                role: newRole || "member"
            });
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«");
        }
    };

    // 3. ÙˆØ¸ÙŠÙØ© Ù…Ù†Ø¹ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„
    window.toggleBan = async (id, currentStatus) => {
        const nextStatus = !currentStatus;
        if(confirm(nextStatus ? "Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†ØµØ©ØŸ" : "Ù‡Ù„ ØªØ±ÙŠØ¯ ÙÙƒ Ø§Ù„Ø­Ø¸Ø± Ø¹Ù† Ø§Ù„Ø¹Ø¶ÙˆØŸ")) {
            await updateDoc(doc(db, "Users", id), { isBanned: nextStatus });
        }
    };

    // 4. ÙˆØ¸ÙŠÙØ© Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹
    window.deleteUser = async (id) => {
        if(confirm("ØªØ­Ø°ÙŠØ±! Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ")) {
            await deleteDoc(doc(db, "Users", id));
        }
    };

</script>
</body>
</html>
