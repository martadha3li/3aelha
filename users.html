<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ | Ø§Ù„Ù…Ù†ØµØ©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .users-wrapper { padding: 15px; padding-bottom: 50px; }
        .search-box { 
            width: 100%; padding: 14px; border-radius: 15px; 
            border: 1px solid #ddd; margin-bottom: 20px; 
            font-family: inherit; font-size: 14px; outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .table-container { 
            background: white; border-radius: 20px; 
            overflow-x: auto; box-shadow: var(--shadow); 
        }
        table { width: 100%; border-collapse: collapse; min-width: 800px; } /* Ø²Ø¯Ù†Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ */
        th { background: #f8f9fa; color: #8e8e93; padding: 15px; text-align: center; font-size: 12px; }
        td { padding: 15px; border-bottom: 1px solid #f2f2f2; text-align: center; font-size: 13px; }
        
        .email-text { color: #007aff; font-size: 12px; font-family: sans-serif; }

        .btn-action { padding: 8px; border: none; border-radius: 10px; cursor: pointer; margin: 0 2px; }
        .btn-edit { background: #eefaf3; color: #34c759; }
        .btn-ban { background: #fff2f2; color: #ff3b30; }
        .btn-delete { background: #f2f2f7; color: #1c1c1e; }
        
        .role-badge { padding: 4px 8px; border-radius: 8px; font-size: 11px; font-weight: bold; }
        .admin-role { background: #fff9e6; color: #ffcc00; }
        .user-role { background: #f2f7ff; color: #007aff; }

        .modal-overlay { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.6); z-index: 5000; 
            align-items: center; justify-content: center; padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: white; padding: 25px; border-radius: 30px; 
            width: 100%; max-width: 450px; 
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 8px; }
        .form-input { 
            width: 100%; padding: 12px; border-radius: 12px; 
            border: 1px solid #eee; background: #f9f9f9; font-family: inherit;
        }
    </style>
</head>
<body style="background: #f4f7f6;">

    <div class="top-bar">
        <button onclick="location.href='admin_requests.html'" style="border:none; background:none; font-size:22px; cursor:pointer;">â¡ï¸</button>
        <b>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</b>
        <div style="width:20px;"></div>
    </div>

    <div class="users-wrapper">
        <input type="text" id="userSearch" class="search-box" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…ØŒ Ø§ÙŠÙ…ÙŠÙ„ØŒ Ø£Ùˆ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„..." oninput="searchTable()">
        
        <div class="table-container">
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø¹Ø¶Ùˆ</th>
                        <th>Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„</th>
                        <th>Ø§Ù„Ø¬Ù†Ø³</th>
                        <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                        <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="6" style="color:gray;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="margin-bottom:20px; text-align:center;">âœï¸ ØªØ­Ø±ÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨</h3>
            <input type="hidden" id="editUserId">
            
            <div class="form-group">
                <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input type="text" id="editName" class="form-input">
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·)</label>
                <input type="text" id="editEmail" class="form-input" disabled style="background:#eee; cursor:not-allowed;">
            </div>

            <div class="form-group">
                <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                <input type="number" id="editPhone" class="form-input">
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:25px;">
                <div class="form-group">
                    <label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                    <select id="editRole" class="form-input">
                        <option value="member">Ø¹Ø¶Ùˆ</option>
                        <option value="editor">Ù…Ø­Ø±Ø±</option>
                        <option value="admin">Ù…Ø¯ÙŠØ±</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ø¬Ù†Ø³</label>
                    <select id="editGender" class="form-input">
                        <option value="male">Ø°ÙƒØ±</option>
                        <option value="female">Ø£Ù†Ø«Ù‰</option>
                    </select>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button onclick="closeEditModal()" style="flex:1; padding:12px; border:none; border-radius:15px; background:#f2f2f7; font-weight:bold; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                <button onclick="saveUserUpdates()" style="flex:2; padding:12px; border:none; border-radius:15px; background:var(--primary); color:white; font-weight:bold; cursor:pointer;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
            </div>
        </div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const usersBody = document.getElementById('usersBody');

    onSnapshot(collection(db, "Users"), (snap) => {
        usersBody.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            const id = d.id;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align:right; font-weight:600;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <img src="${u.profileImg || 'https://via.placeholder.com/30'}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">
                        ${u.fullName}
                    </div>
                </td>
                <td class="email-text">${u.email || '--'}</td>
                <td>${u.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</td>
                <td>${u.phone || '--'}</td>
                <td><span class="role-badge ${u.role === 'admin' ? 'admin-role' : 'user-role'}">${u.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                <td>
                    <button class="btn-action btn-edit" onclick="openEditModal('${id}', '${u.fullName}', '${u.phone || ''}', '${u.role || 'member'}', '${u.gender || 'male'}', '${u.email || ''}')">âœï¸</button>
                    <button class="btn-action btn-ban" onclick="toggleBan('${id}', ${u.isBanned || false})">${u.isBanned ? 'âœ…' : 'ğŸš«'}</button>
                    <button class="btn-action btn-delete" onclick="deleteUser('${id}')">ğŸ—‘ï¸</button>
                </td>
            `;
            usersBody.appendChild(tr);
        });
    });

    window.searchTable = () => {
        const term = document.getElementById('userSearch').value.toLowerCase();
        const rows = usersBody.getElementsByTagName('tr');
        for (let row of rows) {
            row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        }
    };

    window.openEditModal = (id, name, phone, role, gender, email) => {
        document.getElementById('editUserId').value = id;
        document.getElementById('editName').value = name;
        document.getElementById('editPhone').value = phone;
        document.getElementById('editRole').value = role;
        document.getElementById('editGender').value = gender;
        document.getElementById('editEmail').value = email; // Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
        document.getElementById('editModal').style.display = 'flex';
    };

    window.closeEditModal = () => {
        document.getElementById('editModal').style.display = 'none';
    };

    window.saveUserUpdates = async () => {
        const id = document.getElementById('editUserId').value;
        const updates = {
            fullName: document.getElementById('editName').value,
            phone: document.getElementById('editPhone').value,
            role: document.getElementById('editRole').value,
            gender: document.getElementById('editGender').value
        };

        try {
            await updateDoc(doc(db, "Users", id), updates);
            closeEditModal();
        } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
    };

    window.toggleBan = async (id, status) => {
        if(confirm(status ? "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±ØŸ" : "Ø­Ø¸Ø± Ø§Ù„Ø¹Ø¶ÙˆØŸ")) {
            await updateDoc(doc(db, "Users", id), { isBanned: !status });
        }
    };

    window.deleteUser = async (id) => {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            await deleteDoc(doc(db, "Users", id));
        }
    };
</script>
</body>
</html>
