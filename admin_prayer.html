<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªÙ‚ÙˆÙŠÙ… Ø§Ù„Ø´Ù‡Ø±ÙŠ</title>
<style>
body{font-family:-apple-system;background:#f2f2f7;padding:20px}
.card{background:white;padding:15px;border-radius:15px;margin-bottom:15px}
select,input,button{padding:10px;border-radius:10px;border:1px solid #ccc;margin:5px 0}
button{background:#0A84FF;color:white;border:none}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:13px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:#eee}
td input{width:100%;border:none;text-align:center}
.saveBtn{width:100%;margin-top:15px}
</style>
</head>
<body>

<div class="card">
<h3>Ø¥Ø¯Ø§Ø±Ø© ØªÙ‚ÙˆÙŠÙ… Ø´Ù‡Ø± Ù‡Ø¬Ø±ÙŠ ÙƒØ§Ù…Ù„</h3>

<select id="hijriMonth">
<option value="Ù…Ø­Ø±Ù…">Ù…Ø­Ø±Ù…</option>
<option value="ØµÙØ±">ØµÙØ±</option>
<option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„</option>
<option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
<option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
<option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø©</option>
<option value="Ø±Ø¬Ø¨">Ø±Ø¬Ø¨</option>
<option value="Ø´Ø¹Ø¨Ø§Ù†">Ø´Ø¹Ø¨Ø§Ù†</option>
<option value="Ø±Ù…Ø¶Ø§Ù†">Ø±Ù…Ø¶Ø§Ù†</option>
<option value="Ø´ÙˆØ§Ù„">Ø´ÙˆØ§Ù„</option>
<option value="Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©">Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©</option>
<option value="Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©">Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©</option>
</select>

<input type="file" id="calendarImage" accept="image/*">
<button onclick="analyzeImage()">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</button>

<div id="tableContainer"></div>
<button class="saveBtn" onclick="saveMonth()">Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø± ÙƒØ§Ù…Ù„</button>

</div>

<script type="module">
import { db } from './config.js';
import { doc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

window.monthData = [];

// Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
const analyzeBtn = document.querySelector("button[onclick='analyzeImage()']");
const saveBtn = document.querySelector(".saveBtn");
saveBtn.disabled = true;

const progressBox = document.createElement("div");
progressBox.style.marginTop = "10px";
document.querySelector(".card").appendChild(progressBox);

// ===== ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© =====
window.analyzeImage = async function(){

let file = document.getElementById("calendarImage").files[0];
if(!file) return alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");

analyzeBtn.disabled = true;
saveBtn.disabled = true;
progressBox.innerHTML = "ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„...";

const { createWorker } = await import('https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.esm.min.js');

const worker = await createWorker({
logger: m => {
if(m.status === "recognizing text"){
progressBox.innerHTML = "ğŸ“Š Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„: " + Math.round(m.progress*100) + "%";
}
}
});

await worker.loadLanguage('ara');
await worker.initialize('ara');

progressBox.innerHTML = "ğŸ“¸ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©...";

const { data:{ text } } = await worker.recognize(file);

await worker.terminate();

progressBox.innerHTML = "âœ… Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ â€” Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„...";

processText(text);

analyzeBtn.disabled = false;
saveBtn.disabled = false;
}

// ===== ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ =====
function processText(text){

let lines = text.split('\n').filter(l=>l.trim().length>15);

monthData = lines.map(line=>{
let parts=line.trim().split(/\s+/);

return {
hijri:parts[0]||"",
gregorian:parts[1]||"",
dayName:parts[2]||"",
imsak:parts[3]||"",
fajr:parts[4]||"",
dhuhr:parts[5]||"",
maghrib:parts[6]||"",
midnight:parts[7]||"",
event:parts.slice(8).join(" ")||""
};
});

renderTable();
}

// ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ =====
function renderTable(){

let html=`<table>
<tr>
<th>Ù‡Ø¬Ø±ÙŠ</th>
<th>Ù…ÙŠÙ„Ø§Ø¯ÙŠ</th>
<th>Ø§Ù„ÙŠÙˆÙ…</th>
<th>Ø§Ù…Ø³Ø§Ùƒ</th>
<th>ØµØ¨Ø­</th>
<th>Ø¸Ù‡Ø±</th>
<th>Ù…ØºØ±Ø¨</th>
<th>Ù…Ù†ØªØµÙ</th>
<th>Ù…Ù†Ø§Ø³Ø¨Ø©</th>
</tr>`;

monthData.forEach((d,i)=>{
html+=`
<tr>
<td><input value="${d.hijri}" onchange="monthData[${i}].hijri=this.value"></td>
<td><input value="${d.gregorian}" onchange="monthData[${i}].gregorian=this.value"></td>
<td><input value="${d.dayName}" onchange="monthData[${i}].dayName=this.value"></td>
<td><input value="${d.imsak}" onchange="monthData[${i}].imsak=this.value"></td>
<td><input value="${d.fajr}" onchange="monthData[${i}].fajr=this.value"></td>
<td><input value="${d.dhuhr}" onchange="monthData[${i}].dhuhr=this.value"></td>
<td><input value="${d.maghrib}" onchange="monthData[${i}].maghrib=this.value"></td>
<td><input value="${d.midnight}" onchange="monthData[${i}].midnight=this.value"></td>
<td><input value="${d.event}" onchange="monthData[${i}].event=this.value"></td>
</tr>`;
});

html+=`</table>`;
document.getElementById("tableContainer").innerHTML = html;
progressBox.innerHTML = "ğŸ“‹ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø­ÙØ¸";
}

// ===== Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø± =====
window.saveMonth = async function(){

let month = document.getElementById("hijriMonth").value;

await setDoc(doc(db,"MonthlyCalendars",month),{
data:monthData,
savedAt:new Date()
});

// Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ
localStorage.setItem("calendar_"+month,JSON.stringify(monthData));

alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");

// ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ù„ØµÙØ­Ø© Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
localStorage.setItem("refresh_prayer_page","yes");
}
</script>
</body>
</html>
