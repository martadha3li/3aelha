<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ…</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; }
        body { background-color: var(--ios-bg); font-family: -apple-system, sans-serif; padding: 20px; direction: rtl; }
        .card { background: white; padding: 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h3 { margin-top: 0; color: var(--ios-blue); font-size: 16px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        input, select { padding: 10px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        input[type="number"] { width: 70px; text-align: center; }
        button { padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-save { background: var(--ios-blue); color: white; width: 100%; }
        .btn-event { background: #34C759; color: white; width: 100%; margin-top: 10px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª */
        .event-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .event-table th, .event-table td { border-bottom: 1px solid #eee; padding: 12px 8px; text-align: right; }
        .event-table th { color: #888; font-weight: normal; }
        .delete-btn { color: #FF3B30; background: none; border: none; font-size: 18px; cursor: pointer; }
        .edit-btn { color: var(--ios-blue); background: none; border: none; margin-left: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div style="display:flex; align-items:center; gap:10px; margin-bottom:20px;">
        <button onclick="location.href='admin.html'" style="background:#ddd; padding:8px 15px;">Ø±Ø¬ÙˆØ¹</button>
        <h2 style="margin:0; font-size:18px;">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª</h2>
    </div>

    <div class="card">
        <h3>1. ØªØ¹Ø¯ÙŠÙ„ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø£Ø­Ø³Ø§Ø¡ (Ø§Ù„Ø²Ù‡Ø±Ø§Ø¡)</h3>
        <div class="row"><span>Ø§Ù„Ø¥Ù…Ø³Ø§Ùƒ</span> <input type="number" id="offImsak" value="0"></div>
        <div class="row"><span>Ø§Ù„ÙØ¬Ø±</span> <input type="number" id="offFajr" value="0"></div>
        <div class="row"><span>Ø§Ù„Ø´Ø±ÙˆÙ‚</span> <input type="number" id="offShuruq" value="0"></div>
        <div class="row"><span>Ø§Ù„Ø¸Ù‡Ø±</span> <input type="number" id="offDhuhr" value="0"></div>
        <div class="row"><span>Ø§Ù„Ù…ØºØ±Ø¨</span> <input type="number" id="offMaghrib" value="0"></div>
        <button class="btn-save" onclick="saveOffsets()">Ø­ÙØ¸ ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ âœ…</button>
    </div>

    <div class="card">
        <h3>2. Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù‡Ø¬Ø±ÙŠØ© Ù…Ø¬Ø¯ÙˆÙ„Ø©</h3>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
            <input type="number" id="hDay" placeholder="ÙŠÙˆÙ…" min="1" max="30">
            <select id="hMonth" style="flex:1;">
                <option value="1">Ù…Ø­Ø±Ù… (1)</option><option value="2">ØµÙØ± (2)</option>
                <option value="3">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„ (3)</option><option value="4">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ (4)</option>
                <option value="5">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰ (5)</option><option value="6">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø¢Ø®Ø±Ø© (6)</option>
                <option value="7">Ø±Ø¬Ø¨ (7)</option><option value="8">Ø´Ø¹Ø¨Ø§Ù† (8)</option>
                <option value="9">Ø±Ù…Ø¶Ø§Ù† (9)</option><option value="10">Ø´ÙˆØ§Ù„ (10)</option>
                <option value="11">Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø© (11)</option><option value="12">Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø© (12)</option>
            </select>
        </div>
        <input type="text" id="hEventTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©..." style="width:100%; box-sizing:border-box;">
        <button class="btn-event" onclick="saveHijriEvent()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¬Ø¯ÙˆÙ„ ğŸ—“ï¸</button>
    </div>

    <div class="card">
        <h3>3. Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h3>
        <div style="overflow-x: auto;">
            <table class="event-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                    </tr>
                </thead>
                <tbody id="eventsListBody">
                    <tr><td colspan="3" style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { doc, getDoc, setDoc, collection, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. ØªØ­Ù…ÙŠÙ„ Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„ØµÙ„Ø§Ø©
    async function loadPrayerConfig() {
        const snap = await getDoc(doc(db, "Settings", "PrayerConfig"));
        if(snap.exists()){
            const d = snap.data();
            document.getElementById('offImsak').value = d.offsetImsak || 0;
            document.getElementById('offFajr').value = d.offsetFajr || 0;
            document.getElementById('offShuruq').value = d.offsetShuruq || 0;
            document.getElementById('offDhuhr').value = d.offsetDhuhr || 0;
            document.getElementById('offMaghrib').value = d.offsetMaghrib || 0;
        }
    }

    window.saveOffsets = async () => {
        const data = {
            offsetImsak: parseInt(document.getElementById('offImsak').value),
            offsetFajr: parseInt(document.getElementById('offFajr').value),
            offsetShuruq: parseInt(document.getElementById('offShuruq').value),
            offsetDhuhr: parseInt(document.getElementById('offDhuhr').value),
            offsetMaghrib: parseInt(document.getElementById('offMaghrib').value),
        };
        await setDoc(doc(db, "Settings", "PrayerConfig"), data, {merge:true});
        alert("ØªÙ… Ø­ÙØ¸ ÙØ±ÙˆÙ‚Ø§Øª Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø¨Ù†Ø¬Ø§Ø­!");
    };

    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ù‡Ø¬Ø±ÙŠØ©
    window.saveHijriEvent = async () => {
        const d = document.getElementById('hDay').value;
        const m = document.getElementById('hMonth').value;
        const t = document.getElementById('hEventTitle').value;
        if(!d || !m || !t) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        await setDoc(doc(db, "HijriEvents", `${d}-${m}`), {
            day: parseInt(d),
            month: parseInt(m),
            title: t
        });
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
        document.getElementById('hDay').value = "";
        document.getElementById('hEventTitle').value = "";
    };

    // 3. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª ÙˆØ­Ø°ÙÙ‡Ø§
    onSnapshot(collection(db, "HijriEvents"), (querySnapshot) => {
        const tbody = document.getElementById('eventsListBody');
        tbody.innerHTML = "";
        
        let events = [];
        querySnapshot.forEach(doc => {
            events.push({ id: doc.id, ...doc.data() });
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø«Ù… Ø§Ù„ÙŠÙˆÙ…
        events.sort((a, b) => (a.month - b.month) || (a.day - b.day));

        events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ev.day}/${ev.month}</td>
                <td><b>${ev.title}</b></td>
                <td>
                    <button class="edit-btn" onclick="editEvent('${ev.day}', '${ev.month}', '${ev.title}')">âœï¸</button>
                    <button class="delete-btn" onclick="deleteEvent('${ev.id}')">ğŸ—‘ï¸</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        if(events.length === 0) tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ù…Ø¬Ø¯ÙˆÙ„Ø©</td></tr>";
    });

    window.deleteEvent = async (id) => {
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŸ")) {
            await deleteDoc(doc(db, "HijriEvents", id));
        }
    };

    window.editEvent = (day, month, title) => {
        document.getElementById('hDay').value = day;
        document.getElementById('hMonth').value = month;
        document.getElementById('hEventTitle').value = title;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    loadPrayerConfig();
</script>
</body>
</html>
