<script type="module">
    import { auth, db, storage } from './config.js';
    import { doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { updatePassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("تم تسجيل الدخول بـ UID:", user.uid);
            try {
                // جلب المستند
                const userDocRef = doc(db, "Users", user.uid);
                const snap = await getDoc(userDocRef);

                if (snap.exists()) {
                    const data = snap.data();
                    console.log("البيانات الموجودة في Firestore هي:", data);

                    // تحديث الواجهة بمرونة (إذا لم يجد الاسم سيبحث عن مسميات أخرى)
                    document.getElementById('displayFullName').innerText = data.fullName || data.fullname || data.name || "اسم غير محدد";
                    document.getElementById('valPhone').innerText = data.phone || data.mobile || data.tel || "رقم غير محدد";
                    document.getElementById('valEmail').innerText = auth.currentUser.email;
                    document.getElementById('userPhoto').src = data.photoURL || 'https://via.placeholder.com/150';
                    document.getElementById('displayRole').innerText = data.role === 'admin' ? "مدير النظام" : "عضو";

                    // حساب العمر
                    const dob = data.dob || data.birthdate || data.date;
                    if (dob) {
                        const birth = new Date(dob);
                        const age = new Date().getFullYear() - birth.getFullYear();
                        document.getElementById('valAge').innerText = age + " سنة";
                    }

                    // بيانات المعرف
                    if (data.gender === 'female' || data.sex === 'female') {
                        document.getElementById('guardianSection').style.display = 'block';
                        document.getElementById('valGuardian').innerText = data.guardianName || data.guardian || "-";
                    }
                } else {
                    // في حال لم يجد المستند أصلاً
                    document.getElementById('displayFullName').innerText = "لم يتم العثور على ملفك";
                    alert("تنبيه: حسابك مسجل في Authentication ولكن لا يوجد له سجل في Firestore. جرب التسجيل بحساب جديد.");
                }
            } catch (e) {
                console.error("خطأ تقني:", e);
                document.getElementById('displayFullName').innerText = "خطأ في الاتصال بالقاعدة";
            }
        } else { 
            window.location.href = "index.html"; 
        }
    });

    // سأبقي دوام وظائف الأزرار (تغيير الصورة، الخروج، الطلب) كما هي في الكود السابق...
</script>
