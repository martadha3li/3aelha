<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-wrapper { padding-bottom: 80px; }
        .profile-header { 
            background: white; padding: 40px 20px; 
            text-align: center; border-radius: 0 0 35px 35px; 
            box-shadow: var(--shadow); position: relative;
        }
        
        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© */
        .image-section { position: relative; width: 120px; height: 120px; margin: auto; }
        .profile-img { 
            width: 120px; height: 120px; border-radius: 50%; 
            object-fit: cover; border: 4px solid var(--primary);
            background: #eee;
        }
        .change-photo-btn {
            position: absolute; bottom: 0; left: 0;
            background: var(--primary); color: white;
            width: 35px; height: 35px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            border: 3px solid white; cursor: pointer; font-size: 14px;
        }

        /* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø°ÙƒÙŠØ© */
        .age-badge {
            position: absolute; top: 0; right: 0;
            background: var(--accent); color: white;
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; border: 3px solid white; box-shadow: var(--shadow);
        }

        .data-card { background: white; margin: 15px; border-radius: 20px; padding: 10px 20px; box-shadow: var(--shadow); }
        .data-row { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px 0; border-bottom: 1px solid #f0f0f0; 
        }
        .data-row:last-child { border: none; }
        .label { color: #8e8e93; font-size: 13px; font-weight: bold; }
        .value { color: #1c1c1e; font-weight: 600; }

        /* Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ Ø§Ù„ØªØºÙŠÙŠØ± (Modal) */
        .modal { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); 
            z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(5px);
        }
        .modal-box { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 25px; }
        .form-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-family: inherit; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</b>
        <div style="width:20px;"></div>
    </div>

    <div class="profile-wrapper">
        <div class="profile-header">
            <div class="image-section">
                <img id="uImg" src="https://via.placeholder.com/120" class="profile-img">
                <div id="uAge" class="age-badge" title="Ø§Ù„Ø¹Ù…Ø±">--</div>
                <label for="imgUpload" class="change-photo-btn">ğŸ“·</label>
                <input type="file" id="imgUpload" hidden accept="image/*" onchange="uploadImage()">
            </div>
            <h2 id="uName" style="margin: 15px 0 5px 0; font-size: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
            <span id="uRole" style="background: #eef6ff; color: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">Ø¹Ø¶Ùˆ</span>
        </div>

        <div class="data-card">
            <div class="data-row"><span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span> <span id="uEmail" class="value">--</span></div>
            <div class="data-row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span> <span id="uDob" class="value">--</span></div>
            <div class="data-row"><span class="label">Ø§Ù„Ø¬Ù†Ø³</span> <span id="uGender" class="value">--</span></div>
            <div class="data-row"><span class="label">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³ÙƒÙ†</span> <span id="uCity" class="value">--</span></div>
            
            <div id="femaleData" style="display: none;">
                <div class="data-row"><span class="label">Ø§Ø³Ù… Ø§Ù„Ù€Ù…ÙØ¹Ø±Ù‘Ù</span> <span id="uGuardName" class="value">--</span></div>
                <div class="data-row"><span class="label">Ø¬ÙˆØ§Ù„ Ø§Ù„Ù€Ù…ÙØ¹Ø±Ù‘Ù</span> <span id="uGuardPhone" class="value">--</span></div>
            </div>

            <div class="data-row" style="background: #fffcf2; margin: 10px -10px; padding: 15px 10px; border-radius: 15px;">
                <div>
                    <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><br>
                    <span id="uPhone" class="value">--</span>
                </div>
                <button onclick="openModal()" class="mini-btn" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer;">Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ğŸ“±</button>
            </div>
        </div>
    </div>

    <div id="phoneModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0;">Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
            <p style="font-size:12px; color:gray;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø³Ø¨Ø¨ Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø¯ÙŠØ±:</p>
            <input type="tel" id="newPhone" class="form-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <select id="changeReason" class="form-input">
                <option value="ØªØºÙŠØ± Ø±Ù‚Ù…ÙŠ">ØªØºÙŠØ± Ø±Ù‚Ù…ÙŠ</option>
                <option value="Ù…Ù‚Ø·ÙˆØ¹">Ù…Ù‚Ø·ÙˆØ¹</option>
                <option value="Ù…Ù†ØªÙ‡ÙŠ">Ù…Ù†ØªÙ‡ÙŠ</option>
                <option value="Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù…">Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù…</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button onclick="sendPhoneRequest()" class="btn-main" style="flex:2;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                <button onclick="closeModal()" style="flex:1; border:none; border-radius:12px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></a>
        <a href="profile.html" class="nav-item active"><span class="nav-icon">ğŸ‘¤</span><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { doc, getDoc, updateDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userData = null;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.exists()) {
                userData = snap.data();
                renderProfile();
            }
        } else { window.location.replace("login.html"); }
    });

    function renderProfile() {
        document.getElementById('uName').innerText = userData.fullName;
        document.getElementById('uEmail').innerText = userData.email || 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
        document.getElementById('uPhone').innerText = userData.phone;
        document.getElementById('uDob').innerText = userData.dob || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        document.getElementById('uCity').innerText = userData.city || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©';
        document.getElementById('uRole').innerText = userData.role || 'Ø¹Ø¶Ùˆ';
        document.getElementById('uGender').innerText = userData.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';
        if(userData.profileImg) document.getElementById('uImg').src = userData.profileImg;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØ¹Ø±Ø¶Ù‡ ÙÙŠ Ø§Ù„Ø¯Ø§Ø¦Ø±Ø©
        if(userData.dob) {
            const age = new Date().getFullYear() - new Date(userData.dob).getFullYear();
            document.getElementById('uAge').innerText = age;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù„Ø¥Ù†Ø§Ø«
        if(userData.gender === 'female') {
            document.getElementById('femaleData').style.display = 'block';
            document.getElementById('uGuardName').innerText = userData.guardianName || '--';
            document.getElementById('uGuardPhone').innerText = userData.guardianPhone || '--';
        }
    }

    // Ø±ÙØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©
    window.uploadImage = async () => {
        const file = document.getElementById('imgUpload').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64Img = reader.result;
            await updateDoc(doc(db, "Users", auth.currentUser.uid), { profileImg: base64Img });
            document.getElementById('uImg').src = base64Img;
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
        };
        reader.readAsDataURL(file);
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ§Ù„
    window.openModal = () => document.getElementById('phoneModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('phoneModal').style.display = 'none';

    window.sendPhoneRequest = async () => {
        const newP = document.getElementById('newPhone').value.trim();
        const reason = document.getElementById('changeReason').value;
        if(!newP || newP.length < 10) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­");

        await addDoc(collection(db, "PhoneRequests"), {
            userId: auth.currentUser.uid,
            userName: userData.fullName,
            oldPhone: userData.phone,
            newPhone: newP,
            reason: reason,
            timestamp: serverTimestamp()
        });
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeModal();
    };
</script>
</body>
</html>
