<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ | Ù†Ù‚Ø§Ø·ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; --success: #34c759; }
        body { background: var(--bg); font-family: 'Segoe UI', sans-serif; margin: 0; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .stats-card { background: var(--primary); color: white; border-radius: 25px; padding: 25px; text-align: center; box-shadow: 0 10px 20px rgba(88, 86, 214, 0.2); }
        .history-card { background: white; border-radius: 20px; padding: 20px; margin-top: 20px; }
        .history-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f0f0f0; }
    </style>
</head>
<body>

<div class="top-bar">
    <button onclick="history.back()" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
    <b>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</b>
    <div style="width:24px;"></div>
</div>

<div class="container">
    <div class="stats-card">
        <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ğŸ’</small>
        <h1 id="totalPts" style="font-size: 48px; margin: 10px 0;">0</h1>
        <div id="userNameDisp" style="font-weight: bold; opacity: 0.9;">--</div>
    </div>

    <div class="history-card">
        <h3 style="margin-top:0;">ğŸ† Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø§Øª</h3>
        <div id="historyList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</div>
    </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    onAuthStateChanged(auth, user => {
        if (user) {
            loadUserData(user.uid);
        } else location.href = "login.html";
    });

    async function loadUserData(uid) {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø§Ø³Ù… Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© Users (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ ÙƒÙˆØ¯Ùƒ)
        // loadMyName(uid);

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
        const q = query(collection(db, "Answers"), where("userId", "==", uid));
        onSnapshot(q, snap => {
            let total = 0;
            let comps = {};
            
            snap.forEach(d => {
                const a = d.data();
                total += (a.pointsAwarded || 0);
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø©
                if(!comps[a.compTitle]) comps[a.compTitle] = { pts: 0, date: a.timestamp?.toDate().toLocaleDateString('ar-SA') || '--' };
                comps[a.compTitle].pts += (a.pointsAwarded || 0);
            });

            document.getElementById('totalPts').innerText = total;
            
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            for (const [title, data] of Object.entries(comps)) {
                list.innerHTML += `
                    <div class="history-item">
                        <div>
                            <b>${title}</b><br>
                            <small style="color:gray;">ğŸ“… ${data.date}</small>
                        </div>
                        <div style="text-align:left;">
                            <span style="color:var(--success); font-weight:bold;">+${data.pts} Ù†Ù‚Ø·Ø©</span><br>
                            <small style="color:var(--primary); font-weight:bold;">${data.pts > 0 ? 'ğŸ† ÙØ§Ø¦Ø²' : 'â³ Ù…Ø´Ø§Ø±Ùƒ'}</small>
                        </div>
                    </div>`;
            }
            if(snap.empty) list.innerHTML = "Ù„Ù… ØªØ´Ø§Ø±Ùƒ ÙÙŠ Ø£ÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        });
    }
</script>
</body>
</html>
