<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-header { position: relative; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; background: white; border-radius: 0 0 30px 30px; box-shadow: var(--shadow); }
        .img-container { position: relative; }
        .profile-img-large { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); }
        
        /* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø¹Ù…Ø± Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„ØµÙˆØ±Ø© */
        .age-badge { 
            position: absolute; bottom: 5px; right: -5px; 
            background: var(--accent); color: white; 
            width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 14px; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .info-card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .info-row:last-child { border: none; }
        .label { color: #8e8e93; font-weight: 600; }
        .value { color: #1c1c1e; font-weight: 700; }

        /* Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬ÙˆØ§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box { background: white; width: 90%; max-width: 380px; padding: 25px; border-radius: 25px; box-shadow: var(--shadow); }
        .modal-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 12px; font-family: inherit; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="history.back()" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</b>
        <div style="width:20px;"></div>
    </div>

    <div class="profile-header">
        <div class="img-container">
            <img id="uImg" src="https://via.placeholder.com/110" class="profile-img-large">
            <div id="uAge" class="age-badge">--</div>
        </div>
        <h2 id="uName" style="margin: 15px 0 5px 0; font-size: 20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h2>
        <span id="uRole" class="role-badge" style="background: #eef6ff; color: var(--primary); padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">Ø¹Ø¶Ùˆ</span>
    </div>

    <div class="info-card">
        <div class="info-row"><span class="label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</span> <span id="uEmail" class="value">--</span></div>
        <div class="info-row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span> <span id="uBirth" class="value">--</span></div>
        <div class="info-row"><span class="label">Ø§Ù„Ø¬Ù†Ø³</span> <span id="uGender" class="value">--</span></div>
        <div class="info-row" style="align-items: center;">
            <div style="display:flex; flex-direction:column;">
                <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
                <span id="uPhone" class="value">--</span>
            </div>
            <button onclick="openPhoneModal()" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:10px; font-size:11px; cursor:pointer;">Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± ğŸ“±</button>
        </div>
    </div>

    <div id="phoneModal" class="modal">
        <div class="modal-box">
            <h3 style="margin-top:0;">ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
            <p style="font-size:12px; color:gray;">Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡</p>
            
            <input type="tel" id="newPhoneInput" class="modal-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            
            <label style="font-size:12px; font-weight:bold; display:block; margin-top:10px;">Ø³Ø¨Ø¨ Ø§Ù„ØªØºÙŠÙŠØ±:</label>
            <select id="changeReason" class="modal-input">
                <option value="ØªØºÙŠØ± Ø±Ù‚Ù…ÙŠ">ØªØºÙŠØ± Ø±Ù‚Ù…ÙŠ</option>
                <option value="Ù…Ù‚Ø·ÙˆØ¹">Ù…Ù‚Ø·ÙˆØ¹</option>
                <option value="Ù…Ù†ØªÙ‡ÙŠ">Ù…Ù†ØªÙ‡ÙŠ</option>
                <option value="Ù„ÙŠØ³ Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ">Ù„ÙŠØ³ Ø±Ù‚Ù…ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</option>
                <option value="Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù…">Ø®Ø·Ø£ Ø¨Ø§Ù„Ø±Ù‚Ù…</option>
            </select>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn-main" onclick="submitPhoneRequest()" style="flex:1;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                <button onclick="closeModal()" style="flex:1; background:#eee; border:none; border-radius:12px;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></a>
        <a href="profile.html" class="nav-item active"><span class="nav-icon">ğŸ‘¤</span><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { doc, getDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUserData = null;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const docRef = doc(db, "Users", user.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                currentUserData = docSnap.data();
                displayProfile(currentUserData);
            }
        } else { window.location.href = "index.html"; }
    });

    function displayProfile(data) {
        document.getElementById('uName').innerText = data.fullName;
        document.getElementById('uEmail').innerText = data.email;
        document.getElementById('uPhone').innerText = data.phone;
        document.getElementById('uBirth').innerText = data.dob; // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„
        document.getElementById('uRole').innerText = data.role || 'Ø¹Ø¶Ùˆ';
        document.getElementById('uGender').innerText = data.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';
        if(data.profileImg) document.getElementById('uImg').src = data.profileImg;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        if(data.dob) {
            const birthDate = new Date(data.dob);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) { age--; }
            document.getElementById('uAge').innerText = age;
        }
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
    window.openPhoneModal = () => document.getElementById('phoneModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('phoneModal').style.display = 'none';

    window.submitPhoneRequest = async () => {
        const newPhone = document.getElementById('newPhoneInput').value.trim();
        const reason = document.getElementById('changeReason').value;

        if(!newPhone || newPhone.length < 10) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­");

        try {
            await addDoc(collection(db, "PhoneRequests"), {
                userId: auth.currentUser.uid,
                userName: currentUserData.fullName,
                currentPhone: currentUserData.phone,
                newPhone: newPhone,
                reason: reason,
                status: "pending",
                timestamp: serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù…Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
            closeModal();
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨");
        }
    }
</script>
</body>
</html>
