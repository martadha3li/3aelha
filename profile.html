<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù„ÙÙŠ Ø§Ù„Ø´Ø®ØµÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-header { position: relative; display: flex; flex-direction: column; align-items: center; padding: 30px 20px; background: white; border-radius: 0 0 30px 30px; box-shadow: var(--shadow); }
        .img-container { position: relative; cursor: pointer; }
        .profile-img-large { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 4px solid var(--primary); }
        
        /* Ø²Ø± ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© */
        .change-img-btn { 
            position: absolute; top: 0; left: 0; 
            background: rgba(0,0,0,0.5); color: white; 
            width: 30px; height: 30px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 14px;
        }

        .age-badge { 
            position: absolute; bottom: 5px; right: -5px; 
            background: var(--accent); color: white; 
            width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 14px; border: 3px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .info-card { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .info-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f5f5f5; font-size: 14px; }
        .label { color: #8e8e93; font-weight: 600; }
        .value { color: #1c1c1e; font-weight: 700; text-align: left; }
        
        /* Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¥Ù†Ø§Ø« */
        #guardianSection { background: #fff5f5; border: 1px dashed #ffcfcf; border-radius: 15px; padding: 10px; margin-top: 10px; display: none; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</b>
        <div style="width:20px;"></div>
    </div>

    <div class="profile-header">
        <div class="img-container" onclick="document.getElementById('fileInput').click()">
            <img id="uImg" src="https://via.placeholder.com/110" class="profile-img-large">
            <div class="change-img-btn">ğŸ“·</div>
            <div id="uAge" class="age-badge">--</div>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="updateProfilePhoto()">
        </div>
        <h2 id="uName" style="margin: 15px 0 5px 0; font-size: 20px;">--</h2>
        <span id="uRole" class="role-badge" style="background: #eef6ff; color: var(--primary); padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: bold;">Ø¹Ø¶Ùˆ</span>
    </div>

    <div class="info-card">
        <div class="info-row"><span class="label">Ø§Ù„Ø¬Ù†Ø³</span> <span id="uGender" class="value">--</span></div>
        <div class="info-row"><span class="label">Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ø³ÙƒÙ†</span> <span id="uCity" class="value">--</span></div>
        <div class="info-row"><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</span> <span id="uBirth" class="value">--</span></div>
        <div class="info-row">
            <div style="display:flex; flex-direction:column;">
                <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
                <span id="uPhone" class="value">--</span>
            </div>
            <button onclick="openPhoneModal()" style="background:var(--primary); color:white; border:none; padding:6px 10px; border-radius:10px; font-size:10px; cursor:pointer;">ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù‚Ù…</button>
        </div>

        <div id="guardianSection">
            <div style="font-size: 12px; font-weight: bold; color: #d63031; margin-bottom: 5px;">ğŸ›¡ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙØ¹Ø±Ù‘Ù (ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±)</div>
            <div class="info-row"><span class="label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ù</span> <span id="uGuardianName" class="value">--</span></div>
            <div class="info-row"><span class="label">Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù</span> <span id="uGuardianPhone" class="value">--</span></div>
        </div>
    </div>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
        <a href="chat.html" class="nav-item"><span class="nav-icon">ğŸ’¬</span><span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span></a>
        <a href="profile.html" class="nav-item active"><span class="nav-icon">ğŸ‘¤</span><span>Ø­Ø³Ø§Ø¨ÙŠ</span></a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const docSnap = await getDoc(doc(db, "Users", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                populateData(data);
            }
        } else { window.location.href = "index.html"; }
    });

    function populateData(data) {
        document.getElementById('uName').innerText = data.fullName;
        document.getElementById('uPhone').innerText = data.phone;
        document.getElementById('uBirth').innerText = data.dob || '--';
        document.getElementById('uGender').innerText = data.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰';
        document.getElementById('uCity').innerText = data.city || 'Ù„Ù… ØªØ­Ø¯Ø¯';
        document.getElementById('uRole').innerText = data.role || 'Ø¹Ø¶Ùˆ';
        if(data.profileImg) document.getElementById('uImg').src = data.profileImg;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±
        if(data.dob) {
            const age = new Date().getFullYear() - new Date(data.dob).getFullYear();
            document.getElementById('uAge').innerText = age;
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ù Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø£Ù†Ø«Ù‰
        if(data.gender === 'female') {
            document.getElementById('guardianSection').style.display = 'block';
            document.getElementById('uGuardianName').innerText = data.guardianName || '--';
            document.getElementById('uGuardianPhone').innerText = data.guardianPhone || '--';
        }
    }

    window.updateProfilePhoto = async () => {
        const file = document.getElementById('fileInput').files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onloadend = async () => {
            const base64 = reader.result;
            await updateDoc(doc(db, "Users", auth.currentUser.uid), { profileImg: base64 });
            document.getElementById('uImg').src = base64;
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
        };
        reader.readAsDataURL(file);
    };
</script>
</body>
</html>
