<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px;}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:10px;border:1px solid #ddd;}
button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer;}
.primary{background:#007AFF;color:#fff;}
.success{background:#34C759;color:#fff;}
.danger{background:#FF3B30;color:#fff;}
table{width:100%;border-collapse:collapse;margin-top:10px;}
th,td{padding:6px;border-bottom:1px solid #eee;text-align:right;font-size:13px;}
.winner-box{font-size:20px;margin-top:15px;color:#34C759;font-weight:bold;}
</style>
</head>
<body>

<h2>ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>

<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© -->
<div class="card">
<h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
<input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input type="datetime-local" id="compEnd">
<button class="primary" onclick="createCompetition()">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ -->
<div class="card">
<h3>â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
<select id="compSelect"></select>
<input type="text" id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
<input type="text" id="opt1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
<input type="text" id="opt2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
<input type="text" id="opt3" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
<label>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label>
<select id="correctOpt">
<option value="1">Ø§Ù„Ø£ÙˆÙ„</option>
<option value="2">Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
<option value="3">Ø§Ù„Ø«Ø§Ù„Ø«</option>
</select>
<input type="number" id="points" placeholder="Ø§Ù„Ù†Ù‚Ø§Ø·" value="10">
<button class="success" onclick="addQuestion()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„</button>
</div>

<!-- Ø§Ù„Ù‚Ø±Ø¹Ø© -->
<div class="card">
<h3>ğŸ° Ø¹Ù…Ù„ Ù‚Ø±Ø¹Ø©</h3>
<select id="drawComp"></select>
<input type="number" id="winnerCount" value="1" min="1">
<button class="primary" onclick="runDraw()">Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø±Ø¹Ø©</button>
<div id="drawResult" class="winner-box"></div>
</div>

<!-- Ø§Ù„ØªØ±ØªÙŠØ¨ -->
<div class="card">
<h3>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…</h3>
<table>
<thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody id="leaderboard"></tbody>
</table>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª -->
<div class="card">
<h3>ğŸ“‹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</th>
<th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
<th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
</tr>
</thead>
<tbody id="answersTable"></tbody>
</table>
</div>

<script type="module">
import { db } from './config.js';
import { collection, addDoc, onSnapshot, getDocs, query, where, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª */
onSnapshot(collection(db,"Competitions"), snap=>{
 const select=document.getElementById("compSelect");
 const draw=document.getElementById("drawComp");
 select.innerHTML="";
 draw.innerHTML="";
 snap.forEach(doc=>{
   const c=doc.data();
   select.innerHTML+=`<option value="${doc.id}">${c.title}</option>`;
   draw.innerHTML+=`<option value="${doc.id}">${c.title}</option>`;
 });
});

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.createCompetition=async ()=>{
 const title=document.getElementById("compTitle").value;
 const end=document.getElementById("compEnd").value;

 if(!title){alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");return;}

 await addDoc(collection(db,"Competitions"),{
   title:title,
   endDate:end||"",
   createdAt:serverTimestamp()
 });

 alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
 document.getElementById("compTitle").value="";
};

/* Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ */
window.addQuestion=async ()=>{
 const compId=document.getElementById("compSelect").value;
 const text=document.getElementById("qText").value;
 const o1=document.getElementById("opt1").value;
 const o2=document.getElementById("opt2").value;
 const o3=document.getElementById("opt3").value;
 const correctIndex=document.getElementById("correctOpt").value;
 const pts=parseInt(document.getElementById("points").value)||10;

 if(!text||!o1||!o2){alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");return;}

 const options=[o1,o2,o3].filter(x=>x!="");
 const correctOption=options[correctIndex-1];

 await addDoc(collection(db,`Competitions/${compId}/Questions`),{
   text:text,
   options:options,
   correctOption:correctOption,
   showAt:new Date().toISOString(),
   points:pts
 });

 alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„");
};

/* Ø§Ù„Ù‚Ø±Ø¹Ø© */
window.runDraw=async ()=>{
 const compId=document.getElementById("drawComp").value;
 const count=parseInt(document.getElementById("winnerCount").value)||1;

 const q=query(collection(db,"Answers"),where("compId","==",compId),where("isCorrect","==",true));
 const snap=await getDocs(q);

 let participants=[];
 let unique=new Set();

 snap.forEach(doc=>{
   const name=doc.data().userName;
   if(!unique.has(name)){
     participants.push(name);
     unique.add(name);
   }
 });

 if(participants.length==0){
   alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ØµØ­ÙŠØ­ÙŠÙ†");
   return;
 }

 const shuffled=participants.sort(()=>0.5-Math.random());
 const winners=shuffled.slice(0,count);

 document.getElementById("drawResult").innerHTML="ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ†:<br>"+winners.join("<br>");
};

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª + Ø§Ù„ØªØ±ØªÙŠØ¨ */
onSnapshot(collection(db,"Answers"), snap=>{
 let scores={};
 const table=document.getElementById("answersTable");
 table.innerHTML="";

 snap.forEach(doc=>{
   const a=doc.data();
   if(!scores[a.userName]) scores[a.userName]=0;
   scores[a.userName]+=a.pointsAwarded||0;

   const time=a.timestamp?.toDate()?.toLocaleString('ar-EG')||"";

   table.innerHTML+=`
   <tr>
   <td>${a.userName}</td>
   <td>${a.compTitle}</td>
   <td>${a.questionText}</td>
   <td>${a.selectedOption}</td>
   <td style="color:${a.isCorrect?'green':'red'}">${a.isCorrect?'âœ”':'âœ–'}</td>
   <td>${a.pointsAwarded}</td>
   <td>${time}</td>
   </tr>`;
 });

 const lb=document.getElementById("leaderboard");
 lb.innerHTML="";
 const sorted=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
 sorted.forEach((row,i)=>{
   lb.innerHTML+=`<tr><td>${i+1}</td><td>${row[0]}</td><td>${row[1]}</td></tr>`;
 });
});
</script>

</body>
</html>
