<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ù‚Ø±Ø¹Ø©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --gold: #FF9500; --card: #FFFFFF; }
        body { background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; direction: rtl; color: #1c1c1e; }
        .container { max-width: 900px; margin: auto; }
        
        .card { background: var(--card); border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); position: relative; }
        h1 { font-size: 26px; font-weight: 800; text-align: center; margin-bottom: 30px; }
        h2 { font-size: 18px; margin-top: 0; display: flex; align-items: center; gap: 8px; }

        .input-group { margin-bottom: 15px; }
        input, select, textarea { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #E5E5EA; background: #F9F9FB; font-size: 15px; box-sizing: border-box; outline: none; }

        .btn { padding: 12px 20px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 14px; }
        .btn-main { background: var(--primary); color: white; width: 100%; }
        .btn-draw { background: linear-gradient(135deg, #FF9500, #FFCC00); color: white; }
        .btn-ghost { background: #F2F2F7; color: #1c1c1e; }
        
        .comp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .menu-dots { cursor: pointer; padding: 5px 10px; font-size: 22px; font-weight: bold; }
        .dropdown-menu { display: none; position: absolute; left: 20px; top: 50px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 160px; border: 1px solid #EEE; }
        .dropdown-menu div { padding: 12px; font-size: 13px; text-align: right; border-bottom: 1px solid #F2F2F7; cursor: pointer; }
        .dropdown-menu div:hover { background: #F2F2F7; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-body { background: white; width: 95%; max-width: 550px; border-radius: 28px; padding: 30px; max-height: 90vh; overflow-y: auto; }

        /* Ù‚Ø³Ù… Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ù„Ù…Ø®ØµØµ */
        .winners-section { margin-top: 20px; padding-top: 15px; border-top: 2px dashed var(--gold); }
        .winner-tag { background: #FFF9F2; border: 1px solid #FFE0B2; border-radius: 12px; padding: 10px; margin-bottom: 8px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: right; font-size: 11px; color: #8E8E93; padding: 8px; background: #F9F9FB; }
        td { padding: 10px; border-bottom: 1px solid #F2F2F7; font-size: 13px; }
        .badge-win { background: var(--gold); color: white; padding: 2px 8px; border-radius: 6px; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°ÙƒÙŠØ© âš™ï¸</h1>

    <div class="card">
        <h2>ğŸ†• Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©..." class="input-group">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="input-group">
            <input type="datetime-local" id="compEndDate">
            <button class="btn btn-ghost" onclick="publishNow()">Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù† âš¡</button>
        </div>
        <button class="btn btn-main" onclick="createNewCompetition()">Ø­ÙØ¸ ÙˆÙ†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
    </div>

    <div class="card" style="border: 2px solid var(--gold);">
        <h2>ğŸ² Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰</h2>
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 15px;">
            <select id="drawCompSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</option></select>
            <input type="number" id="winnersCount" value="1">
        </div>
        <button class="btn btn-draw" style="width: 100%;" onclick="runAdvancedDraw()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø­Ù…Ø§Ø³ÙŠ ğŸ”¥</button>
    </div>

    <div id="resultsSections"></div>
</div>

<div id="qModal" class="modal"><div class="modal-body" id="qModalContent"></div></div>
<div id="drawModal" class="modal">
    <div class="modal-body" style="text-align: center;">
        <h2 id="drawStatus" style="color: var(--gold);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...</h2>
        <div id="winnersTableContainer"></div>
        <button class="btn btn-main" style="margin-top:20px;" onclick="closeModal('drawModal')">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>
<div id="userModal" class="modal"><div class="modal-body" id="userInfoContent"></div></div>

<script type="module">
    import { db } from './config.js';
    import { collection, addDoc, onSnapshot, getDocs, query, where, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.publishNow = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('compEndDate').value = now.toISOString().slice(0,16);
    };

    window.createNewCompetition = async () => {
        const title = document.getElementById('compTitle').value;
        const endDate = document.getElementById('compEndDate').value;
        if(!title) return alert("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨");
        await addDoc(collection(db, "Competitions"), { title, endDate, createdAt: serverTimestamp() });
        document.getElementById('compTitle').value = "";
    };

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§
    onSnapshot(query(collection(db, "Competitions"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById('resultsSections');
        const drawSelect = document.getElementById('drawCompSelect');
        container.innerHTML = "";
        drawSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</option>';

        snap.forEach(d => {
            const comp = d.data();
            const cid = d.id;
            drawSelect.innerHTML += `<option value="${cid}">${comp.title}</option>`;

            const card = document.createElement('div');
            card.className = "card";
            card.innerHTML = `
                <div class="comp-header">
                    <div><h3>ğŸ† ${comp.title}</h3><small>ÙŠÙ†ØªÙ‡ÙŠ: ${comp.endDate || '---'}</small></div>
                    <div class="menu-dots" onclick="toggleMenu('${cid}')">â‹®</div>
                    <div id="menu-${cid}" class="dropdown-menu">
                        <div onclick="openQManager('${cid}')">â“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                        <div onclick="deleteComp('${cid}')">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
                    </div>
                </div>
                <div class="table-wrapper">
                    <h4 style="margin:5px 0; font-size:12px;">ğŸ‘¥ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ† Ø§Ù„Ø¬Ø¯Ø¯:</h4>
                    <table id="table-${cid}"><tbody><tr><td colspan="3">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody></table>
                </div>
                <div id="winners-area-${cid}" class="winners-section" style="display:none;">
                    <h4 style="color:var(--gold); margin:0 0 10px 0;">ğŸ‰ ÙØ§Ø¦Ø²Ùˆ Ø§Ù„Ù‚Ø±Ø¹Ø©:</h4>
                    <table id="winners-table-${cid}">
                        <thead><tr><th>Ø§Ù„ÙØ§Ø¦Ø²</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø±Ù…</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            `;
            container.appendChild(card);
            loadData(cid);
        });
    });

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† + Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†
    async function loadData(cid) {
        // Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†
        const ansSnap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid)));
        const tbody = document.querySelector(`#table-${cid} tbody`);
        tbody.innerHTML = ansSnap.empty ? "<tr><td colspan='3'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª</td></tr>" : "";
        ansSnap.forEach(d => {
            const a = d.data();
            tbody.innerHTML += `<tr><td onclick="showUser('${a.userId}')" style="color:var(--primary); cursor:pointer">${a.userName}</td><td>${a.userPhone}</td><td>${a.isCorrect?'âœ…':'âŒ'}</td></tr>`;
        });

        // Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙˆÙ†
        const winDoc = await getDoc(doc(db, "Winners", cid));
        if(winDoc.exists()) {
            document.getElementById(`winners-area-${cid}`).style.display = 'block';
            const winTable = document.querySelector(`#winners-table-${cid} tbody`);
            winTable.innerHTML = "";
            winDoc.data().list.forEach(w => {
                winTable.innerHTML += `
                    <tr style="background:#FFFDF9">
                        <td style="font-weight:bold">${w.name}</td>
                        <td>${w.phone}</td>
                        <td style="font-size:11px; color:#666;">${w.guardian || '---'}<br>${w.gPhone || ''}</td>
                    </tr>`;
            });
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    window.runAdvancedDraw = async () => {
        const cid = document.getElementById('drawCompSelect').value;
        const count = parseInt(document.getElementById('winnersCount').value);
        if(!cid) return alert("Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø©");

        document.getElementById('drawModal').style.display = 'flex';
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid), where("isCorrect", "==", true)));
        let candidates = [];
        
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ù‚Ø±Ø¹Ø©
        for(const d of snap.docs) {
            const user = (await getDoc(doc(db, "Users", d.data().userId))).data();
            candidates.push({
                uid: d.data().userId,
                name: d.data().userName,
                phone: d.data().userPhone,
                guardian: user?.femaleGuardianName || '',
                gPhone: user?.femaleGuardianPhone || ''
            });
        }
        
        candidates = [...new Map(candidates.map(item => [item.uid, item])).values()];
        if(candidates.length === 0) return document.getElementById('drawStatus').innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¤Ù‡Ù„ÙŠÙ†";

        let winners = [];
        for(let i=0; i<Math.min(count, candidates.length); i++) {
            winners.push(candidates.splice(Math.floor(Math.random()*candidates.length), 1)[0]);
        }

        // Ø­ÙØ¸ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ² Ù„ÙŠØ¸Ù‡Ø±ÙˆØ§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø§Ø¦Ù…
        await setDoc(doc(db, "Winners", cid), { list: winners, drawnAt: serverTimestamp() });
        
        document.getElementById('drawStatus').innerText = "ğŸ‰ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù‚Ø±Ø¹Ø©";
        document.getElementById('winnersTableContainer').innerHTML = `
            <table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th></tr></thead>
            <tbody>${winners.map(w => `<tr><td>${w.name}</td><td>${w.phone}</td></tr>`).join('')}</tbody></table>
        `;
        loadData(cid); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
    };

    window.showUser = async (uid) => {
        const u = (await getDoc(doc(db, "Users", uid))).data();
        document.getElementById('userInfoContent').innerHTML = `
            <h3>ğŸ“‡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
            <p><b>Ø§Ù„Ø§Ø³Ù…:</b> ${u.fullName}</p><p><b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${u.phone}</p>
            <div style="background:#F9F9FB; padding:10px; border-radius:10px; margin-top:10px;">
                <p style="color:var(--gold); margin:0;"><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø±Ù… (Ù„Ù„Ø¥Ù†Ø§Ø«):</b></p>
                <p>Ø§Ù„Ø§Ø³Ù…: ${u.femaleGuardianName || '---'}</p>
                <p>Ø§Ù„Ø¬ÙˆØ§Ù„: ${u.femaleGuardianPhone || '---'}</p>
            </div>
            <button class="btn btn-main" style="margin-top:15px" onclick="closeModal('userModal')">Ø¥ØºÙ„Ø§Ù‚</button>`;
        document.getElementById('userModal').style.display = 'flex';
    };

    window.toggleMenu = (id) => {
        const m = document.getElementById(`menu-${id}`);
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.deleteComp = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "Competitions", id)); };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù…Ø¨Ø³Ø·)
    window.openQManager = (cid) => {
        document.getElementById('qModalContent').innerHTML = `
            <h3>â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
            <input type="text" id="qT" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„" class="input-group">
            <input type="text" id="qI" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" class="input-group">
            <div id="opts"><input type="text" class="o" placeholder="Ø®ÙŠØ§Ø± 1" class="input-group"><input type="text" class="o" placeholder="Ø®ÙŠØ§Ø± 2"></div>
            <p style="font-size:12px;">* Ø£ÙˆÙ„ Ø®ÙŠØ§Ø± Ù‡Ùˆ Ø§Ù„ØµØ­ÙŠØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø¨Ø³Ø·</p>
            <button class="btn btn-main" onclick="saveQ('${cid}')">Ø­ÙØ¸</button>
            <button class="btn btn-ghost" onclick="closeModal('qModal')">Ø¥Ù„ØºØ§Ø¡</button>`;
        document.getElementById('qModal').style.display = 'flex';
    };

    window.saveQ = async (cid) => {
        const text = document.getElementById('qT').value;
        const options = Array.from(document.querySelectorAll('.o')).map(i => i.value);
        await addDoc(collection(db, "Questions"), { compId: cid, text, options, correctAnswer: 0, createdAt: serverTimestamp() });
        alert("ØªÙ…"); closeModal('qModal');
    };
</script>
</body>
</html>
