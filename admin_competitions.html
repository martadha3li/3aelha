<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
:root{
--primary:#007AFF;
--success:#34C759;
--danger:#FF3B30;
--gold:#FF9500;
--bg:#F2F2F7;
--card:#ffffff;
}

body{
margin:0;
padding:20px;
background:var(--bg);
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
direction:rtl;
color:#1c1c1e;
}

.container{max-width:1100px;margin:auto;}

h1{
text-align:center;
font-size:28px;
font-weight:800;
margin-bottom:35px;
}

/* ====== GRID ====== */
.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
gap:20px;
margin-bottom:30px;
}

/* ====== CARD ====== */
.card{
background:var(--card);
border-radius:22px;
padding:22px;
box-shadow:0 15px 35px rgba(0,0,0,0.05);
border:1px solid rgba(0,0,0,0.04);
transition:.3s;
}
.card:hover{
transform:translateY(-4px);
box-shadow:0 20px 45px rgba(0,0,0,0.08);
}

.card h2{
margin:0 0 18px 0;
font-size:18px;
display:flex;
align-items:center;
gap:8px;
}

/* ====== INPUTS ====== */
input,select,textarea{
width:100%;
padding:13px;
border-radius:14px;
border:1px solid #E5E5EA;
background:#F9F9FB;
font-size:14px;
margin-bottom:12px;
outline:none;
transition:.2s;
}
input:focus,textarea:focus{
border-color:var(--primary);
background:#fff;
}

/* ====== BUTTONS ====== */
.btn{
padding:12px;
border:none;
border-radius:14px;
cursor:pointer;
font-weight:600;
transition:.2s;
display:flex;
justify-content:center;
align-items:center;
gap:6px;
}
.btn-main{background:var(--primary);color:#fff;}
.btn-draw{background:linear-gradient(135deg,#FF9500,#FFCC00);color:#fff;}
.btn-danger{background:var(--danger);color:#fff;}
.btn-ghost{background:#F2F2F7;}
.btn:active{transform:scale(.96);}

/* ====== COMPETITION CARDS ====== */
.comp-card{
margin-bottom:20px;
}

.comp-header{
display:flex;
justify-content:space-between;
align-items:flex-start;
}

.menu-dots{
font-size:22px;
cursor:pointer;
padding:5px 10px;
}

.dropdown{
display:none;
position:absolute;
background:#fff;
border-radius:14px;
box-shadow:0 10px 25px rgba(0,0,0,.15);
overflow:hidden;
z-index:999;
}
.dropdown div{
padding:12px 18px;
font-size:13px;
cursor:pointer;
border-bottom:1px solid #eee;
}
.dropdown div:hover{background:#F2F2F7;}
.dropdown div:last-child{border:none;color:var(--danger);}

/* ====== TABLE ====== */
table{
width:100%;
border-collapse:collapse;
margin-top:12px;
}
th{
font-size:12px;
background:#F9F9FB;
padding:10px;
color:#8E8E93;
}
td{
padding:12px;
border-bottom:1px solid #F2F2F7;
font-size:14px;
}

/* ====== MODAL ====== */
.modal{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
backdrop-filter:blur(10px);
justify-content:center;
align-items:center;
z-index:9999;
}
.modal-body{
background:#fff;
width:95%;
max-width:600px;
border-radius:28px;
padding:28px;
max-height:90vh;
overflow:auto;
}

/* ====== OPTIONS ====== */
.option-box{
display:flex;
align-items:center;
gap:10px;
background:#F2F2F7;
padding:10px;
border-radius:12px;
margin-bottom:10px;
}
.option-box input[type="checkbox"]{
width:22px;
height:22px;
accent-color:var(--success);
}

/* ====== WINNER ANIMATION ====== */
.winner-row{
animation:fadeUp .6s forwards;
opacity:0;
transform:translateY(20px);
}
@keyframes fadeUp{
to{opacity:1;transform:translateY(0);}
}

</style>
</head>

<body>

<div class="container">

<h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ© âš™ï¸</h1>

<!-- ====== TOP GRID ====== -->
<div class="grid">

<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© -->
<div class="card">
<h2>ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
<input type="text" id="compTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<label style="font-size:12px;color:#8E8E93">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input type="datetime-local" id="compEndDate">
<button class="btn btn-ghost" onclick="publishNow()">âš¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù†</button>
<br>
<button class="btn btn-main" onclick="createNewCompetition()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<!-- Ø§Ù„Ù‚Ø±Ø¹Ø© -->
<div class="card" style="border:2px solid var(--gold);background:#FFFDF8">
<h2>ğŸ² Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ø³ÙŠØ©</h2>
<select id="drawCompSelect"><option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</option></select>
<input type="number" id="winnersCount" value="1" min="1">
<button class="btn btn-draw" onclick="runAdvancedDraw()">ğŸ”¥ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø³Ø­Ø¨</button>
</div>

</div>

<!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª -->
<div id="resultsSections"></div>

</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
<div id="qModal" class="modal">
<div class="modal-body">
<h3>â“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
<input type="hidden" id="activeCid">

<textarea id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
<input type="text" id="qImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<input type="number" id="qPoints" value="10" placeholder="Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø¤Ø§Ù„">

<div id="optionsList"></div>
<button class="btn btn-ghost" onclick="addOptionField()">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±</button>
<br><br>
<button class="btn btn-main" onclick="saveQuestion()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
<br><br>
<button class="btn btn-ghost" onclick="closeModal('qModal')">Ø¥ØºÙ„Ø§Ù‚</button>

<div id="currentQs" style="margin-top:20px;border-top:1px solid #eee;padding-top:15px;"></div>
</div>
</div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø±Ø¹Ø© -->
<div id="drawModal" class="modal">
<div class="modal-body" style="text-align:center">
<h2 id="drawStatus" style="color:var(--gold)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...</h2>
<div id="winnersTableContainer"></div>
<button class="btn btn-main" onclick="closeModal('drawModal')">ØªÙ…</button>
</div>
</div>

<script type="module">
import { db } from './config.js';
import { collection, addDoc, onSnapshot, getDocs, query, where, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ====== Ù†Ø´Ø± Ø§Ù„Ø¢Ù† ====== */
window.publishNow=()=>{
const now=new Date();
now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
compEndDate.value=now.toISOString().slice(0,16);
};

/* ====== Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© ====== */
window.createNewCompetition=async()=>{
const title=compTitle.value;
const endDate=compEndDate.value;
if(!title)return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
await addDoc(collection(db,"Competitions"),{title,endDate,createdAt:serverTimestamp()});
compTitle.value="";
alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
};

/* ====== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ====== */
onSnapshot(query(collection(db,"Competitions"),orderBy("createdAt","desc")),(snap)=>{
resultsSections.innerHTML="";
drawCompSelect.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</option>';

snap.forEach(d=>{
const comp=d.data();
const cid=d.id;

drawCompSelect.innerHTML+=`<option value="${cid}">${comp.title}</option>`;

resultsSections.innerHTML+=`
<div class="card comp-card">
<div class="comp-header">
<div>
<h3>${comp.title}</h3>
<small style="color:#8E8E93">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶: ${comp.endDate||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</small>
</div>
<div style="position:relative">
<span class="menu-dots" onclick="toggleMenu('${cid}')">â‹®</span>
<div id="menu-${cid}" class="dropdown">
<div onclick="openQManager('${cid}')">â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</div>
<div onclick="editComp('${cid}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</div>
<div onclick="deleteComp('${cid}')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
</div>
</div>
</div>

<table id="table-${cid}">
<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody><tr><td colspan="4">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
</table>

</div>
`;

loadAnswers(cid);
});
});

/* ====== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ====== */
let optionsCount=0;
window.openQManager=(cid)=>{
activeCid.value=cid;
optionsList.innerHTML="";
optionsCount=0;
addOptionField();addOptionField();
loadExistingQs(cid);
qModal.style.display="flex";
};

window.addOptionField=()=>{
optionsList.innerHTML+=`
<div class="option-box">
<input type="checkbox" class="opt-check">
<input type="text" class="opt-text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± ${++optionsCount}">
</div>
`;
};

window.saveQuestion=async()=>{
const cid=activeCid.value;
const text=qText.value;
const img=qImage.value;
const pts=parseInt(qPoints.value);

let options=[];
let correctIdx=-1;

document.querySelectorAll(".option-box").forEach((el,i)=>{
const txt=el.querySelector(".opt-text").value;
if(txt){
options.push(txt);
if(el.querySelector(".opt-check").checked)correctIdx=i;
}
});

if(!text||correctIdx===-1)return alert("Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©");

await addDoc(collection(db,"Questions"),{
compId:cid,text,image:img,points:pts,
options,correctAnswer:correctIdx,
createdAt:serverTimestamp()
});
alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
openQManager(cid);
};

/* ====== Ø§Ù„Ù‚Ø±Ø¹Ø© ====== */
window.runAdvancedDraw=async()=>{
const cid=drawCompSelect.value;
const count=parseInt(winnersCount.value);
if(!cid)return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");

drawModal.style.display="flex";
drawStatus.innerText="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø³Ø­Ø¨...";

const snap=await getDocs(query(collection(db,"Answers"),where("compId","==",cid),where("isCorrect","==",true)));

let candidates=snap.docs.map(d=>({
uid:d.data().userId,
name:d.data().userName,
phone:d.data().userPhone
}));

candidates=[...new Map(candidates.map(i=>[i.uid,i])).values()];

if(!candidates.length){
drawStatus.innerText="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø´Ø­ÙŠÙ†";
return;
}

setTimeout(()=>{
let winners=[];
for(let i=0;i<Math.min(count,candidates.length);i++){
const r=Math.floor(Math.random()*candidates.length);
winners.push(candidates.splice(r,1)[0]);
}

drawStatus.innerText="ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† ğŸ‰";
let html=`<table><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th></tr></thead><tbody>`;
winners.forEach((w,i)=>{
html+=`<tr class="winner-row" style="animation-delay:${i*.4}s">
<td>${i+1}</td><td>${w.name}</td><td>${w.phone}</td>
</tr>`;
});
html+="</tbody></table>";
winnersTableContainer.innerHTML=html;

},2000);
};

/* ====== ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ====== */
window.toggleMenu=(id)=>{
const m=document.getElementById("menu-"+id);
m.style.display=m.style.display==="block"?"none":"block";
};
window.closeModal=(id)=>document.getElementById(id).style.display="none";
window.deleteComp=async(id)=>{if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ"))await deleteDoc(doc(db,"Competitions",id));};
async function loadAnswers(cid){
const snap=await getDocs(query(collection(db,"Answers"),where("compId","==",cid)));
const tbody=document.querySelector(`#table-${cid} tbody`);
tbody.innerHTML=snap.empty?"<tr><td colspan='4'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª</td></tr>":"";
snap.forEach(d=>{
const a=d.data();
tbody.innerHTML+=`<tr>
<td>${a.userName}</td>
<td>${a.userPhone}</td>
<td>${a.isCorrect?'âœ…':'âŒ'}</td>
<td>${a.pointsAwarded||0}</td>
</tr>`;
});
}
</script>

</body>
</html>
