<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --bg: #F2F2F7; --gold: #FF9500; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; direction: rtl; }
        .card { background: white; border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); font-size: 18px; border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F8F8FB; padding: 12px; text-align: right; font-size: 13px; color: #8E8E93; }
        td { padding: 12px; border-bottom: 1px solid #F2F2F7; font-size: 14px; }

        /* Ø²Ø± Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ§Ù„ØªØµØ¯ÙŠØ± */
        .action-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .btn-excel { background: var(--success); }
        .btn-draw { background: var(--gold); }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Modal) Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ */
        .user-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-body { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; position: relative; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        .info-label { font-weight: bold; color: #8E8E93; }

        .clickable-name { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù‚Ø±Ø¹Ø© ğŸ†</h1>

    <div id="resultsSections"></div>

    <div id="userModal" class="user-modal">
        <div class="modal-body">
            <h3 style="margin-top:0;">ğŸ“‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØ§ØµÙ„</h3>
            <div id="modalInfo"></div>
            <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:12px; border:none; border-radius:10px; background:#EEE;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, getDocs, query, where, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    onSnapshot(collection(db, "Competitions"), async (snap) => {
        const container = document.getElementById('resultsSections');
        container.innerHTML = "";

        for (const compDoc of snap.docs) {
            const comp = compDoc.data();
            const compId = compDoc.id;

            // Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø³Ù… Ù„ÙƒÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø©
            const section = document.createElement('div');
            section.className = "card";
            section.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Ù…Ø³Ø§Ø¨Ù‚Ø©: ${comp.title}</h2>
                    <div>
                        <button class="action-btn btn-draw" onclick="runDraw('${compId}', '${comp.title}')">ğŸ² Ø³Ø­Ø¨ Ù‚Ø±Ø¹Ø©</button>
                        <button class="action-btn btn-excel" onclick="exportExcel('${compId}', '${comp.title}')">ğŸ“Š ØªØµØ¯ÙŠØ± Excel</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th>
                                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            </tr>
                        </thead>
                        <tbody id="table-${compId}"></tbody>
                    </table>
                </div>
            `;
            container.appendChild(section);

            // Ø¬Ù„Ø¨ Ù†ØªØ§Ø¦Ø¬ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
            fetchAnswers(compId);
        }
    });

    async function fetchAnswers(compId) {
        const q = query(collection(db, "Answers"), where("compId", "==", compId));
        const snap = await getDocs(q);
        const tbody = document.getElementById(`table-${compId}`);
        
        // Ø¬Ù„Ø¨ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ØªØ±Ù‚ÙŠÙ…Ù‡Ø§
        const questionsSnap = await getDocs(collection(db, `Questions`)); // Ø£Ùˆ Ø­Ø³Ø¨ Ù‡ÙŠÙƒÙ„ÙŠØ© ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ø¯ÙŠÙƒ
        
        let index = 1;
        snap.forEach(d => {
            const a = d.data();
            tbody.innerHTML += `
                <tr>
                    <td>${index++}</td>
                    <td class="clickable-name" onclick="showUserInfo('${a.userId}')">${a.userName}</td>
                    <td>${a.userPhone}</td>
                    <td>${a.isCorrect ? 'âœ… ØµØ­' : 'âŒ Ø®Ø·Ø£'}</td>
                    <td style="font-size:11px; max-width:150px; overflow:hidden;">${a.questionText}</td>
                    <td style="font-weight:bold; color:var(--success)">${a.pointsAwarded}</td>
                </tr>
            `;
        });
    }

    // ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ
    window.showUserInfo = async (uid) => {
        const userDoc = await getDoc(doc(db, "Users", uid));
        if (!userDoc.exists()) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©");
        
        const u = userDoc.data();
        const infoDiv = document.getElementById('modalInfo');
        
        infoDiv.innerHTML = `
            <div class="info-row"><span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span> <span>${u.fullName || u.name}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span>${u.phone}</span></div>
            <div class="info-row"><span class="info-label">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span> <span>${u.email || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</span></div>
            <hr>
            <div class="info-row"><span class="info-label">Ù…Ø¹Ø±Ù Ø§Ù„Ø£Ù†Ø«Ù‰:</span> <span>${u.femaleGuardianName || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></div>
            <div class="info-row"><span class="info-label">Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù:</span> <span>${u.femaleGuardianPhone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</span></div>
        `;
        document.getElementById('userModal').style.display = 'flex';
    };

    window.closeModal = () => document.getElementById('userModal').style.display = 'none';

    // ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù‚Ø±Ø¹Ø©
    window.runDraw = async (compId, title) => {
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", compId), where("isCorrect", "==", true)));
        const winners = snap.docs.map(d => ({id: d.data().userId, name: d.data().userName}));
        
        if (winners.length === 0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù„ÙŠÙ‡Ø§!");
        
        const luckyOne = winners[Math.floor(Math.random() * winners.length)];
        alert(`ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ ${title} Ù‡Ùˆ: ${luckyOne.name}`);
        showUserInfo(luckyOne.id);
    };

    // ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ø§ÙƒØ³Ù„
    window.exportExcel = async (compId, title) => {
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", compId)));
        const data = snap.docs.map(d => {
            const a = d.data();
            return {
                "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ": a.userName,
                "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„": a.userPhone,
                "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ": a.userEmail || "---",
                "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„": a.questionText,
                "Ø§Ù„Ù†ØªÙŠØ¬Ø©": a.isCorrect ? "ØµØ­ÙŠØ­Ø©" : "Ø®Ø§Ø·Ø¦Ø©",
                "Ø§Ù„Ù†Ù‚Ø§Ø·": a.pointsAwarded
            };
        });

        const worksheet = XLSX.utils.json_to_sheet(data);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
        XLSX.writeFile(workbook, `Ù†ØªØ§Ø¦Ø¬_Ù…Ø³Ø§Ø¨Ù‚Ø©_${title}.xlsx`);
    };

</script>
</body>
</html>
