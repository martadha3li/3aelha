<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 70px;
    background: rgba(255, 255, 255, 0.94);
    backdrop-filter: blur(15px);
    display: flex;
    justify-content: space-around;
    align-items: center;
    border-top: 0.5px solid rgba(0,0,0,0.1);
    padding-bottom: env(safe-area-inset-bottom); /* Ù„Ø¯Ø¹Ù… Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø¢ÙŠÙÙˆÙ† Ø§Ù„Ø­Ø¯ÙŠØ«Ø© */
    z-index: 10000;
}

.nav-item {
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #8E8E93;
    transition: 0.3s;
    flex: 1;
}

.nav-item.active {
    color: var(--primary); /* Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ù†Ø´Ø· */
}

.nav-icon {
    font-size: 22px;
    margin-bottom: 4px;
}

.nav-label {
    font-size: 11px;
    font-weight: 500;
}

/* ØªØ£Ø«ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
.nav-item:active {
    transform: scale(0.9);
}
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --gold: #FF9500; --card: #FFFFFF; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 1000px; margin: auto; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© */
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: relative; }
        .draw-nav-card { background: var(--gold); color: white; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© ÙˆØ£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .comp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #F2F2F7; padding-bottom: 10px; }
        .menu-dots { cursor: pointer; font-size: 24px; padding: 0 10px; }
        .dropdown-menu { display: none; position: absolute; left: 20px; top: 50px; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 100; min-width: 160px; border: 1px solid #EEE; }
        .dropdown-menu div { padding: 12px; font-size: 13px; text-align: right; border-bottom: 1px solid #F2F2F7; cursor: pointer; }
        .dropdown-menu div:hover { background: #F2F2F7; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; background: #fff; }
        th { background: #F9F9FB; padding: 12px; font-size: 12px; color: #8E8E93; text-align: right; }
        td { padding: 12px; border-bottom: 1px solid #F2F2F7; font-size: 13px; }
        .ans-tag { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .ans-correct { background: #E8F5E9; color: var(--success); }
        .ans-wrong { background: #FFEBEE; color: var(--danger); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        .input-group { margin-bottom: 10px; }
        input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #DDD; box-sizing: border-box; outline: none; }
        .btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; width: 100%; }

        /* Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-body { background: white; width: 90%; max-width: 500px; border-radius: 20px; padding: 25px; max-height: 85vh; overflow-y: auto; }
        .option-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ğŸ’</h1>

    <div class="card draw-nav-card" onclick="location.href='draw.html'">
        <span style="font-weight: bold; font-size: 18px;">ğŸ² Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</span>
        <span style="background: white; color: var(--gold); padding: 5px 15px; border-radius: 10px;">Ø¯Ø®ÙˆÙ„ â†</span>
    </div>

    <div class="card">
        <h3>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
        <div class="input-group">
            <input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ø³ÙŠØ±Ø© Ø§Ù„Ù†Ø¨ÙˆÙŠØ©)">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;" class="input-group">
            <input type="datetime-local" id="compEndDate">
            <button class="btn" style="background: #EEE;" onclick="setNow()">Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù† âš¡</button>
        </div>
        <button class="btn btn-main" onclick="createNewCompetition()">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¬Ù…Ù‡ÙˆØ± âœ…</button>
    </div>

    <div id="resultsSections"></div>
</div>

<div id="qModal" class="modal">
    <div class="modal-body">
        <h3 id="qModalTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
        <input type="hidden" id="activeCid">
        
        <div class="input-group">
            <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
            <textarea id="qText" rows="2"></textarea>
        </div>
        <div class="input-group">
            <label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="qImage" placeholder="https://...">
        </div>
        <div class="input-group">
            <label>Ø§Ù„Ù†Ù‚Ø§Ø·:</label>
            <input type="number" id="qPoints" value="10">
        </div>
        
        <div id="optionsArea">
            <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª (Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©):</label>
            <div class="option-row"><input type="radio" name="correct" value="0" checked> <input type="text" class="opt-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„"></div>
            <div class="option-row"><input type="radio" name="correct" value="1"> <input type="text" class="opt-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ"></div>
            <div class="option-row"><input type="radio" name="correct" value="2"> <input type="text" class="opt-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«"></div>
        </div>

        <button class="btn btn-main" style="margin-top: 15px;" onclick="saveQuestion()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ â•</button>
        <button class="btn" style="width:100%; margin-top:10px;" onclick="closeModal()">Ø¥ØºÙ„Ø§Ù‚</button>
        
        <div id="existingQs" style="margin-top: 20px; border-top: 1px solid #EEE; padding-top: 10px;"></div>
    </div>
</div>

<script type="module">
    import { db } from './config.js';
    import { collection, addDoc, onSnapshot, getDocs, query, where, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
    window.setNow = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('compEndDate').value = now.toISOString().slice(0,16);
    };

    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø©
    window.createNewCompetition = async () => {
        const title = document.getElementById('compTitle').value;
        const endDate = document.getElementById('compEndDate').value;
        if(!title || !endDate) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        await addDoc(collection(db, "Competitions"), { title, endDate, createdAt: serverTimestamp() });
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©");
        document.getElementById('compTitle').value = "";
    };

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    onSnapshot(query(collection(db, "Competitions"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById('resultsSections');
        container.innerHTML = "";

        snap.forEach(d => {
            const comp = d.data();
            const cid = d.id;

            const card = document.createElement('div');
            card.className = "card";
            card.innerHTML = `
                <div class="comp-header">
                    <div>
                        <h3 style="margin:0;">ğŸ† ${comp.title}</h3>
                        <small style="color:gray;">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©: ${comp.endDate}</small>
                    </div>
                    <div style="position:relative;">
                        <div class="menu-dots" onclick="toggleMenu('${cid}')">â‹®</div>
                        <div id="menu-${cid}" class="dropdown-menu">
                            <div onclick="openQManager('${cid}', '${comp.title}')">â“ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                            <div onclick="deleteComp('${cid}')" style="color:var(--danger)">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
                        </div>
                    </div>
                </div>

                <div class="table-wrapper">
                    <h4 style="margin-bottom:10px;">ğŸ“Š Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th>
                                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-${cid}">
                            <tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ§Øª...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            container.appendChild(card);
            loadAnswers(cid);
        });
    });

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„ÙƒÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø©
    async function loadAnswers(cid) {
        const q = query(collection(db, "Answers"), where("compId", "==", cid));
        const snap = await getDocs(q);
        const tbody = document.getElementById(`tbody-${cid}`);
        tbody.innerHTML = snap.empty ? "<tr><td colspan='5' style='text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</td></tr>" : "";

        snap.forEach(d => {
            const a = d.data();
            tbody.innerHTML += `
                <tr>
                    <td><b>${a.userName}</b></td>
                    <td>${a.userPhone}</td>
                    <td>${a.selectedOption || '---'}</td>
                    <td>
                        <span class="ans-tag ${a.isCorrect ? 'ans-correct' : 'ans-wrong'}">
                            ${a.isCorrect ? 'ØµØ­ÙŠØ­Ø© âœ…' : 'Ø®Ø§Ø·Ø¦Ø© âŒ'}
                        </span>
                    </td>
                    <td><b style="color:var(--primary)">${a.pointsAwarded || 0}</b></td>
                </tr>
            `;
        });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    window.openQManager = async (cid, title) => {
        document.getElementById('activeCid').value = cid;
        document.getElementById('qModalTitle').innerText = "Ø£Ø³Ø¦Ù„Ø©: " + title;
        document.getElementById('qModal').style.display = 'flex';
        loadQs(cid);
    };

    window.saveQuestion = async () => {
        const cid = document.getElementById('activeCid').value;
        const text = document.getElementById('qText').value;
        const img = document.getElementById('qImage').value;
        const pts = parseInt(document.getElementById('qPoints').value);
        const correct = parseInt(document.querySelector('input[name="correct"]:checked').value);
        const opts = Array.from(document.querySelectorAll('.opt-input')).map(i => i.value);

        if(!text || opts.some(o => !o)) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª");

        await addDoc(collection(db, "Questions"), {
            compId: cid, text, image: img, points: pts, options: opts, correctAnswer: correct, createdAt: serverTimestamp()
        });
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸");
        document.getElementById('qText').value = "";
        loadQs(cid);
    };

    async function loadQs(cid) {
        const qSnap = await getDocs(query(collection(db, "Questions"), where("compId", "==", cid)));
        const area = document.getElementById('existingQs');
        area.innerHTML = "<b>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</b><br>";
        qSnap.forEach(d => {
            area.innerHTML += `<div style="display:flex; justify-content:space-between; margin:5px 0; font-size:12px;">
                <span>â€¢ ${d.data().text} (${d.data().points} Ù†Ù‚Ø·Ø©)</span>
                <span style="color:red; cursor:pointer;" onclick="deleteQ('${d.id}', '${cid}')">Ø­Ø°Ù</span>
            </div>`;
        });
    }

    // ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø©
    window.toggleMenu = (id) => {
        const m = document.getElementById(`menu-${id}`);
        m.style.display = m.style.display === 'block' ? 'none' : 'block';
    };
    window.closeModal = () => document.getElementById('qModal').style.display = 'none';
    window.deleteComp = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ")) await deleteDoc(doc(db, "Competitions", id)); };
    window.deleteQ = async (id, cid) => { await deleteDoc(doc(db, "Questions", id)); loadQs(cid); };

</script>
    <div class="bottom-nav">
    <a href="admin.html" class="nav-item">
        <span class="nav-icon">ğŸ </span>
        <span class="nav-label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </a>
    <a href="admin_competition.html" class="nav-item active">
        <span class="nav-icon">ğŸ†</span>
        <span class="nav-label">Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</span>
    </a>
    <a href="draw.html" class="nav-item">
        <span class="nav-icon">ğŸ²</span>
        <span class="nav-label">Ø§Ù„Ù‚Ø±Ø¹Ø©</span>
    </a>
    <a href="users.html" class="nav-item">
        <span class="nav-icon">ğŸ‘¥</span>
        <span class="nav-label">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span>
    </a>
</div>

<div style="height: 80px;"></div>
</body>
</html>
