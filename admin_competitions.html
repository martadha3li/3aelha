<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --gold: #FF9500; --card: #FFFFFF; }
        body { background: var(--bg); font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; direction: rtl; padding-bottom: 50px; }
        
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 0.5px solid #E5E5EA; }
        
        h1 { font-size: 24px; color: #1c1c1e; text-align: center; margin-bottom: 30px; }
        h2 { font-size: 18px; color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 10px; }

        /* Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Form) */
        .form-group { margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #DDD; box-sizing: border-box; font-size: 14px; background: #FAFAFA; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 10px 18px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn:active { transform: scale(0.97); }
        .btn-main { background: var(--primary); color: white; width: 100%; padding: 14px; font-size: 16px; }
        .btn-draw { background: var(--gold); color: white; }
        .btn-excel { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; padding: 5px 10px; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #F8F8FB; padding: 12px; text-align: right; font-size: 12px; color: #8E8E93; border-bottom: 1px solid #EEE; }
        td { padding: 12px; border-bottom: 1px solid #F2F2F7; font-size: 13px; }

        .clickable-name { color: var(--primary); text-decoration: underline; cursor: pointer; font-weight: bold; }

        /* Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (Modal) */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-body { background: white; width: 90%; max-width: 450px; border-radius: 22px; padding: 25px; position: relative; }
        .info-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #F2F2F7; }
        .info-label { font-weight: bold; color: #8E8E93; }

        /* Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .q-list { margin-top: 10px; padding: 10px; background: #F9F9F9; border-radius: 12px; border: 1px solid #EEE; }
        .q-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #DDD; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ğŸ†</h1>

    <div class="card">
        <h2>ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <div class="form-group">
            <input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø³Ø§Ø¨Ù‚Ø© Ø±Ù…Ø¶Ø§Ù†)">
        </div>
        <div class="form-group">
            <label style="font-size: 12px; color: #8E8E93;">ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¥Ù†ØªÙ‡Ø§Ø¡:</label>
            <input type="datetime-local" id="compEndDate">
        </div>
        <button class="btn btn-main" onclick="createNewCompetition()">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ âœ…</button>
    </div>

    <div id="resultsSections">
        <p style="text-align:center; color:gray;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-body">
        <h3 style="margin-top:0; color:var(--primary);">ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§Ø¦Ø² ÙˆØ§Ù„ØªÙˆØ§ØµÙ„</h3>
        <div id="modalInfo"></div>
        <button onclick="closeModal()" style="width:100%; margin-top:20px; padding:12px; border:none; border-radius:12px; background:#F2F2F7; font-weight:bold; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script type="module">
    import { db } from './config.js';
    import { collection, addDoc, onSnapshot, getDocs, query, where, doc, getDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© (ØªØ¹Ù…Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
    window.createNewCompetition = async () => {
        const title = document.getElementById('compTitle').value;
        const endDate = document.getElementById('compEndDate').value;
        if (!title || !endDate) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹");

        try {
            await addDoc(collection(db, "Competitions"), {
                title, endDate, visible: true, createdAt: serverTimestamp()
            });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById('compTitle').value = "";
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + e.message); }
    };

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª - ØªÙ… ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„
    onSnapshot(collection(db, "Competitions"), async (snap) => {
        const container = document.getElementById('resultsSections');
        container.innerHTML = "";

        if(snap.empty) {
            container.innerHTML = "<p style='text-align:center; padding:20px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ù…Ù†Ø´Ø£Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
            return;
        }

        snap.forEach((compDoc) => {
            const comp = compDoc.data();
            const cid = compDoc.id;

            const section = document.createElement('div');
            section.className = "card";
            section.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom:1px solid #EEE; padding-bottom:10px;">
                    <div>
                        <h2 style="margin:0;">ğŸ† ${comp.title}</h2>
                        <small style="color:gray;">ØªÙ†ØªÙ‡ÙŠ ÙÙŠ: ${comp.endDate ? comp.endDate.replace('T', ' ') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-draw" onclick="runDraw('${cid}', '${comp.title}')">ğŸ² Ù‚Ø±Ø¹Ø©</button>
                        <button class="btn btn-excel" onclick="exportExcel('${cid}', '${comp.title}')">ğŸ“Š Excel</button>
                        <button class="btn btn-danger" onclick="deleteComp('${cid}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th>
                                <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                            </tr>
                        </thead>
                        <tbody id="table-${cid}">
                            <tr><td colspan="4" style="text-align:center; color:#CCC;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...</td></tr>
                        </tbody>
                    </table>
                </div>
            `;
            container.appendChild(section);
            fetchAnswers(cid);
        });
    });

    // 3. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ÙÙ„ØªØ±Ø©)
    async function fetchAnswers(cid) {
        try {
            const q = query(collection(db, "Answers"), where("compId", "==", cid));
            const snap = await getDocs(q);
            const tbody = document.getElementById(`table-${cid}`);
            if(!tbody) return;
            tbody.innerHTML = "";

            if(snap.empty) {
                tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; color:gray;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒØ§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©.</td></tr>";
                return;
            }

            snap.forEach(d => {
                const a = d.data();
                tbody.innerHTML += `
                    <tr>
                        <td class="clickable-name" onclick="showUserInfo('${a.userId}')">${a.userName || 'Ù…Ø´Ø§Ø±ÙƒØª'}</td>
                        <td>${a.userPhone || '---'}</td>
                        <td style="color:${a.isCorrect ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">
                            ${a.isCorrect ? 'âœ… ØµØ­' : 'âŒ Ø®Ø·Ø£'}
                        </td>
                        <td>${a.pointsAwarded || 0}Ù†</td>
                    </tr>
                `;
            });
        } catch (e) { console.error("Error fetching answers:", e); }
    }

    // 4. Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©) - Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©
    window.showUserInfo = async (uid) => {
        try {
            const userDoc = await getDoc(doc(db, "Users", uid));
            const infoDiv = document.getElementById('modalInfo');
            
            if (!userDoc.exists()) {
                infoDiv.innerHTML = "<p>ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø¹Ø¶ÙˆØŒ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ø³Ø¬Ù„Ø§Ù‹ ÙƒØ¶ÙŠÙ.</p>";
            } else {
                const u = userDoc.data();
                infoDiv.innerHTML = `
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø§Ø³Ù…:</span> <span>${u.fullName || u.name || '---'}</span></div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span>${u.phone || '---'}</span></div>
                    <div class="info-row"><span class="info-label">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</span> <span>${u.email || '---'}</span></div>
                    <div style="margin-top:15px; background:#FFF9F2; padding:10px; border-radius:10px; border:1px solid #FFE0B2;">
                        <div style="font-weight:bold; color:var(--gold); margin-bottom:5px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆÙ„ÙŠ (Ù„Ù„Ø¥Ù†Ø§Ø«):</div>
                        <div class="info-row"><span class="info-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</span> <span>${u.femaleGuardianName || '---'}</span></div>
                        <div class="info-row"><span class="info-label">Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</span> <span>${u.femaleGuardianPhone || '---'}</span></div>
                    </div>
                `;
            }
            document.getElementById('userModal').style.display = 'flex';
        } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
    };

    window.closeModal = () => document.getElementById('userModal').style.display = 'none';

    // 5. Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠØ©
    window.runDraw = async (cid, title) => {
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid), where("isCorrect", "==", true)));
        if (snap.empty) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø© Ù„Ù„Ø³Ø­Ø¨ Ø¹Ù„ÙŠÙ‡Ø§!");
        
        const winners = snap.docs.map(d => ({id: d.data().userId, name: d.data().userName}));
        const lucky = winners[Math.floor(Math.random() * winners.length)];
        
        alert(`ğŸ‰ Ø§Ù„ÙØ§Ø¦Ø² ÙÙŠ Ù…Ø³Ø§Ø¨Ù‚Ø© (${title}) Ù‡Ùˆ: ${lucky.name}`);
        showUserInfo(lucky.id);
    };

    // 6. ØªØµØ¯ÙŠØ± Excel
    window.exportExcel = async (cid, title) => {
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid)));
        if (snap.empty) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");

        const data = snap.docs.map(d => {
            const a = d.data();
            return {
                "Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ": a.userName,
                "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„": a.userPhone,
                "Ø§Ù„Ù†ØªÙŠØ¬Ø©": a.isCorrect ? "ØµØ­ÙŠØ­Ø©" : "Ø®Ø§Ø·Ø¦Ø©",
                "Ø§Ù„Ù†Ù‚Ø§Ø·": a.pointsAwarded,
                "Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„": a.questionText
            };
        });

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
        XLSX.writeFile(wb, `Ù†ØªØ§Ø¦Ø¬_${title}.xlsx`);
    };

    window.deleteComp = async (id) => {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) await deleteDoc(doc(db, "Competitions", id));
    };
</script>
</body>
</html>
