<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ù‡Ø¨ÙŠØ© | Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
--primary:#007AFF;
--success:#34C759;
--danger:#FF3B30;
--gold:#FF9500;
--bg:#F2F2F7;
--card:#ffffff;
}
body{
margin:0;
padding:20px;
background:var(--bg);
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
direction:rtl;
color:#1c1c1e;
}
.container{max-width:1100px;margin:auto;}
h1{text-align:center;font-size:28px;font-weight:800;margin-bottom:35px;}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:30px;}
.card{
background:var(--card);
border-radius:22px;
padding:22px;
box-shadow:0 15px 35px rgba(0,0,0,0.05);
border:1px solid rgba(0,0,0,0.04);
transition:.3s;
margin-bottom:20px;
}
.card:hover{transform:translateY(-4px);box-shadow:0 20px 45px rgba(0,0,0,0.08);}
.card h2{margin:0 0 18px 0;font-size:18px;display:flex;align-items:center;gap:8px;}
input,select,textarea{
width:100%;padding:13px;border-radius:14px;border:1px solid #E5E5EA;
background:#F9F9FB;font-size:14px;margin-bottom:12px;outline:none;
}
input:focus,textarea:focus{border-color:var(--primary);background:#fff;}
.btn{
padding:12px;border:none;border-radius:14px;cursor:pointer;
font-weight:600;transition:.2s;display:flex;justify-content:center;align-items:center;gap:6px;
}
.btn-main{background:var(--primary);color:#fff;}
.btn-draw{background:linear-gradient(135deg,#FF9500,#FFCC00);color:#fff;}
.btn-ghost{background:#F2F2F7;}
.btn-danger{background:var(--danger);color:#fff;}
.btn:active{transform:scale(.96);}
.comp-header{display:flex;justify-content:space-between;align-items:flex-start;}
.menu-dots{font-size:22px;cursor:pointer;padding:5px 10px;}
.dropdown{display:none;position:absolute;background:#fff;border-radius:14px;
box-shadow:0 10px 25px rgba(0,0,0,.15);overflow:hidden;z-index:999;}
.dropdown div{padding:12px 18px;font-size:13px;cursor:pointer;border-bottom:1px solid #eee;}
.dropdown div:hover{background:#F2F2F7;}
.dropdown div:last-child{border:none;color:var(--danger);}
table{width:100%;border-collapse:collapse;margin-top:12px;}
th{font-size:12px;background:#F9F9FB;padding:10px;color:#8E8E93;}
td{padding:12px;border-bottom:1px solid #F2F2F7;font-size:14px;}
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);
backdrop-filter:blur(10px);justify-content:center;align-items:center;z-index:9999;}
.modal-body{background:#fff;width:95%;max-width:600px;border-radius:28px;padding:28px;max-height:90vh;overflow:auto;}
.option-box{display:flex;align-items:center;gap:10px;background:#F2F2F7;
padding:10px;border-radius:12px;margin-bottom:10px;}
.option-box input[type="checkbox"]{width:22px;height:22px;accent-color:var(--success);}
.winner-row{animation:fadeUp .6s forwards;opacity:0;transform:translateY(20px);}
@keyframes fadeUp{to{opacity:1;transform:translateY(0);}}
.big-winner{
font-size:30px;
font-weight:900;
color:#FF9500;
margin-bottom:20px;
animation:pop 1s ease;
}
@keyframes pop{
0%{transform:scale(.5);opacity:0;}
100%{transform:scale(1);opacity:1;}
}
</style>
</head>

<body>

<audio id="winSound">
<source src="https://actions.google.com/sounds/v1/crowd/large_crowd_cheer.ogg">
</audio>

<div class="container">
<h1>ğŸ‘‘ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠØ©</h1>

<div class="grid">

<div class="card">
<h2>ğŸ†• Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
<input type="text" id="compTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<label style="font-size:12px;color:#8E8E93">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input type="datetime-local" id="compEndDate">
<button class="btn btn-ghost" onclick="publishNow()">âš¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù†</button>
<br>
<button class="btn btn-main" onclick="createNewCompetition()">Ø­ÙØ¸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<div class="card" style="border:2px solid var(--gold);background:#FFFDF8">
<h2>ğŸ² Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°Ù‡Ø¨ÙŠ</h2>
<select id="drawCompSelect"></select>
<select id="drawMode">
<option value="random">ğŸ² Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
<option value="points">ğŸ¥‡ Ø£Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·</option>
</select>
<input type="number" id="winnersCount" value="1" min="1">
<button class="btn btn-draw" onclick="runAdvancedDraw()">ğŸ”¥ Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨</button>
</div>

</div>

<div id="resultsSections"></div>

<div class="card">
<h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª</h2>
<div id="historyList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

</div>

<div id="qModal" class="modal">
<div class="modal-body">
<h3>â“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
<input type="hidden" id="activeCid">
<textarea id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>
<input type="text" id="qImage" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„">
<input type="number" id="qPoints" value="10" placeholder="Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ø¤Ø§Ù„">
<div id="optionsList"></div>
<button class="btn btn-ghost" onclick="addOptionField()">+ Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±</button>
<br><br>
<button class="btn btn-main" onclick="saveQuestion()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
<br><br>
<button class="btn btn-ghost" onclick="closeModal('qModal')">Ø¥ØºÙ„Ø§Ù‚</button>
<div id="currentQs" style="margin-top:20px;border-top:1px solid #eee;padding-top:15px;"></div>
</div>
</div>

<div id="drawModal" class="modal">
<div class="modal-body" style="text-align:center">
<h2 id="drawStatus">â³ Ø§Ø³ØªØ¹Ø¯ÙˆØ§...</h2>
<div id="winnersTableContainer"></div>
<button class="btn btn-main" onclick="closeModal('drawModal')">ØªÙ…</button>
</div>
</div>

<script type="module">
import { db } from './config.js';
import { collection, addDoc, onSnapshot, getDocs, query, where, doc, deleteDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

window.publishNow=()=>{
const now=new Date();
now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
compEndDate.value=now.toISOString().slice(0,16);
};

window.createNewCompetition=async()=>{
if(!compTitle.value)return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
await addDoc(collection(db,"Competitions"),{
title:compTitle.value,
endDate:compEndDate.value,
createdAt:serverTimestamp()
});
compTitle.value="";
};

onSnapshot(query(collection(db,"Competitions"),orderBy("createdAt","desc")),(snap)=>{
resultsSections.innerHTML="";
drawCompSelect.innerHTML="";
snap.forEach(d=>{
const comp=d.data();
const cid=d.id;
drawCompSelect.innerHTML+=`<option value="${cid}">${comp.title}</option>`;
resultsSections.innerHTML+=`
<div class="card">
<div class="comp-header">
<div>
<h3>${comp.title}</h3>
<small>Ù…ÙˆØ¹Ø¯: ${comp.endDate||"ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</small>
</div>
<div style="position:relative">
<span class="menu-dots" onclick="toggleMenu('${cid}')">â‹®</span>
<div id="menu-${cid}" class="dropdown">
<div onclick="openQManager('${cid}')">â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</div>
<div onclick="deleteComp('${cid}')">ğŸ—‘ï¸ Ø­Ø°Ù</div>
</div>
</div>
</div>
<table id="table-${cid}">
<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody><tr><td colspan="4">ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
</table>
</div>
`;
loadAnswers(cid);
});
});

window.runAdvancedDraw=async()=>{
const cid=drawCompSelect.value;
const count=parseInt(winnersCount.value);
const mode=drawMode.value;
if(!cid)return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©");
drawModal.style.display="flex";
drawStatus.innerText="3";
let c=3;
const interval=setInterval(()=>{
c--;
drawStatus.innerText=c;
if(c===0){clearInterval(interval);start();}
},1000);

async function start(){
drawStatus.innerText="ğŸ° Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¯ÙˆÙŠØ±...";
const snap=await getDocs(query(collection(db,"Answers"),where("compId","==",cid),where("isCorrect","==",true)));
let candidates=snap.docs.map(d=>({
uid:d.data().userId,
name:d.data().userName,
phone:d.data().userPhone,
points:d.data().pointsAwarded||0
}));
candidates=[...new Map(candidates.map(i=>[i.uid,i])).values()];
if(mode==="points")candidates.sort((a,b)=>b.points-a.points);
let winners=(mode==="random")?candidates.sort(()=>0.5-Math.random()).slice(0,count):candidates.slice(0,count);
announce(winners);
await addDoc(collection(db,"WinnersHistory"),{compId:cid,winners,createdAt:serverTimestamp()});
}
};

function announce(winners){
drawStatus.innerHTML=`<div class="big-winner">ğŸ† ${winners[0].name}</div>`;
confetti({particleCount:200,spread:100});
document.getElementById("winSound").play();
let html=`<table><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th></tr></thead><tbody>`;
winners.forEach((w,i)=>{
html+=`<tr class="winner-row" style="animation-delay:${i*.4}s">
<td>${i+1}</td><td>${w.name}</td><td>${w.phone}</td>
</tr>`;
});
html+="</tbody></table>";
winnersTableContainer.innerHTML+=html;
}

window.toggleMenu=(id)=>{
const m=document.getElementById("menu-"+id);
m.style.display=m.style.display==="block"?"none":"block";
};

window.deleteComp=async(id)=>{
if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ"))
await deleteDoc(doc(db,"Competitions",id));
};

async function loadAnswers(cid){
const snap=await getDocs(query(collection(db,"Answers"),where("compId","==",cid)));
const tbody=document.querySelector(`#table-${cid} tbody`);
tbody.innerHTML="";
snap.forEach(d=>{
const a=d.data();
tbody.innerHTML+=`<tr>
<td>${a.userName}</td>
<td>${a.userPhone}</td>
<td>${a.isCorrect?'âœ…':'âŒ'}</td>
<td>${a.pointsAwarded||0}</td>
</tr>`;
});
}

window.closeModal=(id)=>document.getElementById(id).style.display="none";
</script>

</body>
</html>
