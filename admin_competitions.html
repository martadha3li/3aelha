<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px;}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05);}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px;border-bottom:1px solid #eee;text-align:right;}
.badge{padding:6px 10px;border-radius:10px;font-size:12px;color:#fff;cursor:pointer;}
.primary{background:#007AFF;}
.success{background:#34C759;}
.danger{background:#FF3B30;}
</style>
</head>
<body>

<h2>ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>

<div class="card">
<h3>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…</h3>
<table>
<thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody id="leaderboardBody"></tbody>
</table>
</div>

<div class="card">
<h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
<div id="statsBox"></div>
</div>

<div class="card">
<h3>ğŸ“‹ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
<th>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</th>
<th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
<th>Ø¥Ø¬Ø§Ø¨ØªÙ‡</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
</tr>
</thead>
<tbody id="resultsBody"></tbody>
</table>
</div>

<script type="module">
import { db } from './config.js';
import { collection, onSnapshot, query, orderBy, where, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

function calculateLevel(points){
 if(points>=300) return "ğŸ¥‡ Gold";
 if(points>=100) return "ğŸ¥ˆ Silver";
 return "ğŸ¥‰ Bronze";
}

onSnapshot(collection(db,"Answers"), snap=>{

 let scores={};
 let total=0;
 let correct=0;

 const body=document.getElementById("resultsBody");
 body.innerHTML="";

 snap.forEach(doc=>{
   const a=doc.data();

   total++;
   if(a.isCorrect) correct++;

   if(!scores[a.userName]) scores[a.userName]=0;
   scores[a.userName]+=a.pointsAwarded||0;

   const time=a.timestamp?.toDate()?.toLocaleString('ar-EG')||"";

   body.innerHTML+=`
   <tr>
   <td>${a.userName}</td>
   <td>${a.userPhone||"-"}</td>
   <td>${a.compTitle}</td>
   <td>${a.questionText}</td>
   <td>${a.selectedOption}</td>
   <td style="color:${a.isCorrect?'green':'red'}">${a.isCorrect?'âœ”':'âœ–'}</td>
   <td>${a.pointsAwarded}</td>
   <td>${time}</td>
   </tr>`;
 });

 // Leaderboard
 const sorted=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
 const lb=document.getElementById("leaderboardBody");
 lb.innerHTML="";
 sorted.forEach((row,i)=>{
   lb.innerHTML+=`
   <tr>
   <td>${i+1}</td>
   <td>${row[0]}</td>
   <td>${row[1]} ${calculateLevel(row[1])}</td>
   </tr>`;
 });

 // Stats
 document.getElementById("statsBox").innerHTML=`
 Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª: ${total}<br>
 Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correct}<br>
 Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯Ù‚Ø©: ${total?((correct/total)*100).toFixed(1):0}%`;

});
</script>
</body>
</html>
