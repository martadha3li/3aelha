<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}
.stat{background:#111;color:#fff;padding:15px;border-radius:15px;text-align:center}
button{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;margin:3px}
.primary{background:#007AFF;color:#fff}
.success{background:#34C759;color:#fff}
.danger{background:#FF3B30;color:#fff}
.warning{background:#FF9500;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #eee;font-size:12px;text-align:right}
.progress{height:8px;background:#eee;border-radius:10px;overflow:hidden}
.progress div{height:100%;background:#34C759}
.accordion{cursor:pointer;padding:10px;background:#f5f5f5;border-radius:10px;margin-top:10px}
.panel{display:none;padding:10px}
.slot{height:80px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;border-radius:20px;margin-top:10px}
</style>
</head>
<body>

<h2>ğŸš€ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h2>

<!-- DASHBOARD -->
<div class="card">
<h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
<div class="grid" id="dashboardStats"></div>
</div>

<!-- ADD COMP -->
<div class="card">
<h3>â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
<input type="text" id="newTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<input type="datetime-local" id="newEnd">
<button class="primary" onclick="createCompetition()">Ø¥Ù†Ø´Ø§Ø¡</button>
</div>

<!-- COMPETITIONS -->
<div class="card">
<h3>ğŸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h3>
<div id="competitionsContainer"></div>
</div>

<!-- DRAW -->
<div class="card">
<h3>ğŸ° Ù‚Ø±Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h3>
<select id="drawComp"></select>
<select id="drawFilter">
<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</option>
<option value="correct">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·</option>
</select>
<input type="number" id="drawCount" value="1">
<button class="primary" onclick="startDraw()">Ø§Ø¨Ø¯Ø£</button>
<div id="slot" class="slot">---</div>
<div id="drawResult"></div>
</div>

<script type="module">
import { db } from './config.js';
import { collection,getDocs,addDoc,onSnapshot,query,where,updateDoc,doc,deleteDoc,serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let globalAnswers=[];

/* ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
onSnapshot(collection(db,"Answers"),snap=>{
 globalAnswers=snap.docs.map(d=>d.data());
 updateDashboard();
});

/* DASHBOARD */
function updateDashboard(){
 const totalComp = document.querySelectorAll('.accordion').length;
 const totalAnswers = globalAnswers.length;
 const totalUsers = new Set(globalAnswers.map(a=>a.userName)).size;
 const correctCount = globalAnswers.filter(a=>a.isCorrect).length;
 const percent = totalAnswers?Math.round((correctCount/totalAnswers)*100):0;

 document.getElementById("dashboardStats").innerHTML=`
 <div class="stat">ğŸ<br>${totalComp}<br>Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
 <div class="stat">ğŸ‘¥<br>${totalUsers}<br>Ù…Ø´Ø§Ø±Ùƒ</div>
 <div class="stat">ğŸ“<br>${totalAnswers}<br>Ø¥Ø¬Ø§Ø¨Ø©</div>
 <div class="stat">âœ…<br>${percent}%<br>ØµØ­ÙŠØ­Ø©</div>
 `;
}

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.createCompetition=async()=>{
 const title=document.getElementById("newTitle").value;
 const end=document.getElementById("newEnd").value;
 if(!title) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");

 await addDoc(collection(db,"Competitions"),{
   title,
   endDate:end||"",
   visible:true,
   createdAt:serverTimestamp()
 });
};

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª */
onSnapshot(collection(db,"Competitions"),async snap=>{
 const container=document.getElementById("competitionsContainer");
 const draw=document.getElementById("drawComp");
 container.innerHTML="";
 draw.innerHTML="";

 for(const d of snap.docs){
  const c=d.data();
  const compId=d.id;

  draw.innerHTML+=`<option value="${compId}">${c.title}</option>`;

  const qSnap=await getDocs(collection(db,`Competitions/${compId}/Questions`));
  const qCount=qSnap.size;

  const compAnswers=globalAnswers.filter(a=>a.compId==compId);
  const users=new Set(compAnswers.map(a=>a.userName)).size;
  const correct=compAnswers.filter(a=>a.isCorrect).length;
  const percent=compAnswers.length?Math.round((correct/compAnswers.length)*100):0;

  container.innerHTML+=`
  <div class="accordion" onclick="togglePanel('${compId}')">
  ğŸ ${c.title} (${users} Ù…Ø´Ø§Ø±Ùƒ)
  </div>
  <div class="panel" id="panel-${compId}">
   <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${qCount}</p>
   <p>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†: ${users}</p>
   <div class="progress"><div style="width:${percent}%"></div></div>
   <p>${percent}% Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</p>
   <button class="warning" onclick="closeCompetition('${compId}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
   <button class="danger" onclick="deleteCompetition('${compId}')">Ø­Ø°Ù</button>
   <button class="success" onclick="duplicateCompetition('${compId}')">Ù†Ø³Ø®</button>
  </div>
  `;
 }

 updateDashboard();
});

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Accordion */
window.togglePanel=id=>{
 const panel=document.getElementById("panel-"+id);
 panel.style.display=panel.style.display==="block"?"none":"block";
};

/* Ø¥Ù†Ù‡Ø§Ø¡ */
window.closeCompetition=async(id)=>{
 await updateDoc(doc(db,"Competitions",id),{visible:false});
};

/* Ø­Ø°Ù */
window.deleteCompetition=async(id)=>{
 if(confirm("Ø­Ø°ÙØŸ"))
 await deleteDoc(doc(db,"Competitions",id));
};

/* Ù†Ø³Ø® Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.duplicateCompetition=async(id)=>{
 const comp=await getDocs(query(collection(db,"Competitions"),where("__name__","==",id)));
 comp.forEach(async d=>{
  const newComp=await addDoc(collection(db,"Competitions"),{
   ...d.data(),
   title:d.data().title+" (Ù†Ø³Ø®Ø©)",
   createdAt:serverTimestamp()
  });

  const qs=await getDocs(collection(db,`Competitions/${id}/Questions`));
  qs.forEach(async q=>{
   await addDoc(collection(db,`Competitions/${newComp.id}/Questions`),q.data());
  });
 });
};

/* Ù‚Ø±Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
window.startDraw=async()=>{
 const compId=document.getElementById("drawComp").value;
 const filter=document.getElementById("drawFilter").value;
 const count=parseInt(document.getElementById("drawCount").value)||1;

 let names=globalAnswers
  .filter(a=>a.compId==compId)
  .filter(a=>filter==="correct"?a.isCorrect:true)
  .map(a=>a.userName);

 names=[...new Set(names)];
 if(names.length==0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ†");

 const slot=document.getElementById("slot");
 const result=document.getElementById("drawResult");
 result.innerHTML="";

 let spin=setInterval(()=>{
  slot.innerText=names[Math.floor(Math.random()*names.length)];
 },100);

 setTimeout(async()=>{
  clearInterval(spin);
  const winners=names.sort(()=>0.5-Math.random()).slice(0,count);
  slot.innerText="ğŸ‰ Ø§Ù†ØªÙ‡Øª";
  result.innerHTML="<b>"+winners.join("<br>")+"</b>";

  await addDoc(collection(db,"Winners"),{
   compId,
   winners,
   createdAt:serverTimestamp()
  });

 },3000);
};

</script>
</body>
</html>
