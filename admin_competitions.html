<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px}
.stat{background:#111;color:#fff;padding:15px;border-radius:15px;text-align:center}
button{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;margin:3px}
.primary{background:#007AFF;color:#fff}
.success{background:#34C759;color:#fff}
.danger{background:#FF3B30;color:#fff}
.warning{background:#FF9500;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #eee;font-size:12px;text-align:right}
.progress{height:8px;background:#eee;border-radius:10px;overflow:hidden}
.progress div{height:100%;background:#34C759}
.accordion{cursor:pointer;padding:15px;background:#f5f5f5;border-radius:15px;margin-top:10px;font-weight:bold;border:1px solid #e5e5ea}
.panel{display:none;padding:15px;background:#fff;border:1px solid #eee;border-radius:0 0 15px 15px;border-top:none}
.slot{height:80px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;border-radius:20px;margin-top:10px}

/* Ø¥Ø¶Ø§ÙØ§Øª Ø£Ø¯ÙˆØ§Øª ØªØ­Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
.q-box{background:#f9f9f9;padding:15px;border-radius:15px;margin-top:10px;border:1px dashed #ccc}
.q-input{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box}
.opt-row{display:flex;align-items:center;gap:10px;margin-bottom:5px}
.q-list-item{display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;margin-top:5px;border-radius:8px;border:1px solid #eee;font-size:13px}
</style>
</head>
<body>

<h2>ğŸš€ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h2>

<div class="card">
<h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
<div class="grid" id="dashboardStats"></div>
</div>

<div class="card">
<h3>â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
<input type="text" id="newTitle" class="q-input" style="width:70%" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<input type="datetime-local" id="newEnd" class="q-input" style="width:25%">
<button class="primary" onclick="createCompetition()" style="width:100%;padding:12px">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<div class="card">
<h3>ğŸ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
<div id="competitionsContainer"></div>
</div>

<div class="card">
<h3>ğŸ° Ù‚Ø±Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h3>
<select id="drawComp" class="q-input"></select>
<select id="drawFilter" class="q-input">
<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</option>
<option value="correct">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© ÙÙ‚Ø·</option>
</select>
<input type="number" id="drawCount" class="q-input" value="1">
<button class="primary" onclick="startDraw()" style="width:100%;padding:12px">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø¹Ø©</button>
<div id="slot" class="slot">---</div>
<div id="drawResult"></div>
</div>

<script type="module">
import { db } from './config.js';
import { collection,getDocs,addDoc,onSnapshot,query,where,updateDoc,doc,deleteDoc,serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let globalAnswers=[];

/* ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
onSnapshot(collection(db,"Answers"),snap=>{
 globalAnswers=snap.docs.map(d=>d.data());
 updateDashboard();
});

/* DASHBOARD */
function updateDashboard(){
 const totalComp = document.querySelectorAll('.accordion').length;
 const totalAnswers = globalAnswers.length;
 const totalUsers = new Set(globalAnswers.map(a=>a.userName)).size;
 const correctCount = globalAnswers.filter(a=>a.isCorrect).length;
 const percent = totalAnswers?Math.round((correctCount/totalAnswers)*100):0;

 document.getElementById("dashboardStats").innerHTML=`
 <div class="stat">ğŸ<br>${totalComp}<br>Ù…Ø³Ø§Ø¨Ù‚Ø©</div>
 <div class="stat">ğŸ‘¥<br>${totalUsers}<br>Ù…Ø´Ø§Ø±Ùƒ</div>
 <div class="stat">ğŸ“<br>${totalAnswers}<br>Ø¥Ø¬Ø§Ø¨Ø©</div>
 <div class="stat">âœ…<br>${percent}%<br>ØµØ­ÙŠØ­Ø©</div>
 `;
}

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.createCompetition=async()=>{
 const title=document.getElementById("newTitle").value;
 const end=document.getElementById("newEnd").value;
 if(!title) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");

 await addDoc(collection(db,"Competitions"),{
   title,
   endDate:end||"",
   visible:true,
   createdAt:serverTimestamp()
 });
 document.getElementById("newTitle").value="";
};

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª */
onSnapshot(collection(db,"Competitions"),async snap=>{
 const container=document.getElementById("competitionsContainer");
 const draw=document.getElementById("drawComp");
 container.innerHTML="";
 draw.innerHTML="";

 for(const d of snap.docs){
  const c=d.data();
  const compId=d.id;

  draw.innerHTML+=`<option value="${compId}">${c.title}</option>`;

  const qSnap=await getDocs(collection(db,`Competitions/${compId}/Questions`));
  const qCount=qSnap.size;

  const compAnswers=globalAnswers.filter(a=>a.compId==compId);
  const users=new Set(compAnswers.map(a=>a.userName)).size;
  const correct=compAnswers.filter(a=>a.isCorrect).length;
  const percent=compAnswers.length?Math.round((correct/compAnswers.length)*100):0;

  container.innerHTML+=`
  <div class="accordion" onclick="togglePanel('${compId}')">
  ğŸ ${c.title} (${users} Ù…Ø´Ø§Ø±Ùƒ)
  </div>
  <div class="panel" id="panel-${compId}">
    <div style="display:flex; justify-content:space-between; align-items:center">
       <div>
         <p>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${qCount} Ø³Ø¤Ø§Ù„ | ${users} Ù…Ø´Ø§Ø±Ùƒ | ${percent}% Ù†Ø¬Ø§Ø­</p>
         <div class="progress" style="width:200px"><div style="width:${percent}%"></div></div>
       </div>
       <div>
         <button class="warning" onclick="closeCompetition('${compId}')">Ø¥Ù†Ù‡Ø§Ø¡</button>
         <button class="danger" onclick="deleteCompetition('${compId}')">Ø­Ø°Ù</button>
         <button class="success" onclick="duplicateCompetition('${compId}')">Ù†Ø³Ø®</button>
       </div>
    </div>

    <div class="q-box">
      <h4>â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h4>
      <input type="text" id="qText-${compId}" class="q-input" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
      <div class="opt-row"><input type="radio" name="correct-${compId}" value="0" checked> <input type="text" id="opt-${compId}-0" class="q-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„ (Ø§Ù„ØµØ­ÙŠØ­ Ù…Ø«Ù„Ø§Ù‹)"></div>
      <div class="opt-row"><input type="radio" name="correct-${compId}" value="1"> <input type="text" id="opt-${compId}-1" class="q-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ"></div>
      <div class="opt-row"><input type="radio" name="correct-${compId}" value="2"> <input type="text" id="opt-${compId}-2" class="q-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«"></div>
      <div class="opt-row"><input type="radio" name="correct-${compId}" value="3"> <input type="text" id="opt-${compId}-3" class="q-input" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø±Ø§Ø¨Ø¹"></div>
      <button class="primary" onclick="addQuestion('${compId}')" style="width:100%">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
      
      <div id="qList-${compId}" style="margin-top:15px">
        <h5>Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h5>
        </div>
    </div>
  </div>
  `;
  loadQuestions(compId);
 }
 updateDashboard();
});

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„ÙƒÙ„ Ù…Ø³Ø§Ø¨Ù‚Ø© */
async function loadQuestions(compId) {
    const qList = document.getElementById(`qList-${compId}`);
    const qSnap = await getDocs(collection(db, `Competitions/${compId}/Questions`));
    let html = "";
    qSnap.forEach(docSnap => {
        const q = docSnap.data();
        html += `
        <div class="q-list-item">
            <span>â“ ${q.question}</span>
            <button class="danger" style="padding:2px 5px; font-size:10px" onclick="deleteQuestion('${compId}','${docSnap.id}')">Ø­Ø°Ù</button>
        </div>`;
    });
    qList.innerHTML = html || "<small>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…Ø¶Ø§ÙØ©</small>";
}

/* Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ */
window.addQuestion = async (compId) => {
    const question = document.getElementById(`qText-${compId}`).value;
    const options = [
        document.getElementById(`opt-${compId}-0`).value,
        document.getElementById(`opt-${compId}-1`).value,
        document.getElementById(`opt-${compId}-2`).value,
        document.getElementById(`opt-${compId}-3`).value
    ];
    const correctIdx = document.querySelector(`input[name="correct-${compId}"]:checked`).value;

    if(!question || options[0]=="") return alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª");

    await addDoc(collection(db, `Competitions/${compId}/Questions`), {
        question,
        options,
        correctIndex: parseInt(correctIdx),
        createdAt: serverTimestamp()
    });

    alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­");
    // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById(`qText-${compId}`).value = "";
    loadQuestions(compId);
};

/* Ø­Ø°Ù Ø³Ø¤Ø§Ù„ */
window.deleteQuestion = async (compId, qId) => {
    if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) {
        await deleteDoc(doc(db, `Competitions/${compId}/Questions`, qId));
        loadQuestions(compId);
    }
};

/* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Accordion */
window.togglePanel=id=>{
 const panel=document.getElementById("panel-"+id);
 const allPanels = document.querySelectorAll('.panel');
 // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù‚ÙŠØ© Ù„ÙØªØ­ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
 // allPanels.forEach(p => { if(p.id !== "panel-"+id) p.style.display="none" });
 panel.style.display=panel.style.display==="block"?"none":"block";
};

/* Ø¥Ù†Ù‡Ø§Ø¡ */
window.closeCompetition=async(id)=>{
 await updateDoc(doc(db,"Competitions",id),{visible:false});
 alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ÙˆØ¥Ø®ÙØ§Ø¤Ù‡Ø§");
};

/* Ø­Ø°Ù Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.deleteCompetition=async(id)=>{
 if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ"))
 await deleteDoc(doc(db,"Competitions",id));
};

/* Ù†Ø³Ø® Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.duplicateCompetition=async(id)=>{
 const q = query(collection(db,"Competitions"),where("__name__","==",id));
 const compSnap = await getDocs(q);
 
 compSnap.forEach(async d=>{
  const newComp=await addDoc(collection(db,"Competitions"),{
    ...d.data(),
    title:d.data().title+" (Ù†Ø³Ø®Ø©)",
    createdAt:serverTimestamp()
  });

  const qs=await getDocs(collection(db,`Competitions/${id}/Questions`));
  qs.forEach(async qDoc=>{
    await addDoc(collection(db,`Competitions/${newComp.id}/Questions`), qDoc.data());
  });
  alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø£Ø³Ø¦Ù„ØªÙ‡Ø§");
 });
};

/* Ù‚Ø±Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© */
window.startDraw=async()=>{
 const compId=document.getElementById("drawComp").value;
 const filter=document.getElementById("drawFilter").value;
 const count=parseInt(document.getElementById("drawCount").value)||1;

 let names=globalAnswers
  .filter(a=>a.compId==compId)
  .filter(a=>filter==="correct"?a.isCorrect:true)
  .map(a=>a.userName);

 names=[...new Set(names)];
 if(names.length==0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙŠØ­Ù‚Ù‚ÙˆÙ† Ø§Ù„Ø´Ø±ÙˆØ·");

 const slot=document.getElementById("slot");
 const result=document.getElementById("drawResult");
 result.innerHTML="";

 let spin=setInterval(()=>{
  slot.innerText=names[Math.floor(Math.random()*names.length)];
 },100);

 setTimeout(async()=>{
  clearInterval(spin);
  const winners=names.sort(()=>0.5-Math.random()).slice(0,count);
  slot.innerText="ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ø±Ø¹Ø©";
  result.innerHTML="<div style='background:#f2f2f7;padding:15px;border-radius:15px;margin-top:10px;text-align:center'><b>Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ†:<br>"+winners.join("<br>")+"</b></div>";

  await addDoc(collection(db,"Winners"),{
    compId,
    winners,
    createdAt:serverTimestamp()
  });

 },3000);
};

</script>
</body>
</html>
