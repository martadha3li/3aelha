<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:10px;border:1px solid #ddd}
button{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;margin:3px}
.primary{background:#007AFF;color:#fff}
.success{background:#34C759;color:#fff}
.danger{background:#FF3B30;color:#fff}
.warning{background:#FF9500;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #eee;font-size:12px;text-align:right}
.progress{height:6px;background:#eee;border-radius:10px;overflow:hidden;margin-top:5px}
.progress div{height:100%;background:#34C759}
.badge{padding:4px 8px;border-radius:8px;font-size:12px;color:#fff;cursor:pointer}
.slot{height:80px;background:#111;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;border-radius:20px;margin-top:10px}
</style>
</head>
<body>

<h2>ğŸš€ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>
<div> <a href=news.html> Ø¹ÙˆØ¯Ø© </a></div>
<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© -->
<div class="card">
<h3>â• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
<input type="text" id="newTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input type="datetime-local" id="newEnd">
<button class="primary" onclick="createCompetition()">Ø¥Ù†Ø´Ø§Ø¡</button>
</div>

<!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª -->
<div id="competitionsContainer"></div>

<!-- Ù‚Ø±Ø¹Ø© -->
<div class="card">
<h3>ğŸ° Ø§Ù„Ù‚Ø±Ø¹Ø©</h3>
<select id="drawComp"></select>
<select id="drawFilter">
<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†</option>
<option value="correct">Ø§Ù„ØµØ­ÙŠØ­ ÙÙ‚Ø·</option>
</select>
<input type="number" id="drawCount" value="1">
<button class="primary" onclick="startDraw()">Ø§Ø¨Ø¯Ø£</button>
<div id="slot" class="slot">---</div>
<div id="drawResult"></div>
</div>

<script type="module">
import { db } from './config.js';
import {
collection,getDocs,addDoc,onSnapshot,
query,where,updateDoc,doc,
deleteDoc,serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let globalAnswers=[];

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
onSnapshot(collection(db,"Answers"),snap=>{
 globalAnswers=snap.docs.map(d=>d.data());
});

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.createCompetition=async()=>{
 const title=document.getElementById("newTitle").value;
 const end=document.getElementById("newEnd").value;
 if(!title) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");

 await addDoc(collection(db,"Competitions"),{
  title,
  endDate:end||"",
  visible:true,
  createdAt:serverTimestamp()
 });
};

/* Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª + Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
onSnapshot(collection(db,"Competitions"),async snap=>{
 const container=document.getElementById("competitionsContainer");
 const draw=document.getElementById("drawComp");
 container.innerHTML="";
 draw.innerHTML="";

 for(const comp of snap.docs){
  const compId=comp.id;
  const c=comp.data();

  draw.innerHTML+=`<option value="${compId}">${c.title}</option>`;

  const qSnap=await getDocs(collection(db,`Competitions/${compId}/Questions`));
  let questionsHTML="";

  for(const q of qSnap.docs){
   const qData=q.data();

   const answersForQ=globalAnswers.filter(a=>a.questionText===qData.text && a.compId===compId);
   const correctCount=answersForQ.filter(a=>a.isCorrect).length;
   const percent=answersForQ.length?Math.round((correctCount/answersForQ.length)*100):0;

   questionsHTML+=`
   <div class="card" style="margin-top:10px;border-left:5px solid #007AFF">
     <b>â“ ${qData.text}</b>
     <div style="font-size:12px">
       Ø§Ù„Ù†Ù‚Ø§Ø·: ${qData.points||10}
     </div>
     <div>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ${qData.options.join(" | ")}</div>
     <div style="color:green">Ø§Ù„ØµØ­ÙŠØ­Ø©: ${qData.correctOption}</div>

     <div>Ø¥Ø¬Ø§Ø¨Ø§Øª: ${answersForQ.length} | ØµØ­ÙŠØ­Ø©: ${correctCount}</div>
     <div class="progress"><div style="width:${percent}%"></div></div>

     <button onclick="editQuestion('${compId}','${q.id}')">âœ ØªØ¹Ø¯ÙŠÙ„</button>
     <button onclick="deleteQuestion('${compId}','${q.id}')">ğŸ—‘ Ø­Ø°Ù</button>
   </div>
   `;
  }

  container.innerHTML+=`
  <div class="card">
    <h3>ğŸ ${c.title}</h3>
    <div>
      Ø§Ù„Ø­Ø§Ù„Ø©: ${c.visible!==false?'ğŸŸ¢ Ù…ÙØªÙˆØ­Ø©':'ğŸ”´ Ù…ØºÙ„Ù‚Ø©'}
      <br>Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡: ${c.endDate||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
    </div>

    <button onclick="toggleComp('${compId}',${c.visible!==false})">
      ${c.visible!==false?'Ø¥ØºÙ„Ø§Ù‚':'ÙØªØ­'}
    </button>

    <button onclick="addQuestionPrompt('${compId}')">â• Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
    <button class="danger" onclick="deleteCompetition('${compId}')">Ø­Ø°Ù</button>

    ${questionsHTML||"<i>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©</i>"}
  </div>
  `;
 }
});

/* Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ */
window.addQuestionPrompt=async(compId)=>{
 const text=prompt("Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„");
 const opt1=prompt("Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„");
 const opt2=prompt("Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ");
 const correct=prompt("Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©");

 await addDoc(collection(db,`Competitions/${compId}/Questions`),{
  text,
  options:[opt1,opt2],
  correctOption:correct,
  points:10,
  createdAt:serverTimestamp()
 });
};

/* ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¤Ø§Ù„ */
window.editQuestion=async(compId,qId)=>{
 const newText=prompt("Ù†Øµ Ø¬Ø¯ÙŠØ¯");
 const newCorrect=prompt("Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©");
 await updateDoc(doc(db,`Competitions/${compId}/Questions`,qId),{
  text:newText,
  correctOption:newCorrect
 });
};

/* Ø­Ø°Ù Ø³Ø¤Ø§Ù„ */
window.deleteQuestion=async(compId,qId)=>{
 if(confirm("Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ"))
  await deleteDoc(doc(db,`Competitions/${compId}/Questions`,qId));
};

/* Ø¥ØºÙ„Ø§Ù‚/ÙØªØ­ */
window.toggleComp=async(id,status)=>{
 await updateDoc(doc(db,"Competitions",id),{visible:!status});
};

/* Ø­Ø°Ù Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.deleteCompetition=async(id)=>{
 if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ"))
  await deleteDoc(doc(db,"Competitions",id));
};

/* Ù‚Ø±Ø¹Ø© */
window.startDraw=async()=>{
 const compId=document.getElementById("drawComp").value;
 const filter=document.getElementById("drawFilter").value;
 const count=parseInt(document.getElementById("drawCount").value)||1;

 let names=globalAnswers
  .filter(a=>a.compId==compId)
  .filter(a=>filter==="correct"?a.isCorrect:true)
  .map(a=>a.userName);

 names=[...new Set(names)];
 if(names.length==0) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ†");

 const slot=document.getElementById("slot");
 const result=document.getElementById("drawResult");
 result.innerHTML="";

 let spin=setInterval(()=>{
  slot.innerText=names[Math.floor(Math.random()*names.length)];
 },100);

 setTimeout(async()=>{
  clearInterval(spin);
  const winners=names.sort(()=>0.5-Math.random()).slice(0,count);
  slot.innerText="ğŸ‰ Ø§Ù†ØªÙ‡Øª";
  result.innerHTML="<b>"+winners.join("<br>")+"</b>";

  await addDoc(collection(db,"Winners"),{
   compId,
   winners,
   createdAt:serverTimestamp()
  });

 },3000);
};
</script>
</body>
</html>
