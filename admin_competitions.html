<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{font-family:Arial;background:#F2F2F7;padding:20px;direction:rtl}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.05)}
input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #ddd;margin-bottom:10px}
button{padding:10px 15px;border:none;border-radius:12px;cursor:pointer}
.btn-main{background:#007AFF;color:#fff}
.option-box{display:flex;gap:10px;margin-bottom:10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:8px;border-bottom:1px solid #eee}
</style>
</head>
<body>

<h2>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>

<div class="card">
<h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
<input type="text" id="compTitle" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<button class="btn-main" onclick="createNewCompetition()">Ø­ÙØ¸</button>
</div>

<div id="competitions"></div>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
<div id="qModal" style="display:none" class="card">
<h3>Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
<input type="hidden" id="activeCid">
<textarea id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„"></textarea>

<label>ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
<input type="file" id="qImageFile" accept="image/*">

<input type="number" id="qPoints" value="10">

<div id="optionsList"></div>
<button onclick="addOption()">+ Ø®ÙŠØ§Ø±</button>
<br><br>
<button class="btn-main" onclick="saveQuestion()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
<button onclick="closeQ()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script type="module">
import { db } from './config.js';
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
import { collection, addDoc, onSnapshot, getDocs, query, where, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const storage = getStorage();

window.createNewCompetition = async()=>{
if(!compTitle.value) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…");
await addDoc(collection(db,"Competitions"),{
title:compTitle.value,
createdAt:serverTimestamp()
});
compTitle.value="";
};

onSnapshot(collection(db,"Competitions"),snap=>{
competitions.innerHTML="";
snap.forEach(d=>{
const comp=d.data();
const cid=d.id;
competitions.innerHTML+=`
<div class="card">
<h3>${comp.title}</h3>
<button onclick="openQ('${cid}')">â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
<button onclick="deleteComp('${cid}')">ğŸ—‘ Ø­Ø°Ù</button>
<table id="table-${cid}">
<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody></tbody>
</table>
</div>
`;
loadAnswers(cid);
});
});

window.openQ=(cid)=>{
activeCid.value=cid;
optionsList.innerHTML="";
addOption();addOption();
qModal.style.display="block";
};

window.addOption=()=>{
optionsList.innerHTML+=`
<div class="option-box">
<input type="checkbox" class="opt-check">
<input type="text" class="opt-text" placeholder="Ø§Ù„Ø®ÙŠØ§Ø±">
</div>
`;
};

window.saveQuestion=async()=>{
const cid=activeCid.value;
const text=qText.value;
const pts=parseInt(qPoints.value);

let imageUrl="";

const file = qImageFile.files[0];
if(file){
const storageRef = ref(storage, "questions/"+Date.now()+"_"+file.name);
await uploadBytes(storageRef,file);
imageUrl = await getDownloadURL(storageRef);
}

let options=[];
let correct=-1;

document.querySelectorAll(".option-box").forEach((el,i)=>{
const txt=el.querySelector(".opt-text").value;
if(txt){
options.push(txt);
if(el.querySelector(".opt-check").checked) correct=i;
}
});

if(!text || correct===-1) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

await addDoc(collection(db,"Questions"),{
compId:cid,
text,
image:imageUrl,
points:pts,
options,
correctAnswer:correct,
createdAt:serverTimestamp()
});

alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„");
qModal.style.display="none";
};

async function loadAnswers(cid){
const snap=await getDocs(query(collection(db,"Answers"),where("compId","==",cid)));
const tbody=document.querySelector(`#table-${cid} tbody`);
tbody.innerHTML="";
snap.forEach(d=>{
const a=d.data();
tbody.innerHTML+=`
<tr>
<td>${a.userName}</td>
<td>${a.userPhone}</td>
<td>${a.isCorrect?'âœ…':'âŒ'}</td>
<td>${a.pointsAwarded||0}</td>
</tr>
`;
});
}

window.deleteComp=async(id)=>{
if(confirm("Ø­Ø°ÙØŸ"))
await deleteDoc(doc(db,"Competitions",id));
};

window.closeQ=()=>qModal.style.display="none";
</script>

</body>
</html>
