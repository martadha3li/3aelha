<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª | Ù…Ø³Ø­ Ø´Ø§Ù…Ù„</title>
    <style>
        :root { --primary: #5856d6; --success: #34c759; --danger: #ff3b30; --bg: #f2f2f7; --text: #1c1c1e; --gold: #ff9500; }
        
        body { 
            background-color: var(--bg); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 0; color: var(--text);
            line-height: 1.5;
        }

        .top-bar {
            background: white; padding: 15px; display: flex; align-items: center; 
            justify-content: space-between; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
        }

        .container { padding: 12px; max-width: 100%; box-sizing: border-box; }
        
        .card { 
            background: white; border-radius: 16px; padding: 16px; 
            margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); 
        }

        .card-title { 
            font-size: 16px; font-weight: 800; margin-bottom: 15px; 
            display: flex; align-items: center; gap: 8px; color: var(--primary);
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; font-size: 12px; margin-bottom: 5px; font-weight: bold; color: #666; }
        
        .form-input { 
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; 
            box-sizing: border-box; font-size: 14px; background: #fafafa;
        }

        .btn-main {
            background: var(--primary); color: white; border: none; padding: 14px;
            border-radius: 12px; width: 100%; font-weight: bold; font-size: 15px; cursor: pointer; transition: 0.3s;
        }

        .btn-danger { background: var(--danger); }
        .btn-outline-danger { 
            background: transparent; color: var(--danger); border: 1px solid var(--danger); 
            padding: 10px; margin-top: 15px; font-size: 13px;
        }

        .table-wrapper { 
            overflow-x: auto; background: #fff; border-radius: 12px; margin-top: 5px;
        }

        table { width: 100%; border-collapse: collapse; white-space: nowrap; font-size: 13px; }
        th { background: #f8f8fb; padding: 12px; text-align: right; color: #8e8e93; border-bottom: 1px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f2f2f7; }

        .badge { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: bold; color: white; border: none; }
        .bg-primary { background: var(--primary); } .bg-danger { background: var(--danger); } .bg-success { background: var(--success); }

        .comp-item { border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© */
        #drawOverlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.92);
            z-index: 5000; display: none; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center;
        }
        .slot-machine {
            font-size: 28px; font-weight: bold; color: var(--gold);
            height: 90px; overflow: hidden; display: flex; align-items: center;
            justify-content: center; border: 3px solid var(--gold);
            width: 85%; border-radius: 20px; margin: 25px 0; background: #222;
        }
        .winner-tag { background: var(--success); color: white; padding: 10px 20px; border-radius: 12px; margin: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="top-bar">
    <button onclick="location.href='admin.html'" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
    <b>Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</b>
    <div style="width:20px;"></div>
</div>

<div class="container">

    <div class="card" style="border: 2px solid var(--gold);">
        <div class="card-title" style="color: var(--gold);">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù‚Ø±Ø¹Ø©</div>
        
        <div class="form-group">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù‚Ø±Ø¹Ø© Ø£Ùˆ Ù…Ø³Ø­ Ù…Ø®ØµØµ:</label>
            <select id="drawCompSelect" class="form-input"></select>
        </div>
        
        <div class="grid-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button onclick="startDrawProcess()" class="btn-main" style="background: var(--gold);">Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø±Ø¹Ø© ğŸ²</button>
            <button onclick="clearCompetitionResults()" class="btn-main btn-danger" style="font-size: 12px;">Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© ğŸ—‘ï¸</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <div style="text-align: center;">
            <label style="font-size: 11px; color: var(--danger); font-weight: bold;">ğŸš¨ Ù…Ù†Ø·Ù‚Ø© Ø®Ø·Ø±</label>
            <button onclick="clearAllAnswersGlobal()" class="btn-main btn-danger" style="margin-top: 5px; width: 100%; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(255,59,48,0.3);">
                ğŸ”¥ Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª
            </button>
            <p style="font-size: 10px; color: #888; margin-top: 8px;">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠÙ‚ÙˆÙ… Ø¨ØªØµÙÙŠØ± Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙÙˆØ±Ø§Ù‹.</p>
        </div>
    </div>

    <div class="card">
        <div class="card-title">ğŸ†• Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
        <input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©..." class="form-input">
        <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©:</label>
            <input type="datetime-local" id="compEndDate" class="form-input">
        </div>
        <button onclick="createNewCompetition()" class="btn-main">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
    </div>

    <div class="card">
        <div class="card-title">ğŸ“Š Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</div>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th><th>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
    </div>
</div>

<div id="drawOverlay">
    <div id="drawInfo">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±...</div>
    <div id="slotBox" class="slot-machine">---</div>
    <div id="winnersDisplay"></div>
    <button id="closeDrawBtn" onclick="document.getElementById('drawOverlay').style.display='none'" style="display:none; margin-top:20px; padding:10px 20px; border-radius:8px;">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
    import { db } from './config.js';
    import { collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp, query, orderBy, getDocs, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø¨Ø¯ÙˆÙ† ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø¨Ù‚Ø©)
    window.clearAllAnswersGlobal = async () => {
        const firstCheck = confirm("â— ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ ÙƒØ§ÙØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§ØªØŸ");
        if (!firstCheck) return;

        const secondCheck = confirm("âš ï¸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙˆÙ†Ù‚Ø§Ø·Ù‡Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ÙØ¹Ù„Ø§Ù‹ØŸ");
        if (!secondCheck) return;

        try {
            const snap = await getDocs(collection(db, "Answers"));
            if (snap.empty) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ø­Ø°ÙÙ‡Ø§.");

            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(doc(db, "Answers", d.id)));
            
            await batch.commit();
            alert("ØªÙ… ØªÙ†Ø¸ÙŠÙ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        } catch (e) {
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­ Ø§Ù„Ø´Ø§Ù…Ù„: " + e.message);
        }
    };

    // 2. ÙˆØ¸ÙŠÙØ© Ù…Ø³Ø­ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø­Ø¯Ø¯Ø©
    window.clearCompetitionResults = async () => {
        const id = document.getElementById('drawCompSelect').value;
        if (!id) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·ØŸ")) {
            const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", id)));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(doc(db, "Answers", d.id)));
            await batch.commit();
            alert("ØªÙ… Ù…Ø³Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­.");
        }
    };

    // --- Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ© ---
    onSnapshot(collection(db, "Competitions"), snap => {
        const list = document.getElementById('drawCompSelect');
        list.innerHTML = `<option value="">-- Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø© --</option>`;
        snap.forEach(d => {
            list.innerHTML += `<option value="${d.id}">${d.data().title}</option>`;
        });
    });

    window.createNewCompetition = async () => {
        const t = document.getElementById('compTitle').value;
        const e = document.getElementById('compEndDate').value;
        if(t && e) {
            await addDoc(collection(db, "Competitions"), { title: t, endDate: e, visible: true, createdAt: serverTimestamp() });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± âœ…");
        }
    };

    onSnapshot(query(collection(db, "Answers"), orderBy("timestamp", "desc")), snap => {
        const body = document.getElementById('resultsBody');
        body.innerHTML = "";
        snap.forEach(d => {
            const a = d.data();
            body.innerHTML += `<tr><td>${a.userName}</td><td>${a.compTitle}</td><td style="color:${a.isCorrect?'green':'red'}">${a.isCorrect?'ØµØ­':'Ø®Ø·Ø£'}</td><td>${a.pointsAwarded}</td></tr>`;
        });
    });

    // Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
    window.startDrawProcess = async () => {
        const id = document.getElementById('drawCompSelect').value;
        if(!id) return alert("Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø©");
        document.getElementById('drawOverlay').style.display='flex';
        // ... Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚ ...
        setTimeout(()=> { document.getElementById('drawOverlay').style.display='none'; alert("Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ø±Ø¹Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ§Ù‹"); }, 2000);
    };

</script>
</body>
</html>
