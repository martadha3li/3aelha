<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</title>

<style>
body{margin:0;font-family:sans-serif;background:#f2f2f7;padding:20px}
.card{background:#fff;padding:20px;border-radius:20px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
input,select{width:100%;padding:8px;margin:5px 0;border-radius:10px;border:1px solid #ddd}
button{padding:8px 12px;border:none;border-radius:10px;cursor:pointer}
.primary{background:#007AFF;color:#fff}
.success{background:#34C759;color:#fff}
.danger{background:#FF3B30;color:#fff}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border-bottom:1px solid #eee;text-align:right;font-size:13px}
.slot-box{font-size:28px;font-weight:bold;color:#FF9500;height:80px;display:flex;align-items:center;justify-content:center;border:3px solid #FF9500;border-radius:20px;margin-top:15px;background:#111;color:#fff}
.winner{color:#34C759;font-size:20px;font-weight:bold;margin-top:10px}
.badge{padding:4px 8px;border-radius:8px;font-size:12px;color:#fff;cursor:pointer}
</style>
</head>
<body>

<h2>ğŸ¯ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h2>

<!-- Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø© -->
<div class="card">
<h3>â• Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¨Ù‚Ø©</h3>
<input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©">
<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
<input type="datetime-local" id="compEnd">
<button class="primary" onclick="createCompetition()">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</button>
</div>

<!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª -->
<div class="card">
<h3>ğŸ“‹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</h3>
<div id="competitionsList"></div>
</div>

<!-- Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ -->
<div class="card">
<h3>â“ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
<select id="compSelect"></select>
<input type="text" id="qText" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
<input type="text" id="opt1" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
<input type="text" id="opt2" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
<input type="text" id="opt3" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
<select id="correctOpt">
<option value="0">Ø§Ù„Ø£ÙˆÙ„</option>
<option value="1">Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
<option value="2">Ø§Ù„Ø«Ø§Ù„Ø«</option>
</select>
<input type="number" id="points" value="10">
<button class="success" onclick="addQuestion()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„</button>
</div>

<!-- Ø§Ù„Ù‚Ø±Ø¹Ø© -->
<div class="card">
<h3>ğŸ° Ù‚Ø±Ø¹Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h3>
<select id="drawComp"></select>
<input type="number" id="winnerCount" value="1" min="1">
<button class="primary" onclick="startDraw()">Ø¨Ø¯Ø¡ Ø§Ù„Ù‚Ø±Ø¹Ø©</button>
<div id="slotBox" class="slot-box">---</div>
<div id="drawWinners"></div>
</div>

<!-- Ø§Ù„ØªØ±ØªÙŠØ¨ -->
<div class="card">
<h3>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…</h3>
<table>
<thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†Ù‚Ø§Ø·</th></tr></thead>
<tbody id="leaderboard"></tbody>
</table>
<button class="primary" onclick="exportExcel()">ØªØµØ¯ÙŠØ± Excel</button>
</div>

<!-- Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª -->
<div class="card">
<h3>ğŸ“Š Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</h3>
<table>
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</th>
<th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
<th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
</tr>
</thead>
<tbody id="answersTable"></tbody>
</table>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
import { db } from './config.js';
import { collection, addDoc, onSnapshot, getDocs, query, where, updateDoc, deleteDoc, doc, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª */
onSnapshot(collection(db,"Competitions"), snap=>{
 const select=document.getElementById("compSelect");
 const draw=document.getElementById("drawComp");
 const list=document.getElementById("competitionsList");

 select.innerHTML="";
 draw.innerHTML="";
 list.innerHTML="";

 snap.forEach(d=>{
   const c=d.data();

   select.innerHTML+=`<option value="${d.id}">${c.title}</option>`;
   draw.innerHTML+=`<option value="${d.id}">${c.title}</option>`;

   list.innerHTML+=`
   <div style="margin-bottom:8px">
     <b>${c.title}</b>
     <span class="badge success" onclick="toggleComp('${d.id}',${c.visible!==false})">
       ${c.visible!==false?'Ø¥ØºÙ„Ø§Ù‚':'ÙØªØ­'}
     </span>
     <span class="badge danger" onclick="deleteComp('${d.id}')">Ø­Ø°Ù</span>
   </div>`;
 });
});

/* Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³Ø§Ø¨Ù‚Ø© */
window.createCompetition=async()=>{
 const title=document.getElementById("compTitle").value;
 const end=document.getElementById("compEnd").value;
 if(!title){alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");return;}

 await addDoc(collection(db,"Competitions"),{
   title:title,
   endDate:end||"",
   visible:true,
   createdAt:serverTimestamp()
 });
 alert("ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡");
};

/* Ø¥ØºÙ„Ø§Ù‚ / ÙØªØ­ */
window.toggleComp=async(id,status)=>{
 await updateDoc(doc(db,"Competitions",id),{visible:!status});
};

/* Ø­Ø°Ù */
window.deleteComp=async(id)=>{
 if(confirm("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ"))
 await deleteDoc(doc(db,"Competitions",id));
};

/* Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ */
window.addQuestion=async()=>{
 const compId=document.getElementById("compSelect").value;
 const text=document.getElementById("qText").value;
 const options=[
  document.getElementById("opt1").value,
  document.getElementById("opt2").value,
  document.getElementById("opt3").value
 ].filter(x=>x!="");

 const correctIndex=parseInt(document.getElementById("correctOpt").value);
 const pts=parseInt(document.getElementById("points").value)||10;

 if(!text||options.length<2){alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");return;}

 await addDoc(collection(db,`Competitions/${compId}/Questions`),{
   text:text,
   options:options,
   correctOption:options[correctIndex],
   showAt:new Date().toISOString(),
   points:pts
 });
 alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„");
};

/* Ù‚Ø±Ø¹Ø© Ù…ØªØ­Ø±ÙƒØ© */
window.startDraw=async()=>{
 const compId=document.getElementById("drawComp").value;
 const count=parseInt(document.getElementById("winnerCount").value)||1;

 const q=query(collection(db,"Answers"),
  where("compId","==",compId),
  where("isCorrect","==",true)
 );
 const snap=await getDocs(q);

 let names=[...new Set(snap.docs.map(d=>d.data().userName))];
 if(names.length==0){alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø§Ø±ÙƒÙŠÙ†");return;}

 const slot=document.getElementById("slotBox");
 const winnersDiv=document.getElementById("drawWinners");
 winnersDiv.innerHTML="";

 let spin=setInterval(()=>{
   slot.innerText=names[Math.floor(Math.random()*names.length)];
 },100);

 setTimeout(async()=>{
   clearInterval(spin);
   const shuffled=names.sort(()=>0.5-Math.random());
   const winners=shuffled.slice(0,count);
   slot.innerText="ğŸ‰ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù‚Ø±Ø¹Ø©";
   winnersDiv.innerHTML="<div class='winner'>"+winners.join("<br>")+"</div>";

   await addDoc(collection(db,"Winners"),{
     compId:compId,
     winners:winners,
     createdAt:serverTimestamp()
   });

 },3000);
};

/* Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª + ØªØ±ØªÙŠØ¨ */
onSnapshot(collection(db,"Answers"), snap=>{
 let scores={};
 const table=document.getElementById("answersTable");
 table.innerHTML="";

 snap.forEach(d=>{
   const a=d.data();
   if(!scores[a.userName]) scores[a.userName]=0;
   scores[a.userName]+=a.pointsAwarded||0;

   const time=a.timestamp?.toDate()?.toLocaleString('ar-EG')||"";

   table.innerHTML+=`
   <tr>
   <td>${a.userName}</td>
   <td>${a.compTitle}</td>
   <td>${a.questionText}</td>
   <td>${a.selectedOption}</td>
   <td style="color:${a.isCorrect?'green':'red'}">${a.isCorrect?'âœ”':'âœ–'}</td>
   <td>${a.pointsAwarded}</td>
   <td>${time}</td>
   </tr>`;
 });

 const lb=document.getElementById("leaderboard");
 lb.innerHTML="";
 const sorted=Object.entries(scores).sort((a,b)=>b[1]-a[1]);
 sorted.forEach((row,i)=>{
   lb.innerHTML+=`<tr><td>${i+1}</td><td>${row[0]}</td><td>${row[1]}</td></tr>`;
 });
});

/* ØªØµØ¯ÙŠØ± Excel */
window.exportExcel=async()=>{
 const snap=await getDocs(collection(db,"Answers"));
 let data=[];
 snap.forEach(d=>{
   data.push(d.data());
 });
 const ws=XLSX.utils.json_to_sheet(data);
 const wb=XLSX.utils.book_new();
 XLSX.utils.book_append_sheet(wb,ws,"Answers");
 XLSX.writeFile(wb,"competitions.xlsx");
};
</script>

</body>
</html>
