<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù… | Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØ§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #34C759; --danger: #FF3B30; --bg: #F2F2F7; --gold: #FF9500; --card: #FFFFFF; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 900px; margin: auto; }
        .card { background: var(--card); border-radius: 18px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 0.5px solid #E5E5EA; }
        
        /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© */
        .comp-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #EEE; padding-bottom: 15px; }
        .timer-badge { background: #FFF9F2; color: var(--gold); padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; border: 1px solid #FFE0B2; }

        /* Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 10px 18px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-main { background: var(--primary); color: white; width: 100%; margin-top: 10px; padding: 15px; }
        .btn-draw { background: linear-gradient(135deg, var(--gold), #ffcc00); color: white; box-shadow: 0 4px 10px rgba(255,149,0,0.3); }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-body { background: white; width: 90%; max-width: 500px; border-radius: 25px; padding: 30px; position: relative; max-height: 85vh; overflow-y: auto; text-align: center; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø±Ø¹Ø© */
        .winner-item { background: #f8f8fb; padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 2px solid transparent; cursor: pointer; animation: popIn 0.5s ease; }
        .winner-item:hover { border-color: var(--primary); }
        .rank-badge { background: var(--gold); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: right; color: #8E8E93; font-size: 12px; padding: 10px; border-bottom: 1px solid #EEE; }
        td { padding: 10px; border-bottom: 1px solid #F2F2F7; font-size: 13px; }
        .clickable { color: var(--primary); font-weight: bold; cursor: pointer; text-decoration: underline; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .q-row { background: #f9f9f9; padding: 10px; border-radius: 8px; margin-bottom: 5px; text-align: right; font-size: 13px; display: flex; justify-content: space-between; align-items: center; }
        .q-input { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ğŸ’</h1>

    <div class="card" style="border: 2px solid var(--gold);">
        <h2>ğŸ² Ù†Ø¸Ø§Ù… Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <select id="drawCompSelect" style="padding:12px; border-radius:10px; border:1px solid #DDD;">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø³Ø­Ø¨ --</option>
            </select>
            <input type="number" id="winnersCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨" value="1" min="1">
        </div>
        <button class="btn btn-main btn-draw" onclick="startAdvancedDraw()">Ø§Ø¨Ø¯Ø£ Ø³Ø­Ø¨ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø¢Ù† ğŸ”¥</button>
    </div>

    <div class="card">
        <h2>ğŸ†• Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="text" id="compTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...">
        <input type="datetime-local" id="compEndDate" style="margin-top:10px; padding:12px; width:100%; border-radius:10px; border:1px solid #DDD;">
        <button class="btn btn-main" onclick="createNewCompetition()">Ù†Ø´Ø± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© âœ…</button>
    </div>

    <div id="resultsSections"></div>
</div>

<div id="drawModal" class="modal">
    <div class="modal-body">
        <h2 style="color:var(--gold)">ğŸŠ Ø§Ù„ÙØ§Ø¦Ø²ÙˆÙ† ÙÙŠ Ø§Ù„Ù‚Ø±Ø¹Ø© ğŸŠ</h2>
        <div id="drawLoading" style="display:none; padding:20px;">Ø¬Ø§Ø±ÙŠ Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ù…Ø§Ø¡... ğŸ²</div>
        <div id="winnersList"></div>
        <button onclick="closeModal('drawModal')" class="btn btn-main" style="background:#EEE; color:black;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
    </div>
</div>

<div id="questionModal" class="modal">
    <div class="modal-body">
        <h3 id="qModalTitle">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
        <hr>
        <div style="text-align: right; margin-bottom: 15px;">
            <input type="hidden" id="activeCompId">
            <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„:</label>
            <input type="text" id="newQText" class="q-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§...">
            <label>Ø§Ù„Ù†Ù‚Ø§Ø·:</label>
            <input type="number" id="newQPoints" class="q-input" value="10">
            <div id="optionsContainer">
                <input type="text" class="q-input opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙˆÙ„">
                <input type="text" class="q-input opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù†ÙŠ">
                <input type="text" class="q-input opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø«Ø§Ù„Ø«">
            </div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (1-3):</label>
            <input type="number" id="correctIdx" class="q-input" min="1" max="3" value="1">
            <button class="btn btn-main" onclick="saveQuestion()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„ â•</button>
        </div>
        <hr>
        <div id="existingQsList" style="max-height: 200px; overflow-y: auto;"></div>
        <button onclick="closeModal('questionModal')" class="btn btn-main" style="background:#EEE; color:black; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="userModal" class="modal">
    <div class="modal-body" id="modalUserInfo"></div>
</div>

<script type="module">
    import { db } from './config.js';
    import { collection, addDoc, onSnapshot, getDocs, query, where, doc, getDoc, deleteDoc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙˆØ§Ù„Ù€ Select
    onSnapshot(collection(db, "Competitions"), (snap) => {
        const container = document.getElementById('resultsSections');
        const select = document.getElementById('drawCompSelect');
        container.innerHTML = "";
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø³Ø­Ø¨ --</option>';

        snap.forEach(compDoc => {
            const comp = compDoc.data();
            const cid = compDoc.id;

            select.innerHTML += `<option value="${cid}">${comp.title}</option>`;

            const section = document.createElement('div');
            section.className = "card";
            section.innerHTML = `
                <div class="comp-header">
                    <div>
                        <h2 style="margin:0;">ğŸ† ${comp.title}</h2>
                        <div id="timer-${cid}" class="timer-badge">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª...</div>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn" style="background:var(--primary); color:white;" onclick="openQuestionModal('${cid}', '${comp.title}')">â“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</button>
                        <button class="btn btn-excel" style="background:var(--success); color:white;" onclick="exportExcel('${cid}', '${comp.title}')">ğŸ“Š Excel</button>
                        <button class="btn btn-danger" onclick="deleteComp('${cid}')">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Ø§Ù„Ù…Ø´Ø§Ø±Ùƒ</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                        <tbody id="table-${cid}"></tbody>
                    </table>
                </div>
            `;
            container.appendChild(section);
            startTimer(comp.endDate, `timer-${cid}`);
            fetchAnswers(cid);
        });
    });

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
    window.openQuestionModal = async (cid, title) => {
        document.getElementById('qModalTitle').innerText = "Ø£Ø³Ø¦Ù„Ø©: " + title;
        document.getElementById('activeCompId').value = cid;
        document.getElementById('questionModal').style.display = 'flex';
        loadCompQuestions(cid);
    };

    async function loadCompQuestions(cid) {
        const listDiv = document.getElementById('existingQsList');
        listDiv.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        const q = query(collection(db, "Questions"), where("compId", "==", cid));
        const snap = await getDocs(q);
        listDiv.innerHTML = "";
        snap.forEach(d => {
            const data = d.data();
            listDiv.innerHTML += `
                <div class="q-row">
                    <span>${data.text}</span>
                    <button class="btn btn-danger" style="padding:5px" onclick="deleteQuestion('${d.id}', '${cid}')">Ø­Ø°Ù</button>
                </div>`;
        });
    }

    window.saveQuestion = async () => {
        const cid = document.getElementById('activeCompId').value;
        const text = document.getElementById('newQText').value;
        const points = document.getElementById('newQPoints').value;
        const correct = parseInt(document.getElementById('correctIdx').value) - 1;
        const opts = Array.from(document.querySelectorAll('.opt')).map(i => i.value);

        if(!text || opts.some(o => !o)) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„");

        await addDoc(collection(db, "Questions"), {
            compId: cid,
            text: text,
            points: parseInt(points),
            options: opts,
            correctAnswer: correct,
            createdAt: serverTimestamp()
        });
        
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„");
        document.getElementById('newQText').value = "";
        loadCompQuestions(cid);
    };

    window.deleteQuestion = async (id, cid) => {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø³Ø¤Ø§Ù„ØŸ")) {
            await deleteDoc(doc(db, "Questions", id));
            loadCompQuestions(cid);
        }
    };

    // --- Ø¨Ù‚ÙŠØ© Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙƒÙ…Ø§ Ù‡ÙŠ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ---
    window.startAdvancedDraw = async () => {
        const cid = document.getElementById('drawCompSelect').value;
        const count = parseInt(document.getElementById('winnersCount').value);
        if(!cid) return alert("Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹");
        const modal = document.getElementById('drawModal');
        const list = document.getElementById('winnersList');
        const loader = document.getElementById('drawLoading');
        modal.style.display = 'flex';
        list.innerHTML = "";
        loader.style.display = 'block';
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid), where("isCorrect", "==", true)));
        const allCandidates = snap.docs.map(d => ({ uid: d.data().userId, name: d.data().userName }));
        const uniqueCandidates = [...new Map(allCandidates.map(item => [item.uid, item])).values()];
        if (uniqueCandidates.length === 0) {
            loader.style.display = 'none';
            list.innerHTML = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©.";
            return;
        }
        let winners = [];
        let tempPool = [...uniqueCandidates];
        for(let i=0; i < Math.min(count, uniqueCandidates.length); i++) {
            const randomIndex = Math.floor(Math.random() * tempPool.length);
            winners.push(tempPool.splice(randomIndex, 1)[0]);
        }
        loader.style.display = 'none';
        for(let i = winners.length - 1; i >= 0; i--) {
            await new Promise(r => setTimeout(r, 1200));
            const div = document.createElement('div');
            div.className = "winner-item";
            div.onclick = () => showUserInfo(winners[i].uid);
            div.innerHTML = `<div style="display:flex; align-items:center; gap:15px;"><div class="rank-badge">${i + 1}</div><b>${winners[i].name}</b></div><span style="font-size:11px; color:var(--primary);">Ø§Ù„ØªÙØ§ØµÙŠÙ„ â„¹ï¸</span>`;
            list.prepend(div);
        }
    };

    function startTimer(targetDate, elementId) {
        const update = () => {
            const now = new Date().getTime();
            const diff = new Date(targetDate).getTime() - now;
            const el = document.getElementById(elementId);
            if (!el) return;
            if (diff <= 0) { el.innerHTML = "ğŸ›‘ Ù…Ù†ØªÙ‡ÙŠØ©"; el.style.color = "red"; return; }
            const d = Math.floor(diff / 86400000);
            const h = Math.floor((diff % 86400000) / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            el.innerHTML = `â³ Ù…ØªØ¨Ù‚ÙŠ: ${d}ÙŠ ${h}Ø³ ${m}Ø¯`;
        };
        update(); setInterval(update, 60000);
    }

    window.showUserInfo = async (uid) => {
        const userDoc = await getDoc(doc(db, "Users", uid));
        if(!userDoc.exists()) return alert("ØºÙŠØ± Ù…ØªÙˆÙØ±");
        const u = userDoc.data();
        const modal = document.getElementById('userModal');
        document.getElementById('modalUserInfo').innerHTML = `
            <h3 style="color:var(--primary)">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§Ø¦Ø²</h3>
            <div style="text-align:right;">
                <p><b>Ø§Ù„Ø§Ø³Ù…:</b> ${u.fullName || u.name}</p>
                <p><b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> <a href="tel:${u.phone}">${u.phone}</a></p>
                <p><b>Ø§Ù„Ø¨Ø±ÙŠØ¯:</b> ${u.email || '---'}</p>
                <hr><p style="color:var(--gold)"><b>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø±Ù…:</b></p>
                <p><b>Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</b> ${u.femaleGuardianName || '---'}</p>
                <p><b>Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø±Ù‘Ù:</b> ${u.femaleGuardianPhone || '---'}</p>
            </div>
            <button onclick="closeModal('userModal')" class="btn btn-main" style="background:#F2F2F7; color:black;">Ø¥ØºÙ„Ø§Ù‚</button>`;
        modal.style.display = 'flex';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';

    async function fetchAnswers(cid) {
        const q = query(collection(db, "Answers"), where("compId", "==", cid));
        const snap = await getDocs(q);
        const tbody = document.getElementById(`table-${cid}`);
        if(!tbody) return;
        tbody.innerHTML = "";
        snap.forEach(d => {
            const a = d.data();
            tbody.innerHTML += `<tr><td class="clickable" onclick="showUserInfo('${a.userId}')">${a.userName}</td><td>${a.userPhone}</td><td>${a.isCorrect ? 'âœ…' : 'âŒ'}</td></tr>`;
        });
    }

    window.createNewCompetition = async () => {
        const title = document.getElementById('compTitle').value;
        const endDate = document.getElementById('compEndDate').value;
        if(!title || !endDate) return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
        await addDoc(collection(db, "Competitions"), { title, endDate, visible: true, createdAt: serverTimestamp() });
        alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
    };

    window.deleteComp = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ")) await deleteDoc(doc(db, "Competitions", id)); };

    window.exportExcel = async (cid, title) => {
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid)));
        const data = snap.docs.map(d => ({ "Ø§Ù„Ø§Ø³Ù…": d.data().userName, "Ø§Ù„Ø¬ÙˆØ§Ù„": d.data().userPhone, "Ø§Ù„Ù†ØªÙŠØ¬Ø©": d.data().isCorrect ? "ØµØ­" : "Ø®Ø·Ø£" }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
        XLSX.writeFile(wb, `${title}.xlsx`);
    };
</script>
</body>
</html>
