<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø°ÙƒÙŠ | Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰</title>
    <style>
        :root { --primary: #007AFF; --gold: #FF9500; --bg: #F2F2F7; --card: #FFFFFF; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; direction: rtl; }
        .container { max-width: 800px; margin: auto; }
        
        .draw-card { background: linear-gradient(145deg, #ffffff, #f0f0f0); border-radius: 25px; padding: 30px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 2px solid var(--gold); margin-bottom: 30px; }
        h1 { color: #1c1c1e; font-size: 28px; margin-bottom: 10px; }
        
        select, input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: 1px solid #DDD; font-size: 16px; outline: none; }
        
        .btn-draw { background: linear-gradient(135deg, var(--gold), #FFCC00); color: white; border: none; padding: 18px; width: 100%; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 15px rgba(255,149,0,0.4); }
        .btn-draw:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(255,149,0,0.5); }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        .modal-body { background: white; width: 90%; max-width: 500px; border-radius: 30px; padding: 30px; text-align: center; }

        .winner-item { background: #FFF9F2; border: 1px solid #FFE0B2; padding: 15px; border-radius: 15px; margin-top: 10px; animation: pop 0.5s ease-out; }
        @keyframes pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .history-card { background: white; border-radius: 20px; padding: 20px; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: right; color: #8E8E93; font-size: 12px; padding: 10px; }
        td { padding: 12px; border-bottom: 1px solid #F2F2F7; font-size: 14px; }
        .win-badge { background: var(--gold); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; }
    </style>
</head>
<body>

<div class="container">
    <div style="margin-bottom: 20px;">
        <a href="admin_competition.html" style="text-decoration: none; color: var(--primary); font-weight: bold;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </div>

    <div class="draw-card">
        <h1>ğŸ² Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø­Ù…Ø§Ø³ÙŠØ©</h1>
        <p>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ø¨Ø¯Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</p>
        
        <select id="compSelect">
            <option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª...</option>
        </select>
        
        <input type="number" id="winnersCount" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨" value="1" min="1">
        
        <button class="btn-draw" onclick="startLottery()">Ø¨Ø¯Ø¡ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø¢Ù† ğŸ”¥</button>
    </div>

    <div id="historyArea">
        </div>
</div>

<div id="lotteryModal" class="modal">
    <div class="modal-body">
        <div id="animArea" style="font-size: 60px;">ğŸ°</div>
        <h2 id="statusText">Ø¬Ø§Ø±ÙŠ Ø®Ù„Ø· Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</h2>
        <div id="winnersResult"></div>
        <button onclick="closeModal()" class="btn-draw" style="margin-top:20px; background: #EEE; color: #000; box-shadow: none;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, getDocs, query, where, doc, getDoc, setDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const compSelect = document.getElementById('compSelect');
    const historyArea = document.getElementById('historyArea');

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    onSnapshot(query(collection(db, "Competitions"), orderBy("createdAt", "desc")), (snap) => {
        compSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù„Ù„Ø³Ø­Ø¨ --</option>';
        snap.forEach(d => {
            compSelect.innerHTML += `<option value="${d.id}">${d.data().title}</option>`;
        });
    });

    // 2. Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
    onSnapshot(collection(db, "Winners"), (snap) => {
        historyArea.innerHTML = '<h2 style="font-size: 18px;">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ÙØ§Ø¦Ø²ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†</h2>';
        snap.forEach(async (d) => {
            const compData = (await getDoc(doc(db, "Competitions", d.id))).data();
            const winners = d.data().list;
            
            const card = document.createElement('div');
            card.className = "history-card";
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #EEE; padding-bottom:10px;">
                    <b style="color:var(--gold)">ğŸ† ${compData?.title || 'Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø­Ø°ÙˆÙØ©'}</b>
                    <small style="color:gray;">ØªÙ… Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ: ${d.data().drawnAt?.toDate().toLocaleDateString('ar-SA') || '---'}</small>
                </div>
                <table>
                    <thead><tr><th>Ø§Ù„ÙØ§Ø¦Ø²</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø±Ù…</th></tr></thead>
                    <tbody>
                        ${winners.map(w => `
                            <tr>
                                <td><b>${w.name}</b></td>
                                <td>${w.phone}</td>
                                <td style="font-size:11px; color:#555;">${w.guardian || '---'} | ${w.gPhone || ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            historyArea.appendChild(card);
        });
    });

    // 3. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø­Ù…Ø§Ø³ÙŠ
    window.startLottery = async () => {
        const cid = compSelect.value;
        const count = parseInt(document.getElementById('winnersCount').value);
        if(!cid) return alert("Ø§Ø®ØªØ± Ù…Ø³Ø§Ø¨Ù‚Ø©");

        document.getElementById('lotteryModal').style.display = 'flex';
        document.getElementById('statusText').innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø¨Ø§Ù‚Ø±Ø©...";
        document.getElementById('winnersResult').innerHTML = "";

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©
        const snap = await getDocs(query(collection(db, "Answers"), where("compId", "==", cid), where("isCorrect", "==", true)));
        let candidates = [];

        for(const d of snap.docs) {
            const user = (await getDoc(doc(db, "Users", d.data().userId))).data();
            candidates.push({
                uid: d.data().userId,
                name: d.data().userName,
                phone: d.data().userPhone,
                guardian: user?.femaleGuardianName || '',
                gPhone: user?.femaleGuardianPhone || ''
            });
        }

        candidates = [...new Map(candidates.map(item => [item.uid, item])).values()];

        if(candidates.length === 0) {
            document.getElementById('statusText').innerText = "Ù„Ù„Ø£Ø³ÙØŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø¨Ø§Øª ØµØ­ÙŠØ­Ø©";
            return;
        }

        // ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ´ÙˆÙŠÙ‚
        setTimeout(async () => {
            let winners = [];
            for(let i=0; i<Math.min(count, candidates.length); i++) {
                const rand = Math.floor(Math.random() * candidates.length);
                winners.push(candidates.splice(rand, 1)[0]);
            }

            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
            await setDoc(doc(db, "Winners", cid), { list: winners, drawnAt: serverTimestamp() });

            document.getElementById('statusText').innerText = "ğŸ‰ Ù…Ø¨Ø±ÙˆÙƒ Ù„Ù„ÙØ§Ø¦Ø²ÙŠÙ†!";
            document.getElementById('winnersResult').innerHTML = winners.map((w, idx) => `
                <div class="winner-item" style="animation-delay: ${idx * 0.5}s">
                    <span class="win-badge">Ø§Ù„ÙØ§Ø¦Ø² ${idx+1}</span>
                    <div style="margin-top:5px; font-weight:bold; font-size:18px;">${w.name}</div>
                </div>
            `).join('');
        }, 2000);
    };

    window.closeModal = () => document.getElementById('lotteryModal').style.display = 'none';
</script>
</body>
</html>
