<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ©</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #E5DDD5; }
        body { background: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #f6f6f6; padding: 45px 15px 10px; display: flex; align-items: center; border-bottom: 0.5px solid #ccc; position: fixed; top: 0; width: 100%; z-index: 1000; box-sizing: border-box; }
        #messagesArea { flex: 1; padding: 100px 15px 80px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 75%; padding: 10px; border-radius: 15px; font-size: 15px; }
        .msg.sent { align-self: flex-end; background: #DCF8C6; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        .input-area { background: #f6f6f6; padding: 10px; display: flex; gap: 10px; position: fixed; bottom: 0; width: 100%; box-sizing: border-box; }
        .input-box { flex: 1; border-radius: 20px; border: 1px solid #ccc; padding: 10px 15px; outline: none; }
    </style>
</head>
<body>

<div class="header">
    <div style="color:var(--ios-blue); cursor:pointer;" onclick="history.back()">â® Ø¹ÙˆØ¯Ø©</div>
    <div id="chatWith" style="flex:1; text-align:center; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<div id="messagesArea"></div>

<div class="input-area">
    <input type="text" id="msgInput" class="input-box" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ...">
    <button id="sendBtn" style="border:none; background:none; font-size:24px;">ğŸ•Šï¸</button>
</div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const targetId = new URLSearchParams(window.location.search).get('id');
    let user = null;
    let userData = null;
    let targetData = null;

    auth.onAuthStateChanged(async u => {
        if(u) {
            user = u;
            const [uSnap, tSnap] = await Promise.all([getDoc(doc(db, "Users", u.uid)), getDoc(doc(db, "Users", targetId))]);
            userData = uSnap.data();
            targetData = tSnap.data();
            document.getElementById('chatWith').innerText = targetData.fullName;
            loadMsgs();
        } else { location.href='login.html'; }
    });

    function loadMsgs() {
        const q = query(collection(db, "PrivateMessages"), orderBy("timestamp", "asc"));
        onSnapshot(q, (snap) => {
            const area = document.getElementById('messagesArea');
            area.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                if((m.senderId === user.uid && m.receiverId === targetId) || (m.senderId === targetId && m.receiverId === user.uid)) {
                    const div = document.createElement('div');
                    div.className = `msg ${m.senderId === user.uid ? 'sent' : 'received'}`;
                    div.innerText = m.text;
                    area.appendChild(div);
                }
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    document.getElementById('sendBtn').onclick = async () => {
        const config = (await getDoc(doc(db, "Settings", "AppConfig"))).data();
        const isAdmin = userData?.role === 'admin';

        if(!config.privateChatEnabled && !isAdmin) return alert("Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ø®Ø§ØµØ© Ù…Ø¹Ø·Ù„Ø©.");
        if(config.genderRestriction && !isAdmin && userData.gender !== targetData.gender) 
            return alert("Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ØªÙ…Ù†Ø¹ Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø© Ø¨ÙŠÙ† Ø§Ù„Ø¬Ù†Ø³ÙŠÙ†.");

        const txt = document.getElementById('msgInput').value;
        if(!txt.trim()) return;
        document.getElementById('msgInput').value = "";
        await addDoc(collection(db, "PrivateMessages"), {
            text: txt, senderId: user.uid, receiverId: targetId, timestamp: serverTimestamp()
        });
    };
</script>
</body>
</html>
