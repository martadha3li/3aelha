<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container { padding: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .user-row { background: white; padding: 15px; border-radius: 15px; margin-bottom: 10px; box-shadow: var(--shadow); }
        .badge { font-size: 10px; padding: 3px 8px; border-radius: 10px; color: white; }
        .status-pending { background: var(--danger); }
        .status-active { background: var(--accent); }
        .guardian-note { font-size: 11px; background: #fff5f5; padding: 5px; border-radius: 5px; margin-top: 5px; border: 1px dashed red; }
    </style>
</head>
<body>
    <div class="top-bar">
        <b>âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ©</b>
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:20px;">ğŸ </button>
    </div>

    <div class="admin-container">
        <div class="stat-grid" id="statsArea">
            </div>

        <h3>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
        <div id="usersManager"></div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø©
    onSnapshot(collection(db, "Users"), snap => {
        let m=0, f=0, total=snap.size;
        const manager = document.getElementById('usersManager');
        manager.innerHTML = "";
        
        snap.forEach(d => {
            const u = d.data();
            if(u.role === 'admin') return;
            u.gender === 'male' ? m++ : f++;
            
            const isFemale = u.gender === 'female';
            manager.innerHTML += `
                <div class="user-row">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <b>${u.fullName}</b> <span class="badge ${u.status === 'active' ? 'status-active' : 'status-pending'}">${u.status}</span>
                            <div style="font-size:11px; color:gray;">${u.phone} | ØµÙ„Ø§Ø­ÙŠØ©: ${u.role || 'Ø¹Ø¶Ùˆ'}</div>
                        </div>
                        <div style="display:flex; gap:5px;">
                            <button onclick="changeRole('${d.id}', 'editor')" style="font-size:10px;">ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø­Ø±Ø±</button>
                            <button onclick="toggleUser('${d.id}', '${u.status}')" style="font-size:10px;">${u.status === 'active' ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}</button>
                            <button onclick="deleteU('${d.id}')" style="font-size:10px; color:red;">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    ${(isFemale && u.guardianName) ? `<div class="guardian-note">ğŸ›¡ï¸ Ø§Ù„Ù…Ø¹Ø±Ù: ${u.guardianName} (${u.guardianPhone})</div>` : ''}
                </div>`;
        });
        
        document.getElementById('statsArea').innerHTML = `
            <div class="stat-box"><h3>Ø§Ù„Ø°ÙƒÙˆØ±</h3><p>${m}</p></div>
            <div class="stat-box"><h3>Ø§Ù„Ø¥Ù†Ø§Ø«</h3><p>${f}</p></div>`;
    });

    window.changeRole = async (id, role) => await updateDoc(doc(db, "Users", id), { role });
    window.toggleUser = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s === 'active' ? 'disabled' : 'active' });
    window.deleteU = async (id) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await deleteDoc(doc(db, "Users", id)); };
</script>
</body>
</html>
