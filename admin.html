<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <style>
        :root { --primary: #2c3e50; --secondary: #34495e; --accent: #27ae60; --danger: #e74c3c; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        h1 { text-align: center; color: var(--primary); }
        
        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; color: var(--secondary); font-size: 1.2rem; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); padding: 5px 15px; font-size: 0.8rem; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .user-info small { color: #666; display: block; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… âš™ï¸</h1>

    <section>
        <h2>ØªØ®ØµÙŠØµ Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¯ÙŠØ±/Ø§Ù„Ù…Ø´Ø±Ù</h2>
        <div style="display:flex; gap:10px; align-items:center;">
            <select id="viewTypeSelect">
                <option value="mobile">Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ù„ (ØªØ·Ø¨ÙŠÙ‚ÙŠ)</option>
                <option value="desktop">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± (Ø´Ø§Ù…Ù„)</option>
            </select>
            <button class="btn btn-primary" id="btnSaveView">Ø­ÙØ¸ Ø§Ù„Ù†Ù…Ø·</button>
        </div>
    </section>

    <div class="grid">
        <section>
            <h2>Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯ ğŸ“°</h2>
            <input type="text" id="newsTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
            <textarea id="newsBody" rows="3" placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø®Ø¨Ø±"></textarea>
            <select id="newsCatSelect"><option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª...</option></select>
            <button class="btn btn-primary" id="btnPostNews">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±</button>
        </section>

        <section>
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ğŸ·ï¸</h2>
            <input type="text" id="newCatInput" placeholder="Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ (Ù…Ø«Ù„Ø§Ù‹: ØªÙ†Ø¨ÙŠÙ‡Ø§Øª)">
            <button class="btn btn-accent" id="btnAddCat">Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ</button>
            <div id="catsList" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
        </section>
    </div>

    <div class="grid">
        <section>
            <h2>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù„ÙˆÙ† ğŸ“¢</h2>
            <input type="text" id="notifText" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙŠØ¸Ù‡Ø± Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰">
            <select id="notifType">
                <option value="urgent">Ø¹Ø§Ø¬Ù„ (Ø£Ø­Ù…Ø±)</option>
                <option value="medium">Ù…ØªÙˆØ³Ø· (Ø£Ø²Ø±Ù‚)</option>
                <option value="normal">Ø¹Ø§Ø¯ÙŠ (Ø£Ø¨ÙŠØ¶)</option>
            </select>
            <input type="number" id="notifDuration" placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ (Ù…Ø«Ù„Ø§Ù‹: 10)">
            <button class="btn btn-danger" style="width:100%" id="btnSendNotif">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù†</button>
        </section>

        <section>
            <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¤Ù‚ØªØ© ğŸ•’</h2>
            <input type="text" id="groupName" placeholder="Ø§Ø³Ù… Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù†Ù‚Ø§Ø´">
            <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:</label>
            <input type="datetime-local" id="expiryTime">
            <button class="btn btn-primary" style="width:100%; background:#6f42c1;" id="btnCreateGroup">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
        </section>
    </div>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ğŸ‘¥</h2>
        <div id="usersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>

    <div style="text-align:center; padding: 20px;">
        <a href="news.html" style="text-decoration:none; color:var(--primary); font-weight:bold;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</a>
    </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (!snap.exists() || snap.data().role !== 'admin') {
                window.location.href = "news.html";
            }
        } else { window.location.href = "index.html"; }
    });

    // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø¯ÙŠØ± ---
    document.getElementById('btnSaveView').onclick = async () => {
        const type = document.getElementById('viewTypeSelect').value;
        await updateDoc(doc(db, "Users", auth.currentUser.uid), { viewType: type });
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸! Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Ù…Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.");
    };

    // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ---
    onSnapshot(collection(db, "Categories"), (snap) => {
        const list = document.getElementById('catsList');
        const select = document.getElementById('newsCatSelect');
        list.innerHTML = ""; select.innerHTML = "";
        snap.forEach(d => {
            const cat = d.data();
            list.innerHTML += `<div class="list-item"><span>${cat.name}</span><button class="btn btn-danger" onclick="window.delCat('${d.id}')">Ø­Ø°Ù</button></div>`;
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    });

    document.getElementById('btnAddCat').onclick = async () => {
        const name = document.getElementById('newCatInput').value;
        if(name) { await addDoc(collection(db, "Categories"), { name }); document.getElementById('newCatInput').value = ""; }
    };

    window.delCat = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙØŸ")) await deleteDoc(doc(db, "Categories", id)); };

    // --- 3. Ù†Ø´Ø± Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ---
    document.getElementById('btnPostNews').onclick = async () => {
        const title = document.getElementById('newsTitle').value;
        const body = document.getElementById('newsBody').value;
        const cat = document.getElementById('newsCatSelect').value;
        if(title && body) {
            await addDoc(collection(db, "News"), { title, body, cat, date: serverTimestamp() });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±!"); document.getElementById('newsTitle').value = ""; document.getElementById('newsBody').value = "";
        }
    };

    // --- 4. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ---
    document.getElementById('btnSendNotif').onclick = async () => {
        const text = document.getElementById('notifText').value;
        const type = document.getElementById('notifType').value;
        const dur = parseInt(document.getElementById('notifDuration').value);
        if(text && dur) {
            await addDoc(collection(db, "Notifications"), { 
                text, type, duration: dur, 
                createdAt: serverTimestamp(), 
                expiry: new Date().getTime() + (dur * 1000) 
            });
            alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
        }
    };

    // --- 5. Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© ---
    document.getElementById('btnCreateGroup').onclick = async () => {
        const name = document.getElementById('groupName').value;
        const exp = document.getElementById('expiryTime').value;
        if(name && exp) {
            await addDoc(collection(db, "TempGroups"), { name, expiry: new Date(exp).getTime(), status: 'active' });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©");
        }
    };

    // --- 6. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ---
    onSnapshot(collection(db, "Users"), (snap) => {
        const list = document.getElementById('usersList');
        list.innerHTML = "";
        snap.forEach(d => {
            const u = d.data();
            if(u.role !== 'admin') {
                list.innerHTML += `
                <div class="list-item">
                    <div class="user-info">
                        <strong>${u.fullName}</strong>
                        <small>${u.phone} | ${u.isActive ? 'Ù†Ø´Ø·' : 'Ù…Ø¹Ø·Ù„'}</small>
                    </div>
                    <button class="btn btn-primary" style="background:${u.isActive?'#666':'#27ae60'}" onclick="window.toggleUser('${d.id}', ${u.isActive})">
                        ${u.isActive ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'}
                    </button>
                </div>`;
            }
        });
    });

    window.toggleUser = async (id, status) => { await updateDoc(doc(db, "Users", id), { isActive: !status }); };

</script>
</body>
</html>
