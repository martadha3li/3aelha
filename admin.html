<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        section { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .duplicate { background: #ffebeb; border: 1px solid red; border-radius: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© âš™ï¸</h1>

    <section>
        <h2>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ ğŸ†•</h2>
        <div id="pendingList"></div>
    </section>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ğŸ”‘</h2>
        <div id="passReqs"></div>
    </section>

    <section>
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ø£Ø­Ù…Ø± = Ù…ÙƒØ±Ø±) ğŸ‘¥</h2>
        <div id="allUsers"></div>
    </section>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    onSnapshot(collection(db, "Users"), snap => {
        const pList = document.getElementById('pendingList');
        const aList = document.getElementById('allUsers');
        pList.innerHTML = ""; aList.innerHTML = "";
        
        const counts = {};
        const users = [];
        snap.forEach(d => {
            const u = {id: d.id, ...d.data()};
            if(u.role === 'admin') return;
            users.push(u);
            counts[u.phone] = (counts[u.phone] || 0) + 1;
        });

        users.forEach(u => {
            const isDup = counts[u.phone] > 1;
            const html = `<div class="row ${isDup?'duplicate':''}">
                <span>${u.fullName} (${u.phone})</span>
                <button class="btn" style="background:orange" onclick="toggleS('${u.id}','${u.status}')">${u.status}</button>
            </div>`;
            
            if(u.status === 'pending') pList.innerHTML += html;
            aList.innerHTML += html;
        });
    });

    onSnapshot(collection(db, "Requests"), snap => {
        const res = document.getElementById('passReqs');
        res.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            res.innerHTML += `<div class="row">
                <span>${r.fullName} ÙŠØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</span>
                <button class="btn" style="background:#27ae60" onclick="approvePass('${d.id}','${r.uid}')">Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>`;
        });
    });

    window.toggleS = async (id, cur) => await updateDoc(doc(db, "Users", id), { status: cur === 'active' ? 'disabled' : 'active' });

    window.approvePass = async (rid, uid) => {
        const temp = Math.floor(100000 + Math.random() * 900000).toString();
        const uSnap = await getDoc(doc(db, "Users", uid));
        const u = uSnap.data();

        await updateDoc(doc(db, "Users", uid), { tempPass: temp, resetMode: true });
        await deleteDoc(doc(db, "Requests", rid));

        const title = u.gender === 'female' ? 'Ø§Ù„Ø£Ø®Øª Ø§Ù„Ù…Ø¹Ø±ÙØ©' : 'Ø§Ù„Ø£Ø®';
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${title} ${u.fullName}. Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯: *${temp}*`;
        window.open(`https://wa.me/${u.phone}?text=${encodeURIComponent(msg)}`);
    };
</script>
</body>
</html>
