<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --blue: #3498db; --pink: #ff69b4; --gold: #f1c40f; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; margin-bottom: 20px; font-size: 1.1rem; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 28px; font-weight: bold; display: block; margin-bottom: 5px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ§Ù„ØµÙÙˆÙ */
        .card-row { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; border: 1px solid #eee; }
        .active-item { background: #fff3cd; padding: 12px; border-radius: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #ffeeba; }
        
        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        
        .perm-tag { font-size: 11px; padding: 5px 10px; border-radius: 5px; background: #ddd; cursor: pointer; margin: 2px; display: inline-block; }
        .perm-tag.active { background: var(--accent); color: white; }
        .user-tag { background: var(--blue); color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; margin: 3px; display: inline-block; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn btn-primary" onclick="location.href='news.html'" style="margin-bottom:20px;">â¬…ï¸ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø© âš™ï¸</h1>

    <div class="stats-grid">
        <div class="stat-card" style="border-bottom: 5px solid var(--blue);"><span id="mCount" class="stat-num">0</span><span style="color:var(--blue)">Ø°ÙƒÙˆØ± ğŸ‘¨</span></div>
        <div class="stat-card" style="border-bottom: 5px solid var(--pink);"><span id="fCount" class="stat-num">0</span><span style="color:var(--pink)">Ø¥Ù†Ø§Ø« ğŸ‘©</span></div>
        <div class="stat-card"> <span id="maxAge" class="stat-num">0</span><span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø± ğŸ‘´</span></div>
        <div class="stat-card"> <span id="minAge" class="stat-num">0</span><span>Ø£ØµØºØ± Ø¹Ù…Ø± ğŸ‘¶</span></div>
    </div>

    <section style="background: #fff5f5;">
        <h2>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ÙÙˆØ±ÙŠ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ğŸ›‘</h2>
        <div id="activePopup" class="active-item" style="display:none;">
            <span>ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Pop-up (Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚) Ù†Ø´Ø· Ø§Ù„Ø¢Ù†</span>
            <button class="btn btn-danger" onclick="window.disableItem('loginPopup')">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¢Ù†</button>
        </div>
        <div id="activeStar" class="active-item" style="display:none;">
            <span>â­ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ù…Ø© (Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©) Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†</span>
            <button class="btn btn-danger" onclick="window.disableItem('broadcast')">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¢Ù†</button>
        </div>
    </section>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ğŸ“¥</h2>
        <div id="requestsList">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
    </section>

    <section style="background: #f0fdf4;">
        <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¤Ù‚ØªØ© (Ù…Ø³ØªÙ‡Ø¯ÙØ©) ğŸ‘¥</h2>
        <input type="text" id="groupName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
        <input type="datetime-local" id="groupExp">
        <div style="margin: 10px 0;">
            <label><input type="radio" name="target" value="all" checked onclick="toggleGSearch(false)"> Ù„Ù„Ø¬Ù…ÙŠØ¹</label>
            <label><input type="radio" name="target" value="specific" onclick="toggleGSearch(true)"> Ø£Ø´Ø®Ø§Øµ Ù…Ø­Ø¯Ø¯ÙŠÙ†</label>
        </div>
        <div id="groupSearchArea" style="display:none; padding:15px; border:1px solid #ddd; border-radius:12px; background:white;">
            <input type="text" id="uSearchG" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©..." oninput="searchUsersG()">
            <div id="gResults" style="max-height:120px; overflow-y:auto; border-bottom:1px solid #eee; margin-bottom:10px;"></div>
            <div id="selectedUsers"></div>
        </div>
        <button class="btn btn-accent" onclick="createGroup()" style="width:100%; margin-top:10px;">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ¨Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    </section>

    <section style="background: #eef7ff;">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (Pop-up / Ù†Ø¬Ù…Ø© â­)</h2>
        <textarea id="popText" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label style="font-size:12px;">Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚:</label>
                <select id="popType">
                    <option value="white">Ø¹Ø§Ø¯ÙŠ (Ø£Ø¨ÙŠØ¶)</option>
                    <option value="red">Ø¹Ø§Ø¬Ù„ (Ø£Ø­Ù…Ø±)</option>
                    <option value="green">ØªØ¨Ø±Ø¹ (Ø£Ø®Ø¶Ø±)</option>
                </select>
            </div>
            <div>
                <label style="font-size:12px;">ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:</label>
                <input type="datetime-local" id="popExp">
            </div>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
            <button class="btn btn-primary" onclick="sendPopup()">ØªÙØ¹ÙŠÙ„ ÙƒÙ€ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†Ø¨Ø«Ù‚</button>
            <button class="btn btn-accent" onclick="sendStar()">ØªÙØ¹ÙŠÙ„ ÙƒÙ€ Ù†Ø¬Ù…Ø© â­</button>
        </div>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØ§Ù„Ø¨Ø­Ø« ğŸ‘¤</h2>
        <input type="text" id="uSearchMain" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." oninput="filterUsersMain()">
        <div id="usersList" style="margin-top:15px;"></div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, setDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let allUsers = [], selectedUIDs = [];

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role === 'admin') initAdmin();
            else window.location.href = "news.html";
        }
    });

    function initAdmin() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ø­Ø¸ÙŠØ§Ù‹
        onSnapshot(collection(db, "Users"), (snap) => {
            allUsers = []; let m=0, f=0, ages=[];
            snap.forEach(d => {
                const u = {id: d.id, ...d.data()}; allUsers.push(u);
                if(u.gender === 'male') m++; else if(u.gender === 'female') f++;
                if(u.dob) ages.push(new Date().getFullYear() - new Date(u.dob).getFullYear());
            });
            document.getElementById('mCount').innerText = m; document.getElementById('fCount').innerText = f;
            document.getElementById('maxAge').innerText = ages.length ? Math.max(...ages) : 0;
            document.getElementById('minAge').innerText = ages.length ? Math.min(...ages) : 0;
            renderUsers(allUsers);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù„ØªØ¹Ø·ÙŠÙ„
        onSnapshot(doc(db, "Settings", "loginPopup"), s => document.getElementById('activePopup').style.display = (s.exists() && s.data().expiry > Date.now()) ? 'flex' : 'none');
        onSnapshot(doc(db, "Settings", "broadcast"), s => document.getElementById('activeStar').style.display = (s.exists() && s.data().expiry > Date.now()) ? 'flex' : 'none');

        // Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        onSnapshot(collection(db, "Requests"), snap => {
            const list = document.getElementById('requestsList'); list.innerHTML = "";
            snap.forEach(async d => {
                const r = d.data();
                const uSnap = await getDoc(doc(db, "Users", r.uid));
                if(!uSnap.exists()) return;
                const u = uSnap.data();
                const typeText = r.type === "password_reset" ? "ğŸ”‘ Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±" : "ğŸ“± ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„";
                list.innerHTML += `<div class="card-row">
                    <span><b>${u.fullName}</b> | ${typeText} ${r.requestedPhone ? 'Ø¥Ù„Ù‰ '+r.requestedPhone : ''}</span>
                    <button class="btn btn-accent" onclick="approveReq('${d.id}','${r.uid}','${r.type}','${r.requestedPhone || ''}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                </div>`;
            });
        });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    window.toggleGSearch = (s) => { document.getElementById('groupSearchArea').style.display = s ? 'block' : 'none'; if(!s) selectedUIDs=[]; };
    window.searchUsersG = () => {
        const t = document.getElementById('uSearchG').value.toLowerCase();
        const res = document.getElementById('gResults'); res.innerHTML = "";
        if(t.length < 2) return;
        allUsers.filter(u => u.fullName.toLowerCase().includes(t) || u.phone.includes(t)).forEach(u => {
            const d = document.createElement('div'); d.className="user-row"; d.style.padding="8px"; d.style.cursor="pointer"; d.innerText = `â• ${u.fullName}`;
            d.onclick = () => { if(!selectedUIDs.includes(u.id)) { selectedUIDs.push(u.id); renderSelected(); } };
            res.appendChild(d);
        });
    };
    function renderSelected() {
        const area = document.getElementById('selectedUsers'); area.innerHTML = "";
        selectedUIDs.forEach(id => {
            const u = allUsers.find(x => x.id === id);
            area.innerHTML += `<span class="user-tag" onclick="selectedUIDs=selectedUIDs.filter(x=>x!=='${id}');renderSelected();">${u.fullName} âœ•</span>`;
        });
    }
    window.createGroup = async () => {
        const name = document.getElementById('groupName').value;
        const exp = document.getElementById('groupExp').value;
        const type = document.querySelector('input[name="target"]:checked').value;
        if(!name || !exp) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        await addDoc(collection(db, "TempGroups"), {
            name, expiry: new Date(exp).getTime(), targetType: type,
            allowedUsers: selectedUIDs, createdAt: serverTimestamp(), disabled: false
        });
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØ¨Ø«Ù‡Ø§"); location.reload();
    };

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    window.disableItem = async (t) => await updateDoc(doc(db, "Settings", t), { expiry: 0 });
    window.sendPopup = async () => {
        const text = document.getElementById('popText').value;
        const exp = document.getElementById('popExp').value;
        if(!text || !exp) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
        await setDoc(doc(db, "Settings", "loginPopup"), {
            id: "pop_"+Date.now(), message: text,
            type: document.getElementById('popType').value,
            duration: 10, expiry: new Date(exp).getTime()
        });
        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚");
    };
    window.sendStar = async () => {
        const text = document.getElementById('popText').value;
        const exp = document.getElementById('popExp').value;
        if(!text || !exp) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ù†Øµ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®");
        await setDoc(doc(db, "Settings", "broadcast"), {
            message: text, targetGender: "all", minAge: 0, maxAge: 100, expiry: new Date(exp).getTime()
        });
        alert("ØªÙ… Ø¨Ø« Ø§Ù„Ù†Ø¬Ù…Ø© â­");
    };

    // Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    window.approveReq = async (rid, uid, type, phone) => {
        if(type === "password_reset") await updateDoc(doc(db, "Users", uid), { resetMode: true });
        else await updateDoc(doc(db, "Users", uid), { phone: phone });
        await deleteDoc(doc(db, "Requests", rid));
        alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø«
    window.filterUsersMain = () => {
        const t = document.getElementById('uSearchMain').value.toLowerCase();
        renderUsers(allUsers.filter(u => u.fullName.toLowerCase().includes(t) || u.phone.includes(t)));
    };
    function renderUsers(arr) {
        const list = document.getElementById('usersList'); list.innerHTML = "";
        arr.forEach(u => {
            if(u.role === 'admin') return;
            list.innerHTML += `<div class="card-row">
                <div><b>${u.fullName}</b><br><small>${u.phone} | ${u.email}</small></div>
                <div>
                    <span class="perm-tag ${u.canAdd?'active':''}" onclick="updateP('${u.id}','canAdd',${u.canAdd})">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</span>
                    <span class="perm-tag ${u.role==='admin'?'active':''}" onclick="updateP('${u.id}','role','${u.role}')">Ù…Ø¯ÙŠØ±</span>
                </div>
            </div>`;
        });
    }
    window.updateP = async (uid, f, v) => {
        let n = f==='role' ? (v==='admin'?'user':'admin') : !v;
        await updateDoc(doc(db, "Users", uid), { [f]: n });
    };
</script>
</body>
</html>
