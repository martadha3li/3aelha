<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© âš™ï¸</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); padding: 20px; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .card { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        .flex { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .duplicate { border: 2px solid var(--danger); background: #fff5f5; }
        .btn { padding: 8px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; }
        .guardian-info { background: #eef2f7; padding: 8px; border-radius: 8px; margin-top: 10px; font-size: 13px; border-right: 3px solid var(--danger); }
        select { padding: 5px; border-radius: 5px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© âš™ï¸</h1>

    <section>
        <h2>ğŸ”‘ Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ÙˆØ§ØªØ³Ø§Ø¨)</h2>
        <div id="passReqs"></div>
    </section>

    <section>
        <h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØªØ­ÙƒÙ…</h2>
        <div id="usersList"></div>
    </section>

<script type="module">
    import { db } from './config.js';
    import { collection, onSnapshot, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    onSnapshot(collection(db, "Users"), snap => {
        const list = document.getElementById('usersList');
        list.innerHTML = "";
        const phoneCounts = {};
        const users = [];

        snap.forEach(d => {
            const u = {id: d.id, ...d.data()};
            if(u.role === 'admin') return;
            users.push(u);
            phoneCounts[u.phone] = (phoneCounts[u.phone] || 0) + 1;
        });

        users.forEach(u => {
            const isDup = phoneCounts[u.phone] > 1;
            const guardianHTML = (u.gender === 'female' && u.guardianName) ? 
                `<div class="guardian-info">ğŸ›¡ï¸ Ø§Ù„Ù…Ø¹Ø±Ù: ${u.guardianName} | ${u.guardianPhone}</div>` : "";

            list.innerHTML += `
                <div class="card ${isDup ? 'duplicate' : ''}">
                    <div class="flex">
                        <div>
                            <b>${u.fullName}</b> [${u.phone}] <br>
                            <small>Ø±ØªØ¨Ø© Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span style="color:blue">${u.role || 'user'}</span></small>
                        </div>
                        <div class="flex">
                            <select onchange="updateRole('${u.id}', this.value)">
                                <option value="">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</option>
                                <option value="user" ${u.role=='user'?'selected':''}>Ø¹Ø¶Ùˆ Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="editor" ${u.role=='editor'?'selected':''}>Ù…Ø­Ø±Ø± Ø£Ø®Ø¨Ø§Ø±</option>
                                <option value="moderator" ${u.role=='moderator'?'selected':''}>Ù…Ø´Ø±Ù Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                            </select>
                            <button class="btn" style="background:${u.status=='active'?'#e67e22':'#27ae60'}" onclick="toggleStatus('${u.id}','${u.status}')">${u.status=='active'?'ØªØ¹Ø·ÙŠÙ„':'ØªÙØ¹ÙŠÙ„'}</button>
                            <button class="btn" style="background:var(--danger)" onclick="deleteUser('${u.id}')">Ø­Ø°Ù</button>
                        </div>
                    </div>
                    ${guardianHTML}
                </div>`;
        });
    });

    // Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚)
    onSnapshot(collection(db, "Requests"), snap => {
        const res = document.getElementById('passReqs');
        res.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            res.innerHTML += `<div class="card flex">
                <span>Ø·Ù„Ø¨ Ù…Ù†: ${r.fullName}</span>
                <button class="btn" style="background:#25D366" onclick="approvePass('${d.id}','${r.uid}')">Ù…ÙˆØ§ÙÙ‚Ø© ÙˆÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>`;
        });
    });

    window.updateRole = async (id, newRole) => await updateDoc(doc(db, "Users", id), { role: newRole });
    window.toggleStatus = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s=='active'?'disabled':'active' });
    window.deleteUser = async (id) => { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) await deleteDoc(doc(db, "Users", id)); };
    
    window.approvePass = async (rid, uid) => {
        const temp = Math.floor(100000 + Math.random() * 900000).toString();
        const uSnap = await getDoc(doc(db, "Users", uid));
        const u = uSnap.data();
        await updateDoc(doc(db, "Users", uid), { tempPass: temp, resetMode: true });
        await deleteDoc(doc(db, "Requests", rid));
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${u.fullName}. Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯Ùƒ Ø§Ù„Ù…Ø¤Ù‚Øª: *${temp}*`;
        window.open(`https://wa.me/${u.phone}?text=${encodeURIComponent(msg)}`);
    };
</script>
</body>
</html>
