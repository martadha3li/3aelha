<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© | Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 950px; margin: auto; }
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); border-bottom: 4px solid var(--primary); }
        .stat-card h3 { font-size: 20px; color: var(--primary); margin: 5px 0; }
        .stat-card span { font-size: 11px; color: gray; font-weight: bold; }

        .quick-actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-quick { flex: 1; padding: 15px; border-radius: 15px; border: none; color: white; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; box-shadow: var(--shadow); }
        .btn-quick:hover { opacity: 0.9; transform: translateY(-2px); }

        .req-box { padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #bdf0c9; background: #f2fff5; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; }
        .req-box:hover { transform: scale(1.01); box-shadow: var(--shadow); }

        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; text-align: center; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 5000; align-items: center; justify-content: center; backdrop-filter: blur(5px); padding: 20px; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 25px; overflow: hidden; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { background: var(--primary); color: white; padding: 20px; text-align: center; }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .detail-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .detail-label { color: #8e8e93; font-weight: bold; }
        .modal-footer { padding: 20px; display: flex; gap: 10px; background: #f8f9fa; flex-wrap: wrap; }

        .btn-group { display: flex; gap: 5px; justify-content: center; }
        .mini-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; color: white; font-weight: bold; }
        .btn-activate { background: #34c759; color: white; flex: 1; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-delete { background: #ff3b30; color: white; width: 100%; border: none; padding: 12px; border-radius: 12px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        .role-badge { background: #eef6ff; color: var(--primary); padding: 3px 8px; border-radius: 8px; font-size: 11px; }
        .cat-tag { background: #f0f0f0; padding: 8px 12px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; margin: 5px; }
        .admin-card { cursor:pointer; display: flex; align-items: center; padding: 15px; background: #fff; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 0.5px solid #eee; }
    </style>
</head>
<body>
<script type="module" src="header.js"></script>
<script type="module" src="navbar.js"></script>
    

    <div class="admin-wrapper">
        <div class="stat-grid">
            <div class="stat-card"><h3 id="uCount">0</h3><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span></div>
            <div class="stat-card"><h3 id="mCount">0</h3><span>Ø§Ù„Ø°ÙƒÙˆØ± ğŸ‘¨</span></div>
            <div class="stat-card"><h3 id="fCount">0</h3><span>Ø§Ù„Ø¥Ù†Ø§Ø« ğŸ‘©</span></div>
            <div class="stat-card"><h3 id="maxAge">0</h3><span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø± ğŸ‘´</span></div>
            <div class="stat-card"><h3 id="minAge">0</h3><span>Ø£ØµØºØ± Ø¹Ù…Ø± ğŸ‘¶</span></div>
        </div>

        <div class="admin-card" onclick="location.href='admin_duas.html'">
            <div style="font-size: 24px; margin-left: 15px; background: #E5F1FF; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px;">ğŸ“–</div>
            <div style="flex-grow: 1; text-align: right;">
                <h3 style="margin: 0; font-size: 16px; color: #1c1c1e;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© ÙˆØ§Ù„Ø£Ø°ÙƒØ§Ø±</h3>
                <p style="margin: 5px 0 0; font-size: 12px; color: #8E8E93;">Ø¥Ø¶Ø§ÙØ© Ø£Ù‚Ø³Ø§Ù… Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ†Ø´Ø± Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© Ù„Ù„Ø¹Ø§Ø¦Ù„Ø©</p>
            </div>
            <div style="color: #007AFF; font-weight: bold;">â†</div>
        </div>

        <div class="admin-card" onclick="location.href='admin_prayer.html'">
            <div style="font-size: 24px; margin-left: 15px; background: #FFF9E5; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; border-radius: 12px;">ğŸ•Œ</div>
            <div style="flex-grow: 1; text-align: right;">
                <h3 style="margin: 0; font-size: 16px; color: #1c1c1e;">Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„ØµÙ„Ø§Ø©</h3>
                <p style="margin: 5px 0 0; font-size: 12px; color: #8E8E93;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ ÙˆÙƒØªØ§Ø¨Ø© Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„ÙŠÙˆÙ…</p>
            </div>
            <div style="color: #FFCC00; font-weight: bold;">â†</div>
        </div>

        <div class="admin-card" onclick="location.href='admin_chat_settings.html'">
    <div class="card-icon" style="background: #E5F1FF; color: #007AFF;">ğŸ’¬</div>
    <div class="card-info">
        <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
        <p>Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆÙØµÙ„ Ø§Ù„Ø¬Ù†Ø³ÙŠÙ†</p>
    </div>
    <div class="card-arrow">â†</div>
</div>

<style>
    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ±Øª Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø°ÙˆÙ‚ Ø¢ÙŠÙÙˆÙ† Ø§Ù„Ø°ÙŠ Ù†ØªØ¨Ø¹Ù‡ */
    .admin-card {
        background: white;
        padding: 15px;
        border-radius: 18px;
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 12px;
        cursor: pointer;
        border: 0.5px solid #eee;
        transition: 0.2s;
    }
    .admin-card:active { transform: scale(0.97); background: #f9f9f9; }
    .card-icon { width: 45px; height: 45px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .card-info { flex: 1; }
    .card-info h3 { margin: 0; font-size: 16px; color: #1c1c1e; }
    .card-info p { margin: 3px 0 0; font-size: 12px; color: #8e8e93; }
    .card-arrow { color: #c6c6c8; font-weight: bold; }
</style>

        
        <div class="quick-actions">
            <button onclick="location.href='admin_categories.html'" class="btn-quick" style="background: #5856d6;">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</button>
            <button onclick="location.href='admin_requests.html'" class="btn-quick" style="background: #ff9500;">ğŸ“¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
            <button onclick="location.href='admin_competitions.html'" class="btn-quick" style="background: #34c759;">ğŸ† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª</button>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©</h2></div>
            <div id="activationRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
                <button onclick="addNewCategory()" class="mini-btn" style="background:var(--primary)">+ Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ</button>
            </div>
            <div id="categoriesList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2></div>
            <input type="text" id="userSearch" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd; margin-bottom:15px;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterUsers()">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="section" style="background: #fff; padding: 20px; border-radius: 20px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
            <h2 style="font-size: 17px; color: #007aff; border-bottom: 1px solid #eee; padding-bottom: 10px;">ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ</h2>
            <div id="navControls" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª...
            </div>
        </div>
    </div>

    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <img id="mUserImg" src="" style="width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; object-fit: cover;">
                <h2 id="mUserName" style="margin: 10px 0 0 0; font-size: 18px;"></h2>
            </div>
            <div class="modal-body" id="mUserDetails"></div>
            <div class="modal-footer">
                <button id="btnAct" class="btn-activate">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…</button>
                <button onclick="document.getElementById('userModal').style.display='none'" style="flex:1; border:none; border-radius:12px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
                <button id="btnDel" class="btn-delete">Ø­Ø°Ù ğŸ—‘ï¸</button>
            </div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') location.href = 'news.html';
            initFullAdmin();
            initNavControls();
        } else location.href = 'index.html';
    });

    function initNavControls() {
        const navItems = [
            { id: 'showChat', label: 'Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ğŸ’¬' },
            { id: 'showDuas', label: 'Ø§Ù„Ø£Ø¯Ø¹ÙŠØ© ğŸ“–' },
            { id: 'showComps', label: 'Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ğŸ†' },
            { id: 'showPrayer', label: 'Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ğŸ•Œ' }
        ];

        onSnapshot(doc(db, "Settings", "AppConfig"), (docSnap) => {
            const controls = document.getElementById('navControls');
            controls.innerHTML = "";
            const data = docSnap.exists() ? docSnap.data() : {};

            navItems.forEach(item => {
                const status = data[item.id] !== false;
                const div = document.createElement('div');
                div.style = "display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f9f9f9;";
                div.innerHTML = `
                    <span style="font-weight: 600;">${item.label}</span>
                    <button onclick="window.toggleNav('${item.id}', ${status})" 
                            style="padding: 8px 15px; border-radius: 10px; border: none; background: ${status ? '#34C759' : '#8E8E93'}; color: white; cursor: pointer;">
                        ${status ? 'Ù…ÙØ¹Ù„Ø©' : 'Ù…Ø¹Ø·Ù„Ø©'}
                    </button>
                `;
                controls.appendChild(div);
            });
        });
    }

    window.toggleNav = async (field, currentStatus) => {
        await setDoc(doc(db, "Settings", "AppConfig"), { [field]: !currentStatus }, { merge: true });
    };

    function initFullAdmin() {
        onSnapshot(collection(db, "Users"), snap => {
            let male = 0, female = 0, ages = [];
            document.getElementById('uCount').innerText = snap.size;
            snap.forEach(u => {
                const d = u.data();
                if(d.gender === 'male') male++;
                if(d.gender === 'female') female++;
                if(d.age) ages.push(parseInt(d.age));
            });
            document.getElementById('mCount').innerText = male;
            document.getElementById('fCount').innerText = female;
            if(ages.length > 0) {
                document.getElementById('maxAge').innerText = Math.max(...ages);
                document.getElementById('minAge').innerText = Math.min(...ages);
            }
        });

        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), snap => {
            const cont = document.getElementById('activationRequests');
            cont.innerHTML = snap.empty ? '<p style="color:gray; font-size:12px; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p>' : "";
            snap.forEach(u => {
                const d = u.data();
                const div = document.createElement('div');
                div.className = 'req-box';
                div.onclick = () => showUserDetails(u.id, d);
                div.innerHTML = `<div><b>${d.fullName}</b></div> <span style="font-size:10px; color:var(--primary);">Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ”</span>`;
                cont.appendChild(div);
            });
        });

        onSnapshot(collection(db, "Users"), snap => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                tbody.innerHTML += `<tr>
                    <td>${d.fullName}</td><td>${d.phone}</td><td>${d.age || '--'}</td>
                    <td><span class="role-badge">${d.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                    <td style="color:${d.status === 'active' ? 'green' : 'red'}">${d.status}</td>
                    <td><div class="btn-group">
                        <button class="mini-btn" style="background:#007aff" onclick="editField('${u.id}', 'fullName')">âœï¸</button>
                        <button class="mini-btn" style="background:#ff9500" onclick="updateStatus('${u.id}', '${d.status === 'active' ? 'stopped' : 'active'}')">ğŸš«</button>
                        <button class="mini-btn" style="background:#ff3b30" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸</button>
                    </div></td>
                </tr>`;
            });
        });

        onSnapshot(collection(db, "Categories"), snap => {
            const cont = document.getElementById('categoriesList');
            cont.innerHTML = "";
            snap.forEach(c => {
                cont.innerHTML += `<div class="cat-tag">
                    <b>${c.data().name}</b> <span onclick="deleteCategory('${c.id}')" style="color:red; cursor:pointer;">âœ•</span>
                </div>`;
            });
        });
    }

    window.showUserDetails = (uid, data) => {
        const modal = document.getElementById('userModal');
        document.getElementById('mUserName').innerText = data.fullName;
        document.getElementById('mUserImg').src = data.profileImg || 'https://via.placeholder.com/80';
        document.getElementById('mUserDetails').innerHTML = `
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¬ÙˆØ§Ù„:</span> <span>${data.phone}</span></div>
            <div class="detail-row"><span class="detail-label">Ø§Ù„Ø¹Ù…Ø±:</span> <span>${data.age} Ø³Ù†Ø©</span></div>
        `;
        modal.style.display = 'flex';
        document.getElementById('btnAct').onclick = () => { updateStatus(uid, 'active', data.fullName); modal.style.display = 'none'; };
        document.getElementById('btnDel').onclick = () => { deleteUser(uid); modal.style.display = 'none'; };
    };

    window.updateStatus = async (uid, s, name = "") => {
        await updateDoc(doc(db, "Users", uid), { status: s });
        if(s === 'active' && name !== "") {
            await addDoc(collection(db, "Chats"), {
                senderId: auth.currentUser.uid,
                receiverId: uid,
                message: `Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ ${name}! ØªÙ… ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. ğŸŒ¸`,
                timestamp: serverTimestamp()
            });
            alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ âœ…");
        }
    };

    window.deleteUser = async (id) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await deleteDoc(doc(db, "Users", id)); };
    window.deleteCategory = async (id) => { await deleteDoc(doc(db, "Categories", id)); };
    window.editField = async (id, field) => { const val = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:"); if(val) await updateDoc(doc(db, "Users", id), { [field]: val }); };
    window.addNewCategory = async () => {
        const n = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:");
        if(n) await addDoc(collection(db, "Categories"), { name: n });
    };
    window.filterUsers = () => {
        const val = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('#usersTableBody tr').forEach(tr => tr.style.display = tr.innerText.toLowerCase().includes(val) ? "" : "none");
    };
</script>
</body>
</html>
