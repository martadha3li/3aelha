<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© | Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 900px; margin: auto; }
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); border-bottom: 4px solid var(--primary); }
        .stat-card h3 { font-size: 22px; color: var(--primary); margin: 5px 0; }

        /* Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .req-box { padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; }
        .req-phone { background: #eef6ff; border-color: #bcd9ff; }
        .req-pass { background: #fff1f1; border-color: #ffcccc; }
        .req-role { background: #fff9e6; border-color: #ffeeba; }
        .req-activation { background: #f2fff5; border-color: #bdf0c9; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø­Ø« */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; text-align: center; }

        .btn-group { display: flex; gap: 5px; justify-content: center; }
        .mini-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; color: white; font-weight: bold; }
        .role-badge { background: #eef6ff; color: var(--primary); padding: 3px 8px; border-radius: 8px; font-size: 11px; }
        .cat-tag { background: #f0f0f0; padding: 8px 12px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; margin: 5px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
            <b style="font-size: 16px;">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ù†ØµØ©</b>
        </div>
        <img src="logo.png" style="height: 35px; border-radius: 5px;">
    </div>

    <div class="admin-wrapper">
        <div class="stat-grid">
            <div class="stat-card"><h3 id="uCount">0</h3><span>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span></div>
            <div class="stat-card"><h3 id="nCount">0</h3><span>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</span></div>
            <div class="stat-card"><h3 id="rCount">0</h3><span>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ› ï¸ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†</h2></div>
            <div id="adminTeamList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2></div>
            <div id="activationRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¬ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ©</h2></div>
            <div id="mixedRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</h2>
                <button onclick="addNewCategory()" class="mini-btn" style="background:var(--primary)">+ Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="categoriesList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2></div>
            <input type="text" id="userSearch" class="form-input" style="width:100%; margin-bottom:15px;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterUsers()">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') location.href = 'news.html';
            initFullAdmin();
        } else location.href = 'index.html';
    });

    function initFullAdmin() {
        // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        onSnapshot(collection(db, "Users"), s => document.getElementById('uCount').innerText = s.size);
        onSnapshot(collection(db, "News"), s => document.getElementById('nCount').innerText = s.size);

        // ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø©
        onSnapshot(query(collection(db, "Users"), where("role", "in", ["admin", "editor"])), snap => {
            const cont = document.getElementById('adminTeamList');
            cont.innerHTML = "";
            snap.forEach(u => {
                if(u.id === auth.currentUser.uid) return;
                cont.innerHTML += `<div class="req-box" style="background:#f8f9fa;">
                    <div><b>${u.data().fullName}</b> <span class="role-badge">${u.data().role}</span></div>
                    <button class="mini-btn" style="background:var(--accent)" onclick="location.href='chat.html?target=${u.id}'">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                </div>`;
            });
        });

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„
        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), snap => {
            const cont = document.getElementById('activationRequests');
            cont.innerHTML = snap.empty ? '<p style="color:gray; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>' : "";
            snap.forEach(u => {
                cont.innerHTML += `<div class="req-box req-activation">
                    <div><b>${u.data().fullName}</b> (${u.data().phone})</div>
                    <button class="mini-btn" style="background:#34c759" onclick="updateStatus('${u.id}', 'active')">ØªÙØ¹ÙŠÙ„ âœ…</button>
                </div>`;
            });
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø¬ÙˆØ§Ù„ØŒ Ø¨Ø§Ø³ÙˆØ±Ø¯ØŒ ØµÙ„Ø§Ø­ÙŠØ§Øª)
        const reqs = ["PhoneRequests", "PasswordRequests", "RoleRequests"];
        const mixedCont = document.getElementById('mixedRequests');
        mixedCont.innerHTML = "";
        reqs.forEach(col => {
            onSnapshot(collection(db, col), snap => {
                snap.forEach(r => {
                    const d = r.data();
                    let info = col === "PhoneRequests" ? `ØªØºÙŠÙŠØ± Ø¬ÙˆØ§Ù„ Ø¥Ù„Ù‰: ${d.newPhone}` : 
                               col === "PasswordRequests" ? `Ø·Ù„Ø¨ Ø¨Ø§Ø³ÙˆØ±Ø¯: ${d.requestedPass}` : `ØªØ±Ù‚ÙŠØ© Ù„Ù€: ${d.requestedRole}`;
                    let cls = col === "PhoneRequests" ? "req-phone" : col === "PasswordRequests" ? "req-pass" : "req-role";
                    
                    mixedCont.innerHTML += `<div class="req-box ${cls}">
                        <div><b>${d.userName}</b><br><small>${info}</small></div>
                        <div class="btn-group">
                            <button class="mini-btn" style="background:var(--primary)" onclick="approveAny('${col}', '${r.id}', '${d.userId}', '${d.newPhone || d.requestedPass || d.requestedRole}')">Ù‚Ø¨ÙˆÙ„</button>
                            <button class="mini-btn" style="background:var(--danger)" onclick="deleteDoc(doc(db, '${col}', '${r.id}'))">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
                });
            });
        });

        // Ø¬Ø¯ÙˆÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø«
        onSnapshot(collection(db, "Users"), snap => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                tbody.innerHTML += `<tr>
                    <td>${d.fullName}</td><td>${d.phone}</td>
                    <td><span class="role-badge">${d.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                    <td style="color:${d.status === 'active' ? 'green' : 'red'}">${d.status}</td>
                    <td><div class="btn-group">
                        <button class="mini-btn" style="background:#007aff" onclick="editAny('${u.id}', 'fullName', 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯')">âœï¸</button>
                        <button class="mini-btn" style="background:#ff9500" onclick="updateStatus('${u.id}', '${d.status === 'active' ? 'stopped' : 'active'}')">ğŸš«</button>
                        <button class="mini-btn" style="background:#ff3b30" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸</button>
                    </div></td>
                </tr>`;
            });
        });

        // Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        onSnapshot(collection(db, "Categories"), snap => {
            const cont = document.getElementById('categoriesList');
            cont.innerHTML = "";
            snap.forEach(c => {
                cont.innerHTML += `<div class="cat-tag" title="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${c.data().defaultTitle}">
                    <b>${c.data().name}</b> <span onclick="deleteDoc(doc(db, 'Categories', '${c.id}'))" style="color:red; cursor:pointer;">âœ•</span>
                </div>`;
            });
        });
    }

    // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© ---
    window.updateStatus = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s });
    window.deleteUser = async (id) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await deleteDoc(doc(db, "Users", id)); };
    window.editAny = async (id, field, msg) => { const val = prompt(msg); if(val) await updateDoc(doc(db, "Users", id), { [field]: val }); };
    
    window.approveAny = async (col, reqId, uid, val) => {
        const field = col === "PhoneRequests" ? "phone" : col === "PasswordRequests" ? "tempPassword" : "role";
        await updateDoc(doc(db, "Users", uid), { [field]: val });
        await deleteDoc(doc(db, col, reqId));
        alert("ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ù†Ø¬Ø§Ø­.");
    };

    window.addNewCategory = async () => {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:");
        const def = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø®Ø¨Ø±:");
        if(name) await addDoc(collection(db, "Categories"), { name, defaultTitle: def || "" });
    };

    window.filterUsers = () => {
        const val = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('#usersTableBody tr').forEach(tr => {
            tr.style.display = (tr.innerText.toLowerCase().includes(val)) ? "" : "none";
        });
    };
</script>
</body>
</html>
