<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© | Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */
        .user-card { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; }
        .perm-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
        .perm-item { font-size: 12px; display: flex; align-items: center; gap: 5px; }
        
        .group-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #fff; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 8px; }
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 12px; }
        .btn-del { background: var(--danger); }
        .btn-toggle { background: #f39c12; }
        input, select { padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin: 5px 0; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© âš™ï¸</h1>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h2>
        <div id="adminGroupsList"></div>
        <hr>
        <h4>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©</h4>
        <input type="text" id="groupName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
        <input type="datetime-local" id="expiryTime">
        <button class="btn" style="background:var(--primary)" id="btnCreateGroup">Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ­ÙØ¸</button>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ğŸ‘¥</h2>
        <div id="usersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') window.location.href = "news.html";
            init();
        }
    });

    function init() {
        loadUsers();
        loadGroups();
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡Ù…
    function loadUsers() {
        onSnapshot(collection(db, "Users"), (snap) => {
            const list = document.getElementById('usersList');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(u.role === 'admin' && d.id === auth.currentUser.uid) return;

                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between">
                        <b>${u.fullName} (${u.phone})</b>
                        <span style="color:blue">${u.role === 'admin' ? 'Ù…Ø¯ÙŠØ± ÙƒØ§Ù…Ù„' : 'Ø¹Ø¶Ùˆ'}</span>
                    </div>
                    <div class="perm-grid">
                        <label class="perm-item"><input type="checkbox" ${u.canAdd ? 'checked' : ''} onchange="updatePerm('${d.id}', 'canAdd', this.checked)"> Ø¥Ø¶Ø§ÙØ© Ø£Ø®Ø¨Ø§Ø±</label>
                        <label class="perm-item"><input type="checkbox" ${u.canEdit ? 'checked' : ''} onchange="updatePerm('${d.id}', 'canEdit', this.checked)"> ØªØ¹Ø¯ÙŠÙ„ Ø£Ø®Ø¨Ø§Ø±</label>
                        <label class="perm-item"><input type="checkbox" ${u.canDelete ? 'checked' : ''} onchange="updatePerm('${d.id}', 'canDelete', this.checked)"> Ø­Ø°Ù Ø£Ø®Ø¨Ø§Ø±</label>
                        <label class="perm-item" style="color:red; font-weight:bold;"><input type="checkbox" ${u.role === 'admin' ? 'checked' : ''} onchange="updatePerm('${d.id}', 'role', this.checked ? 'admin' : 'user')"> ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø¯ÙŠØ±</label>
                    </div>
                `;
                list.appendChild(card);
            });
        });
    }

    window.updatePerm = async (uid, field, value) => {
        await updateDoc(doc(db, "Users", uid), { [field]: value });
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø­Ø°Ù ÙˆØªØ¹Ø·ÙŠÙ„)
    function loadGroups() {
        onSnapshot(collection(db, "TempGroups"), (snap) => {
            const list = document.getElementById('adminGroupsList');
            list.innerHTML = "";
            snap.forEach(d => {
                const g = d.data();
                const card = document.createElement('div');
                card.className = 'group-card';
                card.innerHTML = `
                    <div>
                        <b>${g.name}</b><br>
                        <small>ÙŠÙ†ØªÙ‡ÙŠ: ${new Date(g.expiry).toLocaleString()}</small>
                    </div>
                    <div>
                        <button class="btn btn-toggle" onclick="toggleGroup('${d.id}', ${g.disabled})">${g.disabled ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„ Ù…Ø¤Ù‚Øª'}</button>
                        <button class="btn btn-del" onclick="deleteGroup('${d.id}')">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                    </div>
                `;
                list.appendChild(card);
            });
        });
    }

    window.toggleGroup = async (id, status) => { await updateDoc(doc(db, "TempGroups", id), { disabled: !status }); };
    window.deleteGroup = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŸ")) await deleteDoc(doc(db, "TempGroups", id)); };

    document.getElementById('btnCreateGroup').onclick = async () => {
        const name = document.getElementById('groupName').value;
        const exp = document.getElementById('expiryTime').value;
        if(name && exp) {
            await addDoc(collection(db, "TempGroups"), { name, expiry: new Date(exp).getTime(), disabled: false });
            alert("ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡");
        }
    };
</script>
</body>
</html>
