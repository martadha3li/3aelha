<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .back-btn { background: #ddd; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .request-card { border-right: 8px solid #f1c40f; background: #fffdf0; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <button class="back-btn" onclick="location.href='news.html'">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h1>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ğŸ“±</h2>
        <div id="requestsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ğŸ‘¥</h2>
        <div id="usersList"></div>
    </section>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "Users", user.uid));
                if (snap.data().role !== 'admin') window.location.href = "news.html";
                loadRequests();
                loadUsers();
            }
        });

        function loadRequests() {
            onSnapshot(collection(db, "Requests"), (snap) => {
                const list = document.getElementById('requestsList');
                list.innerHTML = snap.empty ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹." : "";
                snap.forEach(async (d) => {
                    const r = d.data();
                    const uSnap = await getDoc(doc(db, "Users", r.uid));
                    const u = uSnap.data();
                    const age = new Date().getFullYear() - new Date(u.dob).getFullYear();

                    list.innerHTML += `
                    <div class="request-card">
                        <b>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</b> ${u.fullName} (${u.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'})<br>
                        <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${u.email || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}<br>
                        <b>Ø§Ù„Ø¹Ù…Ø±:</b> ${age} Ø³Ù†Ø©<br>
                        <p>ØªØºÙŠÙŠØ± Ù…Ù† <b>${r.currentPhone}</b> â¬…ï¸ Ø¥Ù„Ù‰ <b>${r.requestedPhone}</b></p>
                        ${u.gender === 'female' ? `<p style="color:red"><b>Ø§Ù„Ù…Ø¹Ø±Ù:</b> ${u.guardianName} - ${u.guardianPhone}</p>` : ''}
                        <button class="btn" style="background:var(--accent)" onclick="approve('${d.id}', '${r.uid}', '${r.requestedPhone}')">Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªØ­Ø¯ÙŠØ«</button>
                        <button class="btn" style="background:var(--danger)" onclick="reject('${d.id}')">Ø±ÙØ¶</button>
                    </div>`;
                });
            });
        }

        window.approve = async (rid, uid, phone) => {
            await updateDoc(doc(db, "Users", uid), { phone: phone });
            await deleteDoc(doc(db, "Requests", rid));
            alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¨Ù†Ø¬Ø§Ø­");
        };

        window.reject = async (rid) => { await deleteDoc(doc(db, "Requests", rid)); };
    </script>
</body>
</html>
