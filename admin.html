<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --warning: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); padding: 15px; margin: 0; }
        
        .container { max-width: 1100px; margin: auto; }
        .header-box { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-right: 5px solid transparent; }
        .section-pending { border-right-color: var(--warning); }
        .section-requests { border-right-color: #3498db; }
        .section-users { border-right-color: var(--accent); }

        h2 { font-size: 1.1rem; color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 10px; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card-row { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; transition: 0.3s; }
        .card-row:hover { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…ÙƒØ±Ø± Ø¨Ø§Ù„Ø£Ø­Ù…Ø± */
        .duplicate { background: #ffdada !important; border-color: var(--danger) !important; animation: blink 2s infinite; }
        @keyframes blink { 50% { border-color: transparent; } }

        .btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .btn-active { background: var(--accent); }
        .btn-disable { background: var(--danger); }
        .btn-whatsapp { background: #25D366; }
        .btn-primary { background: var(--primary); }

        .info-group { display: flex; flex-direction: column; gap: 3px; }
        .info-group b { font-size: 15px; color: #333; }
        .info-group small { color: #666; font-size: 12px; }
        
        .admin-edit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input { padding: 12px; border-radius: 10px; border: 1px solid #ddd; outline: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <h1 style="margin:0; font-size: 1.4rem; color: var(--primary);">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© âš™ï¸</h1>
        <button class="btn btn-primary" onclick="location.href='news.html'">ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    </div>

    <section>
        <h2>ğŸ‘¤ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨ÙŠ (Ø§Ù„Ù…Ø¯ÙŠØ±)</h2>
        <div class="admin-edit-grid">
            <input type="text" id="adminName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <input type="password" id="adminPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="btn btn-primary" onclick="updateAdminProfile()">ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
        </div>
    </section>

    <section class="section-pending">
        <h2>â³ Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªÙØ¹ÙŠÙ„</h2>
        <div id="activationList"></div>
    </section>

    <section class="section-requests">
        <h2>ğŸ”‘ Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <div id="passwordRequests"></div>
    </section>

    <section class="section-users">
        <h2>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ø£Ø­Ù…Ø± = Ù…ÙƒØ±Ø±)</h2>
        <div id="usersList"></div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„ØªÙØ¹ÙŠÙ„ ÙˆÙƒØ´Ù Ø§Ù„Ù…ÙƒØ±Ø±) ---
    onSnapshot(collection(db, "Users"), (snap) => {
        const list = document.getElementById('usersList');
        const actList = document.getElementById('activationList');
        list.innerHTML = ""; 
        actList.innerHTML = "";
        
        const phoneCounts = {};
        const users = [];

        snap.forEach(d => {
            const u = { id: d.id, ...d.data() };
            if (u.role === 'admin') return;
            users.push(u);
            phoneCounts[u.phone] = (phoneCounts[u.phone] || 0) + 1;
        });

        users.forEach(u => {
            const isDuplicate = phoneCounts[u.phone] > 1;
            const cardHTML = `
                <div class="card-row ${isDuplicate ? 'duplicate' : ''}">
                    <div class="info-group">
                        <b>${u.fullName}</b>
                        <small>ğŸ“± ${u.phone} | ğŸ“§ ${u.email}</small>
                        <small>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${u.dob || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</small>
                    </div>
                    <div style="display:flex; gap:8px;">
                        <button class="btn ${u.status === 'active' ? 'btn-disable' : 'btn-active'}" 
                                onclick="toggleUserStatus('${u.id}', '${u.status}')">
                            ${u.status === 'active' ? 'ğŸš« ØªØ¹Ø·ÙŠÙ„' : 'âœ… ØªÙØ¹ÙŠÙ„'}
                        </button>
                    </div>
                </div>`;

            if (u.status === 'pending') {
                actList.innerHTML += cardHTML;
            }
            list.innerHTML += cardHTML;
        });
    });

    // --- Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---
    onSnapshot(collection(db, "Requests"), (snap) => {
        const res = document.getElementById('passwordRequests');
        res.innerHTML = "";
        snap.forEach(d => {
            const r = d.data();
            res.innerHTML += `
                <div class="card-row">
                    <div class="info-group">
                        <b>Ø·Ù„Ø¨ Ù…Ù†: ${r.fullName}</b>
                        <small>Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨: Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</small>
                    </div>
                    <button class="btn btn-whatsapp" onclick="approveAndSendPass('${d.id}', '${r.uid}')">
                        ğŸ”“ Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯
                    </button>
                </div>`;
        });
    });

    // --- ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ø³ÙˆÙˆØ±Ø¯ ÙˆØ¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ---
    window.approveAndSendPass = async (requestId, userId) => {
        const tempPass = Math.floor(100000 + Math.random() * 900000).toString(); // ØªÙˆÙ„ÙŠØ¯ 6 Ø£Ø±Ù‚Ø§Ù…
        const uSnap = await getDoc(doc(db, "Users", userId));
        const u = uSnap.data();

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ²
        await updateDoc(doc(db, "Users", userId), { 
            tempPass: tempPass, 
            resetMode: true 
        });

        // Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
        await deleteDoc(doc(db, "Requests", requestId));

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø®ØµØµ
        const genderTitle = u.gender === 'female' ? 'Ø§Ù„Ø£Ø®Øª Ø§Ù„Ù…Ø¹Ø±ÙØ©' : 'Ø§Ù„Ø£Ø®';
        const msg = `Ù…Ø±Ø­Ø¨Ø§Ù‹ ${genderTitle} ${u.fullName}%0AÙ„Ù‚Ø¯ ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨Ùƒ.%0AÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù‡ÙŠ: *${tempPass}*%0AÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØªØºÙŠÙŠØ±Ù‡Ø§ ÙÙˆØ±Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„.`;
        
        window.open(`https://wa.me/${u.phone}?text=${msg}`, '_blank');
    };

    // --- ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù†Ø´Ø·/Ù…Ø¹Ø·Ù„) ---
    window.toggleUserStatus = async (id, currentStatus) => {
        const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
        await updateDoc(doc(db, "Users", id), { status: newStatus });
    };

    // --- ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± ---
    window.updateAdminProfile = async () => {
        const newName = document.getElementById('adminName').value;
        const newPass = document.getElementById('adminPass').value;
        const user = auth.currentUser;

        if (newName) await updateDoc(doc(db, "Users", user.uid), { fullName: newName });
        if (newPass) await updatePassword(user, newPass);
        
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­.");
    };

</script>
</body>
</html>
