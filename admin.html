<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 600px; margin: auto; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); border-bottom: 3px solid var(--primary); }
        .stat-card h3 { font-size: 22px; color: var(--primary); margin: 5px 0; }
        .stat-card span { font-size: 11px; color: var(--text-muted); font-weight: bold; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        .section-header h2 { font-size: 15px; margin: 0; color: var(--text-main); }

        /* Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */
        .admin-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .user-meta { display: flex; align-items: center; gap: 10px; }
        .user-meta img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #eee; }
        .user-name { font-size: 13px; font-weight: bold; }
        .user-role { font-size: 10px; background: #eef6ff; color: var(--primary); padding: 2px 8px; border-radius: 10px; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª */
        .action-btns { display: flex; gap: 5px; }
        .btn-chat { background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 8px; font-size: 11px; cursor: pointer; }
        .btn-action { background: #f0f0f0; color: #333; border: none; padding: 5px 10px; border-radius: 8px; font-size: 11px; cursor: pointer; }

        /* Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */
        .req-box { background: #fff9e6; border: 1px solid #ffeeba; padding: 12px; border-radius: 15px; margin-bottom: 10px; }
        .req-info { font-size: 12px; margin-bottom: 10px; }
        .req-btns { display: flex; gap: 10px; }
        .btn-ok { background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 8px; font-weight: bold; }
        .btn-no { background: var(--danger); color: white; border: none; padding: 6px 15px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
            <b style="font-size: 16px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØµØ©</b>
        </div>
        <img src="logo.png" style="height: 35px; border-radius: 5px;">
    </div>

    <div class="admin-wrapper">
        <div class="stat-grid">
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3><span id="newsCount">0</span></div>
            <div class="stat-card"><h3>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3><span id="catCount">0</span></div>
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3><span id="usersCount">0</span></div>
            <div class="stat-card"><h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><span id="reqCount">0</span></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©</h2></div>
            <div id="requestsContainer">
                <p style="text-align:center; color:gray; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>
            </div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ› ï¸ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„</h2></div>
            <div id="teamContainer"></div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
                <button class="btn-action" onclick="addCategory()">+ Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="catsContainer" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø©: Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') {
                alert("ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø¯ÙŠØ± ÙÙ‚Ø·!");
                location.href = 'news.html';
            }
            startAdminListeners();
        } else { location.href = 'index.html'; }
    });

    function startAdminListeners() {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        onSnapshot(collection(db, "News"), s => document.getElementById('newsCount').innerText = s.size);
        onSnapshot(collection(db, "Categories"), s => document.getElementById('catCount').innerText = s.size);
        onSnapshot(collection(db, "Users"), s => document.getElementById('usersCount').innerText = s.size);
        onSnapshot(collection(db, "RoleRequests"), s => document.getElementById('reqCount').innerText = s.size);

        // ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        onSnapshot(collection(db, "RoleRequests"), snap => {
            const cont = document.getElementById('requestsContainer');
            if(snap.empty) { cont.innerHTML = '<p style="text-align:center; color:gray; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>'; return; }
            cont.innerHTML = "";
            snap.forEach(r => {
                const req = r.data();
                cont.innerHTML += `
                    <div class="req-box">
                        <div class="req-info">ğŸ‘¤ <b>${req.userName}</b> ÙŠØ·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ©: <b>${req.requestedRole}</b></div>
                        <div class="req-btns">
                            <button class="btn-ok" onclick="handleRoleReq('${r.id}', '${req.userId}', '${req.requestedRole}', true)">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                            <button class="btn-no" onclick="handleRoleReq('${r.id}', null, null, false)">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });

        // ØªØ­Ù…ÙŠÙ„ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø§Ù„Ù…Ø¯Ø±Ø§Ø¡ ÙˆØ§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†)
        const teamQ = query(collection(db, "Users"), where("role", "in", ["admin", "editor"]));
        onSnapshot(teamQ, snap => {
            const cont = document.getElementById('teamContainer');
            cont.innerHTML = "";
            snap.forEach(u => {
                const user = u.data();
                if(u.id === auth.currentUser.uid) return;
                cont.innerHTML += `
                    <div class="admin-list-item">
                        <div class="user-meta">
                            <img src="${user.profileImg || 'https://via.placeholder.com/35'}">
                            <div>
                                <div class="user-name">${user.fullName}</div>
                                <div class="user-role">${user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…Ø­Ø±Ø±'}</div>
                            </div>
                        </div>
                        <button class="btn-chat" onclick="location.href='chat.html?target=${u.id}'">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                    </div>`;
            });
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        onSnapshot(collection(db, "Categories"), snap => {
            const cont = document.getElementById('catsContainer');
            cont.innerHTML = "";
            snap.forEach(c => {
                cont.innerHTML += `<span class="user-role" style="background:#eee; color:#333;">${c.data().name} <b onclick="delCat('${c.id}')" style="color:red; cursor:pointer; margin-right:5px;">âœ•</b></span>`;
            });
        });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    window.handleRoleReq = async (id, uid, role, ok) => {
        if(ok) await updateDoc(doc(db, "Users", uid), { role: role });
        await deleteDoc(doc(db, "RoleRequests", id));
        alert(ok ? "ØªÙ…Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
    };

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
    window.addCategory = async () => {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if(name) await addDoc(collection(db, "Categories"), { name: name });
    };
    window.delCat = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙØŸ")) await deleteDoc(doc(db, "Categories", id)); };
</script>
</body>
</html>
