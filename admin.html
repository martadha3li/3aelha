<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --blue: #3498db; --pink: #ff69b4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .container { max-width: 1100px; margin: auto; }
        
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; margin-bottom: 15px; font-size: 1.1rem; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 24px; font-weight: bold; display: block; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„ØµÙÙˆÙ */
        .card-row { background: #f9f9f9; padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .duplicate { background: #ffdada !important; border-color: #e74c3c; }

        /* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 13px; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        
        .perm-tag { font-size: 10px; padding: 4px 8px; border-radius: 4px; background: #ddd; cursor: pointer; }
        .perm-tag.active { background: var(--accent); color: white; }
    </style>
</head>
<body>

<div class="container">
    <button class="btn btn-primary" onclick="location.href='news.html'">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    
    <section style="background: #eef2f3;">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±) ğŸ‘¤</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            <input type="text" id="adminNewName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">
            <input type="password" id="adminNewPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
            <button class="btn btn-primary" onclick="window.updateAdminProfile()">ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
        </div>
    </section>

    <div class="stats-grid">
        <div class="stat-card" style="border-bottom: 4px solid var(--blue);"><span id="mCount" class="stat-num">0</span><span>Ø°ÙƒÙˆØ±</span></div>
        <div class="stat-card" style="border-bottom: 4px solid var(--pink);"><span id="fCount" class="stat-num">0</span><span>Ø¥Ù†Ø§Ø«</span></div>
        <div class="stat-card"> <span id="maxAge" class="stat-num">0</span><span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø±</span></div>
        <div class="stat-card"> <span id="minAge" class="stat-num">0</span><span>Ø£ØµØºØ± Ø¹Ù…Ø±</span></div>
    </div>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ğŸ“¥</h2>
        <div id="requestsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>
    </section>

    <section style="background: #f0fdf4;">
        <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¤Ù‚ØªØ© ğŸ‘¥</h2>
        <input type="text" id="gName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©">
        <input type="datetime-local" id="gExp">
        <select id="gTarget" onchange="toggleGSearch(this.value)"><option value="all">Ù„Ù„Ø¬Ù…ÙŠØ¹</option><option value="specific">Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø­Ø¯Ø¯ÙŠÙ†</option></select>
        <div id="gSearchArea" style="display:none; padding:10px; background:white; border-radius:10px; margin-top:5px;">
            <input type="text" id="uSearchG" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„..." oninput="searchGUsers()">
            <div id="gResults"></div>
            <div id="gSelected" style="margin-top:10px;"></div>
        </div>
        <button class="btn btn-accent" style="width:100%; margin-top:10px;" onclick="createGroup()">Ø¨Ø« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
    </section>

    <section style="background: #eef7ff;">
        <h2>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Pop-up) ÙˆØ§Ù„Ù†Ø¬Ù…Ø© â­</h2>
        <textarea id="notifText" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±..."></textarea>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-primary" onclick="sendNotif('popup')">ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø± Ù…Ù†Ø¨Ø«Ù‚</button>
            <button class="btn btn-accent" onclick="sendNotif('star')">ØªÙØ¹ÙŠÙ„ Ù†Ø¬Ù…Ø© â­</button>
        </div>
        <div id="activeItems" style="margin-top:10px;"></div>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø§Ù„Ø£Ø­Ù…Ø± = Ù…ÙƒØ±Ø±) ğŸ‘¤</h2>
        <input type="text" id="mainSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ù„..." oninput="filterUsers()">
        <div id="usersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, setDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    let allUsers = [], selectedUIDs = [];

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role === 'admin') initAdmin();
            else window.location.href = "news.html";
        }
    });

    // 1. ØªØ­Ø¯ÙŠØ« Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±
    window.updateAdminProfile = async () => {
        const name = document.getElementById('adminNewName').value;
        const pass = document.getElementById('adminNewPass').value;
        if(name) await updateDoc(doc(db, "Users", auth.currentUser.uid), { fullName: name });
        if(pass) await updatePassword(auth.currentUser, pass);
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
    };

    function initAdmin() {
        // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙƒØ´Ù Ø§Ù„Ù…ÙƒØ±Ø±
        onSnapshot(collection(db, "Users"), (snap) => {
            allUsers = []; let m=0, f=0, ages=[], counts={};
            snap.forEach(d => {
                const u = {id: d.id, ...d.data()}; allUsers.push(u);
                if(u.gender === 'male') m++; else f++;
                if(u.dob) ages.push(new Date().getFullYear() - new Date(u.dob).getFullYear());
                counts[u.phone] = (counts[u.phone] || 0) + 1;
            });
            document.getElementById('mCount').innerText = m;
            document.getElementById('fCount').innerText = f;
            document.getElementById('maxAge').innerText = ages.length ? Math.max(...ages) : 0;
            document.getElementById('minAge').innerText = ages.length ? Math.min(...ages) : 0;
            renderUsers(allUsers, counts);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        onSnapshot(collection(db, "Requests"), snap => {
            const list = document.getElementById('requestsList'); list.innerHTML = "";
            snap.forEach(async d => {
                const r = d.data(); const u = (await getDoc(doc(db, "Users", r.uid))).data();
                list.innerHTML += `<div class="card-row"><span><b>${u.fullName}</b>: ${r.type}</span>
                <button class="btn btn-accent" onclick="approveReq('${d.id}','${r.uid}','${r.type}','${r.requestedPhone}')">Ù…ÙˆØ§ÙÙ‚Ø©</button></div>`;
            });
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
        onSnapshot(doc(db, "Settings", "active"), s => { /* Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù */ });
    }

    // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
    function renderUsers(arr, counts) {
        const list = document.getElementById('usersList'); list.innerHTML = "";
        arr.forEach(u => {
            if(u.role === 'admin' && u.id === auth.currentUser.uid) return;
            const isDup = counts[u.phone] > 1;
            list.innerHTML += `<div class="card-row ${isDup?'duplicate':''}">
                <div><b>${u.fullName}</b><br><small>${u.phone} | ${u.status}</small></div>
                <div>
                    <span class="perm-tag ${u.status==='active'?'active':''}" onclick="updateStatus('${u.id}','${u.status}')">ØªÙØ¹ÙŠÙ„</span>
                    <span class="perm-tag ${u.canAdd?'active':''}" onclick="updatePerm('${u.id}','canAdd',${u.canAdd})">Ø¥Ø¶Ø§ÙØ©</span>
                    <span class="perm-tag ${u.role==='admin'?'active':''}" onclick="updatePerm('${u.id}','role','${u.role}')">Ù…Ø¯ÙŠØ±</span>
                </div>
            </div>`;
        });
    }

    window.updateStatus = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s==='active'?'disabled':'active' });
    window.updatePerm = async (id, f, v) => await updateDoc(doc(db, "Users", id), { [f]: (f==='role'?(v==='admin'?'user':'admin'):!v) });
    
    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
    window.sendNotif = async (type) => {
        const text = document.getElementById('notifText').value;
        const path = type === 'popup' ? "loginPopup" : "broadcast";
        await setDoc(doc(db, "Settings", path), { 
            message: text, expiry: Date.now() + 86400000, id: Date.now(), 
            targetGender: 'all', minAge: 0, maxAge: 100 
        });
        alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„");
    };

    window.approveReq = async (rid, uid, type, phone) => {
        if(type==='password_reset') await updateDoc(doc(db, "Users", uid), { resetMode: true });
        else await updateDoc(doc(db, "Users", uid), { phone: phone });
        await deleteDoc(doc(db, "Requests", rid));
        alert("ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°");
    };

    // Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ Ù„ØªØ¹Ù…Ù„ 100%)
    window.toggleGSearch = (v) => document.getElementById('gSearchArea').style.display = v==='specific'?'block':'none';
    window.filterUsers = () => { /* ÙÙ„ØªØ±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */ };
</script>
</body>
</html>
