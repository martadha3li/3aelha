<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 800px; margin: auto; }
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        .request-item { background: #fdfdfd; border: 1px solid #eee; padding: 12px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .cat-tag { background: #eef6ff; padding: 8px 15px; border-radius: 12px; font-size: 13px; display: flex; align-items: center; gap: 10px; border: 1px solid #d0e3ff; }
        .btn-action-ok { background: var(--accent); color: white; border: none; padding: 6px 15px; border-radius: 10px; font-weight: bold; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 12px; border-bottom: 1px solid #f5f5f5; text-align: center; }
        .role-badge { background: #f0f0f0; padding: 2px 8px; border-radius: 8px; font-size: 11px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
            <b>Ù…Ø±ÙƒØ² Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ…</b>
        </div>
        <img src="logo.png" style="height: 35px; border-radius: 5px;">
    </div>

    <div class="admin-wrapper">
        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
                <button class="btn-action-ok" onclick="addNewCategory()">+ Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ</button>
            </div>
            <div id="categoriesList" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯</h2></div>
            <div id="activationRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ› ï¸ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h2></div>
            <div id="adminTeamList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2></div>
            <input type="text" id="userSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." onkeyup="filterUsers()" class="form-input" style="width:100%; margin-bottom:15px;">
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') { location.href = 'news.html'; }
            initAdmin();
        } else { location.href = 'index.html'; }
    });

    function initAdmin() {
        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        onSnapshot(collection(db, "Categories"), snap => {
            const cont = document.getElementById('categoriesList');
            cont.innerHTML = "";
            snap.forEach(c => {
                const d = c.data();
                cont.innerHTML += `<div class="cat-tag" title="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: ${d.defaultTitle || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}">
                    <b>${d.name}</b> <span onclick="delCat('${c.id}')" style="color:red; cursor:pointer;">âœ•</span>
                </div>`;
            });
        });

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„
        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), snap => {
            const cont = document.getElementById('activationRequests');
            cont.innerHTML = snap.empty ? '<p style="font-size:12px; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : "";
            snap.forEach(u => {
                cont.innerHTML += `<div class="request-item">
                    <div><b>${u.data().fullName}</b></div>
                    <button class="btn-action-ok" onclick="updateUserStatus('${u.id}', 'active')">ØªÙØ¹ÙŠÙ„</button>
                </div>`;
            });
        });

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        onSnapshot(collection(db, "Users"), snap => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                tbody.innerHTML += `<tr>
                    <td>${d.fullName}</td>
                    <td>${d.phone}</td>
                    <td><span class="role-badge">${d.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                    <td><button onclick="editRole('${u.id}')" style="border:none; background:none; cursor:pointer;">âš™ï¸</button></td>
                </tr>`;
            });
        });
    }

    window.addNewCategory = async () => {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if(!name) return;
        const defTitle = prompt(`Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù€ (${name}):`, "Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§...");
        await addDoc(collection(db, "Categories"), { name, defaultTitle: defTitle || "", createdAt: serverTimestamp() });
    };

    window.delCat = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "Categories", id)); };
    window.updateUserStatus = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s });
    window.editRole = async (id) => {
        const r = prompt("Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (admin / editor / user):");
        if(r) await updateDoc(doc(db, "Users", id), { role: r });
    };
</script>
</body>
</html>
