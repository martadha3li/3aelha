<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; border-bottom: 3px solid var(--primary); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; }
        .btn-ok { background: var(--accent); color: white; border: none; padding: 5px 10px; border-radius: 8px; cursor: pointer; }
        .cat-tag { background: #eef6ff; padding: 5px 10px; border-radius: 10px; font-size: 12px; margin: 5px; display: inline-block; }
    </style>
</head>
<body>

    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
        <b>Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„</b>
        <img src="logo.png" style="height: 35px;">
    </div>

    <div style="padding: 15px; max-width: 800px; margin: auto;">
        
        <div class="stat-grid">
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3><span id="uCount">0</span></div>
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3><span id="nCount">0</span></div>
        </div>

        <div class="admin-section">
            <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</h2>
            <button class="btn-ok" onclick="addCat()">+ Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ</button>
            <div id="catsList" style="margin-top:10px;"></div>
        </div>

        <div class="admin-section">
            <h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
            <div id="pendingList"></div>
        </div>

        <div class="admin-section">
            <h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø«</h2>
            <input type="text" id="uSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„..." onkeyup="searchUsers()" style="width:100%; padding:10px; border-radius:10px; border:1px solid #ddd;">
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="uTable"></tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const s = await getDoc(doc(db, "Users", user.uid));
            if (s.data().role !== 'admin') location.href='news.html';
            initAdmin();
        } else location.href='index.html';
    });

    function initAdmin() {
        onSnapshot(collection(db, "Users"), s => document.getElementById('uCount').innerText = s.size);
        onSnapshot(collection(db, "News"), s => document.getElementById('nCount').innerText = s.size);

        // Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        onSnapshot(collection(db, "Categories"), s => {
            const cont = document.getElementById('catsList'); cont.innerHTML = "";
            s.forEach(c => { cont.innerHTML += `<div class="cat-tag">${c.data().name} <b onclick="delCat('${c.id}')" style="color:red; cursor:pointer;">âœ•</b></div>`; });
        });

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„
        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), s => {
            const cont = document.getElementById('pendingList'); cont.innerHTML = s.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª" : "";
            s.forEach(u => { cont.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                <span>${u.data().fullName}</span> <button class="btn-ok" onclick="updateStatus('${u.id}', 'active')">ØªÙØ¹ÙŠÙ„</button>
            </div>`; });
        });

        // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        onSnapshot(collection(db, "Users"), s => {
            const tbody = document.getElementById('uTable'); tbody.innerHTML = "";
            s.forEach(u => {
                const d = u.data();
                tbody.innerHTML += `<tr>
                    <td>${d.fullName}</td><td>${d.phone}</td><td>${d.role || 'Ø¹Ø¶Ùˆ'}</td>
                    <td><button onclick="editUser('${u.id}')">âš™ï¸</button> <button onclick="delUser('${u.id}')" style="color:red">ğŸ—‘ï¸</button></td>
                </tr>`;
            });
        });
    }

    window.addCat = async () => {
        const n = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:");
        const t = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ:");
        if(n) await addDoc(collection(db, "Categories"), { name: n, defaultTitle: t || "" });
    };
    window.delCat = async (id) => { if(confirm("Ø­Ø°ÙØŸ")) await deleteDoc(doc(db, "Categories", id)); };
    window.updateStatus = async (id, st) => await updateDoc(doc(db, "Users", id), { status: st });
    window.delUser = async (id) => { if(confirm("Ø­Ø°Ù Ø§Ù„Ø¹Ø¶ÙˆØŸ")) await deleteDoc(doc(db, "Users", id)); };
    window.editUser = async (id) => {
        const r = prompt("Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (admin/editor/user):");
        if(r) await updateDoc(doc(db, "Users", id), { role: r });
    };
    window.searchUsers = () => {
        const val = document.getElementById('uSearch').value;
        const rows = document.querySelectorAll('#uTable tr');
        rows.forEach(r => r.style.display = r.cells[1].innerText.includes(val) ? "" : "none");
    };
</script>
</body>
</html>
