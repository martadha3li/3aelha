<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة الإدارة</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .user-card { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 5px; border-radius: 8px; }
        .duplicate { background: #ffdada !important; border: 1px solid red; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-size: 12px; }
    </style>
</head>
<body>

    <button onclick="location.href='news.html'">⬅️ عودة</button>
    <h1>لوحة التحكم المركزية ⚙️</h1>

    <section id="statsArea" style="display:flex; justify-content:space-around; text-align:center;">
        <div><h2 id="mCount">0</h2><small>ذكور</small></div>
        <div><h2 id="fCount">0</h2><small>إناث</small></div>
    </section>

    <section>
        <h2>طلبات معلقة</h2>
        <div id="requestsList"></div>
    </section>

    <section>
        <h2>إدارة الأعضاء (الأحمر = جوال مكرر)</h2>
        <input type="text" id="uSearch" placeholder="بحث بالاسم أو الجوال..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:10px; border:1px solid #ddd;">
        <div id="usersList"></div>
    </section>

    <script type="module">
        import { auth, db } from './config.js';
        import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let allUsers = [];

        onSnapshot(collection(db, "Users"), snap => {
            allUsers = [];
            let m=0, f=0;
            const counts = {};
            snap.forEach(d => {
                const u = {id: d.id, ...d.data()};
                allUsers.push(u);
                if(u.gender === 'male') m++; else f++;
                counts[u.phone] = (counts[u.phone] || 0) + 1;
            });
            document.getElementById('mCount').innerText = m;
            document.getElementById('fCount').innerText = f;
            renderUsers(allUsers, counts);
        });

        function renderUsers(arr, counts) {
            const list = document.getElementById('usersList');
            list.innerHTML = "";
            arr.forEach(u => {
                const isDup = counts[u.phone] > 1;
                const div = document.createElement('div');
                div.className = `user-card ${isDup ? 'duplicate' : ''}`;
                div.innerHTML = `
                    <div><b>${u.fullName}</b><br><small>${u.phone} | ${u.status}</small></div>
                    <div>
                        <button class="btn" style="background:orange" onclick="toggleStatus('${u.id}', '${u.status}')">تغيير الحالة</button>
                        <button class="btn" style="background:var(--primary)" onclick="makeAdmin('${u.id}', '${u.role}')">مدير/عضو</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        window.toggleStatus = async (id, s) => {
            const ns = s === 'active' ? 'disabled' : 'active';
            await updateDoc(doc(db, "Users", id), { status: ns });
        };

        window.makeAdmin = async (id, r) => {
            const nr = r === 'admin' ? 'user' : 'admin';
            await updateDoc(doc(db, "Users", id), { role: nr });
        };

        // إدارة الطلبات
        onSnapshot(collection(db, "Requests"), snap => {
            const res = document.getElementById('requestsList');
            res.innerHTML = "";
            snap.forEach(async d => {
                const r = d.data();
                const u = (await getDoc(doc(db, "Users", r.uid))).data();
                res.innerHTML += `<div class="user-card"><span><b>${u.fullName}</b> طلب باسوورد</span><button class="btn" style="background:green" onclick="deleteDoc(doc(db, 'Requests', '${d.id}'))">تم التواصل</button></div>`;
            });
        });
    </script>
</body>
</html>
