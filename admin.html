<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© | Ù…Ø±ÙƒØ² Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 950px; margin: auto; }
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±Ø© */
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); border-bottom: 4px solid var(--primary); }
        .stat-card h3 { font-size: 20px; color: var(--primary); margin: 5px 0; }
        .stat-card span { font-size: 11px; color: gray; font-weight: bold; }

        /* Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù„ÙˆÙ†Ø© */
        .req-box { padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid transparent; display: flex; justify-content: space-between; align-items: center; }
        .req-phone { background: #eef6ff; border-color: #bcd9ff; }
        .req-pass { background: #fff1f1; border-color: #ffcccc; }
        .req-role { background: #fff9e6; border-color: #ffeeba; }
        .req-activation { background: #f2fff5; border-color: #bdf0c9; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø­Ø« */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th { background: #f8f9fa; padding: 12px; border-bottom: 2px solid #eee; }
        td { padding: 12px; border-bottom: 1px solid #f5f5f5; text-align: center; }

        .btn-group { display: flex; gap: 5px; justify-content: center; }
        .mini-btn { padding: 6px 12px; border-radius: 8px; border: none; font-size: 11px; cursor: pointer; color: white; font-weight: bold; }
        .role-badge { background: #eef6ff; color: var(--primary); padding: 3px 8px; border-radius: 8px; font-size: 11px; }
        .cat-tag { background: #f0f0f0; padding: 8px 12px; border-radius: 12px; font-size: 12px; display: inline-flex; align-items: center; gap: 8px; margin: 5px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
            <b style="font-size: 16px;">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…Ù†ØµØ©</b>
        </div>
        <img src="logo.png" style="height: 35px; border-radius: 5px;">
    </div>

    <div class="admin-wrapper">
        <div class="stat-grid">
            <div class="stat-card"><h3 id="uCount">0</h3><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span></div>
            <div class="stat-card"><h3 id="mCount">0</h3><span>Ø§Ù„Ø°ÙƒÙˆØ± ğŸ‘¨</span></div>
            <div class="stat-card"><h3 id="fCount">0</h3><span>Ø§Ù„Ø¥Ù†Ø§Ø« ğŸ‘©</span></div>
            <div class="stat-card"><h3 id="maxAge">0</h3><span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø± ğŸ‘´</span></div>
            <div class="stat-card"><h3 id="minAge">0</h3><span>Ø£ØµØºØ± Ø¹Ù…Ø± ğŸ‘¶</span></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ› ï¸ ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù…Ø­Ø±Ø±ÙŠÙ†</h2></div>
            <div id="adminTeamList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2></div>
            <div id="activationRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¬ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØ±Ù‚ÙŠØ©</h2></div>
            <div id="mixedRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†</h2>
                <button onclick="addNewCategory()" class="mini-btn" style="background:var(--primary)">+ Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="categoriesList"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ‘¥ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2></div>
            <input type="text" id="userSearch" class="form-input" style="width:100%; margin-bottom:15px;" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…..." onkeyup="filterUsers()">
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬ÙˆØ§Ù„</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
                    </thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') location.href = 'news.html';
            initFullAdmin();
        } else location.href = 'index.html';
    });

    function initFullAdmin() {
        // --- ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠØ© Ø­ÙŠØ§Ù‹ ---
        onSnapshot(collection(db, "Users"), snap => {
            let male = 0, female = 0, ages = [];
            document.getElementById('uCount').innerText = snap.size;
            
            snap.forEach(u => {
                const d = u.data();
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ù†Ø³
                if(d.gender === 'male') male++;
                if(d.gender === 'female') female++;
                // Ø¬Ù…Ø¹ Ø§Ù„Ø£Ø¹Ù…Ø§Ø±
                if(d.age) ages.push(parseInt(d.age));
            });

            document.getElementById('mCount').innerText = male;
            document.getElementById('fCount').innerText = female;
            
            if(ages.length > 0) {
                document.getElementById('maxAge').innerText = Math.max(...ages);
                document.getElementById('minAge').innerText = Math.min(...ages);
            }
        });

        // --- ÙØ±ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
        onSnapshot(query(collection(db, "Users"), where("role", "in", ["admin", "editor"])), snap => {
            const cont = document.getElementById('adminTeamList');
            cont.innerHTML = "";
            snap.forEach(u => {
                if(u.id === auth.currentUser.uid) return;
                cont.innerHTML += `<div class="req-box" style="background:#f8f9fa;">
                    <div><b>${u.data().fullName}</b> <span class="role-badge">${u.data().role}</span></div>
                    <button class="mini-btn" style="background:var(--accent)" onclick="location.href='chat.html?target=${u.id}'">ğŸ’¬ Ø¯Ø±Ø¯Ø´Ø©</button>
                </div>`;
            });
        });

        // --- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ ---
        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), snap => {
            const cont = document.getElementById('activationRequests');
            cont.innerHTML = snap.empty ? '<p style="color:gray; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</p>' : "";
            snap.forEach(u => {
                cont.innerHTML += `<div class="req-box req-activation">
                    <div><b>${u.data().fullName}</b> (${u.data().phone})</div>
                    <button class="mini-btn" style="background:#34c759" onclick="updateStatus('${u.id}', 'active')">ØªÙØ¹ÙŠÙ„ âœ…</button>
                </div>`;
            });
        });

        // --- Ø¬Ø¯ÙˆÙ„ ÙƒØ§ÙØ© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ø¨Ø­Ø« ---
        onSnapshot(collection(db, "Users"), snap => {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                tbody.innerHTML += `<tr>
                    <td>${d.fullName}</td><td>${d.phone}</td><td>${d.age || '--'}</td>
                    <td><span class="role-badge">${d.role || 'Ø¹Ø¶Ùˆ'}</span></td>
                    <td style="color:${d.status === 'active' ? 'green' : 'red'}">${d.status}</td>
                    <td><div class="btn-group">
                        <button class="mini-btn" style="background:#007aff" onclick="editAny('${u.id}', 'fullName', 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯')">âœï¸</button>
                        <button class="mini-btn" style="background:#ff9500" onclick="updateStatus('${u.id}', '${d.status === 'active' ? 'stopped' : 'active'}')">ğŸš«</button>
                        <button class="mini-btn" style="background:#ff3b30" onclick="deleteUser('${u.id}')">ğŸ—‘ï¸</button>
                    </div></td>
                </tr>`;
            });
        });

        // --- Ø¨Ù‚ÙŠØ© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚) ---
        // ... (ÙƒÙˆØ¯ PhoneRequests, PasswordRequests, Categories ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©)
    }

    // --- Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© ---
    window.updateStatus = async (id, s) => await updateDoc(doc(db, "Users", id), { status: s });
    window.deleteUser = async (id) => { if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) await deleteDoc(doc(db, "Users", id)); };
    window.editAny = async (id, field, msg) => { const val = prompt(msg); if(val) await updateDoc(doc(db, "Users", id), { [field]: val }); };
    
    window.addNewCategory = async () => {
        const name = prompt("Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:");
        const def = prompt("Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø®Ø¨Ø±:");
        if(name) await addDoc(collection(db, "Categories"), { name, defaultTitle: def || "" });
    };

    window.filterUsers = () => {
        const val = document.getElementById('userSearch').value.toLowerCase();
        document.querySelectorAll('#usersTableBody tr').forEach(tr => {
            tr.style.display = (tr.innerText.toLowerCase().includes(val)) ? "" : "none";
        });
    };
</script>
</body>
</html>
