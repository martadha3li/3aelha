<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 650px; margin: auto; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 20px; text-align: center; box-shadow: var(--shadow); border-bottom: 3px solid var(--primary); }
        .stat-card h3 { font-size: 22px; color: var(--primary); margin: 5px 0; }
        
        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .admin-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 15px; }
        .section-header h2 { font-size: 15px; margin: 0; color: var(--text-main); }

        /* Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø§Øª */
        .request-item { padding: 12px; border-radius: 15px; margin-bottom: 10px; border: 1px solid transparent; }
        .req-phone { background: #eef6ff; border-color: #bcd9ff; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„Ø¬ÙˆØ§Ù„ */
        .req-pass { background: #fff1f1; border-color: #ffcccc; } /* Ø£Ø­Ù…Ø± Ù„Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ */
        .req-role { background: #fff9e6; border-color: #ffeeba; } /* Ø£ØµÙØ± Ù„Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */

        .req-info { font-size: 12px; margin-bottom: 8px; line-height: 1.5; }
        .req-btns { display: flex; gap: 8px; }
        .btn-action-ok { background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 11px; cursor: pointer; }
        .btn-action-no { background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 8px; font-weight: bold; font-size: 11px; cursor: pointer; }

        /* Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª */
        .cat-tag { background: #f0f0f0; padding: 5px 12px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 8px; }
        .cat-del { color: red; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='news.html'" style="border:none; background:none; font-size:22px;">ğŸ </button>
            <b style="font-size: 16px;">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
        </div>
        <img src="logo.png" style="height: 35px; border-radius: 5px;">
    </div>

    <div class="admin-wrapper">
        <div class="stat-grid">
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3><span id="usersCount">0</span></div>
            <div class="stat-card"><h3>Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h3><span id="newsCount">0</span></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“± Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h2></div>
            <div id="phoneRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ”‘ Ø·Ù„Ø¨Ø§Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2></div>
            <div id="passRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h2></div>
            <div id="roleRequests"></div>
        </div>

        <div class="admin-section">
            <div class="section-header">
                <h2>ğŸ“ Ø¥Ø¯Ø§Ø±Ø© ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
                <button class="btn-action-ok" onclick="addNewCategory()">+ Ø¥Ø¶Ø§ÙØ©</button>
            </div>
            <div id="categoriesList" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') { location.href = 'news.html'; }
            initAdminDashboard();
        } else { location.href = 'index.html'; }
    });

    function initAdminDashboard() {
        // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        onSnapshot(collection(db, "Users"), s => document.getElementById('usersCount').innerText = s.size);
        onSnapshot(collection(db, "News"), s => document.getElementById('newsCount').innerText = s.size);

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
        onSnapshot(collection(db, "PhoneRequests"), snap => {
            const cont = document.getElementById('phoneRequests');
            cont.innerHTML = snap.empty ? '<p style="font-size:12px; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : "";
            snap.forEach(r => {
                const data = r.data();
                cont.innerHTML += `
                    <div class="request-item req-phone">
                        <div class="req-info">ğŸ‘¤ <b>${data.userName}</b><br>ÙŠØ±ÙŠØ¯ ØªØºÙŠÙŠØ± Ø±Ù‚Ù…Ù‡ Ø¥Ù„Ù‰: <b>${data.newPhone}</b></div>
                        <div class="req-btns">
                            <button class="btn-action-ok" onclick="approvePhone('${r.id}', '${data.userId}', '${data.newPhone}')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬ÙˆØ§Ù„ âœ…</button>
                            <button class="btn-action-no" onclick="rejectReq('PhoneRequests', '${r.id}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });

        // Ø·Ù„Ø¨Ø§Øª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        onSnapshot(collection(db, "PasswordRequests"), snap => {
            const cont = document.getElementById('passRequests');
            cont.innerHTML = snap.empty ? '<p style="font-size:12px; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : "";
            snap.forEach(r => {
                const data = r.data();
                cont.innerHTML += `
                    <div class="request-item req-pass">
                        <div class="req-info">ğŸ‘¤ <b>${data.userName}</b><br>ÙŠØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©: <b>${data.requestedPass}</b></div>
                        <div class="req-btns">
                            <button class="btn-action-ok" onclick="approvePass('${r.id}', '${data.userId}', '${data.requestedPass}')">ØªØºÙŠÙŠØ± Ø§Ù„Ø¢Ù† âœ…</button>
                            <button class="btn-action-no" onclick="rejectReq('PasswordRequests', '${r.id}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });

        // Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
        onSnapshot(collection(db, "RoleRequests"), snap => {
            const cont = document.getElementById('roleRequests');
            cont.innerHTML = snap.empty ? '<p style="font-size:12px; color:gray;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : "";
            snap.forEach(r => {
                const data = r.data();
                cont.innerHTML += `
                    <div class="request-item req-role">
                        <div class="req-info">ğŸ‘¤ <b>${data.userName}</b> ÙŠØ·Ù„Ø¨ Ø±ØªØ¨Ø©: <b>${data.requestedRole}</b></div>
                        <div class="req-btns">
                            <button class="btn-action-ok" onclick="approveRole('${r.id}', '${data.userId}', '${data.requestedRole}')">ØªØ±Ù‚ÙŠØ© âœ…</button>
                            <button class="btn-action-no" onclick="rejectReq('RoleRequests', '${r.id}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
        onSnapshot(collection(db, "Categories"), snap => {
            const cont = document.getElementById('categoriesList');
            cont.innerHTML = "";
            snap.forEach(c => {
                cont.innerHTML += `<div class="cat-tag">${c.data().name} <span class="cat-del" onclick="delCategory('${c.id}')">âœ•</span></div>`;
            });
        });
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°
    window.approvePhone = async (reqId, uid, phone) => {
        await updateDoc(doc(db, "Users", uid), { phone: phone });
        await deleteDoc(doc(db, "PhoneRequests", reqId));
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„.");
    };

    window.approvePass = async (reqId, uid, pass) => {
        // Ù…Ù„Ø§Ø­Ø¸Ø©: ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ø¨Ø±Ù…Ø¬ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙŠØªØ·Ù„Ø¨ Ø¯ÙˆØ§Ù„ Ø³Ø­Ø§Ø¨ÙŠØ©ØŒ Ù‡Ù†Ø§ Ù†Ø­Ø¯Ø«Ù‡ ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠØ±Ø§Ù‡ Ø§Ù„Ø¹Ø¶Ùˆ
        await updateDoc(doc(db, "Users", uid), { tempPassword: pass });
        await deleteDoc(doc(db, "PasswordRequests", reqId));
        alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¶Ùˆ.");
    };

    window.approveRole = async (reqId, uid, role) => {
        await updateDoc(doc(db, "Users", uid), { role: role });
        await deleteDoc(doc(db, "RoleRequests", reqId));
        alert("ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©.");
    };

    window.rejectReq = async (col, id) => {
        if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø±ÙØ¶ ÙˆØ­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) await deleteDoc(doc(db, col, id));
    };

    window.addNewCategory = async () => {
        const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
        if(name) await addDoc(collection(db, "Categories"), { name, createdAt: serverTimestamp() });
    };

    window.delCategory = async (id) => {
        if(confirm("Ø­Ø°Ù Ø§Ù„ØªØµÙ†ÙŠÙØŸ")) await deleteDoc(doc(db, "Categories", id));
    };
</script>
</body>
</html>
