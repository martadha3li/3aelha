<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© | Ø§Ù„Ù…Ø¯ÙŠØ±</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --warning: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        h1 { text-align: center; color: var(--primary); margin-bottom: 30px; border-bottom: 3px solid var(--primary); padding-bottom: 10px; }
        
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); font-size: 1.2rem; margin-top: 0; border-right: 4px solid var(--accent); padding-right: 10px; }

        /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø´Ø¨ÙƒÙŠØ© */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        
        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¯Ø®Ù„Ø§Øª */
        input, textarea, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); }
        
        /* Ù…ÙØ§ØªÙŠØ­ Ø§Ù„ØªØ­ÙƒÙ… (Toggles) */
        .toggle-box { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; color: white; }
        
        /* Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
        .data-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .request-card { border: 1px solid #ffeeba; background: #fffcf0; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© âš™ï¸</h1>

    <section>
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ğŸ› ï¸</h2>
        <div class="grid">
            <div class="toggle-box">
                <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª (Likes)</span>
                <button id="toggleLikes" class="btn">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
            </div>
            <div class="toggle-box">
                <span>ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª (Comments)</span>
                <button id="toggleComments" class="btn">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
            </div>
            <div class="toggle-box">
                <span>ØªÙØ¹ÙŠÙ„ Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</span>
                <button id="toggleShare" class="btn">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</button>
            </div>
            <div class="toggle-box">
                <span>Ù†Ù…Ø· Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</span>
                <select id="viewTypeSelect" style="width: auto; margin: 0;">
                    <option value="mobile">Ø¬ÙˆØ§Ù„</option>
                    <option value="desktop">ÙƒÙ…Ø¨ÙŠÙˆØªØ±</option>
                </select>
            </div>
        </div>
    </section>

    <div class="grid">
        <section>
            <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø± ğŸ“°</h2>
            <input type="text" id="newsTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
            <textarea id="newsBody" rows="3" placeholder="Ù†Øµ Ø§Ù„Ø®Ø¨Ø± Ø§Ù„ÙƒØ§Ù…Ù„..."></textarea>
            <select id="newsCatSelect"></select>
            <button class="btn btn-primary" id="btnPostNews" style="width:100%">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¢Ù†</button>
            <hr>
            <input type="text" id="newCatInput" placeholder="Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ Ø¬Ø¯ÙŠØ¯">
            <button class="btn btn-accent" id="btnAddCat" style="width:100%">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØµÙ†ÙŠÙ</button>
        </section>

        <section>
            <h2>ØªÙˆØ§ØµÙ„ ÙˆØ¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø­Ø¸ÙŠØ© ğŸ“¢</h2>
            <input type="text" id="notifText" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ">
            <select id="notifType">
                <option value="urgent">Ø¹Ø§Ø¬Ù„ (Ø£Ø­Ù…Ø±)</option>
                <option value="medium">Ù…ØªÙˆØ³Ø· (Ø£Ø²Ø±Ù‚)</option>
                <option value="normal">Ø¹Ø§Ø¯ÙŠ (Ø£Ø¨ÙŠØ¶)</option>
            </select>
            <input type="number" id="notifDuration" placeholder="Ø§Ù„Ù…Ø¯Ø© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ">
            <button class="btn btn-danger" id="btnSendNotif" style="width:100%">Ø¨Ø« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
            <hr>
            <input type="text" id="groupName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©">
            <input type="datetime-local" id="expiryTime">
            <button class="btn" style="background:#6f42c1; width:100%" id="btnCreateGroup">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ù…Ø¤Ù‚ØªØ©</button>
        </section>
    </div>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ğŸ“±</h2>
        <div id="requestsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
    </section>

    <section>
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ğŸ‘¥</h2>
        <div id="usersList">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...</div>
    </section>

    <div style="text-align:center; padding: 20px;">
        <button class="btn btn-primary" onclick="location.href='news.html'">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    </div>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let settings = { likesEnabled: true, shareEnabled: true, commentsEnabled: true };

    // --- Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± ---
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (!snap.exists() || snap.data().role !== 'admin') {
                window.location.href = "news.html";
            } else {
                initAdmin();
            }
        } else { window.location.href = "index.html"; }
    });

    function initAdmin() {
        loadSettings();
        loadCategories();
        loadUsers();
        loadRequests();
    }

    // --- 1. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª ---
    async function loadSettings() {
        onSnapshot(doc(db, "Settings", "global"), (snap) => {
            if(snap.exists()) {
                settings = snap.data();
                updateToggleUI('toggleLikes', settings.likesEnabled);
                updateToggleUI('toggleComments', settings.commentsEnabled);
                updateToggleUI('toggleShare', settings.shareEnabled);
            }
        });
    }

    function updateToggleUI(id, isEnabled) {
        const btn = document.getElementById(id);
        btn.innerText = isEnabled ? "Ù…ÙØ¹Ù„ (Ø¥ÙŠÙ‚Ø§Ù)" : "Ù…Ø¹Ø·Ù„ (ØªÙØ¹ÙŠÙ„)";
        btn.className = isEnabled ? "btn btn-accent" : "btn btn-danger";
    }

    async function toggleSetting(field) {
        settings[field] = !settings[field];
        await setDoc(doc(db, "Settings", "global"), settings, {merge: true});
    }

    document.getElementById('toggleLikes').onclick = () => toggleSetting('likesEnabled');
    document.getElementById('toggleComments').onclick = () => toggleSetting('commentsEnabled');
    document.getElementById('toggleShare').onclick = () => toggleSetting('shareEnabled');

    // --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„Ø£Ø®Ø¨Ø§Ø± ---
    function loadCategories() {
        onSnapshot(collection(db, "Categories"), (snap) => {
            const select = document.getElementById('newsCatSelect');
            select.innerHTML = "";
            snap.forEach(d => {
                select.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`;
            });
        });
    }

    document.getElementById('btnAddCat').onclick = async () => {
        const name = document.getElementById('newCatInput').value;
        if(name) { await addDoc(collection(db, "Categories"), { name }); document.getElementById('newCatInput').value = ""; }
    };

    document.getElementById('btnPostNews').onclick = async () => {
        const title = document.getElementById('newsTitle').value;
        const body = document.getElementById('newsBody').value;
        const cat = document.getElementById('newsCatSelect').value;
        if(title && body) {
            await addDoc(collection(db, "News"), { title, body, cat, likes: 0, likedBy: [], date: serverTimestamp() });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById('newsTitle').value = ""; document.getElementById('newsBody').value = "";
        }
    };

    // --- 3. Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
    document.getElementById('btnSendNotif').onclick = async () => {
        const text = document.getElementById('notifText').value;
        const type = document.getElementById('notifType').value;
        const dur = parseInt(document.getElementById('notifDuration').value);
        if(text && dur) {
            await addDoc(collection(db, "Notifications"), { 
                text, type, duration: dur, createdAt: serverTimestamp(), 
                expiry: Date.now() + (dur * 1000) 
            });
            alert("ØªÙ… Ø§Ù„Ø¨Ø«!");
        }
    };

    document.getElementById('btnCreateGroup').onclick = async () => {
        const name = document.getElementById('groupName').value;
        const exp = document.getElementById('expiryTime').value;
        if(name && exp) {
            await addDoc(collection(db, "TempGroups"), { name, expiry: new Date(exp).getTime() });
            alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©!");
        }
    };

    // --- 4. Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ ---
    function loadRequests() {
        onSnapshot(collection(db, "Requests"), (snap) => {
            const list = document.getElementById('requestsList');
            list.innerHTML = "";
            snap.forEach(d => {
                const r = d.data();
                if(r.status === 'pending') {
                    list.innerHTML += `
                    <div class="request-card">
                        <strong>Ø·Ù„Ø¨ Ù…Ù† UID: ${r.
