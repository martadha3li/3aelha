<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; font-size: 1.2rem; }
        .request-card { border: 1px solid #ddd; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-right: 8px solid #f1c40f; }
        .user-meta { font-size: 0.9rem; color: #555; background: #f9f9f9; padding: 10px; border-radius: 8px; margin: 10px 0; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; margin-left: 5px; }
        .btn-accent { background: var(--accent); }
        .btn-danger { background: var(--danger); }
        input, select, textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ± âš™ï¸</h1>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ğŸ“±</h2>
        <div id="requestsList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª...</div>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h2>
        <input type="text" id="newsTitle" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
        <textarea id="newsBody" placeholder="Ø§Ù„Ù…Ø­ØªÙˆÙ‰"></textarea>
        <button class="btn btn-accent" id="btnPost">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±</button>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
        <div id="usersList"></div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') window.location.href = "news.html";
            init();
        }
    });

    function init() {
        loadRequests();
        loadUsers();
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¹ Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ
    function loadRequests() {
        onSnapshot(collection(db, "Requests"), (snap) => {
            const list = document.getElementById('requestsList');
            list.innerHTML = snap.empty ? "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©." : "";
            snap.forEach(async (d) => {
                const r = d.data();
                const uSnap = await getDoc(doc(db, "Users", r.uid));
                const u = uSnap.data();
                const age = new Date().getFullYear() - new Date(u.dob).getFullYear();

                const card = document.createElement('div');
                card.className = 'request-card';
                card.style.borderRightColor = u.gender === 'male' ? '#3498db' : '#ff69b4';
                card.innerHTML = `
                    <div class="user-meta">
                        <b>Ø§Ù„Ø§Ø³Ù…:</b> ${u.fullName} (${u.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'})<br>
                        <b>Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</b> ${u.email || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}<br>
                        <b>Ø§Ù„Ø¹Ù…Ø±:</b> ${age} Ø³Ù†Ø©<br>
                        ${u.gender === 'female' ? `<b style="color:#e91e63">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø±Ù:</b> ${u.guardianName} - ${u.guardianPhone}` : ''}
                    </div>
                    <p>Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ù…Ù† <b>${r.currentPhone}</b> Ø¥Ù„Ù‰ <b style="color:green">${r.requestedPhone}</b></p>
                    <button class="btn btn-accent" onclick="approveReq('${d.id}', '${r.uid}', '${r.requestedPhone}')">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¢Ù†</button>
                    <button class="btn btn-danger" onclick="rejectReq('${d.id}')">Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨</button>
                `;
                list.appendChild(card);
            });
        });
    }

    window.approveReq = async (id, uid, phone) => {
        await updateDoc(doc(db, "Users", uid), { phone: phone });
        await deleteDoc(doc(db, "Requests", id));
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­");
    };

    window.rejectReq = async (id) => {
        await deleteDoc(doc(db, "Requests", id));
    };

    function loadUsers() { /* ÙƒÙˆØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚ */ }
    document.getElementById('btnPost').onclick = async () => { /* ÙƒÙˆØ¯ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ */ };
</script>
</body>
</html>
