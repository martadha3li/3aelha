<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --pink: #ff69b4; --blue: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; margin-bottom: 20px; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-num { font-size: 24px; font-weight: bold; display: block; }
        
        /* Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø¹Ø¶Ø§Ø¡ */
        .search-box { margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 12px; border-radius: 25px; border: 1px solid #ddd; outline: none; }
        .user-row { display: flex; flex-wrap: wrap; gap: 10px; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; align-items: center; border: 1px solid #eee; }
        .perm-tag { font-size: 11px; padding: 4px 8px; border-radius: 5px; background: #eee; cursor: pointer; }
        .perm-tag.active { background: var(--accent); color: white; }

        /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© */
        .broadcast-box { background: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; }
        
        input, textarea, select { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <button onclick="location.href='news.html'" style="margin-bottom:20px; padding:10px; cursor:pointer; border-radius:8px; border:none;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h1>

    <div class="stats-grid">
        <div class="stat-card" style="border-bottom: 4px solid var(--blue);">
            <span class="stat-num" id="maleCount">0</span>
            <span style="color:var(--blue)">Ø¹Ø¯Ø¯ Ø§Ù„Ø°ÙƒÙˆØ± ğŸ‘¨</span>
        </div>
        <div class="stat-card" style="border-bottom: 4px solid var(--pink);">
            <span class="stat-num" id="femaleCount">0</span>
            <span style="color:var(--pink)">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ù†Ø§Ø« ğŸ‘©</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="maxAge">0</span>
            <span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø± ğŸ‘´</span>
        </div>
        <div class="stat-card">
            <span class="stat-num" id="minAge">0</span>
            <span>Ø£ØµØºØ± Ø¹Ù…Ø± ğŸ‘¶</span>
        </div>
    </div>

    <section class="broadcast-box">
        <h2>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ù…Ø§Ø¹ÙŠØ© (ØªØ¸Ù‡Ø± ÙƒÙ†Ø¬Ù…Ø©) â­</h2>
        <textarea id="bcText" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ù‡Ù†Ø§..."></textarea>
        <div style="display:flex; gap:10px;">
            <div style="flex:1;">
                <label>ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡:</label>
                <input type="datetime-local" id="bcExpiry">
            </div>
        </div>
        <button class="btn btn-primary" onclick="window.sendBroadcast()">Ø¨Ø« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</button>
    </section>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ğŸ“±</h2>
        <div id="requestsList">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª ğŸ‘¥</h2>
        <div class="search-box">
            <input type="text" id="userSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." oninput="window.filterUsers()">
        </div>
        <div id="usersList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, addDoc, setDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let allUsers = [];

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role !== 'admin') window.location.href = "news.html";
            init();
        }
    });

    function init() {
        loadUsersAndStats();
        loadRequests();
    }

    // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª + Ø§Ù„Ø¨Ø­Ø« + Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    function loadUsersAndStats() {
        onSnapshot(collection(db, "Users"), (snap) => {
            allUsers = [];
            let males = 0, females = 0;
            let ages = [];

            snap.forEach(d => {
                const u = d.data();
                allUsers.push({ id: d.id, ...u });

                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¬Ù†Ø³
                if(u.gender === 'male') males++; else if(u.gender === 'female') females++;
                
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù…Ø±
                if(u.dob) {
                    const age = new Date().getFullYear() - new Date(u.dob).getFullYear();
                    ages.push(age);
                }
            });

            document.getElementById('maleCount').innerText = males;
            document.getElementById('femaleCount').innerText = females;
            document.getElementById('maxAge').innerText = ages.length ? Math.max(...ages) : 0;
            document.getElementById('minAge').innerText = ages.length ? Math.min(...ages) : 0;

            renderUsers(allUsers);
        });
    }

    window.filterUsers = () => {
        const term = document.getElementById('userSearch').value.toLowerCase();
        const filtered = allUsers.filter(u => 
            u.fullName.toLowerCase().includes(term) || 
            u.phone.includes(term) || 
            (u.email && u.email.toLowerCase().includes(term))
        );
        renderUsers(filtered);
    };

    function renderUsers(users) {
        const list = document.getElementById('usersList');
        list.innerHTML = "";
        users.forEach(u => {
            if(u.role === 'admin') return;
            const div = document.createElement('div');
            div.className = 'user-row';
            div.innerHTML = `
                <div style="flex:1; min-width:200px;">
                    <b>${u.fullName}</b> <br> <small>${u.phone} | ${u.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</small>
                </div>
                <div class="perm-grid">
                    <span class="perm-tag ${u.canAdd?'active':''}" onclick="togglePerm('${u.id}', 'canAdd', ${u.canAdd})">Ø¥Ø¶Ø§ÙØ©</span>
                    <span class="perm-tag ${u.canEdit?'active':''}" onclick="togglePerm('${u.id}', 'canEdit', ${u.canEdit})">ØªØ¹Ø¯ÙŠÙ„</span>
                    <span class="perm-tag ${u.canDelete?'active':''}" onclick="togglePerm('${u.id}', 'canDelete', ${u.canDelete})">Ø­Ø°Ù</span>
                    <span class="perm-tag ${u.role==='admin'?'active':''}" style="border:1px solid red" onclick="togglePerm('${u.id}', 'role', '${u.role}')">Ù…Ø¯ÙŠØ±</span>
                </div>
            `;
            list.appendChild(div);
        });
    }

    window.togglePerm = async (uid, field, currentVal) => {
        let newVal;
        if(field === 'role') newVal = currentVal === 'admin' ? 'user' : 'admin';
        else newVal = !currentVal;
        await updateDoc(doc(db, "Users", uid), { [field]: newVal });
    };

    // Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©
    window.sendBroadcast = async () => {
        const text = document.getElementById('bcText').value;
        const expiry = document.getElementById('bcExpiry').value;
        if(!text || !expiry) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡");

        await setDoc(doc(db, "Settings", "broadcast"), {
            message: text,
            expiry: new Date(expiry).getTime(),
            createdAt: serverTimestamp()
        });
        alert("ØªÙ… Ø¨Ø« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
    };

    // Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„
    function loadRequests() {
        onSnapshot(collection(db, "Requests"), (snap) => {
            const list = document.getElementById('requestsList');
            list.innerHTML = "";
            snap.forEach(async (d) => {
                const r = d.data();
                const uSnap = await getDoc(doc(db, "Users", r.uid));
                const u = uSnap.data();
                list.innerHTML += `
                    <div class="user-row" style="border-right: 5px solid gold;">
                        <div style="flex:1">
                            <b>Ø·Ù„Ø¨ Ù…Ù†: ${u.fullName}</b><br>
                            Ù…Ù†: ${r.currentPhone} â¬…ï¸ Ø¥Ù„Ù‰: ${r.requestedPhone}
                        </div>
                        <button class="btn btn-primary" style="background:var(--accent)" onclick="approveReq('${d.id}','${r.uid}','${r.requestedPhone}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                    </div>`;
            });
        });
    }

    window.approveReq = async (id, uid, phone) => {
        await updateDoc(doc(db, "Users", uid), { phone: phone });
        await deleteDoc(doc(db, "Requests", id));
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ù‚Ù…");
    };
</script>
</body>
</html>
