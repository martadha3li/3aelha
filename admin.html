<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø©</title>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --danger: #e74c3c; --bg: #f4f7f6; --blue: #3498db; --pink: #ff69b4; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: auto; }
        section { background: white; padding: 20px; border-radius: 15px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee; }
        h2 { color: var(--primary); border-right: 4px solid var(--accent); padding-right: 10px; margin-bottom: 20px; font-size: 1.2rem; }
        
        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-num { font-size: 28px; font-weight: bold; display: block; margin-bottom: 5px; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… */
        .user-row { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 10px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; }
        .perm-tag { font-size: 11px; padding: 5px 10px; border-radius: 5px; background: #ddd; cursor: pointer; margin: 2px; transition: 0.3s; }
        .perm-tag.active { background: var(--accent); color: white; }

        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; width: 100%; }
        .btn-primary { background: var(--primary); }
        .btn-blue { background: var(--blue); }
        
        .request-card { border-right: 8px solid #f1c40f; background: #fffcf0; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="container">
    <button onclick="location.href='news.html'" style="margin-bottom:20px; padding:10px 20px; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">â¬…ï¸ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø®Ø¨Ø§Ø±</button>
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙˆØ§Ù„Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© âš™ï¸</h1>

    <div class="stats-grid">
        <div class="stat-card" style="border-bottom: 5px solid var(--blue);"><span id="mCount" class="stat-num">0</span><span style="color:var(--blue)">Ø°ÙƒÙˆØ± ğŸ‘¨</span></div>
        <div class="stat-card" style="border-bottom: 5px solid var(--pink);"><span id="fCount" class="stat-num">0</span><span style="color:var(--pink)">Ø¥Ù†Ø§Ø« ğŸ‘©</span></div>
        <div class="stat-card"> <span id="maxAge" class="stat-num">0</span><span>Ø£ÙƒØ¨Ø± Ø¹Ù…Ø± ğŸ‘´</span></div>
        <div class="stat-card"> <span id="minAge" class="stat-num">0</span><span>Ø£ØµØºØ± Ø¹Ù…Ø± ğŸ‘¶</span></div>
    </div>

    <section>
        <h2>Ø·Ù„Ø¨Ø§Øª ØªØºÙŠÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2>
        <div id="requestsList">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.</div>
    </section>

    <section style="background: #eef7ff;">
        <h2>Ø¥Ø´Ø¹Ø§Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠØ¸Ù‡Ø± Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©) ğŸ””</h2>
        <textarea id="popText" rows="2" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;">
            <div><label>Ø§Ù„Ù„ÙˆÙ†:</label><select id="popType"><option value="white">Ø£Ø¨ÙŠØ¶</option><option value="red">Ø£Ø­Ù…Ø± (Ø¹Ø§Ø¬Ù„)</option><option value="green">Ø£Ø®Ø¶Ø± (ØªØ¨Ø±Ø¹)</option></select></div>
            <div><label>Ø§Ù„Ù…Ø¯Ø© (Ø«Ø§Ù†ÙŠØ©):</label><input type="number" id="popDur" value="10"></div>
            <div><label>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</label><input type="datetime-local" id="popExp"></div>
        </div>
        <button class="btn btn-blue" onclick="window.sendPopup()" style="margin-top:10px;">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚</button>
    </section>

    <section style="background: #fffdf0;">
        <h2>Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ© (Ø§Ù„Ù†Ø¬Ù…Ø©) Ù…Ø¹ Ø§Ø³ØªÙ‡Ø¯Ø§Ù</h2>
        <textarea id="bcText" rows="2" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:10px;">
            <div><label>Ø§Ù„ÙØ¦Ø©:</label><select id="bcGen"><option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option><option value="male">Ø°ÙƒÙˆØ±</option><option value="female">Ø¥Ù†Ø§Ø«</option></select></div>
            <div><label>Ù…Ù† Ø¹Ù…Ø±:</label><input type="number" id="bcMin" value="0"></div>
            <div><label>Ø¥Ù„Ù‰ Ø¹Ù…Ø±:</label><input type="number" id="bcMax" value="100"></div>
            <div><label>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ:</label><input type="datetime-local" id="bcExp"></div>
        </div>
        <button class="btn btn-primary" onclick="window.sendBC()" style="margin-top:10px;">Ø¨Ø« Ø§Ù„Ù†Ø¬Ù…Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</button>
    </section>

    <section>
        <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª</h2>
        <input type="text" id="userSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¬ÙˆØ§Ù„ØŒ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯..." oninput="window.filterUsers()">
        <div id="usersList" style="margin-top:15px;"></div>
    </section>
</div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, getDoc, updateDoc, deleteDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let allUsers = [];

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role === 'admin') initAdmin();
            else window.location.href = "news.html";
        }
    });

    function initAdmin() {
        loadUsersStats();
        loadRequests();
    }

    function loadUsersStats() {
        onSnapshot(collection(db, "Users"), (snap) => {
            allUsers = [];
            let m=0, f=0, ages=[];
            snap.forEach(d => {
                const u = {id: d.id, ...d.data()};
                allUsers.push(u);
                if(u.gender === 'male') m++; else if(u.gender === 'female') f++;
                if(u.dob) ages.push(new Date().getFullYear() - new Date(u.dob).getFullYear());
            });
            document.getElementById('mCount').innerText = m;
            document.getElementById('fCount').innerText = f;
            document.getElementById('maxAge').innerText = ages.length ? Math.max(...ages) : 0;
            document.getElementById('minAge').innerText = ages.length ? Math.min(...ages) : 0;
            renderUsers(allUsers);
        });
    }

    window.filterUsers = () => {
        const t = document.getElementById('userSearch').value.toLowerCase();
        const filtered = allUsers.filter(u => u.fullName.toLowerCase().includes(t) || u.phone.includes(t));
        renderUsers(filtered);
    };

    function renderUsers(arr) {
        const list = document.getElementById('usersList');
        list.innerHTML = "";
        arr.forEach(u => {
            if(u.role === 'admin') return;
            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `
                <div><b>${u.fullName}</b><br><small>${u.phone} | ${u.gender}</small></div>
                <div>
                    <span class="perm-tag ${u.canAdd?'active':''}" onclick="togglePerm('${u.id}','canAdd',${u.canAdd})">Ø¥Ø¶Ø§ÙØ©</span>
                    <span class="perm-tag ${u.canEdit?'active':''}" onclick="togglePerm('${u.id}','canEdit',${u.canEdit})">ØªØ¹Ø¯ÙŠÙ„</span>
                    <span class="perm-tag ${u.role==='admin'?'active':''}" onclick="togglePerm('${u.id}','role','${u.role}')">Ù…Ø¯ÙŠØ±</span>
                </div>`;
            list.appendChild(row);
        });
    }

    window.togglePerm = async (uid, f, val) => {
        let n = (f === 'role') ? (val==='admin'?'user':'admin') : !val;
        await updateDoc(doc(db, "Users", uid), { [f]: n });
    };

    window.sendPopup = async () => {
        const id = "pop_" + Date.now(); // Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„ÙƒÙ„ Ø¥Ø´Ø¹Ø§Ø± Ø¬Ø¯ÙŠØ¯
        await setDoc(doc(db, "Settings", "loginPopup"), {
            id,
            message: document.getElementById('popText').value,
            type: document.getElementById('popType').value,
            duration: parseInt(document.getElementById('popDur').value),
            expiry: new Date(document.getElementById('popExp').value).getTime()
        });
        alert("ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„!");
    };

    window.sendBC = async () => {
        await setDoc(doc(db, "Settings", "broadcast"), {
            message: document.getElementById('bcText').value,
            targetGender: document.getElementById('bcGen').value,
            minAge: parseInt(document.getElementById('bcMin').value),
            maxAge: parseInt(document.getElementById('bcMax').value),
            expiry: new Date(document.getElementById('bcExp').value).getTime()
        });
        alert("ØªÙ… Ø§Ù„Ø¨Ø«!");
    };

    function loadRequests() {
        onSnapshot(collection(db, "Requests"), (snap) => {
            const list = document.getElementById('requestsList');
            list.innerHTML = "";
            snap.forEach(async d => {
                const r = d.data();
                const u = (await getDoc(doc(db, "Users", r.uid))).data();
                list.innerHTML += `<div class="request-card"><b>${u.fullName}</b> Ø·Ù„Ø¨ ØªØºÙŠÙŠØ± Ø¥Ù„Ù‰ ${r.requestedPhone} <button onclick="approve('${d.id}','${r.uid}','${r.requestedPhone}')">Ù…ÙˆØ§ÙÙ‚Ø©</button></div>`;
            });
        });
    }
    window.approve = async (id, uid, p) => {
        await updateDoc(doc(db, "Users", uid), { phone: p });
        await deleteDoc(doc(db, "Requests", id));
    };
</script>
</body>
</html>
