<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ù…Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-wrapper { padding: 15px; max-width: 1000px; margin: auto; }
        .req-section { background: white; padding: 20px; border-radius: 25px; box-shadow: var(--shadow); margin-bottom: 25px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 15px; }
        
        /* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ù† */
        .security-alert { background: #fff1f1; border: 2px solid #ff3b30; color: #d63031; padding: 10px; border-radius: 12px; font-size: 12px; margin-top: 10px; font-weight: bold; }
        
        /* ÙƒØ±ÙˆØª Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .request-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #f9f9f9; }
        .request-card:last-child { border: none; }
        .user-meta { display: flex; align-items: center; gap: 12px; }
        .user-meta img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; }
        
        .badge { padding: 4px 10px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .badge-phone { background: #eef6ff; color: #007aff; }
        .badge-pass { background: #fdf2f2; color: #ff3b30; }

        .btn-group { display: flex; gap: 8px; }
        .btn-action { border: none; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-size: 12px; font-weight: bold; color: white; }
    </style>
</head>
<body style="background: #f4f7f6;">

    <div class="top-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="location.href='admin.html'" style="border:none; background:none; font-size:22px;">â¡ï¸</button>
            <b>Ù…Ø±ÙƒØ² Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ù…Ù†</b>
        </div>
        <img src="logo.png" style="height: 35px;">
    </div>

    <div class="admin-wrapper">
        
        <div class="req-section">
            <div class="section-header"><h2>ğŸ“¥ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h2></div>
            <div id="activationList"></div>
        </div>

        <div class="req-section">
            <div class="section-header"><h2>ğŸ“¬ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2></div>
            <div id="activeRequests"></div>
        </div>

        <div class="req-section">
            <div class="section-header">
                <h2>ğŸ›¡ï¸ Ø³Ø¬Ù„ Ø£Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª (ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)</h2>
                <small>ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø­Ø§Ù„ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø³Ø§ÙØ© 600 ÙƒÙ…</small>
            </div>
            <div id="passwordHistory"></div>
        </div>

        <div class="req-section" style="border-top: 4px solid var(--primary);">
            <div class="section-header"><h2>ğŸ‘¥ Ø¢Ø®Ø± 7 Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù†Ø¶Ù…ÙˆØ§ Ø¥Ù„ÙŠÙ†Ø§</h2></div>
            <div id="recentUsers"></div>
        </div>

    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, onSnapshot, doc, query, orderBy, limit, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "Users", user.uid));
            if (snap.data().role === 'admin') initRequestsPage();
            else location.href = 'news.html';
        }
    });

    function initRequestsPage() {
        // --- 1. Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙØ¹ÙŠÙ„ ---
        onSnapshot(query(collection(db, "Users"), where("status", "==", "pending")), snap => {
            const cont = document.getElementById('activationList');
            cont.innerHTML = snap.empty ? '<p style="color:gray; font-size:12px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : "";
            snap.forEach(u => {
                const d = u.data();
                cont.innerHTML += `<div class="request-card">
                    <div class="user-meta"><b>${d.fullName}</b><br><small>${d.phone}</small></div>
                    <button class="btn-action" style="background:#34c759" onclick="updateStatus('${u.id}', 'active')">ØªÙØ¹ÙŠÙ„</button>
                </div>`;
            });
        });

        // --- 2. Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø§Ù„Ù…Ø¬Ù…Ø¹Ø©) ---
        const reqCols = ['PhoneRequests', 'PasswordRequests'];
        reqCols.forEach(col => {
            onSnapshot(collection(db, col), snap => {
                const cont = document.getElementById('activeRequests');
                snap.forEach(r => {
                    const d = r.data();
                    const isPhone = col === 'PhoneRequests';
                    cont.innerHTML += `<div class="request-card">
                        <div>
                            <span class="badge ${isPhone ? 'badge-phone' : 'badge-pass'}">${isPhone ? 'Ø¬ÙˆØ§Ù„' : 'ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±'}</span>
                            <b>${d.userName}</b><br>
                            <small>${isPhone ? 'Ø§Ù„Ø¬Ø¯ÙŠØ¯: ' + d.newPhone : 'Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: ' + d.requestedPass}</small>
                        </div>
                        <button class="btn-action" style="background:var(--primary)" onclick="approveReq('${col}', '${r.id}', '${d.userId}', '${d.newPhone || d.requestedPass}')">Ù…ÙˆØ§ÙÙ‚Ø©</button>
                    </div>`;
                });
            });
        });

        // --- 3. Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ + Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ ---
        onSnapshot(query(collection(db, "PasswordHistory"), orderBy("timestamp", "desc")), snap => {
            const cont = document.getElementById('passwordHistory');
            cont.innerHTML = "";
            snap.forEach(h => {
                const d = h.data();
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                let alertMsg = "";
                if(d.regLoc && d.changeLoc) {
                    const dist = calculateDistance(d.regLoc.lat, d.regLoc.lng, d.changeLoc.lat, d.changeLoc.lng);
                    if(dist > 600) {
                        alertMsg = `<div class="security-alert">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ: ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ù† Ù…Ø³Ø§ÙØ© ${dist.toFixed(1)} ÙƒÙ… Ø¨Ø¹ÙŠØ¯Ø§Ù‹ Ø¹Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„!</div>`;
                    }
                }
                cont.innerHTML += `<div class="request-card" style="flex-direction:column; align-items:start;">
                    <div style="width:100%; display:flex; justify-content:space-between;">
                        <b>${d.userName}</b> <span>${new Date(d.timestamp?.toDate()).toLocaleString('ar-EG')}</span>
                    </div>
                    ${alertMsg}
                </div>`;
            });
        });

        // --- 4. Ø¢Ø®Ø± 7 Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† ---
        onSnapshot(query(collection(db, "Users"), orderBy("createdAt", "desc"), limit(7)), snap => {
            const cont = document.getElementById('recentUsers');
            cont.innerHTML = "";
            snap.forEach(u => {
                const d = u.data();
                cont.innerHTML += `<div class="request-card">
                    <div class="user-meta">
                        <img src="${d.profileImg || 'https://via.placeholder.com/45'}">
                        <div><b>${d.fullName}</b><br><small>${d.phone} - ${d.city || 'Ø¨Ø¯ÙˆÙ† Ù…Ø¯ÙŠÙ†Ø©'}</small></div>
                    </div>
                    <span class="badge" style="background:#eee;">${d.role}</span>
                </div>`;
            });
        });
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† (Haversine Formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„ÙƒÙ…
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙˆØ§Ù„ØªÙØ¹ÙŠÙ„
    window.approveReq = async (col, rid, uid, val) => {
        const field = col === 'PhoneRequests' ? 'phone' : 'tempPassword';
        await updateDoc(doc(db, "Users", uid), { [field]: val });
        await deleteDoc(doc(db, col, rid));
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    };

    window.updateStatus = async (id, s) => {
        await updateDoc(doc(db, "Users", id), { status: s });
        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    };
</script>
</body>
</html>
