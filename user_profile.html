<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بروفايل العضو</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .profile-header { background: white; padding: 40px 20px; text-align: center; border-radius: 0 0 35px 35px; box-shadow: var(--shadow); }
        .profile-img { width: 110px; height: 110px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); background: #eee; }
        .data-card { background: white; margin: 20px 15px; border-radius: 20px; padding: 10px 20px; box-shadow: var(--shadow); }
        .data-row { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #f9f9f9; }
        .label { color: #8e8e93; font-size: 13px; font-weight: bold; }
        .value { color: #1c1c1e; font-weight: 600; }
    </style>
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="history.back()" style="border:none; background:none; font-size:20px;">➡️</button>
        <b>بروفايل العضو</b>
        <div style="width:20px;"></div>
    </div>

    <div id="loader" style="text-align:center; margin-top:50px; color:gray;">جاري تحميل بيانات العضو...</div>

    <div id="profileContent" style="display:none;">
        <div class="profile-header">
            <img id="uImg" src="https://via.placeholder.com/110" class="profile-img">
            <h2 id="uName" style="margin: 15px 0 5px 0; font-size: 20px;"></h2>
            <span id="uRole" style="background: #eef6ff; color: var(--primary); padding: 4px 12px; border-radius: 12px; font-size: 12px;">عضو</span>
        </div>

        <div class="data-card">
            <div class="data-row"><span class="label">المدينة</span> <span id="uCity" class="value">--</span></div>
            <div class="data-row"><span class="label">الجنس</span> <span id="uGender" class="value">--</span></div>
            <div class="data-row"><span class="label">تاريخ الانضمام</span> <span id="uDate" class="value">--</span></div>
        </div>

        <h3 style="margin-right:20px; font-size:16px;">✍️ منشورات العضو</h3>
        <div id="userPosts" style="padding: 0 15px 100px 15px;"></div>
    </div>

<script type="module">
    import { db } from './config.js';
    import { doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    // تنظيف المعرف من أي مسافات زائدة
    const targetUid = urlParams.get('uid')?.trim(); 

    if (!targetUid || targetUid === "undefined" || targetUid === "null") {
        document.getElementById('loader').innerText = "خطأ: معرف العضو غير صحيح أو غير موجود";
    } else {
        loadMemberData();
    }

    async function loadMemberData() {
        try {
            // جلب البيانات من سجل Users
            const userSnap = await getDoc(doc(db, "Users", targetUid));
            
            if (userSnap.exists()) {
                const data = userSnap.data();
                
                document.getElementById('uName').innerText = data.fullName || "عضو مجهول";
                document.getElementById('uCity').innerText = data.city || "غير محددة";
                document.getElementById('uGender').innerText = data.gender === 'male' ? 'ذكر' : 'أنثى';
                document.getElementById('uImg').src = data.profileImg || 'https://via.placeholder.com/110';
                
                if(data.createdAt) {
                    document.getElementById('uDate').innerText = new Date(data.createdAt.toDate()).toLocaleDateString('ar-EG');
                }

                document.getElementById('loader').style.display = 'none';
                document.getElementById('profileContent').style.display = 'block';

                loadMemberPosts();
            } else {
                // هذا هو الخطأ الذي ظهر لك، والآن أضفنا الـ ID المفقود في الرسالة للتأكد
                document.getElementById('loader').innerText = "لم يتم العثور على بيانات للعضو في سجل Users.";
                console.log("الـ ID الذي تم البحث عنه ولم يوجد:", targetUid);
            }
        } catch (error) {
            console.error(error);
            document.getElementById('loader').innerText = "حدث خطأ في الاتصال بقاعدة البيانات";
        }
    }
    
    // ... دالة loadMemberPosts تبقى كما هي ...
</script>
</body>
</html>
