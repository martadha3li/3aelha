<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¶Ø§ÙØ© / ØªØ«Ø¨ÙŠØª Ø®Ø¨Ø±</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 20px; direction: rtl; }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #e5e5ea; color: #000; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px; }
        .header h1 { font-size: 18px; flex: 1; text-align: center; margin-left: 35px; }

        .form-container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-selector { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-item { flex: 1; text-align: center; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; color: #8e8e93; }
        .tab-item.active { background: white; color: var(--ios-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #3a3a3c; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; box-sizing: border-box; outline: none; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø«Ø¨Øª */
        .news-picker { max-height: 300px; overflow-y: auto; display: none; }
        .pick-item { display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
        .pick-item:hover { background: #f9f9f9; }
        .pick-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
        .pick-title { font-size: 14px; font-weight: bold; flex: 1; }
        .pick-radio { accent-color: var(--ios-blue); }

        .hidden { display: none !important; }
        .publish-btn { width: 100%; padding: 15px; background: var(--ios-blue); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="news.html" class="back-btn">âœ•</a>
        <h1>Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø£Ùˆ ØªØ«Ø¨ÙŠØªÙ‡</h1>
    </div>

    <div class="form-container">
        <div class="tab-selector">
            <div class="tab-item active" id="tabNormal" onclick="switchTab('normal')">Ø®Ø¨Ø± Ø¹Ø§Ø¯ÙŠ</div>
            <div class="tab-item" id="tabPinned" onclick="switchTab('pinned')">Ø®Ø¨Ø± Ø¹Ù„ÙˆÙŠ Ø«Ø§Ø¨Øª</div>
        </div>

        <div id="normalForm">
            <div class="input-group">
                <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¨Ø±</label>
                <select id="postType" onchange="updateDefaultTitle()">
                    <option value="normal">Ø®Ø¨Ø± Ø¹Ø§Ù… ğŸ“„</option>
                    <option value="wedding">Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬ ğŸ’</option>
                    <option value="death">Ø¥Ø¹Ù„Ø§Ù† ÙˆÙØ§Ø© ğŸ–¤</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±...">
            </div>
            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø± (Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²)</label>
                <input type="file" id="postFile" accept="image/*">
            </div>
            <div class="input-group">
                <label>Ù†Øµ Ø§Ù„Ø®Ø¨Ø±</label>
                <textarea id="postBody" rows="5" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„..."></textarea>
            </div>
        </div>

        <div id="pinnedForm" class="hidden">
            <p style="font-size: 12px; color: #8e8e93; margin-bottom: 10px;">Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø© Ù„ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ:</p>
            <div id="newsPicker" class="news-picker" style="display: block;">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...
            </div>
            <div class="input-group" style="margin-top: 15px;">
                <label>ØªØµÙ†ÙŠÙ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù„ÙˆÙŠ</label>
                <select id="pinType">
                    <option value="wedding">ÙƒØ±Øª Ø²ÙˆØ§Ø¬ Ø°Ù‡Ø¨ÙŠ ğŸ’</option>
                    <option value="death">ÙƒØ±Øª ÙˆÙØ§Ø© Ø±Ù…Ø§Ø¯ÙŠ ğŸ–¤</option>
                </select>
            </div>
        </div>

        <button id="mainBtn" class="publish-btn">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±</button>
    </div>

    <script type="module">
        import { db, auth } from './config.js';
        import { collection, addDoc, getDocs, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentMode = 'normal';
        let selectedNewsId = null;

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹
        window.switchTab = (mode) => {
            currentMode = mode;
            document.getElementById('tabNormal').classList.toggle('active', mode === 'normal');
            document.getElementById('tabPinned').classList.toggle('active', mode === 'pinned');
            document.getElementById('normalForm').classList.toggle('hidden', mode !== 'normal');
            document.getElementById('pinnedForm').classList.toggle('hidden', mode !== 'pinned');
            document.getElementById('mainBtn').innerText = mode === 'normal' ? 'Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±' : 'ØªØ«Ø¨ÙŠØª ÙƒØ¥Ø¹Ù„Ø§Ù† Ø¹Ù„ÙˆÙŠ';
            if(mode === 'pinned') loadNewsForPicker();
        };

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù†ÙˆØ¹
        window.updateDefaultTitle = () => {
            const type = document.getElementById('postType').value;
            const titleInput = document.getElementById('postTitle');
            if(type === 'wedding') titleInput.value = "Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬: ";
            else if(type === 'death') titleInput.value = "Ø¥Ù†Ø§ Ù„Ù„Ù‡ ÙˆØ¥Ù†Ø§ Ø¥Ù„ÙŠÙ‡ Ø±Ø§Ø¬Ø¹ÙˆÙ†: ";
            else titleInput.value = "";
        };

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ù‡Ø§
        async function loadNewsForPicker() {
            const picker = document.getElementById('newsPicker');
            picker.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            const q = query(collection(db, "News"), orderBy("publishDate", "desc"));
            const snap = await getDocs(q);
            picker.innerHTML = "";
            snap.forEach(d => {
                const data = d.data();
                const div = document.createElement('div');
                div.className = 'pick-item';
                div.onclick = () => { selectedNewsId = d.id; div.querySelector('input').checked = true; };
                div.innerHTML = `
                    <input type="radio" name="pick" class="pick-radio">
                    <img src="${data.img || 'https://via.placeholder.com/50'}" class="pick-img">
                    <span class="pick-title">${data.title}</span>
                `;
                picker.appendChild(div);
            });
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        document.getElementById('mainBtn').onclick = async () => {
            if(currentMode === 'normal') {
                const title = document.getElementById('postTitle').value;
                const body = document.getElementById('postBody').value;
                const type = document.getElementById('postType').value;
                const file = document.getElementById('postFile').files[0];

                if(!title || !body) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

                // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ Storage Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Base64 Ù„Ù„ØªØ¨Ø³ÙŠØ·
                let imgUrl = "https://via.placeholder.com/500";
                if(file) {
                    // ÙƒÙˆØ¯ Ù…Ø¨Ø³Ø· Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ Base64 Ù„ØºØ±Ø¶ Ø§Ù„ØªØ¬Ø±Ø¨Ø©
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = async () => {
                        await saveToFirebase(title, body, reader.result, type);
                    };
                } else {
                    await saveToFirebase(title, body, imgUrl, type);
                }
            } else {
                if(!selectedNewsId) return alert("Ø§Ø®ØªØ± Ø®Ø¨Ø±Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹");
                const pinType = document.getElementById('pinType').value;
                await updateDoc(doc(db, "News", selectedNewsId), { type: pinType });
                alert("ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ!");
                window.location.href = "news.html";
            }
        };

        async function saveToFirebase(title, body, img, type) {
            try {
                await addDoc(collection(db, "News"), {
                    title, body, img, type,
                    publishDate: Date.now(),
                    authorId: auth.currentUser.uid,
                    visible: true,
                    likedBy: [], viewedBy: [], comments: []
                });
                alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±!");
                window.location.href = "news.html";
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±"); }
        }
    </script>
</body>
</html>
