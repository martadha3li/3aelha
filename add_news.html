<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; --ios-red: #FF3B30; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 20px; direction: rtl; }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #e5e5ea; color: #000; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px; }
        .header h1 { font-size: 18px; flex: 1; text-align: center; margin-left: 35px; }

        .form-container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-selector { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-item { flex: 1; text-align: center; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; color: #8e8e93; }
        .tab-item.active { background: white; color: var(--ios-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #3a3a3c; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; box-sizing: border-box; outline: none; }
        
        .news-picker { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; }
        .pick-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #f2f2f2; cursor: pointer; transition: 0.2s; }
        .pick-item:last-child { border-bottom: none; }
        .pick-item:active { background: #f0f0f5; }
        .pick-img { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #eee; }
        .pick-title { font-size: 13px; font-weight: bold; flex: 1; color: #1c1c1e; }
        .pick-badge { font-size: 10px; padding: 2px 6px; border-radius: 5px; background: #eee; color: #666; }
        .pick-radio { accent-color: var(--ios-blue); width: 18px; height: 18px; }

        .hidden { display: none !important; }
        .publish-btn { width: 100%; padding: 15px; background: var(--ios-blue); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .remove-pin-btn { width: 100%; padding: 12px; background: #fff; color: var(--ios-red); border: 1.5px solid var(--ios-red); border-radius: 15px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="news.html" class="back-btn">âœ•</a>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h1>
    </div>

    <div class="form-container">
        <div class="tab-selector">
            <div class="tab-item active" id="tabNormal" onclick="switchTab('normal')">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</div>
            <div class="tab-item" id="tabPinned" onclick="switchTab('pinned')">ØªØ«Ø¨ÙŠØª / Ø¥Ù„ØºØ§Ø¡</div>
        </div>

        <div id="normalForm">
            <div class="input-group">
                <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø®Ø¨Ø±</label>
                <select id="postType" onchange="updateDefaultTitle()">
                    <option value="normal">Ø®Ø¨Ø± Ø¹Ø§Ù… ğŸ“„</option>
                    <option value="wedding">Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬ ğŸ’</option>
                    <option value="death">Ø¥Ø¹Ù„Ø§Ù† ÙˆÙØ§Ø© ğŸ–¤</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="postTitle" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§...">
            </div>
            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±</label>
                <input type="file" id="postFile" accept="image/*">
            </div>
            <div class="input-group">
                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                <textarea id="postBody" rows="5" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>
            </div>
            <button id="mainBtn" class="publish-btn">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>

        <div id="pinnedForm" class="hidden">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©:</label>
            <div id="newsPicker" class="news-picker">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            
            <div id="pinActions">
                <div class="input-group">
                    <label>ØªØ«Ø¨ÙŠØª ÙƒÙ€:</label>
                    <select id="pinType">
                        <option value="wedding">ÙƒØ±Øª Ø²ÙˆØ§Ø¬ Ø°Ù‡Ø¨ÙŠ ğŸ’</option>
                        <option value="death">ÙƒØ±Øª ÙˆÙØ§Ø© Ø±Ù…Ø§Ø¯ÙŠ ğŸ–¤</option>
                    </select>
                </div>
                <button onclick="handlePinAction('pin')" class="publish-btn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù„ÙˆÙŠ</button>
                <button onclick="handlePinAction('unpin')" class="remove-pin-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './config.js';
        import { collection, addDoc, getDocs, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentMode = 'normal';
        let selectedNewsId = null;

        window.switchTab = (mode) => {
            currentMode = mode;
            document.getElementById('tabNormal').classList.toggle('active', mode === 'normal');
            document.getElementById('tabPinned').classList.toggle('active', mode === 'pinned');
            document.getElementById('normalForm').classList.toggle('hidden', mode !== 'normal');
            document.getElementById('pinnedForm').classList.toggle('hidden', mode !== 'pinned');
            if(mode === 'pinned') loadNewsForPicker();
        };

        window.updateDefaultTitle = () => {
            const type = document.getElementById('postType').value;
            const titleInput = document.getElementById('postTitle');
            if(type === 'wedding') titleInput.value = "Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬: ";
            else if(type === 'death') titleInput.value = "Ø¥Ù†Ø§ Ù„Ù„Ù‡ ÙˆØ¥Ù†Ø§ Ø¥Ù„ÙŠÙ‡ Ø±Ø§Ø¬Ø¹ÙˆÙ†: ";
            else titleInput.value = "";
        };

        async function loadNewsForPicker() {
            const picker = document.getElementById('newsPicker');
            picker.innerHTML = "<p style='text-align:center; padding:20px; font-size:12px; color:#888;'>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</p>";
            try {
                const q = query(collection(db, "News"), orderBy("publishDate", "desc"));
                const snap = await getDocs(q);
                picker.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const isPinned = (data.type === 'wedding' || data.type === 'death');
                    const div = document.createElement('div');
                    div.className = 'pick-item';
                    div.onclick = () => { selectedNewsId = d.id; div.querySelector('input').checked = true; };
                    div.innerHTML = `
                        <input type="radio" name="pick" class="pick-radio">
                        <img src="${data.img || 'https://via.placeholder.com/50'}" class="pick-img">
                        <div class="pick-title">
                            ${data.title}
                            ${isPinned ? `<span class="pick-badge">Ù…Ø«Ø¨Øª Ø­Ø§Ù„ÙŠØ§Ù‹</span>` : ''}
                        </div>
                    `;
                    picker.appendChild(div);
                });
            } catch(e) { picker.innerHTML = "ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"; }
        }

        // Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ù„Ù„Ø®Ø¨Ø± Ø§Ù„Ø¹Ø§Ø¯ÙŠ
        document.getElementById('mainBtn').onclick = async () => {
            const title = document.getElementById('postTitle').value;
            const body = document.getElementById('postBody').value;
            const type = document.getElementById('postType').value;
            const file = document.getElementById('postFile').files[0];

            if(!title || !body) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ");

            let imgUrl = "https://via.placeholder.com/500x300";
            if(file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => saveToFirebase(title, body, reader.result, type);
            } else {
                saveToFirebase(title, body, imgUrl, type);
            }
        };

        async function saveToFirebase(title, body, img, type) {
            try {
                await addDoc(collection(db, "News"), {
                    title, body, img, type,
                    publishDate: Date.now(),
                    authorId: auth.currentUser.uid,
                    visible: true,
                    likedBy: [], viewedBy: [], comments: []
                });
                alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­");
                window.location.href = "news.html";
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±"); }
        }

        // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø£Ùˆ Ø§Ù„Ø¥Ù„ØºØ§Ø¡
        window.handlePinAction = async (action) => {
            if(!selectedNewsId) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø´ÙˆØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£ÙˆÙ„Ø§Ù‹");
            
            try {
                const newType = (action === 'pin') ? document.getElementById('pinType').value : 'normal';
                await updateDoc(doc(db, "News", selectedNewsId), { type: newType });
                
                alert(action === 'pin' ? "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­");
                window.location.href = "news.html";
            } catch(e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©");
            }
        };
    </script>
</body>
</html>
