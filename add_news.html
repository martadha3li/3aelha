<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; --ios-red: #FF3B30; --wedding-gold: #FFD700; --death-dark: #3A3A3C; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 20px; direction: rtl; }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #e5e5ea; color: #000; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px; }
        .header h1 { font-size: 18px; flex: 1; text-align: center; margin-left: 35px; }
        .form-container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-selector { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-item { flex: 1; text-align: center; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; color: #8e8e93; }
        .tab-item.active { background: white; color: var(--ios-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #3a3a3c; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; box-sizing: border-box; outline: none; }
        .news-picker { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; }
        .pick-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #f2f2f2; cursor: pointer; }
        .ai-status { font-size: 12px; color: var(--ios-blue); text-align: center; margin-top: 10px; display: none; }
        .hidden { display: none !important; }
        .publish-btn { width: 100%; padding: 15px; background: var(--ios-blue); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .ai-btn { background: linear-gradient(135deg, #007AFF, #5856D6); }
        #sizeStats { font-size: 11px; color: #34c759; text-align: center; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <a href="news.html" class="back-btn">âœ•</a>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h1>
    </div>

    <div class="form-container">
        <div class="tab-selector">
            <div class="tab-item active" id="tabNormal" onclick="switchTab('normal')">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</div>
            <div class="tab-item" id="tabAI" onclick="switchTab('ai')">ğŸ¤– Ù‚Ø±Ø§Ø¡Ø© ØµÙˆØ±Ø©</div>
            <div class="tab-item" id="tabPinned" onclick="switchTab('pinned')">ØªØ«Ø¨ÙŠØª / Ø¥Ù„ØºØ§Ø¡</div>
        </div>

        <div id="normalForm">
            <div class="input-group">
                <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø®Ø¨Ø±</label>
                <select id="postType" onchange="updateDefaultTitle()">
                    <option value="normal">Ø®Ø¨Ø± Ø¹Ø§Ù… ğŸ“„</option>
                    <option value="wedding">Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬ ğŸ’</option>
                    <option value="death">Ø¥Ø¹Ù„Ø§Ù† ÙˆÙØ§Ø© ğŸ–¤</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="postTitle" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§...">
            </div>
            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±</label>
                <input type="file" id="postFile" accept="image/*">
                <div id="sizeStats"></div>
            </div>
            <div class="input-group">
                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                <textarea id="postBody" rows="5" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>
            </div>
            <button id="mainBtn" class="publish-btn">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>

        <div id="aiForm" class="hidden">
            <div style="text-align: center; padding: 10px 0;">
                <p style="font-size: 13px; color: #666;">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© "Ø¨ÙˆØ³Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨" Ù„Ø³Ø­Ø¨ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                <input type="file" id="aiFileInput" accept="image/*">
                <div id="aiLoading" class="ai-status">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©...</div>
                <button onclick="processAIImage()" class="publish-btn ai-btn">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ğŸ”</button>
            </div>
        </div>

        <div id="pinnedForm" class="hidden">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù„ØªØ«Ø¨ÙŠØªÙ‡:</label>
            <div id="newsPicker" class="news-picker">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <button onclick="handlePinAction('pin')" class="publish-btn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª</button>
            <button onclick="handlePinAction('unpin')" style="background:none; color:red; border:none; width:100%; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª</button>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './config.js';
        import { collection, addDoc, getDocs, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Ø¯Ø§Ù„Ø© Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
        async function compressImage(file) {
            return new Promise((resolve) => {
                const originalSize = (file.size / 1024).toFixed(2);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6);
                        const newSize = (dataUrl.length * (3/4) / 1024).toFixed(2);
                        document.getElementById('sizeStats').innerText = `ğŸ“Š Ø§Ù„Ø­Ø¬Ù…: ${originalSize}KB â” ${newSize}KB (ØªÙ… ØªÙˆÙÙŠØ± ${(100 - (newSize/originalSize*100)).toFixed(0)}%)`;
                        resolve(dataUrl);
                    };
                };
            });
        }

        // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø·ÙˆØ± ---
        document.getElementById('mainBtn').onclick = async () => {
            const title = document.getElementById('postTitle').value;
            const body = document.getElementById('postBody').value;
            const file = document.getElementById('postFile').files[0];
            const type = document.getElementById('postType').value;

            if(!title || !body) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            
            let img = "https://via.placeholder.com/500x300";
            if(file) {
                document.getElementById('mainBtn').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...";
                img = await compressImage(file);
            }

            try {
                await addDoc(collection(db, "News"), {
                    title, body, img, type,
                    publishDate: Date.now(),
                    authorId: auth.currentUser.uid,
                    visible: true
                });
                alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                window.location.href = "news.html";
            } catch(e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±"); }
        };

        // --- Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ---
        window.processAIImage = async () => {
            const file = document.getElementById('aiFileInput').files[0];
            const status = document.getElementById('aiLoading');
            if(!file) return alert("Ø§Ø®ØªØ± ØµÙˆØ±Ø©");
            status.style.display = "block";
            try {
                const result = await Tesseract.recognize(file, 'ara');
                document.getElementById('postBody').value = result.data.text;
                document.getElementById('postTitle').value = result.data.text.split('\n')[0].substring(0,50);
                alert("âœ… ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©!");
                switchTab('normal');
            } catch(e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„"); } finally { status.style.display="none"; }
        };

        window.switchTab = (mode) => {
            document.getElementById('normalForm').classList.toggle('hidden', mode !== 'normal');
            document.getElementById('aiForm').classList.toggle('hidden', mode !== 'ai');
            document.getElementById('pinnedForm').classList.toggle('hidden', mode !== 'pinned');
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            if(mode === 'normal') document.getElementById('tabNormal').classList.add('active');
            if(mode === 'ai') document.getElementById('tabAI').classList.add('active');
            if(mode === 'pinned') { document.getElementById('tabPinned').classList.add('active'); loadNewsForPicker(); }
        };
        // Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„ (loadNewsForPicker, handlePinAction) ØªØ¸Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
    </script>
</body>
</html>
