<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "a96c2d21-5d88-40fb-8c60-4c0911e9be15",
    });

    // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Firestore Ù„Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
        const subscriptionId = event.current.id;
        if (subscriptionId && auth.currentUser) {
            const { doc, updateDoc } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            const { db } = await import("./config.js");
            await updateDoc(doc(db, "Users", auth.currentUser.uid), {
                onesignalId: subscriptionId
            });
        }
    });
  });
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ø±ÙŠØ± Ø§Ù„Ø®Ø¨Ø± | Ù…Ù†ØµØ© Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --primary: #5856d6; --bg: #f2f2f7; }
        body { background: var(--bg); font-family: -apple-system, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 600px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .form-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; box-sizing: border-box; font-family: inherit; font-size: 15px; }
        .preview-img { width: 100%; border-radius: 12px; margin-bottom: 15px; display: none; border: 1px solid #eee; }
        .btn-save { background: var(--primary); color: white; border: none; width: 100%; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; }
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 1000; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <div style="font-size: 40px;">â³</div>
    <p>Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
</div>

<div class="container">
    <div class="card">
        <h2 id="pageTitle" style="text-align:center; color:var(--primary); margin-top:0;">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</h2>
        
        <input type="text" id="newsTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±" class="form-input">
        
        <select id="newsCat" class="form-input">
            <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
            </select>

        <textarea id="newsBody" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø± Ù‡Ù†Ø§..." class="form-input" style="height: 150px; resize: none;"></textarea>
        
        <label style="display: block; text-align: center; background: #f0f0f7; padding: 15px; border-radius: 12px; cursor: pointer; margin-bottom: 15px; color: var(--primary); font-weight: bold;">
            ğŸ“¸ Ø§Ø±ÙÙ‚ Ø£Ùˆ ØºÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±
            <input type="file" id="imgInput" accept="image/*" style="display: none;" onchange="handleImage(this)">
        </label>
        
        <img id="imgPreview" class="preview-img">
        
        <button id="submitBtn" onclick="saveNews()" class="btn-save">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø±</button>
    </div>
</div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, doc, getDoc, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const urlParams = new URLSearchParams(window.location.search);
    const editId = urlParams.get('edit'); // Ø¬Ù„Ø¨ ID Ø§Ù„Ø®Ø¨Ø± Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    let compressedBase64 = "";

    // 1. Ø¹Ù†Ø¯ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = async () => {
        loadCategories();
        if (editId) {
            document.getElementById('pageTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±";
            document.getElementById('submitBtn').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª";
            fillData(editId);
        }
    };

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function loadCategories() {
        const snap = await getDocs(collection(db, "Categories"));
        const select = document.getElementById('newsCat');
        snap.forEach(c => {
            const name = c.data().name;
            const opt = document.createElement('option');
            opt.value = name; opt.innerText = name;
            select.appendChild(opt);
        });
    }

    // 3. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¨Ø± ÙÙŠ Ø­Ø§Ù„Ø© "Ø§Ù„ØªØ¹Ø¯ÙŠÙ„"
    async function fillData(id) {
        const s = await getDoc(doc(db, "News", id));
        if (s.exists()) {
            const n = s.data();
            document.getElementById('newsTitle').value = n.title;
            document.getElementById('newsBody').value = n.body;
            document.getElementById('newsCat').value = n.category || "Ø¹Ø§Ù…";
            if (n.img) {
                compressedBase64 = n.img;
                const preview = document.getElementById('imgPreview');
                preview.src = n.img;
                preview.style.display = 'block';
            }
        }
    }

    // 4. Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ¶ØºØ· Ø§Ù„ØµÙˆØ±Ø©
    window.handleImage = (input) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    
                    const preview = document.getElementById('imgPreview');
                    preview.src = compressedBase64;
                    preview.style.display = 'block';
                };
            };
            reader.readAsDataURL(file);
        }
    };

    // 5. ÙˆØ¸ÙŠÙØ© Ø§Ù„Ø­ÙØ¸ (Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„)
    window.saveNews = async () => {
        const title = document.getElementById('newsTitle').value;
        const body = document.getElementById('newsBody').value;
        const cat = document.getElementById('newsCat').value;
        const loader = document.getElementById('loading');

        if (!title || !body) return alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

        loader.style.display = 'flex';

        try {
            const newsData = {
                title: title,
                body: body,
                category: cat,
                img: compressedBase64,
                visible: true,
                publishDate: Date.now() // Ù„Ù„ØªØ±ØªÙŠØ¨
            };

            if (editId) {
                // ØªØ­Ø¯ÙŠØ« Ø®Ø¨Ø± Ù…ÙˆØ¬ÙˆØ¯
                await updateDoc(doc(db, "News", editId), newsData);
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯
                newsData.authorId = auth.currentUser.uid;
                newsData.likedBy = [];
                newsData.createdAt = serverTimestamp();
                await addDoc(collection(db, "News"), newsData);
                alert("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ ğŸ‰");
            }
            async function sendNotificationToAll(title, message) {
    const REST_API_KEY = "Ø¶Ø¹Ù‡_Ù‡Ù†Ø§_Ù…Ù†_Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª_Ø§ÙˆÙ†_Ø³ÙŠØ¬Ù†Ø§Ù„"; // Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    
    const data = {
        app_id: "a96c2d21-5d88-40fb-8c60-4c0911e9be15",
        included_segments: ["All"],
        headings: {"ar": title},
        contents: {"ar": message},
        url: "https://Ø±Ø§Ø¨Ø·-Ù…ÙˆÙ‚Ø¹Ùƒ.com/news.html"
    };

    try {
        await fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": `Basic ${REST_API_KEY}`
            },
            body: JSON.stringify(data)
        });
    } catch (e) { console.error("Error sending notification:", e); }
}

// Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ addDoc ÙÙŠ saveNews
// await sendNotificationToAll("Ø®Ø¨Ø± Ø¹Ø§Ø¦Ù„ÙŠ Ø¬Ø¯ÙŠØ¯ ğŸ“°", title);
            location.href = "news.html";
        } catch (e) {
            console.error(e);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        } finally {
            loader.style.display = 'none';
        }
    };
</script>
</body>
</html>
