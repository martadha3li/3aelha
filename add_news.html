<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© / Ø¬Ø¯ÙˆÙ„Ø© Ø®Ø¨Ø±</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .editor-box { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .rich-editor { min-height: 250px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; outline: none; background: #fff; margin-bottom: 15px; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-top: 1px solid #eee; margin-top: 10px; }
        .schedule-input, .select-input { border: 1px solid #ddd; padding: 8px; border-radius: 10px; font-family: inherit; width: 100%; box-sizing: border-box; }
        .toolbar { background: #f0f0f0; padding: 8px; border-radius: 10px 10px 0 0; border: 1px solid #ddd; border-bottom: none; display: flex; gap: 8px; }
    </style>
</head>
<body>
    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:20px;">âœ•</button>
        <b>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†Ø´ÙˆØ± Ø§Ø­ØªØ±Ø§ÙÙŠ</b>
        <button class="btn-main" id="publishBtn" style="padding: 5px 20px;">Ù†Ø´Ø±</button>
    </div>

    <div class="editor-box">
        <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± Ù‡Ù†Ø§..." class="form-input" style="font-weight:bold; font-size:18px; width: 100%; border: none; border-bottom: 1px solid #eee; margin-bottom: 15px;">
        
        <div style="margin-bottom: 15px;">
            <label style="font-size:13px; display:block; margin-bottom:5px; font-weight: bold; color: var(--primary);">ğŸ“ ØªØµÙ†ÙŠÙ Ø§Ù„Ø®Ø¨Ø±:</label>
            <select id="postCategory" class="select-input">
                <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>
                </select>
        </div>

        <div class="toolbar">
            <button onclick="execCmd('bold')" class="btn-tool"><b>B</b></button>
            <button onclick="execCmd('italic')" class="btn-tool"><i>I</i></button>
            <input type="color" onchange="execCmd('foreColor', this.value)" style="width:30px; border:none; cursor:pointer;">
        </div>
        <div id="editor" class="rich-editor" contenteditable="true"></div>

        <div style="margin-bottom:15px;">
            <label style="font-size:13px; display:block; margin-bottom:5px; font-weight: bold; color: var(--primary);">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù:</label>
            <input type="file" id="imgFile" accept="image/*" onchange="handleImg()">
            <input type="hidden" id="imgBase64">
        </div>

        <div class="setting-row">
            <span>ğŸ‘ï¸ Ø¹Ø±Ø¶ Ù…Ø¤Ù‚Øª Ù„Ù„Ù…Ø­Ø±Ø±ÙŠÙ† ÙÙ‚Ø·</span>
            <input type="checkbox" id="tempView">
        </div>

        <div class="setting-row">
            <span>ğŸ“… Ø¬Ø¯ÙˆÙ„Ø© Ø§Ù„Ù†Ø´Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
            <input type="datetime-local" id="scheduleDate" class="schedule-input" style="width: auto;">
        </div>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, serverTimestamp, doc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† Firestore ÙÙˆØ±Ø§Ù‹
    onSnapshot(collection(db, "Categories"), (snap) => {
        const catSelect = document.getElementById('postCategory');
        catSelect.innerHTML = '<option value="Ø¹Ø§Ù…">Ø¹Ø§Ù…</option>'; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        snap.forEach(doc => {
            const cat = doc.data();
            catSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    });

    window.execCmd = (c, v=null) => document.execCommand(c, false, v);

    window.handleImg = () => {
        const file = document.getElementById('imgFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => document.getElementById('imgBase64').value = reader.result;
        if(file) reader.readAsDataURL(file);
    }

    document.getElementById('publishBtn').onclick = async () => {
        const title = document.getElementById('postTitle').value;
        const category = document.getElementById('postCategory').value;
        const body = document.getElementById('editor').innerHTML;
        const img = document.getElementById('imgBase64').value;
        const isTemp = document.getElementById('tempView').checked;
        const schedule = document.getElementById('scheduleDate').value;
        
        if(!title || body === "" || body === "<br>") return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰");

        const btn = document.getElementById('publishBtn');
        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        try {
            const user = auth.currentUser;
            const uSnap = await getDoc(doc(db, "Users", user.uid));
            const uData = uSnap.data();

            await addDoc(collection(db, "News"), {
                title, 
                category, // Ø­ÙØ¸ Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø®ØªØ§Ø±
                body, 
                img,
                authorId: user.uid,
                authorName: uData.fullName,
                authorImg: uData.profileImg || "",
                createdAt: serverTimestamp(),
                publishDate: schedule ? new Date(schedule).getTime() : Date.now(),
                isStopped: isTemp,
                likedBy: []
            });

            alert("ğŸ‰ ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ ØªØµÙ†ÙŠÙ: " + category);
            window.location.href = "news.html";
        } catch(e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±");
            btn.disabled = false;
        }
    }
</script>
</body>
</html>
