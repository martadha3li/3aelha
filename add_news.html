<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø± ÙˆØ§Ù„ØªØ«Ø¨ÙŠØª</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #F2F2F7; --card-bg: #FFFFFF; --ios-red: #FF3B30; --wedding-gold: #FFD700; --death-dark: #3A3A3C; --success: #34C759; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--ios-bg); margin: 0; padding: 20px; direction: rtl; }
        
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .back-btn { background: #e5e5ea; color: #000; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 18px; }
        .header h1 { font-size: 18px; flex: 1; text-align: center; margin-left: 35px; }

        .form-container { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .tab-selector { display: flex; background: #e5e5ea; padding: 4px; border-radius: 12px; margin-bottom: 20px; }
        .tab-item { flex: 1; text-align: center; padding: 8px; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 600; color: #8e8e93; }
        .tab-item.active { background: white; color: var(--ios-blue); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #3a3a3c; }
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; font-size: 15px; box-sizing: border-box; outline: none; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª Ù„Ù„ØªØ«Ø¨ÙŠØª */
        .news-picker { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; background: #fafafa; }
        .pick-item { display: flex; align-items: center; gap: 10px; padding: 12px; border-bottom: 1px solid #f2f2f2; cursor: pointer; transition: 0.2s; }
        .pick-item:active { background: #f0f0f5; }
        .pick-item.wedding { border-right: 5px solid var(--wedding-gold); background: #fffdf0; }
        .pick-item.death { border-right: 5px solid var(--death-dark); background: #f4f4f4; }
        .pick-img { width: 45px; height: 45px; border-radius: 8px; object-fit: cover; background: #eee; }
        .pick-title { font-size: 13px; font-weight: bold; flex: 1; color: #1c1c1e; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .pick-badge { font-size: 10px; padding: 2px 6px; border-radius: 50px; background: #eee; color: #666; }
        .pick-badge.gold { background: var(--wedding-gold); color: #000; }
        .pick-badge.black { background: var(--death-dark); color: #fff; }
        .pick-radio { accent-color: var(--ios-blue); width: 18px; height: 18px; }

        .ai-status { font-size: 12px; color: var(--ios-blue); text-align: center; margin-top: 10px; display: none; font-weight: 600; }
        .size-stats { font-size: 11px; color: var(--success); text-align: center; margin-top: 5px; font-weight: bold; }
        .hidden { display: none !important; }
        .publish-btn { width: 100%; padding: 15px; background: var(--ios-blue); color: white; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .ai-btn { background: linear-gradient(135deg, #007AFF, #5856D6); }
        .remove-pin-btn { width: 100%; padding: 12px; background: #fff; color: var(--ios-red); border: 1.5px solid var(--ios-red); border-radius: 15px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <a href="news.html" class="back-btn">âœ•</a>
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø®Ø¨Ø§Ø±</h1>
    </div>

    <div class="form-container">
        <div class="tab-selector">
            <div class="tab-item active" id="tabNormal" onclick="switchTab('normal')">Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø±</div>
            <div class="tab-item" id="tabAI" onclick="switchTab('ai')">ğŸ¤– Ù‚Ø±Ø§Ø¡Ø© ØµÙˆØ±Ø©</div>
            <div class="tab-item" id="tabPinned" onclick="switchTab('pinned')">ØªØ«Ø¨ÙŠØª / Ø¥Ù„ØºØ§Ø¡</div>
        </div>

        <div id="normalForm">
            <div class="input-group">
                <label>ØªØµÙ†ÙŠÙ Ø§Ù„Ø®Ø¨Ø±</label>
                <select id="postType" onchange="updateDefaultTitle()">
                    <option value="normal">Ø®Ø¨Ø± Ø¹Ø§Ù… ğŸ“„</option>
                    <option value="wedding">Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬ ğŸ’</option>
                    <option value="death">Ø¥Ø¹Ù„Ø§Ù† ÙˆÙØ§Ø© ğŸ–¤</option>
                </select>
            </div>
            <div class="input-group">
                <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                <input type="text" id="postTitle" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù‡Ù†Ø§...">
            </div>
            <div class="input-group">
                <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø± (Ø³ÙŠØªÙ… Ø¶ØºØ·Ù‡Ø§ Ø¢Ù„ÙŠØ§Ù‹)</label>
                <input type="file" id="postFile" accept="image/*">
                <div id="sizeStats" class="size-stats"></div>
            </div>
            <div class="input-group">
                <label>Ø§Ù„ØªÙØ§ØµÙŠÙ„</label>
                <textarea id="postBody" rows="5" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±..."></textarea>
            </div>
            <button id="mainBtn" class="publish-btn">Ù†Ø´Ø± Ø§Ù„Ø¢Ù†</button>
        </div>

        <div id="aiForm" class="hidden">
            <div style="text-align: center; padding: 10px 0;">
                <p style="font-size: 13px; color: #666;">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¨ÙˆØ³Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØªØ¹Ø¨Ø¦ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                <div class="input-group">
                    <label>Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø§Ù„Ø¨ÙˆØ³Øª</label>
                    <input type="file" id="aiFileInput" accept="image/*">
                </div>
                <div id="aiLoading" class="ai-status">â³ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ ÙˆØªØ­Ù„ÙŠÙ„Ù‡...</div>
                <button onclick="processAIImage()" class="publish-btn ai-btn">ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ğŸ”</button>
            </div>
        </div>

        <div id="pinnedForm" class="hidden">
            <label>Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ«Ø¨ÙŠØªÙ‡ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ ØªØ«Ø¨ÙŠØªÙ‡:</label>
            <div id="newsPicker" class="news-picker">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            
            <div id="pinActions">
                <div class="input-group">
                    <label>ØªØ«Ø¨ÙŠØª ÙƒÙ€:</label>
                    <select id="pinType">
                        <option value="wedding">ÙƒØ±Øª Ø²ÙˆØ§Ø¬ Ø°Ù‡Ø¨ÙŠ ğŸ’</option>
                        <option value="death">ÙƒØ±Øª ÙˆÙØ§Ø© Ø±Ù…Ø§Ø¯ÙŠ ğŸ–¤</option>
                    </select>
                </div>
                <button onclick="handlePinAction('pin')" class="publish-btn">ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø§Ù„Ø¹Ù„ÙˆÙŠ</button>
                <button onclick="handlePinAction('unpin')" class="remove-pin-btn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './config.js';
        import { collection, addDoc, getDocs, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let selectedNewsId = null;

        // 1. Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        window.switchTab = (mode) => {
            document.getElementById('tabNormal').classList.toggle('active', mode === 'normal');
            document.getElementById('tabAI').classList.toggle('active', mode === 'ai');
            document.getElementById('tabPinned').classList.toggle('active', mode === 'pinned');
            
            document.getElementById('normalForm').classList.toggle('hidden', mode !== 'normal');
            document.getElementById('aiForm').classList.toggle('hidden', mode !== 'ai');
            document.getElementById('pinnedForm').classList.toggle('hidden', mode !== 'pinned');
            
            if(mode === 'pinned') loadNewsForPicker();
        };

        // 2. Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø­Ø©
        async function compressImage(file) {
            return new Promise((resolve) => {
                const originalSize = (file.size / 1024).toFixed(2);
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        let width = img.width, height = img.height;
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.6); // Ø¶ØºØ· 60%
                        const newSize = (dataUrl.length * (3/4) / 1024).toFixed(2);
                        document.getElementById('sizeStats').innerText = `ğŸ“Š Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£ØµÙ„ÙŠ: ${originalSize}KB | Ø¨Ø¹Ø¯ Ø§Ù„Ø¶ØºØ·: ${newSize}KB (ØªÙˆÙÙŠØ± ${Math.round(100 - (newSize/originalSize*100))}%)`;
                        resolve(dataUrl);
                    };
                };
            });
        }

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
        window.processAIImage = async () => {
            const file = document.getElementById('aiFileInput').files[0];
            const status = document.getElementById('aiLoading');
            if (!file) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹");

            status.style.display = "block";
            try {
                const result = await Tesseract.recognize(file, 'ara', { logger: m => console.log(m) });
                const text = result.data.text;

                document.getElementById('postBody').value = text;
                const lines = text.split('\n').filter(l => l.trim() !== '');
                if (lines.length > 0) document.getElementById('postTitle').value = lines[0].substring(0, 50);

                if (text.includes("Ø²ÙˆØ§Ø¬") || text.includes("Ø§ÙØ±Ø§Ø­")) document.getElementById('postType').value = "wedding";
                else if (text.includes("ÙˆÙØ§Ø©") || text.includes("Ø§Ù†ØªÙ‚Ù„")) document.getElementById('postType').value = "death";

                alert("âœ… ØªÙ…Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„.");
                switchTab('normal');
            } catch (e) { alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©"); } finally { status.style.display = "none"; }
        };

        // 4. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø®Ø¨Ø§Ø± Ù„Ù„ØªØ«Ø¨ÙŠØª (Ù…ØµÙ„Ø­)
        async function loadNewsForPicker() {
            const picker = document.getElementById('newsPicker');
            picker.innerHTML = "<p style='text-align:center; padding:20px; font-size:12px; color:#888;'>â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø®Ø¨Ø§Ø±...</p>";
            try {
                const q = query(collection(db, "News"), orderBy("publishDate", "desc"));
                const snap = await getDocs(q);
                picker.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const type = data.type || 'normal';
                    const div = document.createElement('div');
                    div.className = `pick-item ${type}`;
                    div.onclick = () => { selectedNewsId = d.id; div.querySelector('input').checked = true; };
                    div.innerHTML = `
                        <input type="radio" name="pick" class="pick-radio">
                        <img src="${data.img || 'https://via.placeholder.com/50'}" class="pick-img">
                        <div class="pick-title">
                            ${data.title}
                            <span class="pick-badge ${type === 'wedding' ? 'gold' : (type === 'death' ? 'black' : '')}">
                                ${type === 'wedding' ? 'Ø²ÙˆØ§Ø¬ ğŸ’' : (type === 'death' ? 'ÙˆÙØ§Ø© ğŸ–¤' : 'Ø¹Ø§Ø¯ÙŠ ğŸ“„')}
                            </span>
                        </div>
                    `;
                    picker.appendChild(div);
                });
            } catch(e) { picker.innerHTML = "<p style='text-align:center; color:red;'>ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</p>"; }
        }

        // 5. Ø²Ø± Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        document.getElementById('mainBtn').onclick = async () => {
            const title = document.getElementById('postTitle').value;
            const body = document.getElementById('postBody').value;
            const type = document.getElementById('postType').value;
            const fileInput = document.getElementById('postFile');

            if(!title || !body) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

            let finalImg = "https://via.placeholder.com/500x300";
            if(fileInput.files[0]) {
                document.getElementById('mainBtn').innerText = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¶ØºØ·...";
                finalImg = await compressImage(fileInput.files[0]);
            }

            try {
                await addDoc(collection(db, "News"), {
                    title, body, img: finalImg, type,
                    publishDate: Date.now(),
                    authorId: auth.currentUser.uid,
                    visible: true
                });
                alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                window.location.href = "news.html";
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±"); }
        };

        // 6. Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ«Ø¨ÙŠØª
        window.handlePinAction = async (action) => {
            if(!selectedNewsId) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ø´ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹");
            try {
                const newType = (action === 'pin') ? document.getElementById('pinType').value : 'normal';
                await updateDoc(doc(db, "News", selectedNewsId), { type: newType });
                alert(action === 'pin' ? "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ«Ø¨ÙŠØª");
                loadNewsForPicker();
            } catch(e) { alert("ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«"); }
        };

        window.updateDefaultTitle = () => {
            const type = document.getElementById('postType').value;
            const titleInput = document.getElementById('postTitle');
            if(type === 'wedding') titleInput.value = "Ø¯Ø¹ÙˆØ© Ø²ÙˆØ§Ø¬: ";
            else if(type === 'death') titleInput.value = "Ø¥Ù†Ø§ Ù„Ù„Ù‡ ÙˆØ¥Ù†Ø§ Ø¥Ù„ÙŠÙ‡ Ø±Ø§Ø¬Ø¹ÙˆÙ†: ";
            else titleInput.value = "";
        };
    </script>
</body>
</html>
