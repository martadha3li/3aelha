<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</title>
   <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© | ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="top-bar">
        <img src="logo.png" style="height: 35px;">
        <div class="top-bar-right">
            <button id="adminLink" style="display:none; border:none; background:none; font-size:20px;" onclick="location.href='admin.html'">âš™ï¸</button>
            <button onclick="window.handleLogout()" style="border:none; background:none; font-size:20px;">ğŸšª</button>
        </div>
    </div>

    <div id="newsFeed">
        </div>

    <button id="addNewsBtn" class="floating-btn" onclick="location.href='add_news.html'" style="display:none;">+</button>

    <nav class="bottom-nav">
        <a href="news.html" class="nav-item active"><span class="nav-icon">ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
        <a href="chat.html" id="chatBtn" class="nav-item"><span class="nav-icon">ğŸ’¬</span>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a>
        <a href="profile.html" class="nav-item"><span class="nav-icon">ğŸ‘¤</span>Ø­Ø³Ø§Ø¨ÙŠ</a>
    </nav>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, query, orderBy, onSnapshot, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let userUID, userData;

    auth.onAuthStateChanged(async (user) => {
        if (user) {
            userUID = user.uid;
            const s = await getDoc(doc(db, "Users", user.uid));
            userData = s.data();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
            if (userData.role === 'admin' || userData.role === 'editor') {
                document.getElementById('addNewsBtn').style.display = 'block';
                if(userData.role === 'admin') document.getElementById('adminLink').style.display = 'block';
            }
            loadFeed();
        } else { window.location.href = "index.html"; }
    });

    function loadFeed() {
        onSnapshot(query(collection(db, "News"), orderBy("date", "desc")), (snap) => {
            const feed = document.getElementById('newsFeed');
            feed.innerHTML = "";
            snap.forEach((d) => {
                const n = d.data();
                const canControl = (userUID === n.authorId) || (userData.role === 'admin');

                feed.innerHTML += `
                    <div class="news-card">
                        <div class="news-body-content">
                            <div class="author-info">
                                <img src="${n.authorImg || 'https://via.placeholder.com/35'}" class="author-img">
                                <div>
                                    <div style="font-weight:700; font-size:14px;">${n.authorName || 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚'}</div>
                                    <div style="font-size:11px; color:var(--text-muted);">${n.category || 'Ø¹Ø§Ù…'}</div>
                                </div>
                            </div>
                            <h3 style="margin:10px 0; font-size:16px;">${n.title}</h3>
                        </div>
                        <img src="${n.img}" class="news-img-main" onclick="openFullNews('${d.id}')">
                        <div class="news-body-content">
                            <p style="font-size:13px; line-height:1.5; color:#444;">${n.body}</p>
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                                <div style="color:var(--primary); font-weight:bold;">â¤ï¸ ${n.likes || 0}</div>
                                ${canControl ? `<button onclick="deleteNews('${d.id}')" style="color:var(--danger); border:none; background:none; font-size:12px; font-weight:bold; cursor:pointer;">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±</button>` : ''}
                            </div>
                        </div>
                    </div>`;
            });
        });
    }

    window.deleteNews = async (id) => {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) await deleteDoc(doc(db, "News", id));
    };
</script>
</body>
</html>
</head>
<body>

<div class="form-card">
    <h2 style="text-align:center;">Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯ ğŸ“°</h2>
    <input type="text" id="newsTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±">
    
    <label>ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø± (Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø²):</label>
    <input type="file" id="newsImgFile" accept="image/*" onchange="processImage()">
    <img id="preview">
    <input type="hidden" id="newsImgBase64"> <textarea id="newsBody" rows="5" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±..."></textarea>
    <button class="btn-post" onclick="publishNews()">Ù†Ø´Ø± Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø¢Ù†</button>
</div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    window.processImage = () => {
        const file = document.getElementById('newsImgFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            document.getElementById('newsImgBase64').value = reader.result;
            document.getElementById('preview').src = reader.result;
            document.getElementById('preview').style.display = 'block';
        }
        if (file) reader.readAsDataURL(file);
    };

    window.publishNews = async () => {
        const title = document.getElementById('newsTitle').value;
        const imgData = document.getElementById('newsImgBase64').value;
        const body = document.getElementById('newsBody').value;

        if(!title || !imgData || !body) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø®ØªØ± ØµÙˆØ±Ø©");

        const uSnap = await getDoc(doc(db, "Users", auth.currentUser.uid));
        const uName = uSnap.data().fullName;

        await addDoc(collection(db, "News"), {
            title, img: imgData, body,
            authorId: auth.currentUser.uid,
            authorName: uName, // Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø±Ø±
            date: serverTimestamp(),
            likes: 0
        });
        alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­");
        window.location.href = "news.html";
    };
</script>
</body>
</html>
