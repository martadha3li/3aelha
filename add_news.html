<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¶Ø§ÙØ© Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .editor-box { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .rich-editor { min-height: 250px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; outline: none; background: #fff; margin-bottom: 15px; }
        .input-label { font-size: 13px; font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }
        .select-input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 15px; outline: none; }
    </style>
</head>
<body>
    <div class="top-bar">
        <button onclick="location.href='news.html'" style="border:none; background:none; font-size:20px;">âœ•</button>
        <b>Ù†Ø´Ø± Ø®Ø¨Ø± Ø§Ø­ØªØ±Ø§ÙÙŠ</b>
        <button class="btn-main" id="publishBtn">Ù†Ø´Ø±</button>
    </div>

    <div class="editor-box">
        <label class="input-label">ğŸ“ ØªØµÙ†ÙŠÙ Ø§Ù„Ø®Ø¨Ø±:</label>
        <select id="postCategory" class="select-input">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>
        </select>

        <label class="input-label">ğŸ“ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø±:</label>
        <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± Ù‡Ù†Ø§..." class="form-input" style="width:100%; margin-bottom:15px; font-weight:bold;">
        
        <div id="editor" class="rich-editor" contenteditable="true"></div>

        <label class="input-label">ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ø®Ø¨Ø±:</label>
        <input type="file" id="imgFile" accept="image/*" onchange="handleImg()" style="margin-bottom:15px;">
        <input type="hidden" id="imgBase64">

        <div style="display:flex; justify-content:space-between; align-items:center; border-top:1px solid #eee; padding-top:10px;">
            <span style="font-size:13px;">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ù„Ù„Ù…Ø­Ø±Ø±ÙŠÙ† ÙÙ‚Ø·</span>
            <input type="checkbox" id="tempView">
        </div>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, onSnapshot, addDoc, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let categoriesMap = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
    onSnapshot(collection(db, "Categories"), snap => {
        const select = document.getElementById('postCategory');
        select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ --</option>';
        snap.forEach(d => {
            const cat = d.data();
            categoriesMap[cat.name] = cat.defaultTitle;
            select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
        });
    });

    // Ø±Ø¨Ø· Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    document.getElementById('postCategory').onchange = function() {
        const titleInput = document.getElementById('postTitle');
        if (categoriesMap[this.value]) {
            titleInput.value = categoriesMap[this.value];
            titleInput.style.border = "1px solid var(--primary)";
        } else {
            titleInput.value = "";
            titleInput.style.border = "1px solid #ddd";
        }
    };

    window.handleImg = () => {
        const file = document.getElementById('imgFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => document.getElementById('imgBase64').value = reader.result;
        if(file) reader.readAsDataURL(file);
    };

    document.getElementById('publishBtn').onclick = async () => {
        const title = document.getElementById('postTitle').value;
        const body = document.getElementById('editor').innerHTML;
        const category = document.getElementById('postCategory').value;
        const img = document.getElementById('imgBase64').value;
        const isStopped = document.getElementById('tempView').checked;

        if(!title || !body || !category) return alert("Ø£ÙƒÙ…Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        const uSnap = await getDoc(doc(db, "Users", auth.currentUser.uid));
        const uData = uSnap.data();

        await addDoc(collection(db, "News"), {
            title, body, category, img, isStopped,
            authorId: auth.currentUser.uid,
            authorName: uData.fullName,
            authorImg: uData.profileImg || "",
            publishDate: Date.now(),
            likedBy: []
        });

        alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­!");
        location.href = "news.html";
    };
</script>
</body>
</html>
