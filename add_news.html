<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø´Ø± Ø®Ø¨Ø± Ø¬Ø¯ÙŠØ¯</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .editor-container { background: white; margin: 15px; padding: 20px; border-radius: 20px; box-shadow: var(--shadow); }
        .toolbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .tool-btn { padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; background: white; cursor: pointer; font-weight: bold; }
        .rich-editor { min-height: 200px; border: 1px solid #eee; padding: 15px; border-radius: 10px; outline: none; background: #fafafa; }
        .preview-img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; margin-top: 10px; display: none; }
    </style>
</head>
<body>
    <div class="top-bar">
        <button onclick="history.back()" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b id="pageTitle">Ù†Ø´Ø± Ù…Ù†Ø´ÙˆØ± Ø¬Ø¯ÙŠØ¯</b>
        <button class="btn-main" onclick="publishPost()" id="pubBtn">Ù†Ø´Ø±</button>
    </div>

    <div class="editor-container">
        <input type="text" id="postTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø®Ø¨Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" class="form-input" style="font-weight: bold; font-size: 18px;">
        
        <div class="toolbar">
            <button class="tool-btn" onclick="execCmd('bold')">B</button>
            <button class="tool-btn" onclick="execCmd('italic')">I</button>
            <select onchange="execCmd('foreColor', this.value)" class="tool-btn">
                <option value="#000">Ù„ÙˆÙ† Ø§Ù„Ù†Øµ</option>
                <option value="#ff3b30">Ø£Ø­Ù…Ø±</option>
                <option value="#007aff">Ø£Ø²Ø±Ù‚</option>
                <option value="#34c759">Ø£Ø®Ø¶Ø±</option>
            </select>
        </div>

        <div id="editor" class="rich-editor" contenteditable="true" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¨Ø± Ù‡Ù†Ø§..."></div>

        <div style="margin-top:20px;">
            <label>ğŸ–¼ï¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø©:</label>
            <input type="file" id="imgFile" accept="image/*" onchange="previewImage()" style="display: block; margin-top:10px;">
            <img id="imgPreview" class="preview-img">
            <input type="hidden" id="base64Img">
        </div>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, serverTimestamp, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const params = new URLSearchParams(window.location.search);
    const editId = params.get('edit');

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    if(editId) {
        document.getElementById('pageTitle').innerText = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø¨Ø±";
        document.getElementById('pubBtn').innerText = "Ø­ÙØ¸";
        const snap = await getDoc(doc(db, "News", editId));
        const n = snap.data();
        document.getElementById('postTitle').value = n.title;
        document.getElementById('editor').innerHTML = n.body;
        if(n.img) {
            document.getElementById('imgPreview').src = n.img;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('base64Img').value = n.img;
        }
    }

    window.execCmd = (cmd, val = null) => document.execCommand(cmd, false, val);

    window.previewImage = () => {
        const file = document.getElementById('imgFile').files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            document.getElementById('imgPreview').src = reader.result;
            document.getElementById('imgPreview').style.display = 'block';
            document.getElementById('base64Img').value = reader.result;
        };
        if(file) reader.readAsDataURL(file);
    };

    window.publishPost = async () => {
        const title = document.getElementById('postTitle').value;
        const body = document.getElementById('editor').innerHTML;
        const img = document.getElementById('base64Img').value;
        const user = auth.currentUser;

        if(!title || body === "") return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

        try {
            if(editId) {
                await updateDoc(doc(db, "News", editId), { title, body, img });
                alert("ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
            } else {
                const uSnap = await getDoc(doc(db, "Users", user.uid));
                const uData = uSnap.data();
                await addDoc(collection(db, "News"), {
                    title, body, img,
                    authorId: user.uid,
                    authorName: uData.fullName,
                    authorImg: uData.profileImg || "",
                    date: serverTimestamp(),
                    likedBy: [], isStopped: false
                });
                alert("ØªÙ… Ø§Ù„Ù†Ø´Ø±");
            }
            window.location.href = "news.html";
        } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£"); }
    };
</script>
</body>
</html>
