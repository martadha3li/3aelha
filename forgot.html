<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: #f8f9fa;">

    <div class="top-bar">
        <button onclick="history.back()" style="border:none; background:none; font-size:20px;">â¡ï¸</button>
        <b>Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</b>
        <div style="width:20px;"></div>
    </div>

    <div style="padding: 30px 20px; max-width: 450px; margin: auto;">
        <div class="category-card" style="background:white; padding:25px; border-radius:25px; box-shadow: var(--shadow); text-align: center;">
            <p style="font-size: 14px; color: gray; margin-bottom: 20px;">
                Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ù„Ù„Ù…Ø¯ÙŠØ±ØŒ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨.
            </p>
            
            <input type="email" id="resetEmail" class="form-input" placeholder="Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„" style="width:100%; margin-bottom:15px; padding:12px; border-radius:12px; border:1px solid #ddd;">
            
            <button id="btnReset" class="btn-main" style="width:100%; padding:15px;" onclick="handleResetRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¯ÙŠØ± ğŸ›¡ï¸</button>
            
            <div id="statusMsg" style="margin-top:15px; font-size:12px; display:none;"></div>
        </div>
    </div>

<script type="module">
    import { auth, db } from './config.js';
    import { collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ GPS
    async function getGPS() {
        return new Promise((resolve) => {
            navigator.geolocation.getCurrentPosition(
                (p) => resolve({ lat: p.coords.latitude, lng: p.coords.longitude }),
                () => resolve(null),
                { timeout: 5000 }
            );
        });
    }

    window.handleResetRequest = async () => {
        const email = document.getElementById('resetEmail').value.trim();
        const btn = document.getElementById('btnReset');
        const status = document.getElementById('statusMsg');

        if (!email) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯");

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ...";

        const location = await getGPS();

        try {
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ø¬Ù„Ø¨ Ø§Ø³Ù…Ù‡ ÙˆÙ…Ø¹Ø±ÙØ§ØªÙ‡
            const q = query(collection(db, "Users"), where("email", "==", email));
            const snap = await getDocs(q);

            if (snap.empty) {
                alert("Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§");
                btn.disabled = false;
                return;
            }

            const userDoc = snap.docs[0];
            const userData = userDoc.data();

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ø³Ø¬Ù„ PasswordRequests Ù„ÙŠØ±Ø§Ù‡ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©
            await addDoc(collection(db, "PasswordRequests"), {
                userId: userDoc.id,
                userName: userData.fullName,
                email: email,
                changeLoc: location, // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                regLoc: userData.regLoc || null, // Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ
                status: "pending",
                timestamp: serverTimestamp()
            });

            // Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù‡ÙŠØ³ØªÙˆØ±ÙŠ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ©
            await addDoc(collection(db, "PasswordHistory"), {
                userId: userDoc.id,
                userName: userData.fullName,
                changeLoc: location,
                regLoc: userData.regLoc || null,
                timestamp: serverTimestamp()
            });

            status.innerHTML = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø¨Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡ ÙˆØªØ²ÙˆÙŠØ¯Ùƒ Ø¨ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…ÙˆÙ‚Ø¹Ùƒ.";
            status.style.display = "block";
            status.style.color = "green";
            btn.style.display = "none";

        } catch (e) {
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + e.message);
            btn.disabled = false;
        }
    };
</script>
</body>
</html>
