<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¹Ø§Ù…</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-green: #34C759; --msg-in: #ffffff; --msg-out: #E1FEC6; }
        body { background: #E5DDD5; font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        #messagesArea { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; padding-top: 80px; }
        
        /* ÙÙ‚Ø§Ø¹Ø§Øª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 15px; position: relative; font-size: 15px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-start; background: var(--msg-out); border-top-left-radius: 2px; }
        .msg.received { align-self: flex-end; background: var(--msg-in); border-top-right-radius: 2px; }
        
        .msg-info { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 4px; font-size: 10px; color: #8e8e93; }
        .msg-user { font-weight: bold; color: var(--ios-blue); font-size: 12px; display: block; margin-bottom: 3px; }
        .msg-img { width: 100%; border-radius: 10px; margin-top: 5px; cursor: pointer; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ (Ù…Ø«Ù„ ÙˆØ§ØªØ³Ø§Ø¨) */
        .input-area { background: #f6f6f6; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-box { flex: 1; background: white; border-radius: 20px; padding: 8px 15px; border: 1px solid #ddd; outline: none; max-height: 100px; overflow-y: auto; }
        .action-btn { font-size: 24px; cursor: pointer; color: var(--ios-blue); display: flex; align-items: center; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…Ø·ÙˆÙ„ */
        .context-menu { position: fixed; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 10000; overflow: hidden; width: 150px; }
        .context-menu button { border: none; background: none; padding: 12px; text-align: right; font-size: 14px; border-bottom: 0.5px solid #eee; cursor: pointer; }
        .context-menu button.del { color: red; }
    </style>
</head>
<body>

    <script type="module" src="header.js"></script>

    <div id="messagesArea"></div>

    <div class="input-area">
        <label class="action-btn">
            â•<input type="file" id="imgInput" hidden accept="image/*">
        </label>
        <input type="text" id="msgInput" class="input-box" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <div class="action-btn" id="sendBtn">ğŸ•Šï¸</div>
    </div>

    <div id="contextMenu" class="context-menu">
        <button id="forwardBtn">â†ªï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡</button>
        <button id="deleteBtn" class="del">ğŸ—‘ï¸ Ø­Ø°Ù Ù„Ù„Ø¬Ù…ÙŠØ¹</button>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUser = null;
    const msgArea = document.getElementById('messagesArea');
    const msgInput = document.getElementById('msgInput');
    const imgInput = document.getElementById('imgInput');
    let selectedMsgId = null;

    auth.onAuthStateChanged(user => { if(user) currentUser = user; else location.href='login.html'; });

    // 1. Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ©
    async function sendMessage(text = "", img = null) {
        if (!text && !img) return;
        const userSnap = await getDoc(doc(db, "Users", currentUser.uid));
        const userData = userSnap.data();

        await addDoc(collection(db, "PublicMessages"), {
            text,
            image: img,
            senderId: currentUser.uid,
            senderName: userData.fullName,
            timestamp: serverTimestamp()
        });
        msgInput.value = "";
    }

    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø´ÙƒÙ„ Ø­ÙŠ
    onSnapshot(query(collection(db, "PublicMessages"), orderBy("timestamp", "asc")), (snap) => {
        msgArea.innerHTML = "";
        snap.forEach(docSnap => {
            const m = docSnap.data();
            const isMe = m.senderId === currentUser.uid;
            
            const div = document.createElement('div');
            div.className = `msg ${isMe ? 'sent' : 'received'}`;
            div.oncontextmenu = (e) => showMenu(e, docSnap.id, isMe);
            
            div.innerHTML = `
                ${!isMe ? `<span class="msg-user">${m.senderName}</span>` : ''}
                ${m.image ? `<img src="${m.image}" class="msg-img">` : ''}
                <div>${m.text}</div>
                <div class="msg-info">
                    <span>${m.timestamp?.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) || ''}</span>
                    ${isMe ? '<span>âœ“âœ“</span>' : ''}
                </div>
            `;
            msgArea.appendChild(div);
        });
        msgArea.scrollTop = msgArea.scrollHeight;
    });

    // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± (Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø· Base64 Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø±ÙŠØ¹)
    imgInput.onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onloadend = () => sendMessage("", reader.result);
        reader.readAsDataURL(file);
    };

    // 4. Ø§Ù„Ø­Ø°Ù ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
    function showMenu(e, id, isMe) {
        e.preventDefault();
        selectedMsgId = id;
        const menu = document.getElementById('contextMenu');
        menu.style.display = 'flex';
        menu.style.top = e.pageY + 'px';
        menu.style.left = e.pageX + 'px';
        document.getElementById('deleteBtn').style.display = isMe ? 'block' : 'none';
    }

    document.getElementById('deleteBtn').onclick = async () => {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ØŸ")) await deleteDoc(doc(db, "PublicMessages", selectedMsgId));
        hideMenu();
    };

    document.getElementById('forwardBtn').onclick = () => {
        alert("Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®Øµ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ (ÙŠÙ…ÙƒÙ†Ùƒ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£Ø¹Ø¶Ø§Ø¡)");
        hideMenu();
    };

    function hideMenu() { document.getElementById('contextMenu').style.display = 'none'; }
    document.addEventListener('click', hideMenu);
    document.getElementById('sendBtn').onclick = () => sendMessage(msgInput.value);
</script>
</body>
</html>
