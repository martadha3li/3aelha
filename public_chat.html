<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÿßŸÑŸÖÿ¨ŸÑÿ≥ ÿßŸÑÿπÿßŸÖ ŸÑŸÑÿπÿßÿ¶ŸÑÿ©</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #E5DDD5; }
        body { background: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: rgba(246, 246, 246, 0.9); backdrop-filter: blur(10px); padding: 45px 15px 10px; display: flex; align-items: center; border-bottom: 0.5px solid #ccc; position: fixed; top: 0; width: 100%; z-index: 1000; box-sizing: border-box; }
        .back-btn { color: var(--ios-blue); text-decoration: none; cursor: pointer; flex: 1; }
        .group-info { flex: 2; text-align: center; font-weight: bold; }
        #chatBox { flex: 1; padding: 110px 15px 90px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-end; background: #DCF8C6; border-bottom-right-radius: 2px; }
        .msg.received { align-self: flex-start; background: white; border-bottom-left-radius: 2px; }
        .sender-name { font-size: 11px; font-weight: bold; color: var(--ios-blue); display: block; }
        .msg-time { font-size: 9px; color: #999; display: flex; justify-content: space-between; align-items: center; margin-top: 4px; }
        .delete-btn { color: #FF3B30; font-size: 14px; cursor: pointer; margin-right: 8px; border: none; background: none; }
        .input-area { background: #f6f6f6; padding: 10px 15px 25px; display: flex; align-items: center; gap: 10px; border-top: 0.5px solid #ccc; position: fixed; bottom: 0; width: 100%; box-sizing: border-box; }
        .msg-input { flex: 1; border: 0.5px solid #ccc; padding: 10px 15px; border-radius: 20px; outline: none; }
        .send-btn { background: var(--ios-blue); color: white; border: none; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
        .send-btn:disabled { background: #ccc; }
    </style>
</head>
<body>

<div class="header">
    <div class="back-btn" onclick="location.href='chat.html'">‚ùÆ ÿπŸàÿØÿ©</div>
    <div class="group-info">ÿßŸÑŸÖÿ¨ŸÑÿ≥ ÿßŸÑÿπÿßŸÖ</div>
    <div style="flex:1"></div>
</div>

<div id="chatBox"></div>

<div class="input-area">
    <input type="text" id="msgInput" class="msg-input" placeholder="ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÇŸÇ...">
    <button id="sendBtn" class="send-btn" disabled>‚ñ≤</button>
</div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, query, onSnapshot, orderBy, serverTimestamp, getDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let user = null;
    let userData = null;

    auth.onAuthStateChanged(async (u) => {
        if (u) {
            user = u;
            const snap = await getDoc(doc(db, "Users", u.uid));
            userData = snap.data();
            watchSettings();
            loadMessages();
        } else { location.href = "login.html"; }
    });

    function watchSettings() {
        onSnapshot(doc(db, "Settings", "AppConfig"), (snap) => {
            const config = snap.data();
            const isAdmin = userData?.role === 'admin';
            const input = document.getElementById('msgInput');
            const btn = document.getElementById('sendBtn');

            if (!config.publicChatEnabled && !isAdmin) {
                input.disabled = true;
                input.placeholder = "üîí ŸÖÿ∫ŸÑŸÇ ÿ≠ÿßŸÑŸäÿßŸã";
                btn.disabled = true;
            } else {
                input.disabled = false;
                input.placeholder = "ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ© ŸÑŸÑŸÖÿ¨ŸÑÿ≥...";
                btn.disabled = false;
            }
        });
    }

    function loadMessages() {
        const q = query(collection(db, "PublicMessages"), orderBy("timestamp", "asc"));
        onSnapshot(q, (snap) => {
            const box = document.getElementById('chatBox');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === user.uid;
                const isAdmin = userData?.role === 'admin';
                const time = m.timestamp?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || "";

                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                div.innerHTML = `
                    ${!isMe ? `<span class="sender-name">${m.senderName}</span>` : ''}
                    <div>${m.text}</div>
                    <div class="msg-time">
                        ${time}
                        ${isAdmin ? `<button class="delete-btn" onclick="deleteMsg('${d.id}')">ÿ≠ÿ∞ŸÅ</button>` : ''}
                    </div>
                `;
                box.appendChild(div);
            });
            box.scrollTop = box.scrollHeight;
        });
    }

    window.deleteMsg = async (id) => {
        if(confirm("ÿ≠ÿ∞ŸÅ Ÿáÿ∞Ÿá ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑÿ¨ŸÖŸäÿπÿü")) await deleteDoc(doc(db, "PublicMessages", id));
    };

    async function send() {
        const input = document.getElementById('msgInput');
        if(!input.value.trim()) return;
        const txt = input.value;
        input.value = "";
        await addDoc(collection(db, "PublicMessages"), {
            senderId: user.uid, senderName: userData.fullName, text: txt, timestamp: serverTimestamp()
        });
    }

    document.getElementById('sendBtn').onclick = send;
    document.getElementById('msgInput').onkeypress = (e) => { if(e.key === 'Enter') send(); };
</script>
</body>
</html>
