<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø¬Ù„Ø³ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø¹Ø§Ø¦Ù„Ø©</title>
    <style>
        :root { --ios-blue: #007AFF; --ios-bg: #E5DDD5; --msg-in: #ffffff; --msg-out: #E1FEC6; }
        body { background: var(--ios-bg); font-family: -apple-system, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        #messagesArea { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; padding-top: 80px; }
        
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 15px; position: relative; font-size: 15px; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.sent { align-self: flex-start; background: var(--msg-out); border-top-left-radius: 2px; }
        .msg.received { align-self: flex-end; background: var(--msg-in); border-top-right-radius: 2px; }
        
        .msg-info { display: flex; justify-content: space-between; font-size: 10px; color: #8e8e93; margin-top: 4px; }
        .msg-user { font-weight: bold; color: var(--ios-blue); font-size: 12px; display: block; margin-bottom: 3px; }
        .msg-img { width: 100%; border-radius: 10px; margin-bottom: 5px; cursor: pointer; }
        .fwd-tag { font-style: italic; font-size: 10px; color: #8e8e93; display: block; margin-bottom: 2px; }

        .input-area { background: #f6f6f6; padding: 10px; display: flex; align-items: center; gap: 10px; border-top: 1px solid #ddd; }
        .input-box { flex: 1; background: white; border-radius: 20px; padding: 10px 15px; border: 1px solid #ddd; outline: none; }

        /* Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© ÙˆÙ†Ø§ÙØ°Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ */
        .context-menu { position: fixed; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: none; flex-direction: column; z-index: 10000; width: 150px; }
        .context-menu button { border: none; background: none; padding: 12px; text-align: right; border-bottom: 0.5px solid #eee; cursor: pointer; }
        
        .forward-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 20000; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .forward-content { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 20px; max-height: 60vh; overflow-y: auto; }
        .user-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 0.5px solid #eee; cursor: pointer; }
        .user-row.disabled { opacity: 0.4; pointer-events: none; }
    </style>
</head>
<body>

    <script type="module" src="header.js"></script>

    <div id="messagesArea"></div>

    <div class="input-area">
        <label style="font-size: 24px; cursor: pointer;">â•<input type="file" id="imgInput" hidden accept="image/*"></label>
        <input type="text" id="msgInput" class="input-box" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <button id="sendBtn" style="border:none; background:none; font-size: 24px; cursor: pointer;">ğŸ•Šï¸</button>
    </div>

    <div id="contextMenu" class="context-menu">
        <button id="fwdBtn">â†ªï¸ Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡</button>
        <button id="delBtn" style="color:red;">ğŸ—‘ï¸ Ø­Ø°Ù</button>
    </div>

    <div id="forwardModal" class="forward-modal">
        <div class="forward-content">
            <h3 style="margin-top:0;">Ø¥Ø¹Ø§Ø¯Ø© ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰...</h3>
            <div id="usersList"></div>
            <button onclick="document.getElementById('forwardModal').style.display='none'" style="width:100%; margin-top:10px; padding:10px; border-radius:10px; border:none; background:#eee;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

<script type="module">
    import { db, auth } from './config.js';
    import { collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, doc, deleteDoc, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let currentUser = null, currentUserData = null, selectedMsgId = null;

    auth.onAuthStateChanged(async user => {
        if(user) {
            currentUser = user;
            const snap = await getDoc(doc(db, "Users", user.uid));
            currentUserData = snap.data();
            loadMessages();
        } else location.href='login.html';
    });

    async function loadMessages() {
        onSnapshot(query(collection(db, "PublicMessages"), orderBy("timestamp", "asc")), (snap) => {
            const area = document.getElementById('messagesArea');
            area.innerHTML = "";
            snap.forEach(docSnap => {
                const m = docSnap.data();
                const isMe = m.senderId === currentUser.uid;
                const div = document.createElement('div');
                div.className = `msg ${isMe ? 'sent' : 'received'}`;
                div.oncontextmenu = (e) => {
                    e.preventDefault();
                    selectedMsgId = docSnap.id;
                    const menu = document.getElementById('contextMenu');
                    menu.style.display = 'flex'; menu.style.top = e.pageY+'px'; menu.style.left = e.pageX+'px';
                    document.getElementById('delBtn').style.display = isMe ? 'block' : 'none';
                };
                div.innerHTML = `
                    ${!isMe ? `<span class="msg-user">${m.senderName}</span>` : ''}
                    ${m.isForwarded ? `<span class="fwd-tag">â†ªï¸ Ø±Ø³Ø§Ù„Ø© Ù…Ø­ÙˆÙ„Ø©</span>` : ''}
                    ${m.image ? `<img src="${m.image}" class="msg-img">` : ''}
                    <span>${m.text}</span>
                    <div class="msg-info"><span>${m.timestamp?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || ''}</span></div>
                `;
                area.appendChild(div);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
    window.send = async (text, img = null) => {
        if(!text && !img) return;
        await addDoc(collection(db, "PublicMessages"), {
            text, image: img, senderId: currentUser.uid, senderName: currentUserData.fullName, timestamp: serverTimestamp()
        });
        document.getElementById('msgInput').value = "";
    };

    document.getElementById('sendBtn').onclick = () => window.send(document.getElementById('msgInput').value);
    
    document.getElementById('imgInput').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = () => window.send("", reader.result);
        reader.readAsDataURL(e.target.files[0]);
    };

    // Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡
    document.getElementById('delBtn').onclick = async () => {
        if(confirm("Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) await deleteDoc(doc(db, "PublicMessages", selectedMsgId));
    };

    document.getElementById('fwdBtn').onclick = async () => {
        const config = (await getDoc(doc(db, "Settings", "AppConfig"))).data();
        if(!config.privateChatEnabled) return alert("Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø®Ø§ØµØ© Ù…Ø¹Ø·Ù„Ø©");
        
        document.getElementById('forwardModal').style.display = 'flex';
        const list = document.getElementById('usersList');
        list.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
        
        const users = await getDocs(collection(db, "Users"));
        list.innerHTML = "";
        users.forEach(uDoc => {
            const u = uDoc.data();
            if(uDoc.id === currentUser.uid) return;
            const blocked = config.genderRestriction && u.gender !== currentUserData.gender;
            const row = document.createElement('div');
            row.className = `user-row ${blocked ? 'disabled' : ''}`;
            row.innerHTML = `<span>${u.fullName}</span> <small>${blocked ? 'ğŸš« Ù…Ù‚ÙŠØ¯' : 'Ø¥Ø±Ø³Ø§Ù„'}</small>`;
            row.onclick = () => forwardTo(uDoc.id, u.fullName);
            list.appendChild(row);
        });
    };

    async function forwardTo(id, name) {
        if(!confirm(`ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ${name}ØŸ`)) return;
        const msg = (await getDoc(doc(db, "PublicMessages", selectedMsgId))).data();
        await addDoc(collection(db, "PrivateMessages"), {
            text: msg.text, image: msg.image || null, senderId: currentUser.uid, receiverId: id, 
            senderName: currentUserData.fullName, timestamp: serverTimestamp(), isForwarded: true
        });
        alert("ØªÙ… Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ âœ…");
        document.getElementById('forwardModal').style.display = 'none';
    }

    document.addEventListener('click', () => document.getElementById('contextMenu').style.display='none');
</script>
</body>
</html>
